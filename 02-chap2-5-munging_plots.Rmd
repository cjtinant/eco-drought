---
title: "02-chapt2-5_study-area"
author: "CJ Tinant"
date: "8/06/2019"
output: html_document 
---

<!--
Purpose: 
Refactors prior code to develop tables and plots for the study area description 
section of Chapter 2 

Data: 
 discuss

Approach: 
1) find  possible sites by bounding box 
-- find all sites within a bounding box 
-- add the metadata, 
-- filters no data sites for 1980- 2018 water years 
# for filtering info see: https://help.waterdata.usgs.gov/site_tp_cd
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


# bBox = a contiguous range of decimal latitude and longitude, starting with the west longitude, then the south latitude, then the east longitude, and then the north latitude with each value separated by a comma. 
# https://waterservices.usgs.gov/rest/Site-Service.html#bBox 
# the Pine Ridge Reservation boundary is c(-103, 43, -100.2, 43.8)
2) Split train/test data 

Next Steps: 
-- check into stylr-packag

Variable naming convention:   
# ~~~~~~~~~~~~~~~~~~~~~~~~~
gpg_layers          names of layers in gpkg file for the watershed summaries 
   _gage_summary 
   _prr_wq_sites
   _wbd_summary

wsd_summary     zonal statistics of watershed environmental parameters 
*   _id          unique id
*  _sta_id      four- or seven-digit station ID   
--> 

```{r setup, include=FALSE, message=FALSE}  
#knitr::opts_chunk$set(echo = FALSE)  
options(tibble.print_max = 70) # sets tibble output for printing  

# Sets up the library of packages   
library("here")                   # identifies where to save work  
library("EGRET")                  # Exploration and Graphics for RivEr Trends 
library("rio")                    # more robust I/O - to import and clean data  
library("lubridate")              # easier dates 
library("janitor")                # tools for examining and cleaning dirty data  
library("dataRetrieval")          # USGS data import  
library("huxtable")               # easily create and style tables
library("tidyverse")              # data munging tools 
```

```{r import_daily_flow_metadata, eval=FALSE} 

gage_poss <- whatNWISsites(bBox = c(-103.8, 42.2, -99.2, 44.6),
                       parameterCd = "00060",
                       hasDataTypeCd = "dv") %>% 
  arrange(site_no)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 2. get metadata 
# this needs to be run in parts because some project numbers & 
# inventories are stored as integers & others are stored as characters 

gage_meta_int1 <- gage_poss %>% 
    slice(7, 17, 142, 148) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_int2 <- gage_poss %>% 
    slice(94) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_char <- gage_poss %>% 
    slice(-c(7, 17, 94, 142, 148)) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# 3. join gage metadata & ??drop the partial sites?? 
gage_meta_poss <- bind_rows(gage_meta_int1, 
                            gage_meta_int2, 
                            gage_meta_char)  

# clean up
rm(gage_gage_meta_int1, 
   gage_meta_int2, 
   gage_meta_char) 

# 4. export metadata to data folder 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
export(gage_meta_poss, "data/gage_meta_poss.csv")  
```

```{r remove_not_useful_stations, eval=FALSE}
# remove gages that do not meet standards or in crystaline or karst catchments 
gage_meta <- gage_meta_poss %>%   
  mutate(reliability_cd = replace_na(reliability_cd, 0)) %>% #  NA <- 
  filter(reliability_cd != "M") %>% # M is minimal data 
  filter(!str_detect(station_nm, 'DAM|DITCH|DRAIN')) %>% # upstream control 
  filter(!str_detect(station_nm, 
                     'CUSTER|KEYSTONE|HILL CITY|HAYWARD')) %>% 
  # crystaline catchments 
  filter(!str_detect(station_nm, 
                     'LEAD|DEADWOOD|WHITEWOOD')) %>%   
  # crystaline catchments 
  filter(!str_detect(station_nm, 'CLEGHORN')) %>% # karstic? spring 
  filter(!str_detect(station_nm, 'BOXELDER|LIME')) %>% # karstic 
  filter(!str_detect(station_nm, 'RAPID')) %>%   
  # Rapid Creek & upper Spring Creek 
  filter(!str_detect(station_nm, 'MISSOURI'))

# 4. export metadata to data folder after fixing leading zero
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_meta <- gage_meta %>% 
  mutate(site_no = as.character(site_no)) %>% 
  select(-reliability_cd) %>% 
  mutate(length = str_length(site_no)) %>% 
  filter(length <= 8) %>%   # removes two provisional sites
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8)) %>% 
  select(-length)

export(gage_meta, "data/gage_meta.csv") 

```



```{r clean_daily_flow_metadata, eval=FALSE}
# 1. load daily flow data  & renive crystaline basins    
gage_dv_raw <- read_csv("data/gage_dv.csv") %>%  
  clean_names() %>%  
  filter(sta != "elk_rob")           # remove the record of crystaline basins  

# 1.1 check a short record 
#wkc_wok <- gage_dv_raw %>%  
#  filter(sta == "wkc_wok")  

# 2. check for incomplete days of record & years of record  
yr_incomp <- gage_dv_raw %>%                          
  group_by(sta, water_year) %>%                  
  summarise(days_yr = n()) %>%                    
  ungroup() %>%  
  filter(between(days_yr, .8 * 360, 364))  

# 3. fill the station-years with missing data  
wy_1991 <- tibble(date = seq.Date(from=as.Date("1990-10-01"),  
                 to=as.Date("1991-09-30"), by="day")) 

wy_2003 <- tibble(date = seq.Date(from=as.Date("2002-10-01"),  
                 to=as.Date("2003-09-30"), by="day")) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
bev_pri_1991 <- gage_dv_raw %>%  
  filter(sta == "bev_pri") %>%  
  filter(water_year == 1991) 

bev_pri_1991 <- full_join(bev_pri_1991, wy_1991) 

bev_pri_1991 <- bev_pri_1991 %>%  
  mutate(sta = "bev_pri") %>%  
  mutate(incomp_yr = "Y") %>%  
  mutate(water_year = 1991) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
whi_slm_1991 <- gage_dv_raw %>%  
  filter(sta == "whi_slm") %>%  
  filter(water_year == 1991) 

whi_slm_1991 <- full_join(whi_slm_1991, wy_1991) 

whi_slm_1991 <- whi_slm_1991 %>%  
  mutate(sta = "whi_slm") %>%  
  mutate(incomp_yr = "Y") %>%  
  mutate(water_year = 1991) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
lwr_aro_2003 <- gage_dv_raw %>%  
  filter(sta == "lwr_aro") %>%  
  filter(water_year == 2003) 

lwr_aro_2003 <- full_join(lwr_aro_2003 , wy_2003) 

lwr_aro_2003 <- lwr_aro_2003 %>%  
  mutate(sta = "lwr_aro") %>%   
  mutate(incomp_yr = "Y") %>%   
  mutate(water_year = 2003) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  

# 4. append and join data  
yr_dv_incomp <- bind_rows(bev_pri_1991, whi_slm_1991, lwr_aro_2003) 

gage_dv <- bind_rows(yr_dv_incomp, gage_dv_raw) %>%  
  distinct() %>%  
  group_by(sta, water_year) %>%                  
  mutate(days_yr = n()) %>%                   
  ungroup()   

# 4. remove short years  
gage_dv_incomp <-  gage_dv %>% 
  filter(days_yr < 365) 

gage_dv <- gage_dv %>% 
  filter(days_yr >= 365)  

# 5. check results  
gage_ck <- gage_dv %>%  
  filter(sta == "lwr_aro") %>%  
  filter(water_year == "2003") 

yr_sum <- gage_dv %>%                          
  group_by(sta, water_year) %>%                  
  summarise(days_yr = n()) %>%                    
  ungroup() 

# 6. clean up  
rm(bev_pri_1991, gage_dv_incomp, gage_dv_raw, lwr_aro_2003, whi_slm_1991, 
   wy_1991, wy_2003, yr_dv_incomp, yr_incomp, wkc_wok, gage_ck)  
``` 