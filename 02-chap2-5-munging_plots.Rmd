---
title: "02-chapt2-5_study-area"
author: "CJ Tinant"
date: "8/06/2019"
output: html_document 
---

<!--
Purpose: 
Refactors prior code to develop tables and plots for the study area description 
section of Chapter 2 

Data: 
 discuss

Approach: 
1) find possible gages by bounding box 
-- find all gages within a bounding box 
-- add the metadata, 

# bBox = a contiguous range of decimal latitude and longitude, starting with the west longitude, then the south latitude, then the east longitude, and then the north latitude with each value separated by a comma. 
# https://waterservices.usgs.gov/rest/Site-Service.html#bBox 
# the Pine Ridge Reservation boundary is c(-103, 43, -100.2, 43.8)

2) filter gages for the following reasons
     - upstream control, 
     - in crystaline or karst catchments
     - provisional data 

3) clean metadata by removing non-needed variables  

4) Load USGS gage data for active stations individually, bind_rows 

5) filter based on record length 
    - no data gages for 1990- 2018 water years 
      for filtering info see: https://help.waterdata.usgs.gov/site_tp_cd 
    - 

6) filter 
Next Steps: 
-- check into stylr-packag

Variable naming convention:   
# ~~~~~~~~~~~~~~~~~~~~~~~~~
gage_poss           possible USGS gaging stations in the study area 
gage_meta_poss      metadata for possible gaging stations
-- _int1            scratch df for pulling gages with integer fields 
-- _int2            scratch df for pulling gages with integer fields 
-- _char            scratch df for pulling gages with character fields 

gage_meta           cleaned metadata for USGS gaging stations in the study area 
  "site_no"                site number     
  "station_nm"             station name     
  "dec_lat_va"             latitude value in decimal degrees 
  "dec_long_va"            longitude value in decimal degrees 
  "state_cd"               State code
  "county_cd"              County code
  "alt_va"                 altitude 
  "huc_cd"                 hydrologic unit code 
  "drain_area_va"          drainage area ???in square miles???
  "contrib_drain_area_va"  contributing drainage area ???in square miles???

endDate             used for calling Egret::readNWISDaily 
parameter_cd        used for calling Egret::readNWISDaily 
startDate           used for calling Egret::readNWISDaily 

lon_riv_dv          scratch df for pulling lon_riv 
gage_most_dv        scratch df for pulling !lon_riv 
yrs_rec             calculates years of record 
gage_dv             daily flow values for waterYear 1980-2017 


--> 

```{r setup, include=FALSE, message=FALSE}  
#knitr::opts_chunk$set(echo = FALSE)   
options(tibble.print_max = 70) # sets tibble output for printing   

# Sets up the library of packages   
library("here")                   # identifies where to save work  
library("EGRET")                  # Exploration and Graphics for RivEr Trends 
library("rio")                    # more robust I/O - to import and clean data  
library("lubridate")              # easier dates 
library("janitor")                # tools for examining and cleaning dirty data  
library("dataRetrieval")          # USGS data import  
library("measurements") 
library("flextable")             # construct complex table with 'kable'  
library("tidyverse")              # data munging tools 
```

```{r import_daily_flow_metadata, eval=FALSE} 
gage_poss <- whatNWISsites(bBox = c(-103.8, 42.2, -99.2, 44.6), 
                       parameterCd = "00060",
                       hasDataTypeCd = "dv") %>% 
  arrange(site_no)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 2. get metadata 
# this needs to be run in parts because some project numbers & 
# inventories are stored as integers & others are stored as characters 

gage_meta_int1 <- gage_poss %>% 
    slice(7, 17, 142, 148) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_int2 <- gage_poss %>% 
    slice(94) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_char <- gage_poss %>% 
    slice(-c(7, 17, 94, 142, 148)) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# 3. join gage metadata & ??drop the partial sites?? 
gage_meta_poss <- bind_rows(gage_meta_int1, 
                            gage_meta_int2, 
                            gage_meta_char)  

# clean up
rm(gage_meta_int1, 
   gage_meta_int2, 
   gage_meta_char, 
   gage_poss) 

# 4. export metadata to data folder 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
export(gage_meta_poss, "data/gage_meta_poss.csv")  
```

```{r filter_clean_gage_meta}
gage_meta_poss <- import("data/gage_meta_poss.csv")  

# 1. remove gages that do not meet standards 
gage_meta <- gage_meta_poss %>%   
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8)) %>%              # pad site_no  
  mutate(reliability_cd = replace_na(reliability_cd, 0))  %>% #  NA <- zero 
  filter(site_no != "06461150"& 
         site_no != "06463670"& 
         site_no != "06461595") %>%  # remove short sites with provisional data 
  filter(site_no != "06441000") %>%  # only active 180 days/yr
  filter(site_no != "06438000") %>% 
  filter(site_no != "06437000") %>%  # remove northern Black Hills stations 
  filter(site_no != "06442718") %>%  # remove East River stations
  filter(reliability_cd != "M") %>% # M is minimal data 
  filter(!str_detect(station_nm, 'DAM|DITCH|DRAIN')) %>% # upstream control 
  filter(!str_detect(station_nm, 
                     'CUSTER|KEYSTONE|HILL CITY|HAYWARD')) %>% 
  filter(site_no != "06424000") %>% 
  # crystaline catchments 
  filter(!str_detect(station_nm, 
                     'LEAD|DEADWOOD|WHITEWOOD')) %>%   
  # crystaline catchments 
  filter(!str_detect(station_nm, 'CLEGHORN')) %>% # karstic? spring 
  filter(!str_detect(station_nm, 'BOXELDER|LIME')) %>% # karstic 
  filter(!str_detect(station_nm, 'RAPID')) %>%   
  # Rapid Creek & upper Spring Creek 
  filter(!str_detect(station_nm, 'MISSOURI'))

# 2. fix leading zero & remove provisional sites 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_meta <- gage_meta %>% 
  mutate(site_no = as.character(site_no)) %>% 
  select(-reliability_cd) %>% 
  mutate(length = str_length(site_no)) %>% 
  filter(length <= 8) %>%   # removes two provisional sites

  select(-length)

# 3. remove codes not needed for this project 
gage_meta <- gage_meta %>% 
  select(-agency_cd) %>% 
  select(-site_tp_cd) %>% # all streams so delete 
  select(-c(lat_va, long_va)) %>% # in DMS so delete 
  select(-c(coord_meth_cd, coord_acy_cd)) %>% # coord method & agency, so delete 
  select(-c(coord_datum_cd, dec_coord_datum_cd)) %>% # NAD83 or NAD27 
  select(-c(district_cd, country_cd)) %>% # Congressional dist & Country 
  select(-c(land_net_ds, map_nm, map_scale_fc)) %>%  # refers to USGS maps 
  select(-c(alt_meth_cd, alt_datum_cd, alt_acy_va)) %>% #%>% # altitude metadata  
  select(-c(basin_cd, topo_cd, instruments_cd)) %>% 
  select(-c(construction_dt)) %>% 
  select(-c(tz_cd, local_time_fg)) %>% # daily data, so NA 
  select(-c(gw_file_cd, nat_aqfr_cd, aqfr_type_cd, aqfr_cd)) %>% 
  # aquifer data, so NA 
  select(-c(well_depth_va, hole_depth_va, depth_src_cd)) 


```

```{r import_daily_flow} 

# set parameters for Egret::readNWISDaily 
startDate    <- "1979-10-01" # note that blank gets earliest date 
endDate      <- "2018-09-30" 
parameter_cd <- "00060" 

# get daily flows ------------------------------------------------------------ 
# Long River gage needs to be called separately or it creates an error 
lon_riv_dv <- gage_meta %>% 
  filter(site_no == "06463500") %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISDaily(
    siteNumber = .$site_no, 
    parameter_cd, 
    startDate, 
    endDate), 
    .id = "site_no") 

gage_most_dv <- gage_meta %>% 
  filter(site_no != "06463500") %>%           # drop long river from call
  split(.$site_no) %>% 
  map_dfr(~ readNWISDaily(
    siteNumber = .$site_no, 
    parameter_cd, 
    startDate, 
    endDate), 
    .id = "site_no") 

# join into a single dataframe & clean up 
gage_dv <-bind_rows(gage_most_dv, lon_riv_dv) 

rm(startDate, endDate, parameter_cd)
``` 

```{r clean_daily_flow_metadata, eval=FALSE}

# 1. filter gages with short flow records--------------------------------------
# filter gages without flow data for the period of record 
gage_id <- gage_dv %>% 
  select(site_no) %>% 
  distinct() 

gage_meta <- semi_join(gage_meta, gage_id, 
                       by = "site_no")

rm(gage_id)

# calculate min & max years of record 
yrs_summary <- gage_dv %>% 
  group_by(site_no) %>%                  
  summarise(years_rec = n_distinct(waterYear), 
            min_year = min(waterYear), 
            max_year = max(waterYear),
            ) %>%                    
  ungroup() %>% 
  mutate(apparent_yrs = 1 + max_year - min_year) 

#  drop stations with less than 6 years of record  
gage_meta <- full_join(yrs_summary, gage_meta,  
                       by = "site_no") 

gage_meta <- gage_meta %>% 
  filter(years_rec >= 6) 

# 2. check for incomplete days of record & years of record --------------------  
yr_incomp <- gage_dv %>%                          
  group_by(site_no, waterYear) %>%                  
  summarise(days_yr = n()) %>%                    
  ungroup() %>% 
  filter(days_yr < 360) %>% 
  group_by(site_no) %>%   
  summarise(yrs_incomp = n()) %>%    
  ungroup() 
  
gage_meta <- full_join(yr_incomp, gage_meta,  
                       by = "site_no") 

gage_meta <- gage_meta %>% 
  mutate(yrs_incomp = replace_na(yrs_incomp, 0)) %>% 
  mutate(yrs_comp = years_rec - yrs_incomp) 

# 3. remove data with short record between 1990-2017 ------------------------- 
## These didn't make the cut because the original data selection was 
# for 1990-2017  & it would be extremely difficult to put in post-hoc.
# it would be good for the future! 

# station   min_yr  maxyr  name 
# 06459175   1982   1995   SNAKE R AT DOUGHBOY, NE
# 06459500   1980   1995   SNAKE RIVER NEAR BURGE, NEBR. 
# 06454100   1980   1992   Niobrara River at Agate, Nebr. 
# 06461000   1980   1995   MINNECHADUZA CREEK AT VALENTINE, NEBR.
# 06462500   1980   1995   PLUM CREEK AT MEADVILLE, NE
# 06400497   1980   1995   CASCADE SPRINGS NEAR HOT SPRINGS SD
# 06463720   2012   2018   Niobrara River at Mariaville, Nebr.

short_rec <- tibble(
  site_no = c("06459175", "06459500", "06454100", "06461000", 
              "06462500", "06400497", "06463720")
  ) 

gage_meta <- anti_join(gage_meta, short_rec, 
                       by = "site_no") %>% 
  filter(site_no != "06441000") # Bad River at Midland only partial data 

rm(short_rec, yr_incomp, yrs_summary, gage_meta_poss) 
```

```{r prepare_table_metadata}

# prepare df for gaging station metadata 
gage_table <- gage_meta %>% 
  mutate(contrib_drain_area_va = 
           coalesce(contrib_drain_area_va, drain_area_va)
  ) %>% 
  mutate(alt_si = 
           conv_unit(alt_va, "ft", "m")
         ) %>% 
  mutate(contrib_drain_area_si = 
           conv_unit(contrib_drain_area_va, "mi2", "km2")
         ) 


gage_table$years_rec <-  as.integer(gage_table$years_rec) 

gage_table <- gage_table %>% 
select(site_no, station_nm, dec_lat_va, dec_long_va, alt_si, years_rec, 
         contrib_drain_area_si) 

```










```{r make_docx-file_for_export} 

# create a flextable objects  
col_key_nm <-gage_table %>% 
  select(dec_lat_va:alt_si, contrib_drain_area_si) %>% 
  names() 

col_key_int <-gage_table %>% 
  select(years_rec, site_no) %>% 
  names() 

tabl_meta <- flextable(gage_table) %>% 
  colformat_num(col_keys = col_key_nm, 
                big.mark=",", 
                digits = 1, na_str = "N/A") %>% 
  set_header_labels(site_no = "Sta. Number", 
                    station_nm = "Name", 
                    dec_lat_va = "Latitude", 
                    dec_long_va = "Longitude", 
                    alt_si = "Altitude, m",
                    years_rec = "Years of Record", 
                    contrib_drain_area_si = "Drainage Area, sq-km") %>% 
  autofit() %>% 
  theme_booktabs() 

sht_sta_doc <- read_docx() %>% 
  body_add_flextable(value = tabl_meta) 

print(sht_sta_doc, target = "output/example1.docx") 

fileout <- tempfile(fileext = ".docx")
# fileout <- "test.docx" # uncomment to write in your working directory
print(doc, target = fileout)

library(officer)
my_doc <- read_docx() 



my_doc <- my_doc %>% 
#  body_add_img(src = src, width = 5, height = 6, style = "centered") %>% 
#  body_add_par("Hello world!", style = "Normal") %>% 
#  body_add_par("", style = "Normal") %>% # blank paragraph
  body_add_table(tabl_meta, style = "table_template") 
styles_info(my_doc) 

print(my_doc, target = "output/example.docx")
```














# 3. fill the station-years with missing data  
wy_1991 <- tibble(date = seq.Date(from=as.Date("1990-10-01"),  
                 to=as.Date("1991-09-30"), by="day")) 

wy_2003 <- tibble(date = seq.Date(from=as.Date("2002-10-01"),  
                 to=as.Date("2003-09-30"), by="day")) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
bev_pri_1991 <- gage_dv_raw %>%  
  filter(sta == "bev_pri") %>%  
  filter(water_year == 1991) 

bev_pri_1991 <- full_join(bev_pri_1991, wy_1991) 

bev_pri_1991 <- bev_pri_1991 %>%  
  mutate(sta = "bev_pri") %>%  
  mutate(incomp_yr = "Y") %>%  
  mutate(water_year = 1991) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
whi_slm_1991 <- gage_dv_raw %>%  
  filter(sta == "whi_slm") %>%  
  filter(water_year == 1991) 

whi_slm_1991 <- full_join(whi_slm_1991, wy_1991) 

whi_slm_1991 <- whi_slm_1991 %>%  
  mutate(sta = "whi_slm") %>%  
  mutate(incomp_yr = "Y") %>%  
  mutate(water_year = 1991) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
lwr_aro_2003 <- gage_dv_raw %>%  
  filter(sta == "lwr_aro") %>%  
  filter(water_year == 2003) 

lwr_aro_2003 <- full_join(lwr_aro_2003 , wy_2003) 

lwr_aro_2003 <- lwr_aro_2003 %>%  
  mutate(sta = "lwr_aro") %>%   
  mutate(incomp_yr = "Y") %>%   
  mutate(water_year = 2003) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  

# 4. append and join data  
yr_dv_incomp <- bind_rows(bev_pri_1991, whi_slm_1991, lwr_aro_2003) 

gage_dv <- bind_rows(yr_dv_incomp, gage_dv_raw) %>%  
  distinct() %>%  
  group_by(sta, water_year) %>%                  
  mutate(days_yr = n()) %>%                   
  ungroup()   

# 4. remove short years  
gage_dv_incomp <-  gage_dv %>% 
  filter(days_yr < 365) 

gage_dv <- gage_dv %>% 
  filter(days_yr >= 365)  

# 5. check results  
gage_ck <- gage_dv %>%  
  filter(sta == "lwr_aro") %>%  
  filter(water_year == "2003") 

yr_sum <- gage_dv %>%                          
  group_by(sta, water_year) %>%                  
  summarise(days_yr = n()) %>%                    
  ungroup() 

# 6. clean up  
rm(bev_pri_1991, gage_dv_incomp, gage_dv_raw, lwr_aro_2003, whi_slm_1991, 
   wy_1991, wy_2003, yr_dv_incomp, yr_incomp, wkc_wok, gage_ck)  
``` 