---
output: html_document
editor_options: 
  chunk_output_type: console
---


<!--  
These are some useful thoughts:    
 check into stylr-packag

lmomco <- citation("lmomco") 
a useful description of commits -- http://r-pkgs.had.co.nz/git.html  

# Some shortcuts in a code chunk styling format----  
# key-bindings====     
# insert operators####    
# pipe operator        %>% 	      Cmd+Shift+M
# assignment operator  <-    	    Option+-  

# Code chunks====  
# collapse                        Cmd+Option+L
# expand                          Cmd+Shift+Option+L
# collapse all                    Cmd+Option+O
# expand all                      Cmd+Shift+Option+O

# Navigation====
# insert section                 Cmd+Shift+R 
# jump to                        Shift+Alt+J

Exploratory Data Analysis Checklist by Roger Peng 
https://leanpub.com/exdata  

1.0   Formulate your question  
2.0   Read in your data  
3.0   Check the dataset 
3.1   Check the number of rows and columns.
3.2   Check the types of data
3.3   Look at the top and the bottom of your data 
3.4   Check your “n”s & NAs 
3.5   Validate with at least one external data source  
4.0   Try the easy solution first to answer question
5.0   Challenge your solution 
6.0  Follow up questions 
-->  

<!-- 
Purpose:  
This R markdown file calculates SCI 
Standardized precipitation index - SPI  
Streamflow runoff index - SRI  

Analysis steps 
1.0)  sets up the library and settings 

2.0)  downloads precipitation daily data and metadata (sta_orig); 
2.1)    creates groups by location;   
2.2)    creates short names;  
2.3)    downloads daily data for original stations (30-years);  
2.4)    removes incomplete years (sta_plus)  
2.5)    defines the final stations  (sta_fin)

3.0)  plot study area map;  
3.1)    prepare map elements: Theissen line segments, stream gages, location  
        data: states, counties, USA map-grob

4.0)  check data flags  
-- identified & filled NA
2.0)  convert daily precip to monthly precip  
2.1)  Updated unit vals - originally in tenths of mm; now in mm 
3.0)  Created plots 

Data:
Predominant datasets used are:  
1) NOAA data from NOAA GHCN database - 60-years (1959-2019)
2) USGS daily streamflow and station metadata,  
3) 

3)  prepare data for drought index 

1. Recreated analysis from the lmomco text ch 12 (author?) in Tidyverse
2. Imported cleaned precipitation data (see 04_prcp-data_munging)   

5. Applied Weibull plotting position and graphed the data on sqrt plot
6. Calculated L-moments and L-moment ratios 
7. Calculated SPI for 'cot', 'oel', 'rap', 'int', and 'ora' datasets using Pearson III. 

3. Applied sqrt & log10 transform to explore effects on skew 
4. Explored the data with box plots, violin plot.

####3) Summary data from a QGIS analysis of ungaged watersheds of interest.  

## Results: Fits a PE3 distribution
The results from the precipitation analysis indicate: 1) an annual trend of increasing aridity across the project area that trends from northwest to southeast that may be a result of the Black Hills rainshadow, 2) the 1900s were the wettest time in regions recorded history.  ??? what about the seasonal trend?  

Variable naming convention----  
a_session    list variable of session information  

precipitation and spi variables====  
dateMin       minimum date for downloading data   
dateMax       maximum date for downloading data  
sta           NOAA weather station locations  
  _dv         daily values  
  _meta       metadata  
  _orig       all stations (n = 46 sations)  
  _plus       potential stations (n = 14 stations)  
  _fin        final dvs used in the analysis   
  _mon        monthly precipitation depths (60-years)  
  _pres       monthly precipitation depths (30-years)  

daily value check & fill variables==== 
sta  
  _check       used to summarize station flags
  _alt         alternate station dv data for filling missing values 
  _fil         station to be filled 
  _miss_day    checks for missing days 
  _short_name  adds a short name for the station to be filled
  _rap         Rapid City Regional Airport station (NW)  
  _cot         Cottonwood station (NC)  
  _oni         Onida station (NE)   
  _ora         Oral station (SW)   
  _gor         Gordon staion (SC)   
  _mis         Mission station (SE)  

L-moment variables====  
lmom          L-moments  
  _sta        L-moments for stations
  _nm        station name
lmrdia       list of L-moment distributions 
gev          Generalized Extreme Value Distribution
glo          Generalized Logistic Distribution
gpa          Generalized Pareto Distribution
gno          Generalized Logistic Distribution 
gov          Govindarajulu Distribution
pe3          Pearson Type III Distribution  
L1           first L-moment, similiar to mean
L_CV         first L-moment ratio, similiar to coefficient of var
L_skew       second L-moment ratio, similiar to skewness 
L_kurtosis   third L-moment ratio, similiar to kurtosis
n            number of months in a given record

dischord     the Hosking and Wallis discordancy of the first three L-moment 
             ratios according to their implementation in Hosking and Wallis 
             (1997) and earlier. Discordancy triplets of these L-moment ratios 
             is heuristically measured by locating the triplet from the mean
             center of the 3-dim. cloud of values. 
  $Dmax	     The maximum discordancy D_{max} = (n-1)/3.
  $Dalpha1   The critical value of D for α_1 = 0.10 (default) 
  $Dalpha2	 The critical value of D for α_2 = 0.01 (default) 
  $Dcrit	   The critical value of discordancy (user or tabled).
  $D	       The discordancy of the L-moment ratios used to trigger isD	
  $isD       Are the L-moment ratios discordant (if starred) 
  $signif	   A hyphen, star, or double star based on Dalpha1 and Dalpha2 vals.

# SCI calculation variables----   
spi           Standardized Precipitation Index vals from NOAA precip data  
sri           Standardized Runoff Index vals from USGS streamflow gage data  
sci           Generalized variable for SPI and SRI calculations  
  _1mo        One    month duration                           
  _2mo        Two    month duration                             
  _3mo        Three  month duration                           
  _4mo        Four   month duration  
  _6mo        Six    month duration  
  _9mo        Nine   month duration   
  _12mo       Twelve month duration  

_freq       frequency of periodicity -- used in seasonality calculations  
_trend      trend of periodicity -- used in seasonality calculations  

# individual station variables for SRI====  
bhp_         Black Hills Plateau  
  _bat       Battle Creek above Hermosa  
  _bev       Beaver Creek  
  _fal       Fall River  
  _frn       French Creek  
kpt_         Keya Paha Tablelands  
  _key       Keya Paha River at Keya Paha   
  _wew       Keya Paha River at Wewila  
psp_         Pierre Shale Plains  
  _bat       Battle Creek below Hermosa   
  _brs       South Fork of the Bad River   
  _che       Cheyenne River at Wa??   
  _elk       Elk Creek at Elm Springs   
  _hat       Hat Creek at Edgemont  
  _whi       White River at Oacoma 
pre_         Pine Ridge Escarpment  
  _ogl       White River at Oglala  
  _sta       White River at Stateline 
snd_         Sand Hills  
  _lcr       Lake Creek below Refuge?
  _lon       Long River   
  _mar       Little White River at Martin  
  _ros       Little White River at Rosebud   
  _vet       Little White River at Vetal     
  _whi       Little White River at White River   
  _nio       Niobrera River at SPA??
whi_         White River Badlands  
  _kad       White River at Kadoka
    _v       as a double vector  

gage          USGS streamgage station  

'site' is a variable for OST monitoring stations 

## Broad questions:
What is the drought history of the Pine Ridge Reservation?  
Does the drought extent differ across the study area?

## Narrower question:
What is the underlying distribution of precipitation data?  

# Next STEPS  
1. update bootstrapping to check precip differences - with water year  
Also check these -- 
this needs to be raw data -because the old data missing some dates 
Also need to drop the Hot Springs creek 
Fixing the 02_streamflow_cleaning.Rmd

3. Describe the precipitation seasonality ??

-->  

```{r setup_&_library, message=FALSE}    
  
knitr::opts_chunk$set(echo = FALSE)      
options(tibble.print_max = 70) # sets tibble output for printing          
   
# increase memory allocation for dabest()   
# usethis::edit_r_environ("project")   
  
# Get API key (aka, token) for downloading precip data at   http://www.ncdc.noaa.gov/cdo-web/token  
# token for NOAA API tied to jtinant@olc.edu -- see 'rnoaa' for details  
options(noaakey = "VpcuARumMpCfFyclKHPfvskEYnaiLJHD")  
   
# Sets up the library of packages   
library("conflicted")        # An alternative conflict resolution strategy  
library("here")              # identifies where to save work  
library("rnoaa")             # R wrapper for NOAA data inc. NCDC  
library("rio")           # more robust I/O - to import and clean data  
library("lubridate")     # easier dates   
library("lmomco")        # lmoments to find distribution   
library('deldir')        # for Vorononi tesselation - Theissen polygons  
library("SCI")           # calculates SPI & RDI   
library("forecast")      # using the BoxCox function   
library("broom")         # tidies linear models   
library("ggbeeswarm")    # plot 1D data as a violin / beeswarm plot  
library("scales")        # graphical scales map data to aesthetics,  
                         #   & methods for determining breaks and labels  
                         #   for axes and legends   
library("mclust")        # model-based clustering & density estimation  
library("anomalize")     # detect anomalies using the tidyverse   
library("dabestr")       # data analysis using bootstrap estimation    
library("cowplot")       # multiple plots with plot_grid()  
library("timetk")        # tool kit for working with time series in R   
library("tidyquant")     # integrate quant. analysis tools w/ tidyverse  
library("corrr")         # Tidy correlation tables and correlation plotting  
#library("cranlogs")      # For inspecting package downloads over time  
# for GLMs                    
library("doMC")          # parallelization for caret  
library("caret")         # classification and regression training 
library("glmnet")        # fit a GLM with lasso or elasticnet regularization 
library("Metrics")       # evaluation metrics for machine learning  
library("flextable")     # functions for tabular reporting  
library("officer")       # facilitates '.docx' access for table export  
library("patchwork")     # the 'composer of plots'  
library("tidyverse")  
  
# resolve conflicted packages----  
conflict_prefer("filter", "dplyr")  
conflict_prefer("select", "dplyr")  
conflict_prefer("as.dist", "stats")  
conflict_prefer("first", "dplyr")  
conflict_prefer("map", "purrr")  
conflict_prefer("lag", "dplyr")  
 
# used in time series clustering example--
#library(gridExtra)           # merge plots  
#library(ggdendro)            # dendrograms
#library(gplots)              # heatmap
#library(tseries)             # bootstrap
#library(TSclust)             # cluster time series
#library(dtwclust)            # cluster time series with dynamic time warping    
# other packages I have thought about ---------------------------------------  
# library("ggfortify")        # data vis tools for statistical analysis  
# library("ggpubr")           # some easy ggplot wrappers for publication ready 
#                             #   'ggplot2'- based plots  
  
# library("standardize")      # tools for controlling continuous variable   
#  scaling and factor contrasts for linear models   
# library("pdftools")         # utilities for extracting text, fonts,  
#   attachments and metadata from a pdf file.  
  
# Spatial data====  
#library("biogeo")            # Functions for error detection & correction  
#   in point-data datasets; includes functions   
#   to parse & convert coords to decimal-degrees  
#library("maps")              # Outlines of continents, countries, states &  
#   counties  
#library("mapdata")           # higher-resolution outlines  
#library('ggmap')             # Spatial visualization with ggplot2   
#library("sf")                # Simple features--spatial geometries for R  
#library("RColorBrewer")      # Provides color schemes for maps -- see  
#   http://colorbrewer2.org  
  
# Colors====  
#library("colorspace")        # Manipulate & assess colors & palettes  
#library("munsell")           # Access & manipulate munsell system colours  
#   https://github.com/cwickham/munsell  
  
# working with lists and urls====  
#library("jsonlite")          # Convert between JSON data and R objects  
#library("curl")              # Drop-in replacement for base url  
#library("listviewer")        # htmlwidget for interactive views of R lists  
#library("forecast")         # for BoxCox.lambda   
#library("magrittr") # provides aliases for easier reading  
#library("workflowr") # creates a research website  
#library("bookdown") #  
#library(unpivotr) # fix nasty Excel files  
#library("friendlyeval")  
#library("mathpix")                # support for 'Mathpix' image to 'LaTeX'    
#library("grateful") - not yet ready for R 3.5.0  
#lmomco <- citation("lmomco")  
#toBibtex(lmomco)  
  
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
why_to_write <- function()   
{today <- today(tzone = "")  
paper2 <- ymd("2020-01-10")  
until <- paper2 - today  
print(paste("You have", until, "days until the second paper is due"  
))   
}   
why_to_write()  
  
```  

```{r 1_import_hydrologic-data}    

# 1 import streamflow & precipitation records====   
#   min gage is 1979-10-15  
#   max gage is 2018-09-15  
gage_mon <- import("data/gage_mon_full.csv") %>%  # this is just >30-yr gages  
  mutate(Date = ymd(Date))  

# 2 reduce lengths for the 30-year analysis====  
gage_mon_sri <- gage_mon %>%  
  filter(between(Date,  
                 as.Date("1988-10-15"),  
                 as.Date("2018-09-15")))  

# * create some data checks====  
gage_check <- gage_mon_sri %>%  
  group_by(sta) %>%  
  summarise(min = min(Date),  
            max = max(Date)  
  )  

gage_full <- gage_mon_sri %>%  
  select(sta) %>%  
  distinct()  

# 3 add flow regime to the 30-year timeframe====  
flow_regime <-  import("data/gage_meta.csv") %>%  
  select(sta,  
         flow_regime)  

flow_regime <- semi_join(flow_regime, gage_full,  
                         by = "sta")  

# * join flow regime to streamflow data  
gage_mon_sri <- full_join(gage_mon_sri, flow_regime,   
                          by = "sta")  

# * check results by printing a summary of the data====  
gage_mon_sri %>%   
  group_by(sta) %>%   
  summarise(count = n()) %>%   
  ungroup() %>%   
  mutate(num_yr = count/12)  

# 4 summarise gage ecoregion & flow regime====  
gage_summary <- gage_mon_sri %>%  
  select(sta, ecoreg, flow_regime) %>%   
  distinct()  

# 5 import monthly precip data & prepare for bootstrapping====   
# Dates are based on water year instead of calender year  
#   min sta1 is 1958-10-15  
#   max sta1 is 1988-09-15  
#   min sta2 is 1988-10-15  
#   max sta2 is 2018-09-15    
sta_meta_fin <- import("data/sta_meta_fin.csv")  

sta_mon_full <- import("data/sta_mon.csv") %>%  
  mutate(date = ymd(date)) %>%   
  mutate(yr = year(date))  %>%  
  arrange(desc(date)) %>%      # slice 2018 obs for 10-15 to 12-15  
  slice(-1:-6) %>%  
  # create an id variable  
  mutate(Period = case_when(   
    date < "1988-10-15" ~ "<1989",  
    TRUE ~ ">1989")  
  ) %>%  
  # create a grouping variable   
  unite("group",   
        c("sta", "Period"),  
        sep = "",   
        remove = FALSE) %>%   
  arrange(date)   

# * check results by printing a summary of the data====  
sta_mon_full %>%   
  group_by(group) %>%   
  summarise(count = n()) %>%   
  ungroup() %>%   
  mutate(num_yr = count/12)  

# 6 clean up global environment====  
rm(flow_regime,  
   gage_check,  
   gage_full,  
   gage_mon)  

# 7 prepare for SCI below====  
# * the bootstrapping showed there is some difference between past & present   
sta_pres <- sta_mon_full %>%  
  as_tibble() %>%  
  filter(Period == ">1989") %>%  
  select(-c(group, Period)) %>%  
  mutate(mon = month(date)) %>%  
  mutate(location = case_when(   
    sta == "COT" ~ "NC",  
    sta == "GOR" ~ "SC",  
    sta == "MIS" ~ "SE",  
    sta == "OEL" ~ "SW",  
    sta == "ONI" ~ "NE",  
    sta == "RAP" ~ "NW"))  

```

# use bootstrapping to check precip differences 
# NEED TO REDO with water years!
```{r 2_bootstrap_precip, eval=FALSE}   

# Construct bootstrap confidence intervals of precipitation----    
#   to identify differences in means   
# Monthly precipitation data is from 1954 to 2018 = 65 years  
#   Split data into two groups of 30 years & test for differences  

# Notes on dabest and memory -- see setup for how to increase memory  
# dabest for 14,027 obs; 40,000 reps takes ~2 hours.    
#   Still had memory allocation issues @ 50,000 reps after increasing memory.   


# construct bootstrap confidence interval of prcp====   
prcp_dabest <- sta_mon %>%   
  dabest(x = group,             # grouping variable  
         y = prcp,              # measurement variable   
         # list order shows control as first group on the list   
         idx = list(c("RAP<1989",  
                      "OEL<1989",  
                      "COT<1989",  
                      "GOR<1989",  
                      "ONI<1989",  
                      "MIS<1989"),   
                    c("RAP>1989",  
                      "OEL>1989",  
                      "COT>1989",   
                      "GOR>1989",  
                      "ONI>1989",  
                      "MIS>1989")  
         ),                   
         paired    = TRUE,  
         reps      = 20000,  
         id.column = group   
  )  

# plot the dabest bootstrap====   
plot(prcp_dabest,  
     color.column = Period,  
     tick.fontsize = 5,  
     rawplot.type = "sinaplot",  
     axes.title.fontsize = 9,  
     rawplot.ylabel = "Monthly precipitation (mm)",  
     rawplot.groupwidth = 0.3,  
     palette = "Greys")  

# save results====   
ggplot2::ggsave(filename = "figure/prcp_dif.png",   
                width = 6.5, height = 4.5, units = "in")  

rm(prcp_dabest,  
   sta_mon  
)      

```

```{r 3_plot_monthly_precip}  

# * set plotting order====  
sta_pres$location <-  factor(sta_pres$location,  
                             levels = c("NW", "NC", "NE", "SW", "SC", "SE"))  

# 2 plot annual precips====  
sta_pres %>%  
  ggplot(aes(mon, prcp)) +  
  # set up theme and facets  
  theme_bw() +   
  facet_grid(rows =vars(location)) +  
  # set up labels  
  labs(title = "Annual precipitation depths",  
       subtitle = "water years 1989-2018",  
       x = "",  
       y = "mm") +  
  scale_x_continuous(breaks = 1:12,   
                     labels = c("J", "F", "M", "A", "M", "J",  
                                "J", "A", "S", "O", "N", "D")) +  
  geom_quasirandom(size = 0.2,  
                   position = position_beeswarm())  

# export results and clean up global enviroment  
ggsave(filename = "figure/prcp_mon.png",   
       width = 6.5, height = 4.5, units = "in")  

```

```{r 4_compare_precip-locations, eval=FALSE}  

#sta_mon <- import("data/sta_mon.csv") %>%    
#mutate(date = ymd(date))  

# comparison of locations----   
# split out northwest & southeast to prepare for plot    
nw <- sta_pres %>%  
  filter(sta == "COT" |  
           sta == "RAP" |  
           sta == "OEL") %>%  
  select(sta, date, prcp) %>%  
  mutate(prcp = prcp + 1) %>%  
  spread(sta, prcp) %>%   
  gather(other, prcp, -c(date, COT)) %>%  
  mutate(location = "COT") %>%  
  rename(control = COT)   

se <- sta_pres %>%  
  filter(sta == "GOR" |  
           sta == "ONI" |  
           sta == "MIS") %>%  
  select(sta, date, prcp) %>%  
  mutate(prcp = prcp + 1) %>%  
  spread(sta, prcp) %>%   
  gather(other, prcp, -c(date, GOR)) %>%  
  mutate(location = "GOR")  %>%  
  rename(control = GOR)  

# join splits & create factor     
prcp_compare <- bind_rows(nw, se) %>%  
  mutate(diff = control - prcp) %>%    
  mutate(other = fct_relevel(other,  
                             "RAP",  
                             "OEL",  
                             "ONI",  
                             "MIS"  
  ))  

# plot location differences  
prcp_compare %>%   
  ggplot(aes(date, diff)) +  
  theme_bw() +  
  xlab("") +  
  ylab("Monthly precipitation difference (mm)") +  
  facet_grid(cols    = vars(location),  
             rows    = vars(other)) +  
  geom_line(color    = "gray60") +  
  geom_smooth(method = "lm",  
              color  = "gray30",  
              size   = 0.5  
  )  

ggplot2::ggsave(filename = "figure/prcp_loc_dif.png",   
                width = 6.5, height = 4.5, units = "in")  

rm(nw,  
   se,  
   prcp_compare, 
   sta_mon,  
   sta_pres  
)  

```

# L-moments 
```{r 5_lmoment-ratios_streamflow}

# 1 calculate L-moment ratios====     
# Note -- we might consider Weiss 1964 bias value of 1.018 for L1  
lmom_gage <- gage_mon_sri %>%  
  split(.$sta) %>%  
  map(~ lmoms(.$log_q1_mon)) %>%    
  transpose() %>%  
  as_tibble(rownames = sta) %>%  
  select(lambdas, ratios) %>%  
  mutate(lambdas = map(lambdas,   
                       ~as_tibble(t(.x)) )) %>%  
  mutate(lambdas = map(lambdas,   
                       ~set_names(.x,  
                                  c("L1", "L2", "L3", "L4", "L5")  
                       ))) %>%  
  mutate(ratios = map(ratios,  
                      ~as_tibble(t(.x)))) %>%  
  mutate(ratios = map(ratios,  
                      ~set_names(.x,  
                                 c("T1", "T2", "T3", "T4", "T5")   
                      ))) %>%  
  unnest(lambdas) %>%  
  unnest(ratios)  %>%   
  select(-T1) %>%  
  rename(L_CV = T2) %>%  
  rename(L_skew = T3) %>%  
  rename(L_kurtosis = T4) %>%  
  select(L1, L_CV, L_skew, L_kurtosis) %>%  
  mutate(L1 = round(L1,  
                    digits = 2))  

# 2 get station names from the list====  
lmom_gage_list <- gage_mon_sri %>%  
  split(.$sta) %>%  
  map(~ lmoms(.$log_q1_mon)) %>%  
  transpose()  

lmom_gage_nm <- lmom_gage_list %>%  
  pluck(2) %>%                     # plucks lmom-ratios  
  enframe()  

lmom_gage_nm <- lmom_gage_nm %>%  
  unnest(value) %>%  
  drop_na() %>%  
  rename(sta = name) %>%  
  group_by(sta) %>%  
  summarize(L_CV = first(value))  

# 3 join name to lmom vals & to the metadata====  
lmom_gage <- full_join(lmom_gage_nm, lmom_gage,  
                       by = ("L_CV"))  

# 4 clean up lmom_gage & join with metadata====  
lmom_gage <- lmom_gage %>%  
  gather(type, value, -sta) %>%  
  mutate(value = round(value,  
                       digits = 2)) %>%   
  spread(type, value) %>%  
  select(sta, L1, L_CV, L_skew, L_kurtosis)  

lmom_gage <- full_join(gage_summary, lmom_gage,   
                       by = "sta")  

# 5 check for discordant gages====    
dischord <- lmrdiscord(site = lmom_gage$sta,  
                       #                       Dcrit = 2.5,  
                       digits = 2,  
                       t2 = lmom_gage$L_CV,  
                       t3 = lmom_gage$L_skew,   
                       t4 = lmom_gage$L_kurtosis  
) %>%  
  mutate(site = as.character(site)) %>%  
  rename(sta = site) %>%  
  rename(L_CV = t2) %>%  
  rename(L_skew = t3) %>%  
  rename(L_kurtosis = t4)  

# 6 join all of the lmom data====  
lmom_gage <- full_join(lmom_gage, dischord, 
                       by = c("sta", "L_CV", "L_skew", 'L_kurtosis'))  

# 7 clean up global enviroment====   
rm(lmom_gage_list,  
   lmom_gage_nm,  
   dischord, 
   gage_summary)   

# 7. export results====  
export(lmom_gage, "data/gage_meta_lmom.csv")   

```

```{r 6_lmoment-ratios_prcp}

# 1 calculate L-moment ratios for precip stations====   
lmom_sta <- sta_mon_full %>%   
  split(.$sta) %>%  
  map(~ lmoms(.$prcp)) %>%    
  transpose() %>%  
  as_tibble() %>%  
  select(lambdas, ratios) %>%  
  mutate(lambdas = map(lambdas,   
                       ~as_tibble(t(.x)))) %>%   
  mutate(lambdas = map(lambdas,    
                       ~set_names(.x,   
                                  c("L1", "L2", "L3", "L4", "L5")  
                       ))) %>%   
  mutate(ratios = map(ratios,   
                      ~as_tibble(t(.x)    
                      )   
  )) %>%  
  mutate(ratios = map(ratios,  
                      ~set_names(.x,  
                                 c("T1", "T2", "T3", "T4", "T5")   
                      )   
  )) %>%  
  unnest(lambdas) %>%  
  unnest(ratios)  %>%   
  select(-T1) %>%  
  rename(L_CV = T2) %>%  
  rename(L_skew = T3) %>%  
  rename(L_kurtosis = T4) %>%  
  select(L1, L_CV, L_skew, L_kurtosis) %>%  
  mutate(L1 = round(L1,  
                    digits = 2))  

# 2 get station names from the list====  
lmom_sta_nm <- sta_mon_full %>%  
  split(.$sta) %>%  
  map(~ lmoms(.$prcp)) %>%  
  transpose()  

lmom_sta_nm <- lmom_sta_nm %>%  
  pluck(1) %>%  
  enframe()  

lmom_sta_nm <- lmom_sta_nm %>%  
  unnest(value)  

lmom_sta_nm <- lmom_sta_nm %>%  
  group_by(name) %>%  
  summarize(L1 = first(value)) %>%  
  ungroup() %>%  
  mutate(L1 = round(L1,  
                    digits = 2))  

# 3 join name to lmom vals & to the metadata  
lmom_sta <- full_join(lmom_sta_nm, lmom_sta,  
                      by = "L1") %>%  
  rename(sta = name) %>%  
  mutate(L_CV = round(L_CV,  
                      digits = 2)  
  ) %>%  
  mutate(L_skew = round(L_skew,  
                        digits = 2)  
  ) %>%  
  mutate(L_kurtosis = round(L_kurtosis,  
                            digits = 2)  
  )  

lmom_sta <- full_join(sta_meta_fin, lmom_sta,   
                      by = "sta")   

# 4 clean up global environment====  
rm(sta_meta_fin,   
   lmom_sta_nm)   

# 5 export results====  
export(lmom_sta, "data/sta_meta_lmom.csv")  

```

```{r 7_prepare_Lmoment_diagram_ratios}  

# extract elements from the lmrdia list to plot in ggplot2====          
#   the x-value is the L-skewness and y-value is L-kurtosis    

# 1. get vals from the lmrdia list====   
# note that as gamma distribution is a 2-parameter dist, it is not shown    
lmrdia <- lmrdia()   

# * extract L-skew & L-kurtosis values for several distributions====   
#   note:  aep4 <- lmrdia %>% extract2(2) %>% as.tibble()    

gev <- lmrdia[[5]] %>%  
  as_tibble() %>%  
  mutate(distribution = "GEV")   # Generalized Extreme Value distribution  

glo <- lmrdia[[6]] %>%   
  as_tibble() %>%          
  mutate(distribution = "GLO")   # Generalized Logistic distribution 

gpa <- lmrdia[[7]] %>%   
  as_tibble() %>%         
  mutate(distribution = "GPA")   #  Generalized Pareto distribution  

gno <- lmrdia[[9]] %>%   
  as_tibble() %>%      
  mutate(distribution = "GNO")   #  Generalized Normal distribution      

gov <- lmrdia[[10]] %>%    
  as_tibble() %>%     
  mutate(distribution = "GOV")   #  Govindarajulu distribution  
pe3 <- lmrdia[[12]] %>%   
  as_tibble() %>%         
  mutate(distribution = "PE3")   #  Pearson Type III distribution  

# 2. create a dataframe of results====  
lmom_theo <- bind_rows(gev,   
                       glo,   
                       gpa,   
                       gno,   
                       gov,   
                       pe3    
) %>%  
  rename(L_skew = V1) %>%  
  rename(L_kurtosis = V2)  

# 3. clean up global environment====  
rm(gev,   
   glo,   
   gpa,   
   gno,   
   gov,   
   pe3,   
   lmrdia)  

# 4 export lmom_theo====  
export(lmom_theo, "data/lmom_theo.csv")  

```  

```{r 8_prepare-lmoment-diagram}  

# 1. prepare station data for plot====    
lmom_sta <- import("data/sta_meta_lmom.csv") %>%   
  select(sta,  
         L1,  
         L_CV,   
         L_skew,  
         L_kurtosis) %>%  
  mutate(flow_regime = "Precipitation") %>%  
  mutate(ecoreg = "Precipitation") %>%  
  mutate(type = "sta")  

# 2. prepare gage data for plot====       
lmom_gage <- import("data/gage_meta_lmom.csv") %>%  
  select(sta,  
         flow_regime,  
         ecoreg,  
         L1,   
         L_CV,   
         L_skew,   
         L_kurtosis,  
         isD) %>%  
  mutate(flow_regime = str_to_title(flow_regime))  

# * filter discordant stations & calculate ecoregion vals====  
gage_discord <- lmom_gage %>%  
  filter(isD == TRUE) %>%  
  select(-isD) %>%  
  mutate(type = "discordant")  

lmom_gage <- lmom_gage %>%  
  # prepare to join to lmom_ecoreg  
  filter(isD == FALSE)  %>%  
  select(-isD) %>%  
  mutate(type = "gage")  

# 3. calculate lmom ecoregion values====  
lmom_ecoreg <- lmom_gage %>%  
  group_by(ecoreg) %>%  
  summarise(L1         = mean(L1),  
            L_CV       = mean(L_CV),  
            L_skew     = mean(L_skew),  
            L_kurtosis = mean(L_kurtosis),  
            n          = n()) %>%  
  ungroup() %>%  
  gather(key, val, -ecoreg) %>%  
  mutate(val           = round(val, digits = 2)) %>%  
  spread(key, val) %>%  
  select(ecoreg, L1, L_CV, L_skew, L_kurtosis) %>%  
  mutate(sta           = NA) %>%  
  mutate(flow_regime   = "ecoregion mean") %>%  
  mutate(type          = "gage")  

# 4. join lmom data & prepare for plotting====  
lmom_data <- bind_rows(lmom_gage,  
                       lmom_ecoreg,  
                       lmom_sta,  
                       gage_discord)  

lmom_data %<>%  
  # arrange columns  
  select(type, everything()) %>%  
  # remove ecoregion means  #  
  filter(flow_regime != "ecoregion mean") %>%  
  # refactor levels  #     
  mutate(ecoreg = fct_relevel(ecoreg,   
                              "Sand Hills",   
                              "Keya Paha Tablelands",  
                              "Black Hills Plateau",  
                              "White River Badlands",  
                              "Pine Ridge Escarpment",  
                              "Pierre Shale Plains")) %>%   
  mutate(flow_regime = fct_relevel(flow_regime,   
                                   "Perennial",   
                                   "Intermittent",   
                                   "Precipitation"))    

type_labels <- c(discordant = "discordant gages",  
                 gage = "concordant gages",  
                 sta = "weather stations")  

```

```{r 9_plot-lmoment-diagram}

# 1 plot the theoretical distributions, and sample vals====    
lmom_data %>%  
  filter(flow_regime != "ecoregion mean") %>%  
  ggplot(aes(x = L_skew, y = L_kurtosis)) +  
  # set labels and themes  #   
  labs(x = "L-skew",  
       y = "L-kurtosis") +   
  theme_bw() +    
  theme(legend.title      = element_text(size = 10),  
        legend.text       = element_text(size = 8),  
        legend.key.height = unit(0.3, 'cm'),  
        legend.spacing    = unit(0.1, "cm")) +  
  guides(linetype         = guide_legend(order = 1),  
         color            = guide_legend(order = 2),   
         shape            = guide_legend(order = 3)) +  
  # set plot limits  #  
  xlim(-0.7, 0.7) +  
  ylim(-0.1, 0.4) +  
  facet_grid(cols     = vars(type),   
             rows     = NULL,  
             scale    = "fixed",   
             labeller = labeller(  
               type     = type_labels)) +  
  # add L-moments distributions  #    
  geom_line(data = lmom_theo,  
            size = 0.5,  
            color = "gray30",  
            aes(L_skew,  
                L_kurtosis,  
                group = distribution,  
                linetype = distribution)) +   
  scale_linetype_discrete(name = "Distribution") +  
  # add individual station data  #  
  geom_point(aes(shape = flow_regime,   
                 color = ecoreg),  
             size = 2) +  
  # scale aesthetics  #  
  scale_shape_discrete(name = "Type") +  
  scale_colour_grey(  
    breaks = rev(levels(lmom_data$ecoreg)),  
    guide = "legend",  
    na.value   = "red",   
    aesthetics = "colour",  
    name       = 'Ecoregion')  

# 2 save lmom plot====  
ggplot2::ggsave(filename = "figure/lmom_plot.png",  
                width = 6, height = 3.6, units = "in")  

# 3 join discordant gages and save lmom table====  
export(lmom_data, "data/lmom_table.csv")  

# clean-up global environment====     
rm(lmom_theo,   
   lmom_gage,   
   lmom_ecoreg,    
   lmom_sta,   
   type_labels,  
   gage_discord)  

```  

```{r 10_export-lmoment-table}
  
# * set the numeric columns====   
col_key_num <- lmom_data %>%   
  names()  

# * convert tibble to a flextable====    
coef_table <- lmom_data %>%   
  # change factors to characters  
  mutate(flow_regime = as.character(flow_regime)) %>%  
  mutate(ecoreg = as.character(ecoreg)) %>%  
  # prepare cases for export  
  mutate(flag = case_when(  
    type == "discordant" ~ "discordant",  
    TRUE ~ "")) %>%  
  mutate(type = case_when(  
    type == "discordant" ~ "gage",  
    TRUE ~ type)) %>%   
  # arrange cases  
  arrange(sta)  %>%  
  arrange(ecoreg) %>%  
  arrange(type)  %>%  
  # prepare cases for export  
  mutate(type = case_when(  
    type == "sta" ~ "weather station",  
    TRUE ~ type)) %>%   
  mutate(type = case_when(  
    is.na(sta) ~ "ecoregion mean",  
    TRUE ~ type)) %>%  
  mutate(ecoreg = case_when(  
    ecoreg == "NA" ~ "",  
    TRUE ~ ecoreg)) %>%  
  mutate(flow_regime = case_when(  
    flow_regime == "ecoregion mean" ~ "",  
    flow_regime == "precipitation" ~ "",  
    TRUE ~ flow_regime)) %>%  
  select(type, sta, ecoreg, flow_regime, everything()) %>%  
  # convert to a flextable  
  flextable() %>%   
  colformat_num(col_keys = col_key_num,   
                big.mark=",",   
                digits = 2, na_str = "") %>%  
  # rename header labels  
  set_header_labels(  
    type  = "Type",  
    sta = "Name",    
    ecoreg  = "Ecoregion",  
    flow_regime = "Flow regime") %>%    
  autofit() %>%  
  theme_booktabs()   

# * export a docx of flextables & clean up global environment====     
coef_table <- read_docx() %>%  
  body_add_flextable(value = coef_table)  
print(coef_table, target = "output/lmom_table.docx")   

rm(coef_table,  
   col_key_num   
)     

```

# model-based clustering  
```{r 11_Mclust-model_gages}  

# 1 make clustering inputs for gage lmoments====    
lmom_gage <- lmom_data %>%  
  filter(type != "sta") %>%  
  filter(sta != "ecoreg_mean")   

clust_input <- lmom_gage  %>%  
  select(-c(type, sta, flow_regime, ecoreg)) # get rid of categorical data   

# 2 find Bayesian Information Criterion and run Mclust====   
BIC <- mclustBIC(clust_input)  

mod <- Mclust(clust_input, x = BIC)   

# 3 get Mclust model results and tidy the Mclust model====   
mclust_fit <-glance(mod)  
mclust_aug <- augment(mod, lmom_gage)   

# * get centroids===   
mclust_means <- tidy(mod)  

# 4 update groups based on L_skew====  
mclust_aug %<>%  
  mutate(flow_regime = as.character(flow_regime)) %>%  
  mutate(CV_group = case_when(  
    L_CV < 0.15 ~ "very low",  
    L_CV < 0.30 ~ "low",  
    L_CV < 0.60 ~ "moderate",  
    L_CV < 0.90 ~ "high",  
    L_CV > 0.90 ~ "very high")) %>%  
  mutate(CV_group = as_factor(CV_group)) %>%  
  mutate(CV_group = fct_reorder(CV_group, L_CV)) %>%  
  mutate(group = case_when(  
    .class == "3" ~ "1",  
    .class == "1" ~ "2",  
    .class == "2" ~ "3",  
    .class == "7" ~ "4",  
    .class == "4" ~ "5",  
    .class == "6" ~ "6",  
    .class == "5" ~ "7",  
    .class == "8" ~ "8"))  

# 5 create hydrologic clusters====  
mclust_aug %<>%  
  # create a short name variable for ecoregion  
  mutate(ecoreg2 = case_when(  
    ecoreg == "Pierre Shale Plains" ~ "psp",  
    ecoreg == "Keya Paha Tablelands" ~ "kpt",  
    ecoreg == "Pine Ridge Escarpment" ~ "pre",  
    ecoreg == "Black Hills Plateau" ~ "bhp",  
    ecoreg == "Sand Hills" ~ "snd",  
    ecoreg == "White River Badlands" ~ "bad")) %>%  
  # unite ecoregion and Mclust groups  
  unite("hydro_group", ecoreg2, group,  
        sep = "_",  
        remove = FALSE) %>%  
  # create hydrologic groups based on MCLUST  
  mutate(hydro_mclust = case_when(  
    hydro_group == "bad_2" ~ "Tertiary Clays",  
    hydro_group == "pre_2" ~ "Tertiary Clays",  
    hydro_group == "bhp_3" ~ "Black Hills Plateau",  
    hydro_group == "kpt_3" ~ "Keya Paha Tablelands",  
    hydro_group == "kpt_4" ~ "Keya Paha Tablelands",  
    hydro_group == "snd_3" ~ "Sand Hills",  
    hydro_group == "snd_4" ~ "Sand Hills",  
    hydro_group == "snd_1" ~ "GW control",  
    hydro_group == "bhp_1" ~ "GW control",   
    L1           < 1.0     ~ "Pierre Shale Low",  
    L1           > 1.0     ~ "Pierre Shale High",  
    TRUE ~ "NA")) %>%  
  # change hydro_group based on STL decomp (below)  
  mutate(hydro_group = case_when(  
    sta == "fal_hot" ~ "GW control",  
    TRUE ~ hydro_mclust)) %>%  
  # relevel ecoregion for plotting  
  mutate(ecoreg = factor(ecoreg)) %>%  
  mutate(ecoreg = fct_relevel(ecoreg,  
                              "Pierre Shale Plains",  
                              "Pine Ridge Escarpment",  
                              "White River Badlands",  
                              "Black Hills Plateau",  
                              "Keya Paha Tablelands",  
                              "Sand Hills")) %>%  
  # relevel hydrologic groups for plotting  
  mutate(hydro_group = factor(hydro_group)) %>%  
  mutate(hydro_group = fct_relevel(hydro_group,  
                                   "Pierre Shale Low",  
                                   "Pierre Shale High",  
                                   "Tertiary Clays",  
                                   "Black Hills Plateau",  
                                   "GW control",  
                                   "Keya Paha Tablelands", 
                                   "Sand Hills"))   

# 6 create hydrologic group summaries====  
hydro_group <- mclust_aug %>%  
  # summarise by hydrologic group  
  group_by(hydro_group) %>%  
  summarise(L1 = mean(L1),   
            L_CV = mean(L_CV),  
            L_skew = mean(L_skew),  
            L_kurtosis = mean(L_kurtosis)) %>%  
  ungroup() %>%  
  mutate_if(is.numeric, round, 2) %>%  
  # add ecoregions as doubled for cases when two ecoregions are present  
  mutate(ecoreg = case_when(  
    hydro_group == "GW control" ~  
      "Black Hills Plateau_Sand Hills",  
    hydro_group == "Tertiary Clays" ~  
      "Pine Ridge Escarpment_White River Badlands",  
    hydro_group == "Pierre Shale High" ~  
      "Pierre Shale Plains_Pierre Shale Plains",  
    hydro_group == "Black Hills Plateau" ~  
      "Black Hills Plateau_Black Hills Plateau",  
    hydro_group == "Keya Paha Tablelands" ~  
      "Keya Paha Tablelands_Keya Paha Tablelands",   
    hydro_group == "Sand Hills" ~  
      "Sand Hills_Sand Hills",  
    hydro_group == "Pierre Shale Low" ~  
      "Pierre Shale Plains_Pierre Shale Plains")) %>%  
  # separate ecoregons into two columns  
  separate(ecoreg, c("ecoreg1", "ecoreg2"), sep = "_") %>%  
  # gather and drop duplicates  
  gather(key = drop, val = ecoreg,  
         -c(hydro_group, L1, L_CV, L_skew, L_kurtosis)) %>%  
  select(-drop) %>%  
  distinct() %>%  
  arrange(L_skew) %>%   
  # relevel ecoregion for plotting  
  mutate(ecoreg = factor(ecoreg)) %>% 
  mutate(ecoreg = fct_relevel(ecoreg,  
                              "Pierre Shale Plains",  
                              "Pine Ridge Escarpment",  
                              "White River Badlands",  
                              "Black Hills Plateau",  
                              "Keya Paha Tablelands",  
                              "Sand Hills")) %>%  
  # relevel hydrologic groups for plotting  
  mutate(hydro_group = factor(hydro_group)) %>% 
  mutate(hydro_group = fct_relevel(hydro_group,  
                                   "Pierre Shale Low",  
                                   "Pierre Shale High",  
                                   "Tertiary Clays",  
                                   "Black Hills Plateau",  
                                   "GW control",  
                                   "Keya Paha Tablelands", 
                                   "Sand Hills"))  

# 6 export results and clean up global environment====  
export(mclust_aug, "data/lmom_mclust_fit.csv")  

rm(lmom_data,  
   clust_input,  
   mod,  
   BIC,  
   mclust_fit,  
   mclust_means,  
   lmom_gage)  

```

```{r 12-Mclust-plot}  

# plot intitial Mclust groups ====   
mclust_aug %>%  
  ggplot(aes(L_skew, L_kurtosis)) +  
  # set theme, facets, labels #  
  theme_bw() +  
  facet_wrap(vars(ecoreg)) +  
  ggtitle("Initial L-moment groups for streamflow gages",  
          subtitle = "scaled by L1 magnitude") +  
  xlab("L-skew") +  
  ylab("L-kurtosis") +  
  # plot stations #  
  geom_point(aes(color = group,  
                 shape = CV_group,  
                 size = L1)) +  
  # set the plot styles #  
  scale_size(range = c(1, 4), guide = "none") +     
  scale_color_grey(name = "Mclust group") +  
  scale_shape(name = "CV magnitude")  

# plot final hydrologic groups====  
mclust_aug %>%  
  ggplot(aes(L_skew, L_kurtosis)) +  
  # set theme, facets, labels #  
  theme_bw() +  
  #  ggtitle("Hydrologic groups based on streamflow gage L-moments",  
  #          subtitle = "Scaled by L1 magnitude") +  
  xlab("L-skew") +  
  ylab("L-kurtosis") +  
  theme_bw() +  
  facet_wrap(vars(hydro_group)) +  
  # plot stations #  
  geom_point(aes(color = ecoreg,  
                 size = L1,  
                 shape = CV_group)) +  
  # set the legend names #  
  scale_size(range = c(1, 4), guide = "none") +     
  scale_color_grey(name = "Ecoregion") +  
  scale_shape(name = "L-CV magnitude")  

# save individual plot - drop this to add stuff below   
ggsave("figure/Mclust_lmoms.png",  
       units = "in",  
       width = 7,  
       height = 4.5)  

rm(mclust_plot)  

```

```{r 13 export_mclust-table}

# 1 arrange gage data====   
mclust_aug <- mclust_aug %>%  
  select(sta,  
         ecoreg,  
         L1:L_kurtosis,  
         hydro_group) %>%  
  arrange(hydro_group, ecoreg)  

# 2 prepare export table====  
# * set the numeric columns====   
col_key_num <- mclust_aug %>%   
  names()  

# * convert tibble to a flextable====     
coef_table <- mclust_aug %>%   
  # convert factors to characters   
  mutate(hydro_group = as.character(hydro_group)) %>%  
  mutate(ecoreg = as.character(ecoreg)) %>%  
  # create flextable object  
  flextable() %>%   
  colformat_num(col_keys = col_key_num,   
                big.mark=",",   
                digits = 2, na_str = "") %>%  
  # rename header labels  
  set_header_labels(sta = "Name",    
                    ecoreg  = "Ecoregion",  
                    L_CV = "L-CV",  
                    L_skew = "L-skew",  
                    L_kurtosis = "L-kurtosis",  
                    hydro_group = "Hydrologic group") %>%    
  autofit() %>%  
  align(align = "center") %>%   # not working!!!  
  theme_booktabs()   

# * export a docx of flextables & clean up global environment====     
coef_table <- read_docx() %>%  
  body_add_flextable(value = coef_table)  
print(coef_table, target = "output/lmom_mclust_table.docx")   

rm(coef_table,  
   col_key_num,  
   hydro_group)       

```

# calculate SCI  
```{r prepare_SPI} 

# 1.0 prepare sci function vector inputs====    
# 1.1 north-west (NW)====   
sta_rap <- sta_pres %>%   
  arrange(date) %>%   
  filter(sta == "RAP")   

rap <- as.double(sta_rap$prcp)   

# 1.2 north-central (NC)====   
sta_cot <- sta_pres %>%   
  arrange(date) %>%  
  filter(sta == "COT")   

cot <- as.double(sta_cot$prcp)   

# 1.3 north-east (NE)====  
sta_oni <- sta_pres %>%  
  arrange(date) %>%   
  filter(sta == "ONI")    

oni <- as.double(sta_oni$prcp)   

# 1.4 south-west (SW)====   
sta_oel <- sta_pres %>%  
  arrange(date) %>%  
  filter(sta == "OEL")   

oel <- as.double(sta_oel$prcp)   

# 1.5 south-central (SC)====  
sta_gor <- sta_pres %>%  
  arrange(date) %>%  
  filter(sta == "GOR")    

gor <- as.double(sta_gor$prcp)   

# 1.6 south-east (SE)====  
sta_mis <- sta_pres %>%  
  arrange(date) %>%  
  filter(sta == "MIS")   

mis <- as.double(sta_mis$prcp)   

``` 

```{r prepare_SRI}

# 1 double-check input data====     
gage_mon_sri %>%   
  group_by(sta) %>%   
  summarise(count = n()) %>%   
  ungroup() %>%   
  mutate(num_yr = count/12)   

# 2 prepare input for SCI====    
sri_input <- semi_join(gage_mon_sri, mclust_aug,  
                       by = "sta") %>%  
  rename(date = Date) %>%   
  arrange(date) %>%  
  select(sta,  
         ecoreg,  
         date,  
         log_q1_mon)  

# * double-check input data====  
sri_input %>%  
  group_by(sta) %>%  
  summarise(min = min(date),  
            max = max(date))  

# 3 prepare vector inputs as double for SCI fun----  
# 3.1 Black Hills Plateau (bhp) gages====    
bhp_bat <- sri_input %>%  
  filter(sta == "bat_her")    

bhp_fal <- sri_input %>%  
  filter(sta == "fal_hot")   

bhp_frn <- sri_input %>%  
  filter(sta == "frn_fai")    

bhp_bat_v <- as.double(bhp_bat$log_q1_mon)   
bhp_fal_v <- as.double(bhp_fal$log_q1_mon)  
bhp_frn_v <- as.double(bhp_frn$log_q1_mon)  

# 3.2 GW-control (gwc) gages====    
gwc_bev <- sri_input %>%  
  filter(sta == "bev_buf")  

gwc_lcr <- sri_input %>%  
  filter(sta == "lcr_bel")     

gwc_bev_v <- as.double(gwc_bev$log_q1_mon)  
gwc_lcr_v <- as.double(gwc_lcr$log_q1_mon)   

# 3.3 Keya Paha Tablelands (kpt) gages====   
kpt_key <- sri_input %>%   
  filter(sta == "key_key")   

kpt_wew <- sri_input %>%  
  filter(sta == "key_wew")   

kpt_key_v <- as.double(kpt_key$log_q1_mon)   
kpt_wew_v <- as.double(kpt_wew$log_q1_mon)   

# 3.4 Pierre Shale Low (psl) gages====     
psl_brs <- sri_input %>%  
  filter(sta == "brsf_co")    

psl_elk <- sri_input %>%  
  filter(sta == "elk_elm")   

psl_hat <- sri_input %>%  
  filter(sta == "hat_edg") 

psl_bad <- sri_input %>%  
  filter(sta == "bad_fpi")  

psl_hor <- sri_input %>%  
  filter(sta == "hor_oel")  

psl_brs_v <- as.double(psl_brs$log_q1_mon)   
psl_elk_v <- as.double(psl_elk$log_q1_mon)   
psl_hat_v <- as.double(psl_hat$log_q1_mon)   
psl_bad_v <- as.double(psl_bad$log_q1_mon)   
psl_hor_v <- as.double(psl_hor$log_q1_mon)   

# 3.5 Pierre Shale High (psh) gages====     
psh_bat <- sri_input %>%  
  filter(sta == "bat_bhr")    

psh_che <- sri_input %>%  
  filter(sta == "che_was")    

psh_whi <- sri_input %>%  
  filter(sta == "whi_oac")    

psh_bat_v <- as.double(psh_bat$log_q1_mon)   
psh_che_v <- as.double(psh_che$log_q1_mon)   
psh_whi_v <- as.double(psh_whi$log_q1_mon)  

# 3.6 Sand Hills (snd) gages====   
snd_lon <- sri_input %>%  
  filter(sta == "lon_riv")     

snd_mar <- sri_input %>%  
  filter(sta == "lwr_mar")     

snd_ros <- sri_input %>%  
  filter(sta == "lwr_ros")     

snd_vet <- sri_input %>%  
  filter(sta == "lwr_vet")     

snd_whi <- sri_input %>%  
  filter(sta == "lwr_whi")    

snd_nio <- sri_input %>%  
  filter(sta == "nio_spa")     

snd_lon_v <- as.double(snd_lon$log_q1_mon)   
snd_mar_v <- as.double(snd_mar$log_q1_mon)   
snd_ros_v <- as.double(snd_ros$log_q1_mon)   
snd_vet_v <- as.double(snd_vet$log_q1_mon)   
snd_whi_v <- as.double(snd_whi$log_q1_mon)   
snd_nio_v <- as.double(snd_nio$log_q1_mon)   

# 3.7 Tertiary Clay (ter) gages====   
ter_ogl <- sri_input %>%  
  filter(sta == "whi_ogl")   

ter_sta <- sri_input %>%  
  filter(sta == "whi_sta")   

ter_whi <- sri_input %>%  
  filter(sta == "whi_kad")  

ter_ogl_v <- as.double(ter_ogl$log_q1_mon)   
ter_sta_v <- as.double(ter_sta$log_q1_mon)   
ter_whi_v <- as.double(ter_whi$log_q1_mon)   

# 4.0 clean up global enviroment====    
rm(sri_input)   

```  

```{r SCI_function}
#   some notes about the SCI package:      
#     the SCI package doesn't like snake_case variables,     
#     need to change tibble to a vector as double:    
#       cot <- as.double(sta_cot$depth_mm)      

# Initial values for SCI calculations====       
time_scale <- 1     # sets the length of the averaging period - inital value    
distrib    <- "pe3" # sets the distribution type    
p_zero     <- TRUE  # sets a function to reduce zero-precip bias   
p_zero_cm  <- TRUE  # uses Weibull plotting position for p_zero     
scale      <- "sd"  # scales input by subtract mean & divide by sd     
warn_me    <- TRUE  # sets explicit warning    
first_mon  <- 10     # Set first month for each station   
sci.limit  <- 3     # Sets a limit of [-3, 3] for limit   

# sci function====                                            
sci.fun <- function(sta, time_scale) fitSCI(x = sta,    
                                            start.fun.fix  = TRUE,    
                                            time.scale     = time_scale,    
                                            first.mon      = first_mon,   
                                            distr          = distrib,   
                                            p0             = p_zero,     
                                            p0.center.mass = p_zero_cm,     
                                            scaling        = scale,     
                                            warn	         = warn_me)     

```

```{r calculate_SPI}

# 1.0 calculate SCI-rap----  
# * set up the station for sci & make sci list vars  
sta      <- rap  
sci_1mo  <- sci.fun(sta, 1)      # MLE fail month 5  (MAY)                 
sci_2mo  <- sci.fun(sta, 2)      # MLE fail month 6  (MAY-JUN)                  
sci_3mo  <- sci.fun(sta, 3)                             
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      # MLE fail month 5  (MAY-DEC)  
sci_9mo  <- sci.fun(sta, 9)      # MLE fail month 1  (MAY-JAN)  
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)   

# * apply the transformation identified by fitSCI function====   
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,    
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====      
sci_rap <- bind_cols(sta_rap,     
                     sci_1mo,   
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,   
                     sci_6mo,  
                     sci_9mo,   
                     sci_12mo,  
                     sci_18mo,  
                     sci_24mo,  
                     ) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)          

# * clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)      
rm(sta_rap, rap)   

# 2.0 calculate SCI-cot----   
# * set up the station for sci & make sci list vars  
sta      <- cot  
sci_1mo  <- sci.fun(sta, 1)                               
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)    # MLE fail month 6    (APR-JUN)              
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)   
sci_9mo  <- sci.fun(sta, 9)   
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)  

# * apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====     
sci_cot <- bind_cols(sta_cot,     
                     sci_1mo,  
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,  
                     sci_6mo,  
                     sci_9mo,   
                     sci_12mo, 
                     sci_18mo, 
                     sci_24mo) %>%    
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%   
  rename(sci_12mo = value6) %>%  
  rename(sci_18mo = value7) %>%  
  rename(sci_24mo = value8)            

# * clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)           
rm(sta_cot, cot)  

# 3.0 calculate SCI-oni----   
# * set up the station for sci & make sci list vars    
sta      <- oni    
sci_1mo  <- sci.fun(sta, 1)         # fail at mon = 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)   
sci_9mo  <- sci.fun(sta, 9)   
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)   

# * apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====     
sci_oni <- bind_cols(sta_oni,     
                     sci_1mo,  
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,  
                     sci_6mo,  
                     sci_9mo,  
                     sci_12mo,  
                     sci_18mo,  
                     sci_24mo) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)         
rm(sta_oni, oni)  

# 4.0 calculate SCI-oel----  
# * set up the station for sci & make sci list vars====   
sta      <- oel  
sci_1mo  <- sci.fun(sta, 1)                              
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)   # MLE fail month 12 (OCT-DEC)              
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)   
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)   

# * apply the transformation identified by fitSCI function====       
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_1mo) %>%  
  enframe(name = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_2mo) %>%  
  enframe(name = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_3mo) %>%  
  enframe(name = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_4mo) %>%  
  enframe(name = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_6mo) %>%  
  enframe(name = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_9mo) %>%  
  enframe(name = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj = sci_12mo) %>%  
  enframe(name = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====   
sci_oel <- bind_cols(sta_oel,     
                     sci_1mo,  
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,  
                     sci_6mo,   
                     sci_9mo,    
                     sci_12mo,  
                     sci_18mo,  
                     sci_24mo) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * clean up global environment====        
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)           
rm(sta_oel, oel)    

# 5.0 calculate SCI-gor----  
# * set up the station for sci & make sci list vars====   
sta      <- gor    
sci_1mo  <- sci.fun(sta, 1)      # MLE fail month 9 (SEP)                   
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)   
sci_9mo  <- sci.fun(sta, 9)   
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)   

# * apply the transformation identified by fitSCI function====        
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====      
sci_gor <- bind_cols(sta_gor,     
                     sci_1mo,  
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,  
                     sci_6mo,  
                     sci_9mo,   
                     sci_12mo,  
                     sci_18mo,  
                     sci_24mo) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * clean up global environment====    
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,   
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)     
rm(sta_gor, gor)    

# 6.0 calculate sci-mis----   
# * set up the station for sci & make sci list vars ====  
sta      <- mis  
sci_1mo  <- sci.fun(sta, 1)         # fail for mon = 8 (AUG)               
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)   
sci_9mo  <- sci.fun(sta, 9)   
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)       # fail for mon = 3 (JAN-???)
sci_24mo <- sci.fun(sta, 24)   

# * apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bind and rename the sci vals====     
sci_mis <- bind_cols(sta_mis,     
                     sci_1mo,  
                     sci_2mo,   
                     sci_3mo,  
                     sci_4mo,  
                     sci_6mo,  
                     sci_9mo,   
                     sci_12mo,  
                     sci_18mo,  
                     sci_24mo) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)    
rm(sta_mis, mis)      

# 7.0 join sci data----   
sci_sta <- bind_rows(  
  sci_rap,  
  sci_cot,  
  sci_oni,  
  sci_oel,  
  sci_gor,  
  sci_mis) %>%  
  select(-c(yr, mon)) %>%  
  # truncate sci vals to [-3, 3]    
  gather(key = type, val = value, -c(sta, date, prcp, location)) %>%  
  #  mutate(val_orig = value) %>% 
  mutate(value = case_when(     
    value < -3.0 ~ -3.0,    
    value >  3.0 ~  3.0,  
    TRUE ~ value)) %>%  
  spread(type, value) %>%    
  # move the longer sci-values to the end of the df    
  select(-sci_12mo, sci_12mo) %>%   
  select(-sci_18mo, sci_18mo) %>%   
  select(-sci_24mo, sci_24mo)    

sci_sta <- sci_sta %>%  
  pivot_longer(-c(sta, date, prcp, location), 
               names_to = "key", values_to = "value")  

# 8.0 export sci data & clean workspace====        
export(sci_sta, "data/sci_sta.csv")  

# * clean up workspace====     
rm(sci_cot,  
   sci_gor,  
   sci_mis,  
   sci_oel,  
   sci_oni,  
   sci_rap,  
   sta_pres)         

```  

```{r calculate_SRI-PE3_part1}

#distrib    <- "pe3" # sets the distribution type    
# 1.0 calculate SCI_blp====   
# 1.1 SCI calcs - bhp_bat -- set up station for sci & make sci list vars ====  
sta      <- bhp_bat_v    
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                           
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)   

# * bhp_bat -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo,  
                         sci.limit = sci.limit) %>%   
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_12mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)   

# * bhp_bat -- bind and rename the sci vals====       
sci_bhp_bat <- bind_cols(bhp_bat,    
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * bhp_bat -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)    
rm(bhp_bat, bhp_bat_v)   

# 1.2 SCI calcs - bhp_fal -- set up station for sci & make sci list vars====   
sta      <- bhp_fal_v   
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)           # MLE fail month 4                  
sci_3mo  <- sci.fun(sta, 3)           # MLE fail month 1 & 5                
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)           # MLE fail month 6  
sci_9mo  <- sci.fun(sta, 9)           # MLE fail month 7 & 8  
sci_12mo <- sci.fun(sta, 12)          # MLE fail month 8 & 9  
sci_18mo <- sci.fun(sta, 18)          # MLE fail month 1, 2 & 3  
sci_24mo <- sci.fun(sta, 24)          # MLE fail month 1, 2, 3, 7, 8, 9 & 10  

# * bhp_fal -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo,  
                         sci.limit = sci.limit) %>%   
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_12mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * bhp_fal -- bind and rename the sci vals====    
sci_bhp_fal <- bind_cols(bhp_fal,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * bhp_fal -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)    
rm(bhp_fal, bhp_fal_v)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)           # MLE fail month 11                  
sci_3mo  <- sci.fun(sta, 3)           # MLE fail month 12                
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)           
sci_9mo  <- sci.fun(sta, 9)           
sci_12mo <- sci.fun(sta, 12)         
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)         

# * bha_frn -- apply the transformation identified by fitSCI function====  
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo,  
                         sci.limit = sci.limit) %>%   
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_12mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * bha_frn -- bind and rename the sci vals====      
sci_bhp_frn <- bind_cols(bhp_frn,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * bha_frn -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)    
rm(bhp_frn, bhp_frn_v)   

# 2.0 calculate SCI_gwc---- 
# 2.1 SCI calcs - gwc_bev -- set up station for sci & make sci list vars====    
sta      <- gwc_bev_v  
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                             
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)    

# * gwc_bev -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * gwc_bev -- bind and rename the sci vals====         
sci_gwc_bev <- bind_cols(gwc_bev,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * gwc_bev -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)         
rm(gwc_bev, gwc_bev_v)  

# 2.2 SCI calcs - gwc_lcr -- set up station for sci & make sci list vars====    
sta      <- gwc_lcr_v   
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 5, 8                     
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 5   
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)    
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)    

# * gwc_lcr -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * gwc_lcr -- bind and rename the sci vals====        
sci_gwc_lcr <- bind_cols(gwc_lcr,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * gwc_lcr -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(gwc_lcr, gwc_lcr_v)  

# 3.0 calculate SCI_kpt----  
# 3.1 SCI calcs - kpt_key -- set up station for sci & make sci list vars====   
sta      <- kpt_key_v   
sci_1mo  <- sci.fun(sta, 1)                     
sci_2mo  <- sci.fun(sta, 2)                   
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)    

# * kpt_key -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * kpt_key -- bind and rename the sci vals====       
sci_kpt_key <- bind_cols(kpt_key,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * kpt_key -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)       
rm(kpt_key, kpt_key_v)   

# 3.2 SCI calcs - kpt_wew -- set up station for sci & make sci list vars====  
sta      <- kpt_wew_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)    

# * kpt_wew -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)   

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * kpt_wew -- bind and rename the sci vals====       
sci_kpt_wew <- bind_cols(kpt_wew,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * kpt_wew -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(kpt_wew, kpt_wew_v)   
```

```{r calculate_SRI-PE3_part2}

# 4.0 calculate SCI_psh---- 
# 4.1 SCI calcs - psh_bat -- set up station for sci & make sci list vars====   
sta      <- psh_bat_v   
sci_1mo  <- sci.fun(sta, 1)   # MLE fail months 8 & 10 (AUG & OCT)         
sci_2mo  <- sci.fun(sta, 2)   # MLE fail month 11 (OCT-NOV)                
sci_3mo  <- sci.fun(sta, 3)   # MLE fail months 9 & 11  (JUL-SEP) & (SEP-NOV)  
sci_4mo  <- sci.fun(sta, 4)   # MLE fail month 10 (JUL-OCT)           
sci_6mo  <- sci.fun(sta, 6)   # MLE fail month 12 (JUN-DEC)                
sci_9mo  <- sci.fun(sta, 9)   # MLE fail month 3 (JUN-MAR)            
sci_12mo <- sci.fun(sta, 12)  # MLE fail months 4 & 5 (MAR-APR) & (APR-MAY)    
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)  # MLE fail months 1, 3, 4 8 & 12    

# * psh_bat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psh_bat -- bind and rename the sci vals====       
sci_psh_bat <- bind_cols(psh_bat,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psh_bat -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)          
rm(psh_bat, psh_bat_v)  

# 4.2 SCI calcs - psh_che -- set up station for sci & make sci list vars====   
sta      <- psh_che_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)                 
sci_4mo  <- sci.fun(sta, 4)               
sci_6mo  <- sci.fun(sta, 6)                   
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)  
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)      

# * psh_che -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psh_che -- bind and rename the sci vals====       
sci_psh_che <- bind_cols(psh_che,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psh_che -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)    
rm(psh_che, psh_che_v)  

# 4.3 SCI calcs - psh_whi -- set up station for sci & make sci list vars====   
sta      <- psh_whi_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 7   
sci_2mo  <- sci.fun(sta, 2)      
sci_3mo  <- sci.fun(sta, 3)                
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)                 
sci_12mo <- sci.fun(sta, 12)    
sci_18mo <- sci.fun(sta, 18)          
sci_24mo <- sci.fun(sta, 24)      

# * psh_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psh_whi -- bind and rename the sci vals====       
sci_psh_whi <- bind_cols(psh_whi,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psh_whi -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)       
rm(psh_whi, psh_whi_v)  

# 5.0 calculate SCI_psl---- 
# 5.1 SCI calcs - psl_brs -- set up station for sci & make sci list vars====   
sta      <- psl_brs_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 9, 11 (JAN & SEP & NOV)   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month  4 (MAR-APr)                 
sci_3mo  <- sci.fun(sta, 3)    # MLE fail month 11 (SEP-NOV)                 
sci_4mo  <- sci.fun(sta, 4)    # MLE fail month 12 (SEP-DEC)             
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month  2 (SEP-FEB)                 
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)       
sci_18mo <- sci.fun(sta, 18)   # MLE fail month  6        
sci_24mo <- sci.fun(sta, 24)      

# * psl_brs -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psl_brs -- bind and rename the sci vals====       
sci_psl_brs <- bind_cols(psl_brs,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psl_brs -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)         
rm(psl_brs, psl_brs_v)  

# 5.2 SCI calcs - psl_elk -- set up station for sci & make sci list vars====   
sta      <- psl_elk_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 8, 10, 11, 12   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 11, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 9, 10, 11, 12         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 9, 12   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 9, 11, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 6    
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 6, 7    
sci_18mo <- sci.fun(sta, 18)   # MLE fail months 1, 2, 3, 4, 5, 7, 8, 10, 12  
sci_24mo <- sci.fun(sta, 24)      

# * psl_elk -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psl_elk -- bind and rename the sci vals====       
sci_psl_elk <- bind_cols(psl_elk,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psl_elk -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(psl_elk, psl_elk_v)  

# 5.3 SCI calcs - psl_hat -- set up station for sci & make sci list vars====   
sta      <- psl_hat_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)      

# * psl_hat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psl_hat -- bind and rename the sci vals====       
sci_psl_hat <- bind_cols(psl_hat,        
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psl_hat -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)       
rm(psl_hat, psl_hat_v)  

# 5.4 SCI calcs - psl_bad -- set up station for sci & make sci list vars====   
sta      <- psl_bad_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         
sci_18mo <- sci.fun(sta, 18)   
sci_24mo <- sci.fun(sta, 24)      

# * psl_bad -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psl_bad -- bind and rename the sci vals====       
sci_psl_bad <- bind_cols(psl_bad,        
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psl_bad -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)     
rm(psl_bad, psl_bad_v)  

# 5.5 SCI calcs - psl_hor -- set up station for sci & make sci list vars====   
sta      <- psl_hor_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 5, 6, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 2, 3, 6, 9         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 7    
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 7, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 1, 8, 9     
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 5, 11      
sci_18mo <- sci.fun(sta, 18)   # MLE fail months 10, 11      
sci_24mo <- sci.fun(sta, 24)   

# * psl_hor -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * psl_hor -- bind and rename the sci vals====       
sci_psl_hor <- bind_cols(psl_hor,        
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * psl_hor -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)      
rm(psl_hor, psl_hor_v)  

# 6.0 calculate SCI_snd---- 
# 6.1 SCI calcs - snd_lon -- set up station for sci & make sci list vars====   
sta      <- snd_lon_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)    # MLE fail month 12        
sci_12mo <- sci.fun(sta, 12)   # MLE fail month 6   
sci_18mo <- sci.fun(sta, 18)   # MLE fail months 10, 11      
sci_24mo <- sci.fun(sta, 24)   # MLE fail month 5  

# * snd_lon -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_lon -- bind and rename the sci vals====      
sci_snd_lon <- bind_cols(snd_lon,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_lon -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)         
rm(snd_lon, snd_lon_v)   

# 6.2 SCI calcs - snd_mar -- set up station for sci & make sci list vars====  
sta      <- snd_mar_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   # MLE fail month 8  

# * snd_mar -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_mar -- bind and rename the sci vals====      
sci_snd_mar <- bind_cols(snd_mar,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_mar -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(snd_mar, snd_mar_v)    

# 6.3 SCI calcs - snd_nio -- set up station for sci & make sci list vars====  
sta      <- snd_nio_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                           
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * snd_nio -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_nio -- bind and rename the sci vals====      
sci_snd_nio <- bind_cols(snd_nio,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_nio -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)     
rm(snd_nio, snd_nio_v)    

# 6.4 SCI calcs - snd_ros -- set up station for sci & make sci list vars====  
sta      <- snd_ros_v  
sci_1mo  <- sci.fun(sta, 1)                        
sci_2mo  <- sci.fun(sta, 2)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 5    
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * snd_ros -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)     

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_ros -- bind and rename the sci vals====      
sci_snd_ros <- bind_cols(snd_ros,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_ros -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(snd_ros, snd_ros_v)    

# 6.5 SCI calcs - snd_vet -- set up station for sci & make sci list vars====  
sta      <- snd_vet_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)     # MLE fail month 5   
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * snd_vet -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_vet -- bind and rename the sci vals====      
sci_snd_vet <- bind_cols(snd_vet,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_vet -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)     
rm(snd_vet, snd_vet_v)    

# 6.6 SCI calcs - snd_whi -- set up station for sci & make sci list vars====  
sta      <- snd_whi_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                            
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * snd_whi -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * snd_whi -- bind and rename the sci vals====      
sci_snd_whi <- bind_cols(snd_whi,      
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * snd_whi -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)          
rm(snd_whi, snd_whi_v)    

# 7.0 calculate SCI_ter---- 
# 7.1 SCI calcs - ter_ogl -- set up station for sci & make sci list vars====   
sta      <- ter_ogl_v   
sci_1mo  <- sci.fun(sta, 1)     # MLE fail month 9 (SEP)                    
sci_2mo  <- sci.fun(sta, 2)     # MLE fail month 10 (SEP-OCT)           
sci_3mo  <- sci.fun(sta, 3)    
sci_4mo  <- sci.fun(sta, 4)     # MLE fail month 2 (NOV-FEB)  
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * ter_ogl -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * ter_ogl -- bind and rename the sci vals====        
sci_ter_ogl <- bind_cols(ter_ogl,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * ter_ogl -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)       
rm(ter_ogl, ter_ogl_v)   

# 7.2 SCI calcs - ter_sta -- set up station for sci & make sci list vars====   
sta      <- ter_sta_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 9 (SEP)                   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 10  (SEP-OCT)               
sci_3mo  <- sci.fun(sta, 3)             
sci_4mo  <- sci.fun(sta, 4)          
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 1, 5 (DEC-MAY)       
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)   

# * ter_sta -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * ter_sta -- bind and rename the sci vals====       
sci_ter_sta <- bind_cols(ter_sta,       
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * ter_sta -- clean up global environment====   
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)        
rm(ter_sta, ter_sta_v)  

# 7.3 SCI calcs - ter_whi -- set up station for sci & make sci list vars====  
sta      <- ter_whi_v    
sci_1mo  <- sci.fun(sta, 1)                              
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)  # MLE fail month 6     
sci_12mo <- sci.fun(sta, 12)   
sci_18mo <- sci.fun(sta, 18)       
sci_24mo <- sci.fun(sta, 24)  

# * ter_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

sci_18mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_18mo) %>%   
  enframe(name                     = NULL)   

sci_24mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_24mo) %>%   
  enframe(name                     = NULL)  

# * ter_whi -- bind and rename the sci vals====       
sci_ter_whi <- bind_cols(ter_whi,     
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo,  
                         sci_18mo,  
                         sci_24mo) %>%      
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  %>%  
  rename(sci_18mo = value7)  %>%  
  rename(sci_24mo = value8)  

# * ter_whi -- clean up global environment====     
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo,  
   sci_18mo,  
   sci_24mo)      
rm(ter_whi, ter_whi_v)     

```

```{r join_SRI}

# 2.1 join black hills plateau SCI vals====   
# NOTE changed fal_hot to GW Control  
sci_bhp <- bind_rows(sci_bhp_bat,  
                     sci_bhp_frn) %>%  
  mutate(group = "Black Hills Plateau") %>%   
  select(sta, group, ecoreg, everything())  

# 2.2 join gw control SCI vals====  
# changed fal_hot to GW Control  
sci_gwc <- bind_rows(sci_gwc_bev,  
                     sci_gwc_lcr,  
                     sci_bhp_fal) %>%           
  mutate(group = "GW Control") %>%   
  select(sta, group, ecoreg, everything())  

# 2.3 join keya paha tablelands SCI vals====  
sci_kpt <- bind_rows(sci_kpt_key,  
                     sci_kpt_wew) %>%  
  mutate(group = "Keya Paha Tablelands") %>%   
  select(sta, group, ecoreg, everything())  

# 2.4 join pierre shale high SCI vals====  
sci_psh <- bind_rows(sci_psh_bat,  
                     sci_psh_che,  
                     sci_psh_whi) %>%  
  mutate(group = "Pierre Shale High") %>%   
  select(sta, group, ecoreg, everything())  

# 2.5 join pierre shale low SCI vals====  
sci_psl <- bind_rows(  sci_psl_bad,  
                       sci_psl_brs,  
                       sci_psl_elk,  
                       sci_psl_hat,  
                       sci_psl_hor) %>%  
  mutate(group = "Pierre Shale Low") %>%   
  select(sta, group, ecoreg, everything())  

# 2.6 join sand hills SCI vals====  
sci_snd <- bind_rows(sci_snd_lon,  
                     sci_snd_mar,  
                     sci_snd_nio,  
                     sci_snd_ros,  
                     sci_snd_vet,  
                     sci_snd_whi) %>%  
  mutate(group = "Sand Hills") %>%   
  select(sta, group, ecoreg, everything())  

# 2.7 join tertiary clay SCI values====    
sci_ter <- bind_rows(sci_ter_ogl,  
                     sci_ter_sta,  
                     sci_ter_whi) %>%  
  mutate(group = "Tertiary Clays") %>%   
  select(sta, group, ecoreg, everything())  

# 3.0 join all values====  
sci_gage <- bind_rows(sci_bhp,  
                      sci_gwc,  
                      sci_kpt,  
                      sci_psh,  
                      sci_psl,  
                      sci_snd,  
                      sci_ter) %>%  
  gather(key = type, val = value,  
         -c(sta, date, group, ecoreg, log_q1_mon))    

# * 4 clean up global environment====  
rm(sci_bhp,  
   sci_gwc,  
   sci_kpt,  
   sci_psh,  
   sci_psl,  
   sci_snd,  
   sci_ter,  
   sci_bhp_bat,  #  
   sci_bhp_fal,  #  
   sci_bhp_frn,  #  
   sci_gwc_bev,  #  
   sci_gwc_lcr,  #  
   sci_kpt_key,  #  
   sci_kpt_wew,  #  
   sci_psh_bat,  #  
   sci_psh_che,  #  
   sci_psh_whi,  #  
   sci_psl_bad,  #  
   sci_psl_brs,  #  
   sci_psl_elk,  
   sci_psl_hat,  
   sci_psl_hor,  
   sci_snd_lon,  
   sci_snd_mar,  
   sci_snd_nio,  
   sci_snd_ros,  
   sci_snd_vet,  
   sci_snd_whi,  
   sci_ter_ogl,  
   sci_ter_sta,  
   sci_ter_whi)  

# * clean up sci.fun vars====  
rm(distrib,  
   first_mon,  
   p_zero,  
   p_zero_cm,  
   scale,  
   sci.limit,  
   sta,  
   time_scale,  
   warn_me,  
   sci.fun)  

```

```{r summarise_sri}

# Get counts of high and low vals====    
# * summarize high and low flow values  #  
summary_prop <- sci_gage %>%  
  group_by(group) %>%  
  summarise(n = n())  

summary_high <- sci_gage %>%  
  filter(value >= 3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()  

summary_low <- sci_gage %>%  
  filter(value <= -3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()   

# * get high and low flow counts by year and month====  
# * summarize year====  
high_year <- summary_high %>%  
  group_by(group, year) %>%  
  summarise(high_year = sum(count)) %>%  
  ungroup() 

low_year <- summary_low %>%  
  group_by(group, year) %>%  
  summarise(low_year = sum(count)) %>%  
  ungroup()  

# join the high and low year values 
exceed_year <- full_join(high_year, low_year,  
                         by = c("group", "year")) %>%  
  replace_na(list(low_year = 0, high_year = 0)) %>%  
  mutate(low_year = -low_year) %>% 
  pivot_longer(c(high_year, low_year),  
               names_to = "key",  
               values_to = "value")  

# * create year proportations====  
exceed_year <- full_join(exceed_year, summary_prop, 
                         by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>%  
  mutate(group = fct_relevel(group,  
                             "GW Control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * summarize month====  
high_month <- summary_high %>%  
  group_by(group, month) %>%  
  summarise(high_month = sum(count)) %>%  
  ungroup()  

low_month <- summary_low %>%  
  group_by(group, month) %>%  
  summarise(low_month = sum(count)) %>%  
  ungroup()  

# join the high and low month values  
exceed_month <- full_join(high_month, low_month,  
                          by = c("group", "month")) %>%  
  replace_na(list(low_month = 0, high_month = 0)) %>%  
  mutate(low_month = -low_month) %>% 
  pivot_longer(c(high_month, low_month),  
               names_to = "key",  
               values_to = "value")  

# * create month proportations====  
exceed_month <- full_join(exceed_month, summary_prop, 
                          by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>%  
  mutate(group = fct_relevel(group,  
                             "GW Control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * clean up global environment====  DO IN A BIT
rm(summary_high,  
   summary_low,  
   summary_prop,  
   high_year,  
   low_year,  
   high_month,  
   low_month)  

```  

```{r plot_exceedances}

# 1 prepare for plotting====    
# * yearly exceedances  
exceed_year %<>%  
  mutate(group = as.character(group)) %>%  
  mutate(group = case_when(  
    group == "GW control" ~ "GW Control",  
    TRUE ~ group)) %>%  
  # round proportions for plotting  
#  mutate(prop = round(prop, digits = 1)) %>%  
  # refactor levels and provide label names  #  
  mutate(group = fct_relevel(group,  
                             "Pierre Shale Low",  
                             "Pierre Shale High",  
                             "Tertiary Clays",  
                             "Keya Paha Tablelands",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Sand Hills"))  

# * monthly exceedences  
exceed_month %<>%  
  mutate(group = as.character(group)) %>%  
  mutate(group = case_when(  
    group == "GW control" ~ "GW Control",  
    TRUE ~ group)) %>%   
  # round proportions for plotting  
#  mutate(prop = round(prop, digits = 1)) %>%  
  # refactor levels and provide label names  #  
  mutate(group = fct_relevel(group,  
                             "Pierre Shale Low",  
                             "Pierre Shale High",  
                             "Tertiary Clays",  
                             "Keya Paha Tablelands",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Sand Hills"))  

# 2 plot exceedances by year  #  
exceed_yr_plot <- exceed_year %>%  
  drop_na() %>%              
  ggplot(aes(x = year, y = prop, fill = key)) +  
  # set theme, facets, labels  #  
  theme_bw() +  
  facet_wrap(vars(group)) +  
   scale_y_continuous(breaks = c(-1.5, -1.0, -0.5, 0, 0.5)) +  
  # ggtitle("High and low streamflow months by ecoregion") +  
  ylab("Proportion of outliers") +  
  xlab("") +  
  # plot horizontal line  #  
  geom_hline(yintercept = 0,  
             color = "gray40",  
             size = 0.1) +  
  # plot proportation of months with sci outside the range of [-3, 3]  #  
  geom_bar(stat ="identity",  
           position ="identity",  
           fill = "grey70",  
           show.legend = FALSE)  

# 3 plot exceedances by month  #  
exceed_mon_plot <- exceed_month %>%  
  drop_na() %>%      
  ggplot(aes(x = month, y = prop, fill = key)) +  
  # set theme, facets, labels  #  
  theme_bw() +  
  facet_wrap(vars(group)) +  
#  ggtitle("High and low streamflow months by ecoregion ") +  
  ylab("Proportion of outliers") +  
  xlab("") +  
  scale_x_continuous(breaks = 1:12,   
                     labels = c("J", "F", "M", "A", "M", "J",  
                                "J", "A", "S", "O", "N", "D")) +  
 scale_y_continuous(breaks = c(-1.5, -1.0, -0.5, 0, 0.5)) +  
  # plot horizontal line  #  
  geom_hline(yintercept = 0,  
             color = "gray40",  
             size = 0.1) +  
  # plot proportation of months with sci outside the range of [-3, 3]  #  
  geom_bar(stat ="identity",  
           position ="identity",  
           fill = "grey70",  
           show.legend = FALSE)   

# 4 plot using patchwork and save====  
exceed_yr_plot / exceed_mon_plot +  
  plot_layout(height = c(1, 1))  

ggsave("figure/SCI_exceed.png",  
                 units = "in",  
                 width = 7,  
                 height = 4.5)  

# 5 clean up global enviroment====  
rm(exceed_yr_plot,  
   exceed_mon_plot,  
   exceed_month,  
   exceed_year)  

```

```{r truncate_SCI-vars}

# 1 truncate sci vals to [-3, 3]====     
sci_gage <- sci_gage %>%  
  mutate_if(is.numeric, round, 3) %>%  
  mutate(value = case_when(     
    value < -3.0 ~ -3.0,    
    value >  3.0 ~  3.0,  
    TRUE ~ value))  

sci_sta <- sci_sta %>%  
  mutate_if(is.numeric, round, 3) %>%  
  mutate(value = case_when(     
    value < -3.0 ~ -3.0,    
    value >  3.0 ~  3.0,  
    TRUE ~ value))  

export(sci_gage, "data/sci_gage.csv")  
export(sci_sta, "data/sci_sta.csv")  

```

# Identify seasonality & trend of SCI data -- plot seasonality  
```{r make_stl-decomp_function}    

# make function to decompose into seasonal, trend, & remainder----   
decomp_fun <- function(df) {    
  arrange(df, .data$date) %>%  
    group_by(.data$sta) %>%  
    time_decompose(   
      target         = , TARGET,     
      data           = .,   
      method         = "stl",   
      frequency      = , FREQ,   
      trend          = , TREND,   
      merge          = TRUE,   
      message        = TRUE    
    ) %>%                    
    ungroup() %>%   
    anomalize(remainder,   
              method = "gesd",  
              alpha  = 0.003) %>%    
    select(-observed)    
}   
  
# notes: map_dfr can cause issues with indexing; use split and combine  
#   input needs to be a tibble   
  
```

```{r deconvolute_sci}    

# 1 deconvolute the grouped prcp into trend, seasonal & random components----  
# import working data====           
#sci_sta <- import("data/sci_sta.csv") %>%    
#  mutate(date = ymd(date))  

#sci_gage <- import("data/sci_gage.csv") %>%    
#  mutate(date = ymd(date))  

# 2 identify frequency of seasonality -- should be 12 months====  
# * precip data====  
freq_sta <- sci_sta  %>%  
  pivot_wider(names_from = key, values_from = value) %>%  
  split(.$sta) %>%  
  map_dfc(~ anomalize::time_frequency(period       = "auto",  
    data = .)) %>%  
  gather(key     = group,  
         value   = freq) %>%   
  summarise(freq = mean(freq),    
            max  = max(freq),   
            min  = min(freq),   
            sd   = sd(freq))   

# * streamflow data====  
freq_gage <- sci_gage  %>%  
  pivot_wider(names_from = type, values_from = value) %>%  
  split(.$sta) %>%   
  map_dfc(~ anomalize::time_frequency(  
    period       = "auto",  
    data = .)) %>%  
  gather(key     = group,  
         value   = freq) %>%   
  summarise(freq = mean(freq),   
            max  = max(freq),   
            min  = min(freq),   
            sd   = sd(freq))   

# 3 identify trend of periodicity -- should be 60 months====   
# * precip data====  
trend_sta <- sci_sta  %>%  
  pivot_wider(names_from = key, values_from = value) %>%  
  split(.$sta) %>%   
  map_dfc(~ anomalize::time_trend(  
    period       = "auto", data = .)) %>%  
  gather(key     = grpup, value = freq) %>%   
  summarise(freq = mean(freq),  
            max  = max(freq),  
            min  = min(freq),  
            sd   = sd(freq))  

# * streamflow data====
trend_gage <- sci_gage  %>%   
  pivot_wider(names_from = type, values_from = value) %>%  
  split(.$sta) %>%   
  map_dfc(~ anomalize::time_trend(   
    period       = "auto", data = .)    
  ) %>%                        
  gather(key     = grpup, value = freq) %>%   
  summarise(freq = mean(freq),   
            max  = max(freq),   
            min  = min(freq),   
            sd   = sd(freq)    
  )   

# 4 decompose SCIs into seasonal, trend, & remainder====     
# * set frequency and trend  
FREQ   <- "12 months"   
TREND  <- "60 months"    

# * pivot the data wider to prepare for decomp_fun() input   
spi_wide <- sci_sta %>%   
  pivot_wider(names_from = key, values_from = value) 

sri_wide <- sci_gage %>%  
  pivot_wider(names_from = type, values_from = value)   

# * need to drop NA vals prior to decomp_fun() - prepare results for join====  
# next step is to create a function for the drop and rename steps  
# *  1-month SCI decomp====  
TARGET <- "sci_1mo"   
spi_seas_1mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET)) 

sri_seas_1mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# *  2-month SCI decomp====  
TARGET <- "sci_2mo"   
spi_seas_2mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_2mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# *  3-month SCI decomp====  
TARGET <- "sci_3mo"   
spi_seas_3mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_3mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# *  4-month SCI decomp====  
TARGET <- "sci_4mo"   
spi_seas_4mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_4mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# *  6-month SCI decomp====  
TARGET <- "sci_6mo"   
spi_seas_6mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_6mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# *  9-month SCI decomp====  
TARGET <- "sci_9mo"   
spi_seas_9mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_9mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# * 12-month SCI decomp====  
TARGET <- "sci_12mo"   
spi_seas_12mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_12mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# * 18-month SCI decomp====  
TARGET <- "sci_18mo"   
spi_seas_18mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_18mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# * 24-month SCI decomp====  
TARGET <- "sci_24mo"   
spi_seas_24mo <- spi_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:location,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))  

sri_seas_24mo <- sri_wide %>%  
  drop_na(!!!TARGET) %>%  
  decomp_fun() %>%  
  select(!!!TARGET,  
         sta:date,  
         season:anomaly) %>%  
  rename(value = 1) %>%  
  mutate(name = paste0(TARGET))   

# 5 clean up global environment====   
rm(freq_gage,  
   freq_sta,  
   trend_gage,  
   trend_sta,  
   FREQ,   
   TARGET,  
   TREND,  
   decomp_fun,   
   sci_gage,  
   sci_sta,  
   spi_wide,  
   sri_wide)  

```

```{r append_decomp_results} 

# 1 append decomp results ====    
spi_decomp_long <- bind_rows(spi_seas_1mo,  
                        spi_seas_2mo,  
                        spi_seas_3mo,  
                        spi_seas_4mo,  
                        spi_seas_6mo,  
                        spi_seas_9mo,  
                        spi_seas_12mo,  
                        spi_seas_18mo,  
                        spi_seas_24mo,  
                        ) %>%  
  as_tibble()  

sri_decomp_long <- bind_rows(sri_seas_1mo,  
                        sri_seas_2mo,  
                        sri_seas_3mo,  
                        sri_seas_4mo,  
                        sri_seas_6mo,  
                        sri_seas_9mo,  
                        sri_seas_12mo,  
                        sri_seas_18mo,  
                        sri_seas_24mo) %>%  
  as_tibble()   

# * clean up global environment  
rm(spi_seas_1mo,  
   spi_seas_2mo,  
   spi_seas_3mo,  
   spi_seas_4mo,  
   spi_seas_6mo,  
   spi_seas_9mo,  
   spi_seas_12mo,  
   spi_seas_18mo,  
   spi_seas_24mo,
   sri_seas_1mo,  
   sri_seas_2mo,  
   sri_seas_3mo,  
   sri_seas_4mo,  
   sri_seas_6mo,  
   sri_seas_9mo,  
   sri_seas_12mo,  
   sri_seas_18mo,  
   sri_seas_24mo)  

# 7 export results====     
#mclust_aug <- full_join(mclust_aug, sri_intermit,  
#                        by = "sta")  

export(spi_decomp_long, "data/spi_seas.csv")  
export(sri_decomp_long, "data/sri_seas.csv")  

```

```{r plot_spi-deconvolution} 

# * check for anomonies====        
spi_anom <- spi_decomp_long %>%   
  filter(anomaly == "Yes")  

# * vars for plotting====    
sta_size   <- 0.2   
sta_color  <- "black"  

# 1 spi_1mo observations plot====  
spi_obs <- spi_decomp_long %>%  
  filter(name == "sci_1mo") %>%  
  # set theme and facets  
  ggplot(aes(date, value)) +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(location)) +   
  theme_bw() +  
  xlab("") +  
  ylab("SPI 1-month") +   
  # plot station vals  
  geom_line(size   = sta_size,  
            colour = sta_color)    

# 2 spi seasons plot====   
spi_seas_plot <- spi_decomp_long %>%  
  filter(name == "sci_1mo") %>%  
  mutate(month = month(date)) %>% 
  select(month, location, season) %>%  
  distinct() %>%  
  # set theme and facets  
  ggplot(aes(month, season)) +  
  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_continuous(breaks = 1:12,   
                     labels = c("J", "F", "M", "A", "M", "J",  
                                "J", "A", "S", "O", "N", "D")) +  
  facet_wrap(vars(location)) +   
  theme_bw() +  
  xlab("") +  
  ylab("SPI 1-month") +   
  # plot station vals              
  geom_line(size   = sta_size,  
            colour = sta_color)    

# 3 spi trend plot====  
spi_trend_plot <- spi_decomp_long %>%  
  filter(name == "sci_1mo") %>%  
  # set theme and facets  
  ggplot(aes(date, trend)) +  
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(location)) +   
  theme_bw() +  
  xlab("") +  
  ylab("SPI 1-month") +   
  # plot station vals              
  geom_line(size   = sta_size,  
            colour = sta_color)    

# 4 spi remainder plot====   
spi_remain <- spi_decomp_long %>%  
  filter(name == "sci_1mo") %>%  
  # set theme and facets  
  ggplot(aes(date, remainder)) +  
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(location)) +   
  theme_bw() +  
  xlab("") +  
  ylab("SPI 1-month") +   
  # plot station vals              
  geom_line(size   = sta_size,  
            colour = sta_color)    

# 5 plot above as a grid & save====  
spi_obs / spi_seas_plot / spi_trend_plot / spi_remain   

ggsave("figure/spi_deconv.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  

# 6 clean up global environment====  
rm(spi_anom,  
   spi_obs,  
   spi_remain,  
   spi_seas_plot,  
   spi_trend_plot,  
   sta_color,  
   sta_size)  

```

```{r prepare_sri_plot} 

# prep_season_plot_sri----    
# 1 check for anomolies====  
sri_anom <- sri_decomp_long %>%  
  filter(anomaly == "Yes")  

# 2 relevel groups for plotting====  
sri_decomp_1mo <- sri_decomp_long %>%  
  filter(name == "sci_1mo")  

sri_decomp_1mo %<>%  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

# 3 get quantiles====  
sri_summary <- sri_decomp_1mo %>%  
  select(group, sci_1mo = value, season, trend, remainder) %>%  
  pivot_longer(-group) %>%   
  group_by(group, name) %>%  
  summarise(median = median(value),  
            lower  = quantile(value, probs = 0.25),  
            upper  = quantile(value, probs = 0.75),  
            high   = quantile(value, probs = 0.95),  
            low    = quantile(value, probs = 0.05)) %>%  
  ungroup() %>%  
  mutate_if(is.numeric, round, 2) %>%  
  pivot_wider(names_from = name,  
              values_from = c(median:low))  

sri_1mo <- full_join(sri_decomp_1mo, sri_summary,  
                        by = "group")  

# 4 pull fal-hot for plotting ====  
fal_hot <- sri_1mo %>%  
  filter(sta == "fal_hot")  

# 5 identify group max mins====  
seas_group_max <- sri_1mo %>%  
  group_by(group) %>%  
  slice(which.max(season)) %>%  
  ungroup() %>%  
  select(group, season_max = season)  

seas_group_min <- sri_1mo %>%   
  group_by(group) %>%  
  slice(which.min(season)) %>%  
  ungroup() %>%  
  select(group, season_min = season)  

seas_group_med <- sri_1mo %>%  
  group_by(group) %>%  
  summarise(season_med   = median(season)) %>%  
  ungroup() %>%  
  select(group, season_med)  

```

```{r plot-sri-deconvolution}

# 1 plot SRI obs, seasons, trend, and remainder----    
# * streamflow observations plot====  
sri_obs <- sri_1mo %>%   
  ggplot(aes(date, value)) +  
# set theme, labels, facets #  
  theme_bw() +  
  xlab("") +  
  ylab("SSI 1-month") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2) +   
# plot 5% & 95% as line segments #  
  geom_segment(aes(y = high_sci_1mo,  
                   x = date,  
                   yend = low_sci_1mo,  
                   xend = date),  
               colour          = "gray90") +  
# plot 25% & 75% as line segments #  
  geom_segment(aes(y = upper_sci_1mo,  
                   x = date,  
                   yend = lower_sci_1mo,  
                   xend = date),  
               colour          = "gray70") +  
# plot median value #  
  geom_line(aes(date, median_sci_1mo),  
            size        = 0.3,  
            colour      = "black") +  
  # plot all station vals #  
  geom_point(shape      = ".",  
            colour      = "black")  

# * streamflow seasons plot====    
sri_seas_plot <- sri_1mo %>%   
  mutate(month = month(date)) %>%  
  ggplot(aes(month, season)) +  
# set theme, labels, facets #  
  theme_bw() +  
  xlab("") +  
  ylab("SSI seasonal") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_continuous(breaks = 1:12,   
                     labels = c("J", "F", "M", "A", "M", "J",  
                                "J", "A", "S", "O", "N", "D")) +   
  facet_wrap(vars(group),   
             nrow = 2) +   
# plot 5% & 95% as line segments #  
  geom_segment(aes(y    = high_season,  
                   x    = month,  
                   yend = low_season,  
                   xend = month),  
               colour   = "gray80",  
               size     = 2) + 
# plot 25% & 75% as line segments #  
  geom_segment(aes(y    = upper_season,  
                   x    = month,  
                   yend = lower_season,  
                   xend = month),  
               size     = 2,  
               colour   = "gray60" ) + 
# plot median #  
  geom_line(aes(month, median_season),  
            size        = 0.3,  
            colour      = "black") +    
  # plot all station vals #  
  geom_point(size  = 0.5,  
            colour = "black")  

# * streamflow trend plot====  
sri_trend_plot <- sri_1mo %>%   
  ggplot(aes(date, trend)) +  
# set theme, labels, facets #  
  theme_bw() +  
  xlab("") +  
  ylab("SRI trend") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2) +   
# plot 5% & 95% as line segments #  
  geom_segment(aes(y    = high_trend,   
                   x    = date,  
                   yend = low_trend,  
                   xend = date),  
               colour   = "gray90") +  
# plot 25% & 75% as line segments #  
  geom_segment(aes(y    = upper_trend,  
                   x    = date,  
                   yend = lower_trend,  
                   xend = date),  
               colour   = "gray70") + 
# plot median #  
  geom_line(aes(date, median_trend),  
           size    = 0.3,  
            colour = "black") +  
  # plot all station vals #  
  geom_point(shape = ".",  
            colour = "gray30") +  
# plot fal-hot -- different from other BH Plateu stations #  
  geom_line(data     = fal_hot,  
            size     = 1,  
            linetype = 3,  
            colour   = "black")  

# * streamflow remainder plot====  
sri_remain <- sri_1mo %>%   
  ggplot(aes(date, remainder)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  xlab("") +  
  ylab("SSI remainder") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2) +   
  # plot 5% & 95% as line segments #  
  geom_segment(aes(y      = high_remainder,  
                   x      = date,  
                   yend   = low_remainder,  
                   xend   = date),  
               colour = "gray90") +  
  # plot 25% & 75% as line segments #  
  geom_segment(aes(y = upper_remainder,  
                   x      = date,  
                   yend   = lower_remainder,  
                   xend   = date),  
               colour = "gray70") +  
  # plot median #  
  geom_line(aes(date, median_remainder), 
            size   = 0.3,  
            colour = "black") +  
  # plot all station vals #  
  geom_point(shape  = ".",  
             colour = "gray30")  

# 2 plot above as a grid & save====  
sri_obs / sri_seas_plot / sri_trend_plot / sri_remain  

ggsave("figure/sri_deconv.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  

# 4 clean up global environment====  
rm(sri_anom,  
  sri_obs,  
  sri_remain,  
  sri_seas_plot,  
  sri_trend_plot,  
  fal_hot,  
  sri_summary,  
  sri_1mo,  
  sri_decomp_1mo,  
  seas_group_max,  
  seas_group_med,  
  seas_group_min)  

```


# SCI summary statistics 
```{r prepare-SPI1-summary-statistics-moderate}

# 1 set conditions for getting summary statistics  
SCI_hi   <- -1.50   # high boundary value  
SCI_lo   <- -1.00   # low boundary value  
sci_n    <-  1      # SCI accumulation length
duration <-  35     # days between observations  

# 1. create the set of SPI drought====  
sci_drought <- spi_decomp_long %>%  
 select(sci_value = value,  
         sta,  
         date,  
         sci_length = name) %>%  
  # prepare sci_length  
  mutate(sci_length = str_remove_all(sci_length, "sci_")) %>%   
  mutate(sci_length = str_remove_all(sci_length, "mo")) %>%  
  mutate(sci_length = as.numeric(sci_length)) %>%  
  # keep only sci of length n    
  filter(sci_length == sci_n) %>%                 
  filter(between(sci_value, SCI_hi, 0)) %>%   
  # drop possible duplicates   
  distinct(.keep_all = TRUE)                                    

# 2. create a df of start ids====  
sci_start <- sci_drought %>%  
  # keep only moderate drought start points  
  filter(between(sci_value, SCI_hi, SCI_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup() 

# 3. join start ids and drought obs====   
sci_obs <- left_join(sci_drought, sci_start,  
                   by = c("date", "sci_value", "sci_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) |  
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
# currently for only 1-9 months duration  
sci_obs <- sci_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
sci_obs <- sci_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(sci_value:sci_length)  

# 6 create a unique name for sci-n and type
spi1_mod <- sci_obs %>%  
  mutate(sci_n = "1") %>%  
  mutate(type = "moderate")  

# 6 clean up global enviroment====  

# 1 set conditions for getting summary statistics  
rm(SCI_hi,  
   SCI_lo,  
   sci_n,  
   duration)   

```

```{r prepare-SPI1-summary-statistics-severe}

SCI_hi <- -2.0   
SCI_lo <- -1.501  

# 1. create the set of SPI drought [-2, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, SCI_hi, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-2, -1.5]====  
spi1_sev_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, SCI_hi, SCI_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_sev_obs <- left_join(spi1_drought, spi1_sev_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
spi1_sev_obs <- spi1_sev_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
spi1_sev_obs <- spi1_sev_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length) %>%  
  mutate(type = "severe")    

# 6 clean up global enviroment====  
rm(spi1_drought)   

```

```{r prepare-SPI1-summary-statistics-extreme}

SCI_hi <- -2.5  
SCI_lo <- -2.001  

# 1. create the set of SPI drought [-2.5, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, SCI_hi, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-2, 1]====  
spi1_ext_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, SCI_hi, SCI_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_ext_obs <- left_join(spi1_drought, spi1_ext_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
spi1_ext_obs <- spi1_ext_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
spi1_ext_obs <- spi1_ext_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length) %>%  
  mutate(type = "extreme")  

# 6 clean up global enviroment====  
rm(spi1_drought, 
   duration, 
   SCI_hi, 
   SCI_lo)   

```

```{r join-SPI1-summary}

# 1 join observations -- drop duplicates  
spi1_obs <- bind_rows(spi1_ext_obs,  
                  spi1_sev_obs,  
                  spi1_mod_obs) %>%  
  group_by(sta) %>%  
  distinct(date, .keep_all = TRUE) %>%  
  ungroup()  

# 2 get drought count  
spi1_count <- spi1_obs %>%  
  group_by(sta, type) %>%  
  summarise(count = n_distinct(drought_id)) %>%  
  ungroup()  

# 3 get drought duration  
spi1_duration <- spi1_obs %>%  
  group_by(sta, type, drought_id) %>%  
  summarise(duration = n()) %>%  
  group_by(sta, type) %>%  
  summarise(min = min(duration),  
            max = max(duration),  
            mean = mean(duration), 
            median = median(duration))  %>%  
  ungroup()  

# 4 get drought severity  
spi1_severity <- spi1_obs %>%  
  group_by(sta, type, drought_id) %>%  
  summarise(severity = sum(spi_value)) %>%  
  group_by(sta, type) %>%  
  summarise(min = min(severity),  
            max = max(severity),  
            mean = mean(severity),  
            median = median(severity)) %>%  
  ungroup()  

# jon tables
spi1_summary <- full_join(spi1_count, spi1_duration, 
                          by = c("sta", "type"))  
spi1_summary <- full_join(spi1_summary, spi1_severity, 
                          by = c("sta", "type"))  

# x clean up global environment  
rm(spi1_ext_obs,  
   spi1_sev_obs,  
   spi1_mod_obs,  
   spi1_ext_start,  
   spi1_sev_start,  
   spi1_mod_start, 
   spi1_count,  
   spi1_duration,  
   spi1_severity,  
   spi1_obs)  
   
```

```{r prepare-SPI1-summary-statistics-moderate}

severity_hi <- -1.50  
severity_lo <- -1.00  
spi_n       <-  6  
duration    <-  35  

# 1. create the set of SPI drought [-1.5, 0]====  
spi6_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == spi_n) %>%                 
  filter(between(spi_value, severity_hi, 0)) %>%   
  # drop possible duplicates from SSI corr  
  distinct(.keep_all = TRUE)                                    

# 2. create a df of start ids [-2, 1]====  
spi6_mod_start <- spi6_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, severity_hi, severity_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup() 

# 3. join start ids and drought obs====   
spi6_mod_obs <- left_join(spi6_drought, spi6_mod_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
spi6_mod_obs <- spi6_mod_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) 

# PROBLEM #%>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) #%>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
spi1_mod_obs <- spi1_mod_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length) %>%  
  mutate(type = "moderate")  
 

# 6 clean up global enviroment====  
rm(spi1_drought)   

```

```{r prepare-SPI1-summary-statistics-severe}

severity_hi <- -2.0   
severity_lo <- -1.501  

# 1. create the set of SPI drought [-2, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, severity_hi, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-2, -1.5]====  
spi1_sev_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, severity_hi, severity_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_sev_obs <- left_join(spi1_drought, spi1_sev_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
spi1_sev_obs <- spi1_sev_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
spi1_sev_obs <- spi1_sev_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length) %>%  
  mutate(type = "severe")    

# 6 clean up global enviroment====  
rm(spi1_drought)   

```

```{r prepare-SPI1-summary-statistics-extreme}

severity_hi <- -2.5  
severity_lo <- -2.001  

# 1. create the set of SPI drought [-2.5, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, severity_hi, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-2, 1]====  
spi1_ext_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, severity_hi, severity_lo)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_ext_obs <- left_join(spi1_drought, spi1_ext_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. create unique droughts -- should do this as a loop!!====  
spi1_ext_obs <- spi1_ext_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop < non-moderate droughts====    
spi1_ext_obs <- spi1_ext_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length) %>%  
  mutate(type = "extreme")  

# 6 clean up global enviroment====  
rm(spi1_drought, 
   duration, 
   severity_hi, 
   severity_lo)   

```

# drought propogation
```{r prepare-SCI-correlation}

# 1 pivot SPI wider and drop non-important vars====  
spi_decomp <- spi_decomp_long %>%  
  group_by(sta, date) %>%  
  mutate(seas_trend = season + trend) %>%  
  ungroup() %>%  
  select(sta:location, name, value, season, trend, seas_trend) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  pivot_wider(names_from = name,  
              values_from = c(value, season, trend, seas_trend)) %>%  
  rename_at(vars(starts_with('value_')), ~ str_remove_all(., "value_"))  

# 2 pivot SRI wider and drop non-important vars====  
sri_decomp <- sri_decomp_long %>%  
  group_by(sta, date) %>%  
  mutate(seas_trend = season + trend) %>%  
  ungroup() %>%  
  select(sta:date, name, value, season, trend, seas_trend) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  pivot_wider(names_from = name, 
              values_from = c(value, season, trend, seas_trend)) %>%  
  rename_at(vars(starts_with('value_')), ~ str_remove_all(., "value_"))  

# 3 add location to mclust dataframe====  
# * identify gage locations    
mclust_aug <- import("data/lmom_mclust_fit.csv") %>%  
    rename(gage = sta)  

gage_location <- import("data/gage_meta.csv") %>%  
    rename(gage = sta)  

gage_location <- semi_join(gage_location, mclust_aug,  
                       by = "gage") %>%  
  mutate(north_group = case_when(   
    dec_lat_va > 43.5 ~ "N",   
    TRUE ~ "S")) %>%   
  mutate(east_group = case_when(  
    dec_long_va  > -100.67 ~ "E",  
    dec_long_va  > -102.33 ~ "C",    
    TRUE ~ "W")) %>%  
  mutate(location = str_c(north_group,  
                       east_group,   
                       sep = "")) %>%  
  select(gage, location)  

# * add location to mclust dataframe   
mclust_fin <- full_join(mclust_aug, gage_location,  
                         by = "gage") %>% 
  mutate(hydro_group = case_when(  
    hydro_group == "GW control" ~ "GW Control",  
    TRUE ~ hydro_group))

# * add location to SRI dataframe  
sri_decomp <- full_join(sri_decomp, gage_location,  
                        by = c("sta" ="gage")) %>%  
  rename(gage = sta)  

# 4 prepare for joining SCI dfs====   
spi_decomp <- spi_decomp %>%  
  rename_at(vars(contains('sci')), ~ str_replace_all(., "sci", "spi")) %>%  
  mutate(location = as.character(location))  

sri_decomp <- sri_decomp %>%  
  rename_at(vars(contains('sci')), ~ str_replace_all(., "sci", "sri"))  

# * join SRI and SPI====  
sci_decomp <- full_join(spi_decomp, sri_decomp,  
                       by = c("date", "location")) %>%  
  select(-contains("season_spi")) %>%  
  select(-contains("season_sri")) %>%    
  select(-contains("trend_spi"))  %>%  
  select(-contains("trend_sri")) %>%  
  select(sta, gage, location, group, ecoreg, date, everything())  

# 5 lag the SSI-1 values====  
#cross-correlations calculated for SSI-1 series which were lagged by 0 to 6  
# after the SPI series. In this case, the SPI accumulation period with the   
# strongest correlation with SSI-1 was denoted as the lagged SPI-n.

sci_cross_corr <- sci_decomp %>%  
  select(-c(prcp, sri_2mo:sri_24mo)) %>%  
  rename(sri_lag0 = sri_1mo) %>%  
  mutate(sri_lag1 = lag(sri_lag0, 1)) %>%  
  mutate(sri_lag2 = lag(sri_lag0, 2)) %>%  
  mutate(sri_lag3 = lag(sri_lag0, 3)) %>%  
  mutate(sri_lag4 = lag(sri_lag0, 4)) %>%  
  mutate(sri_lag5 = lag(sri_lag0, 5)) %>%  
  mutate(sri_lag6 = lag(sri_lag0, 6))     

# make sci longer for plotting as points====  
sci_ccor_long <- sci_cross_corr %>%  
  pivot_longer(cols = spi_1mo:spi_24mo,  
               names_to = "spi_length",  
               values_to = "spi_value",  
               values_drop_na = TRUE) %>%  
  pivot_longer(cols = sri_lag0:sri_lag6,  
               names_to = "sri_lag",  
               values_to = "sri_value",  
               values_drop_na = TRUE) %>%  
  mutate(spi_length = str_remove_all(spi_length, "[spi_mo]")) %>%  
  mutate(sri_length = str_remove_all(sri_lag, "[sri_lag]")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  mutate(sri_lag = as.numeric(sri_length)) %>%     
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))   

# * clean up global environment====  
rm(mclust_aug,  
   gage_location,  
   spi_decomp,  
   sri_decomp, 
   seas_group_max, 
   seas_group_med, 
   seas_group_min, 
   spi_decomp_long)  

```

```{r SCI-correlation}

# 1 prepare for SPI & SRI correlations====  
sci_corr <- sci_cross_corr %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%  
  # drop longer than 1 month correlations for SRI  
  correlate(method = "pearson") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
#  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 2 make SPI correlation table ====  
spi_corr_table <- sci_corr %>%  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^spi")) %>%  
  spread(y, r) %>%   
  select(-spi_12mo, spi_12mo) %>%  
  select(-spi_18mo, spi_18mo) %>%  
  select(-spi_24mo, spi_24mo) %>%  
  column_to_rownames(var = "x") %>%  
  arrange(spi_18mo)  

# 3 make SRI lag corr table====   
sri_corr_table <- sci_corr %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  spread(y, r) %>%   
  rename(lag =  x) %>%  
  mutate(lag = str_remove_all(lag, "[sri_lag]"))   

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
sci_corr_table <- sci_corr %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(lag =  y) %>%  
  arrange(r) %>%  
 # remove characters and transform to numeric  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(lag = str_remove_all(lag, "[sri_lag]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate(lag = as.numeric(lag)) 

# 5 calculate correlation coefficents for SPI-SRI by gage====  
sci_corr_sta <- sci_cross_corr %>%  
  select(-c(group, sta, location, ecoreg, date)) %>%  
  # group by gage, nest, and correlate  
  group_by(gage) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "pearson")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1mo:spi_24mo)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_lag0:sri_lag6),  
               names_to = "lag",  
               values_to = "r") %>%  
  # remove characters and transform to numeric  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%   
  mutate(lag = str_remove_all(lag, "[sri_lag]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate(lag = as.numeric(lag))  

# * add back hydrologic group  
hydro_group <- mclust_fin %>%   
  select(gage, hydro_group)  

sci_corr_sta <- full_join(sci_corr_sta, hydro_group) %>%  
  rename(group = hydro_group) %>%  
  mutate(group = factor(group)) %>%   
  # relevel groups for plotting  
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  %>%  
  mutate_if(is.numeric, round, digits = 2) 

```

Drought propagation
Streamflow integrates hydrogeological processes at the watershed catchment-scale.  Comparison of SPI and SSI provides an indication of how long it takes for precipitation deficits to propagate through the hydrological cycle and appear as streamflow deficits. {Barker:2016ua}.  The 1-month SSI also provides a good description of low flows, similar to the 30-day mean flow, which is often used in studies of annual minimum flows {Gustard:1992vo, Barker:2016ua}.  We cross-correlated SPI accumulation periods of 1– 24 months and 1-month SSI (SSI-1) time series using the Spearman coefficient to analyze the most appropriate accumulation period of SPI to characterize to SSI- 1. 






START HERE 
```{r plot-SCI-correlation}  


# plot r vs spi - lags====     
sci_corr_sta %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = lag, y = r, group = group)) +  
  facet_wrap(vars(spi),   
             nrow = 3) +   
  # set theme, labels, facets #   
  theme_bw() + 
  geom_smooth(se = FALSE, 
              aes(linetype = group,  
                  color = group)) +  
  scale_colour_viridis_d()    
  #  xlab("") +  
  #  ylab("SRI 1-month") +    
  #  scale_y_continuous(limits = c(-3, 3)) +  
#  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12, 18, 24)) +   

sci_corr_sta %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = r, group = group)) +  
  facet_wrap(vars(lag),   
             nrow = 3) +   
  # set theme, labels, facets #   
  theme_bw() + 
  geom_smooth(se = FALSE, 
              aes(linetype = group,  
                  color = group)) +  
  scale_colour_viridis_d()  
  # plot xxx #  
#  geom_point(aes(#shape = group,  
 #               color = group,)) +  


# SPI corr short====  
sci_corr_tab <- sci_corr_group %>%  
  group_by(group, spi)  %>%  
  summarize(r = max(r)) %>%  
  ungroup() 

sci_corr_tab <- left_join(sci_corr_tab, sci_corr_group)  

sci_corr_table <- sci_corr_tab %>% 
  group_by(group, spi)  %>%  
summarise(mean_lag = mean(lag)) %>% 
  ungroup()  



test <- sci_corr_tab %>% 
  group_by(spi, lag)  %>% 
  summarise(count = n()) #%>% 



test2 <- full_join(sci_corr_tab, test) %>% 
  group_by(spi)



# plot r vs spi - lags====     
sci_corr_table %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = mean_lag, group = group)) +  
  # set theme, labels, facets #   
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +    
  #  scale_y_continuous(limits = c(-3, 3)) +  
#  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12, 18, 24)) +   
  facet_wrap(vars(group),   
             nrow = 2) +   
#  # plot xxx #  
geom_smooth(method = "loess") + 
geom_point()  
#  geom_point(aes(#shape = group,  
 #               color = group,)) +  
  geom_line(
    aes(linetype = group, 
        color = group)) +
  scale_colour_viridis_d()   

  
sci_corr_table %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = mean_lag, group = group)) +  
  # set theme, labels, facets #   
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +    
  #  scale_y_continuous(limits = c(-3, 3)) +  
#  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12, 18, 24)) +   
#  facet_wrap(vars(lag),   
#             nrow = 3) +   
  # plot xxx #  
geom_point() 
+ 
geom_smooth()
#  geom_point(aes(#shape = group,  
 #               color = group,)) +  
  geom_line(
    aes(linetype = group, 
        color = group)) +
  scale_colour_viridis_d()   


```



<!--  

```{r prepare-SPI1-summary-statistics-moderate-old}

duration <-  35    # days
severity <- -1.5  

# 1. create the set of SPI drought [-1.5, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, !!!severity, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-1.5, 1]====  
spi1_mod_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, !!!severity, -1)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_mod_obs <- left_join(spi1_drought, spi1_mod_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. moderate - create unique droughts -- should do this as a loop!!====  
spi1_mod_obs <- spi1_mod_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 1-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop non-moderate droughts====    
spi1_mod_obs <- spi1_mod_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length)  

# 6 clean up global enviroment====  
rm(spi1_mod_start,  
   spi1_drought)  

```

```{r old-drop}

# create a drought span == 1-month duration  
#drought_mod <- drought_mod %>%  
#  mutate(date_lag = lag(date, 1)) %>%  
  mutate(span = date - date_lag) %>%  

  


# create a drought span == 2-month duration    
drought_mod <- drought_mod %>%    
  mutate(date_lag = lag(date, 2)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id2, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 65 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id)) 


  # create a drought span == 3-month duration  
drought_mod <- drought_mod %>%    
  mutate(date_lag = lag(date,3)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 95 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id)) %>%  
  # create a drought span == 3-month duration  
  mutate(date_lag = lag(date,4)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 125 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id))  


```

#  # get deviations from the mean  
#  unite("spi_lag", spi:lag, remove = FALSE) %>%  
#  group_by(spi_lag) %>%   
#  mutate(r_mean = mean(r, na.rm = TRUE)) %>%  
#  ungroup() %>%  
#  mutate(deviation = r - r_mean) #%>%  

# check on these !!  
# check sri drought====  
spi_drought <- sci_long %>%  
#  filter(spi_length <= 4) %>%   
  filter(sri_value <= -0.8)  

spi_drought_mid <- sci_long %>%  
  filter(spi_length == 6) %>%   
  filter(spi_value <= -0.8)  
```{r other spi correlations -drop}



# plot spi vs sri====  
sci_long %>%  
#  filter(group == "Pierre Shale Low") %>%  
  filter(spi_length == 12) %>% 
  filter(sri_length == 12)  %>%  
  select(-c(spi_length, sri_length)) %>% 
  pivot_longer(cols = spi_value:sri_value) %>%  
  ggplot(aes(x = date, y = value)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  facet_grid(cols = vars(name),  
             rows = vars(group)) +   
  # plot xxx #  
  geom_point(color = "gray50",  
             shape = ".") +  
  geom_smooth() + 
  geom_hline(yintercept = 0, 
             color = "gray80")

# plot deviation vs spi====  
sci_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  

```

```{r plot_drought-corr-short}

# plot rho vs spi====  
drought_corr_s_group %>%  
  filter(rho > 0.25) %>% 
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = rho, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
geom_point(aes(shape = group,  
                color = group)) +   
    geom_line(aes(linetype = group,  
                color = group)) +  
  scale_colour_viridis_d()  
  
# plot deviation vs spi====  
drought_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  


scale_x_continuous(breaks = c(2, 4, 6))
```

```{r plot_drought-corr-mid}

# plot rho vs spi====  
drought_corr_group %>%  
  filter(rho > 0) %>%  
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = rho, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
geom_point(aes(shape = group,  
                color = group)) +   
    geom_line(aes(linetype = group,  
                color = group)) +  
  scale_colour_viridis_d()  
  
# plot deviation vs spi====  
drought_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  


scale_x_continuous(breaks = c(2, 4, 6))
```

```{r SCI-correlation_drought}

# 1 prepare for SPI & SRI correlations====  
sci_drought_all <- spi_drought %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_corr <- sci_drought_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr <- sci_drought_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_group <- spi_drought %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_drought-short}

# 1 prepare for SPI & SRI correlations====  
sci_drought_s_all <- spi_drought_short %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_s_corr <- sci_drought_s_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr_s <- sci_drought_s_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_s_group <- spi_drought_short %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_drought-midt}

# 1 prepare for SPI & SRI correlations====  
sci_drought_m_all <- spi_drought_mid %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_s_corr <- sci_drought_s_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr_s <- sci_drought_s_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_m_group <- spi_drought_mid %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_all-values-drop}

# 1 prepare for SPI & SRI correlations====  
sci_corr_all <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp, group)) %>%    
  correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 2 make SPI correlation table ====  
spi_corr_table <- sci_corr_all %>%  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^spi")) %>%  
  spread(y, rho) %>%   
  select(-spi_12mo, spi_12mo)  

# 3 make SRI corr table====  
sri_corr_table <- sci_corr_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12mo, sri_12mo)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
sci_corr <- sci_corr_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
sci_corr_group <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1mo:spi_12mo)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1mo:sri_12mo),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  # get deviations from the mean  
#  mutate(rho_noGW = case_when(  
#    group == "GW Control" ~ NA_real_,   
#    TRUE ~ rho)) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r plot-SCRATCH}
# 6 create group max mins====  
#seas_group <- full_join(seas_group_min, seas_group_max,  
#                        by = "group")  
#seas_group <- full_join(seas_group, seas_group_med,  
#                        by = "group")  

# * clean up global environment  
#rm(seas_group_max,  
#   seas_group_med,  
#   seas_group_min)  
# rm(seas_group)  
```

```{r SCRATCH4} 
# 1.2 SCI calcs - bhp_fal -- set up station for sci & make sci list vars====   
sta      <- bhp_fal_v   
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 4 (MAR-APR)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 1, 5 (NOV-JAN) (MAR-MAY)   
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    # MLE fail for month 6 (JAN-JUN)   
sci_9mo  <- sci.fun(sta, 9)    # MLE fail for month 8 (DEC-AUG)  
sci_12mo <- sci.fun(sta, 12)   # MLE fail for month 8, 9 (AUG & SEP)  

# * bhp_fal -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bhp_fal -- bind and rename the sci vals====       
sci_bhp_fal <- bind_cols(bhp_fal,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value) %>%  
  rename(sci_2mo = value1) %>%   
  rename(sci_3mo = value2) %>%  
  rename(sci_4mo = value3) %>%   
  rename(sci_6mo = value4) %>%   
  rename(sci_9mo = value5) %>%  
  rename(sci_12mo = value6)  

# * bhp_fal -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_fal, bhp_fal_v)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# * bha_frn -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bha_frn -- bind and rename the sci vals====       
sci_bhp_frn <- bind_cols(bhp_frn,       
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,    
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * bha_frn -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_frn, bhp_frn_v)   


```

```{r SCRATCH3}

# * bhp_bat -- bind and rename the sci vals====         
sci_bhp_bat <- bind_cols(bhp_bat,     
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,   
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)   

# * bhp_bat -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_bat, bhp_bat_v)   

``` 

```{r sthings}
# working from here----
library(igraph)
library(ggraph) 
library("ggcorrplot")

  
#  rename(rho = r) %>%  
#  fashion() #%>%  
# transforms the 'no quote' class from 
#  as.matrix() %>%  
#  as_tibble() %>%  
#  mutate(rho = as.numeric(rho)) %>%  
  
  # 3 ?? prepare SPI for plotting ??====  
#  mutate(x = str_remove_all(x, "spi_")) %>%  
#  mutate(y = str_remove_all(y, "spi_")) %>%  

# make SPI corr table2 - not working yet  
#spi_corr %>% 
#  column_to_rownames(spi, var = "spi")
#  as.matrix() %>%  
  
#ggcorrplot()  
# working====  
sci_corr_group <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%    
  group_by(group) %>% ## avoids calling data = everything() below  
  nest() %>%  
#  mutate(data = map(data, 
#                    purrr::compose(stretch, correlate,  
#                                   method = "spearman"))) %>% 
  mutate(data = map(data, c
                    purrr::compose(stretch, correlate,  
                                   method = "spearman"))) %>% 
  unnest() %>%  
#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)

# working====  
mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%  
#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)


sci_corr_table <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%    
  group_by(group) %>% ## avoids calling data = everything() below  
  nest() %>%  
  mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%  
  drop_na()  

#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)


# interesting graph----
ggraph(spi_corr, layout = "kk") +
  geom_edge_link(aes(edge_alpha = abs(r), color = r), edge_width = 5) +
  guides(edge_alpha = "none") +
  scale_edge_colour_gradientn(limits = c(-1, 1), colors = heat.colors(5)) +
  geom_node_point(color = "black", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) +
#  facet_edges(~group) +
  theme_minimal() 

sci_corr_table1

test2 <- sci_corr %>%  

  
  split(.$group) %>% 
  correlate(method = "spearman") %>%  
  mutate_if(is.numeric, round, 2) %>%  
  ungroup()  
#  filter(str_detect(rowname, "sri")) #%>% 

#  column_to_rownames("final_group")      
  select(rowname:spi_12mo) 
  %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  select(-sri_12mo, sri_12mo) %>% 
  rownames_to_column() %>% 
  mutate(rowname = case_when( 
    rowname == "2" ~ "10", 
    TRUE ~ rowname)) %>% 
  mutate(rowname = as.integer(rowname)) %>% 
  arrange(rowname) %>% 
  select(-rowname)
  
  

# [WORKING] 5 correlate SPI and SRI====  

weather_cor <- weather_sub %>%
  group_by(origin) %>% ## redundant but worth it for illustration
  nest() %>%
  mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%

  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)

```

```{r eda_plot_series} 
# needs work!
mon_plot <- sci_1mo %>%  
  ggplot(aes(x = spi_length_12, y = sci_val)) + 
  theme_bw() + 
  facet_wrap(vars(sci_val), 
             ncol =2) +
  geom_jitter(size = .1) + 
  geom_smooth() +
  geom_abline(slope = 1 , intercept = 0)

mon_plot
eco_plot <- sci_1mo %>%  
  ggplot(aes(x = spi_length_12, y = sci_val)) + 
  theme_bw() + 
  facet_wrap(vars(ecoreg), 
             ncol =2) +
  geom_jitter(size = .1) + 
  geom_smooth() +
  geom_abline(slope = 1 , intercept = 0) 

```

```{r create-models}
# http://environmentalcomputing.net/intro-to-gams/ -- check this!
# https://multithreaded.stitchfix.com/blog/2015/07/30/gam/ 

# Consider that different months might behave differently!
# Also consider that different drought lengths might behave differently!

test <- sci %>% 
  select(sci_length) %>% 
  distinct() 

# load gam model -- mgcv 
library(mgcv) 

# walk before you run 
#sci_1mo_nest <- sci_1mo %>% 
#  group_by(ecoreg) %>% 
#  nest()  

sci_1mo_input <- sci %>% 
  filter(sci_length == 1) %>% 
  group_by(sta, mon, spi_length) %>% 
  nest()

#define function for linear model
sci_1mo_lm <-function(df) {
  lm(sci_val ~ spi_val, data = df)
}

#define function for GAM 
sci_1mo_gam <- function(df) {
  gam(sci_val ~ s(spi_val), 
                   method = "REML", 
                   data = df)
} 
  
# create columns for the models
sci_models <- sci_1mo_input %>%
        mutate(model_lm = map(data, sci_1mo_lm),
               model_gam = map(data,sci_1mo_gam)
               )

# extract models 
models_details<-sci_models %>%
        mutate(
                glance_lm  = model_lm %>% 
                  map(glance),  #model summary 
                AIC_lm     = glance_lm %>% 
                  map_dbl("AIC"),  #extract AIC   
                glance_gam = model_gam %>% 
                  map(broom::glance), #GAM model summary  
                AIC_gam    = glance_gam %>% 
                  map_dbl("AIC"), #extract AIC
                tidy_lm    = model_lm %>% 
                  map(tidy), #model estimate: coeff...
                tidy_gam    = model_gam %>% 
                  map(tidy), #model estimate: coeff...
                rsq_lm      = glance_lm %>% 
                  map_dbl("r.squared"),  #extract rsquared 
                augment_lm = model_lm %>% 
                  map(augment), #observation stats: resid,hat...
                res_lm        = augment_lm %>% 
                  map(".resid") #extract resid
               ) %>% 
  mutate(AIC_diff = AIC_lm - AIC_gam) 

test <- sci_models %>% 
  mutate(R.square = map_dbl(model_gam, ~ summary(.)$r.sq)) %>% 
  select(R.square)

test2 <- test %>% 
  group_by(ecoreg, spi_length) %>%  
  summarize(rsq_mean     = mean(R.square),  
            rsq_median   = median(R.square), 
            rsq_75       = quantile(R.square, probs =.75), 
            rsq_25       = quantile(R.square, probs =.25), 
            rsq_min      = min(R.square), 
            rsq_max      = max(R.square)          
            ) %>% 
  ungroup()
  


  
out <- models_details %>% 
  group_by(ecoreg, spi_length) %>%  
  summarize(AIC_mean     = mean(AIC_diff),  
            AIC_median   = median(AIC_diff), 
            AIC_75       = quantile(AIC_diff, probs =.75), 
            AIC_25       = quantile(AIC_diff, probs =.25), 
            AIC_min      = min(AIC_diff), 
            AIC_max      = max(AIC_diff) , 
            deviance_gam = median(deviance_gam)           
            ) %>% 
  ungroup()

out2 <- out %>% 
  arrange(desc(deviance_gam)) 

  summarize(deviance = ma)
```

```{r model-plot}
# make a boxplot of the three models   

out2 %>%
  ggplot() +   
  theme_bw() + 
  facet_wrap(vars(spi_length), 
             ncol = 3, 
           scale = "free") +   
#geom_point()
  geom_boxplot(aes(x = factor(ecoreg),  
#                   group = ecoreg,  
                   lower = `AIC_25`,  
                   upper = `AIC_75`,  
                   middle = `AIC_median`,  
                   ymin = `AIC_min`,  
                   ymax = `AIC_max`),  
               stat = "identity") 

test2 %>%
  ggplot() +   
  theme_bw() + 
  facet_wrap(vars(ecoreg), 
             ncol = 3 #, 
#           scale = "free"
) +   
  geom_boxplot(aes(x = factor(spi_length),  
#                   group = ecoreg,  
                   lower = `rsq_25`,  
                   upper = `rsq_75`,  
                   middle = `rsq_median`,  
                   ymin = `rsq_min`,  
                   ymax = `rsq_max`),  
               stat = "identity") 


```

```{r time-series-correlation_join_sci}    
#  start by walking ----  

# keep only the 1-mo vals as a response variable -- checking step
#sci_gage_1mo <- sci_gage %>%  
 # filter(sci_length == 1)  
  
sci <- full_join(sci_gage, sci_sta,  
                     by = c("group", "date")) %>%  
  drop_na() %>%   
#  spread(spi_length, spi_val, sep = "_") %>%  
#  drop_na() %>%  
  # reorder factors by ecoreg 
  mutate(ecoreg = fct_relevel(ecoreg, 
                              "Pierre Shale Plains", 
                              "Pine Ridge Escarpment",  
                              "White River Badlands", 
                              "Black Hills Plateau", 
                              "Keya Paha Tablelands", 
                              "Sand Hills")) %>% 
  mutate(year = year(date)) %>% 
  mutate(mon = month(date))
  
# check for na values ====  
# the '2' beelow refers to columns 
indx <- sci %>%
  apply(2, 
        function(x) any(is.na(x) | is.infinite(x))
        ) %>%   
enframe()  

rm(indx) 

# make a 'biology' series====  
# using april = 4, may = 5, june = 6 - idea --
#sci_1mo_b <- sci_1mo %>% 
#  filter(mon == 4 | 
#           mon == 5 | 
#           mon == 6)  
  
```

```{r time-series-correlation_prepare_sci-old}    
  
# import gage group to fix the 'group' -- used for function call above====   
gage_group <- import("data/gage_meta_seas.csv") %>%  
 rename(gage = sta) %>%  
  mutate(north_group = case_when(   
    dec_lat_va > 43.5 ~ "N",   
    TRUE ~ "S")   
  ) %>%   
  mutate(east_group = case_when(  
    dec_long_va  > -100.67 ~ "E",  
    dec_long_va  > -102.33 ~ "C",    
    TRUE ~ "W")  
  ) %>%  
  mutate(group = str_c(north_group,  
                       east_group,   
                       sep = "")) %>%  
  select(gage, group)   
  
# import gage & fix 'group' which was used above====    
sci_gage <- import("data/sri_seas.csv") %>%    
  mutate(date = ymd(date)) %>%  
  rename(gage = sta) %>%  
  select(-group)  

# join group & spi data====    
sci_gage <- full_join(gage_group, sci_gage, 
                      by = "gage") %>%   
  mutate(min_date_gage = min(date)) %>%    
  mutate(max_date_gage = max(date)) %>%  
  select(-c(log_q1_mon,  
            season,  
            trend,  
            remainder,  
            remainder_l1,  
            remainder_l2,  
            anomaly  
  )) %>%  
# arrange data from wide to long -- spi_length is used in the join below
  gather(key   = sci_length,   
         value = sci_val,   
         -c(group,   
            date,   
            gage,   
            ecoreg,   
            min_date_gage,   
            max_date_gage    
         )) %>%    
  ungroup() %>%   
# prepare for joining by spi_length  
  mutate(sci_length = str_remove_all(sci_length, "mo")) %>%     
  mutate(sci_length = str_sub(sci_length, start = 5) %>% as.numeric)  
  
rm(gage_group)  
```  

```{r time-series-correlation_prepare_spi-old1}  

# 1 get data====  
#spi_seas  <- import("data/spi_seas.csv")   
#sri_final <- import("data/sri_final.csv")   

# 2 identify gage locations====     
mclust_fin <- import("data/mclust_final.csv") %>%  
    rename(gage = sta)  

gage_location <- import("data/gage_meta.csv") %>%  
    rename(gage = sta)  

gage_location <- semi_join(gage_location, mclust_fin,  
                       by = "gage") %>%  
 # select(gage, dec_lat_va, dec_long_va) %>%   
  mutate(north_group = case_when(   
    dec_lat_va > 43.5 ~ "N",   
    TRUE ~ "S")   
  ) %>%   
  mutate(east_group = case_when(  
    dec_long_va  > -100.67 ~ "E",  
    dec_long_va  > -102.33 ~ "C",    
    TRUE ~ "W"))%>%  
  mutate(location = str_c(north_group,  
                       east_group,   
                       sep = "")) %>%  
  select(gage, location)  

# * add location to mclust dataframe====  
mclust_fin <- full_join(mclust_fin, gage_location,  
                         by = "gage")  

# 3 drop season & trend variables from SPI and SRI dataframes====  
spi_corr <- spi_seas %>%  
  select(-c(prcp,  
            season:anomaly)) %>%  
  pivot_longer(-c(sta, date, location)) %>%  
  mutate(name = str_replace_all(name, "sci", "spi")) %>%   
  pivot_wider()  

# 3 join SRI and SRI by location and date====  
# * add gage location to SRI dataframe====  
sri_corr <- full_join(sri_final, gage_location,  
                         by = c("sta" ="gage")) %>%  
  select(-c(log_q1_mon,  
            ecoreg,  
            group,  
            remainder_l1,  
            remainder_l2,  
            anomaly)) %>%  
  select(sta, final_group, location, everything()) %>%  
  rename(gage = sta) #%>%  
  pivot_longer(-c(gage, date, location, final_group)) %>%  
  mutate(name = str_replace_all(name, "sci", "sri")) %>%   
  pivot_wider()  

# * join SRI and SPI & clean up global environment====  
sci_corr <- full_join(spi_corr, sri_corr)  

rm(gage_location,  
   spi_seas,  
 #  sri_seas,  
   sri_final,  
   spi_corr,  
   sri_corr)    

# [WORKING] prepare to correlate SPI and SRI====  
sci_drought <- sci_corr %>%  
  pivot_longer(c(spi_1mo:spi_12mo)) %>%   
  filter(value <= -0.8) %>%  
  pivot_wider() %>%     
  filter(final_group == "Black Hills Plateau") 
  
# [WORKING] 4 prepare to correlate SPI and SRI--filter SRI drought months====  
#test <- sci_corr %>%  
#  filter(final_group == "Black Hills Plateau") 
#  
#  rename(current = spi_1mo) %>%  
#  mutate(spi_1mo = lag(current, 1)) %>%  
#  select(sta:current, spi_1mo, everything())  

ggplot(sci_drought, aes(spi_1mo, sri_2mo)) + 
  geom_point() +  
  geom_smooth()


# [WORKING] 5 correlate SPI and SRI====  
test2 <- sci_drought %>%  
  select(-c(sta, date, location, gage, final_group)) %>%  
#  column_to_rownames("final_group")  
  correlate(method = "spearman") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  filter(str_detect(rowname, "sri")) #%>% 
    
  select(rowname:spi_12mo) 
  %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  select(-sri_12mo, sri_12mo) %>% 
  rownames_to_column() %>% 
  mutate(rowname = case_when( 
    rowname == "2" ~ "10", 
    TRUE ~ rowname)) %>% 
  mutate(rowname = as.integer(rowname)) %>% 
  arrange(rowname) %>% 
  select(-rowname)

```

```{r summarise_sri}

# Get counts of high and low vals====  
# * summarize high and low flow values====  
summary_prop <- sci_gage %>%  
    group_by(group) %>%  
    summarise(n = n()) 

summary_high <- sci_gage %>%  
  filter(value >= 3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()  

summary_low <- sci_gage %>%  
  filter(value <= -3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()   

# * get high and low flow counts by year and month====  
# * summarize year====  
high_year <- summary_high %>%  
  group_by(group, year) %>%  
  summarise(high_year = sum(count)) %>%  
  ungroup() 

low_year <- summary_low %>%  
  group_by(group, year) %>%  
  summarise(low_year = sum(count)) %>%  
  ungroup()  

# join the high and low year values 
exceed_year <- full_join(high_year, low_year,  
                         by = c("group", "year")) %>%  
  replace_na(list(low_year = 0, high_year = 0)) %>%  
  mutate(low_year = -low_year) %>% 
  pivot_longer(c(high_year, low_year),  
               names_to = "key",  
               values_to = "value")  

# * create year proportations====  
exceed_year <- full_join(exceed_year, summary_prop, 
                         by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>% 
  mutate(group = fct_relevel(group,  
                             "GW control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * summarize month====  
high_month <- summary_high %>%  
  group_by(group, month) %>%  
  summarise(high_month = sum(count)) %>%  
  ungroup()  

low_month <- summary_low %>%  
  group_by(group, month) %>%  
  summarise(low_month = sum(count)) %>%  
  ungroup()  

# join the high and low month values  
exceed_month <- full_join(high_month, low_month,  
                         by = c("group", "month")) %>%  
  replace_na(list(low_month = 0, high_month = 0)) %>%  
  mutate(low_month = -low_month) %>% 
  pivot_longer(c(high_month, low_month),  
               names_to = "key",  
               values_to = "value")  

# * create month proportations====  
exceed_month <- full_join(exceed_month, summary_prop, 
                         by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>%  
  mutate(group = fct_relevel(group,  
                             "GW control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * clean up global environment====  
rm(summary_high,  
   summary_low,  
   summary_prop,  
   high_year,  
   low_year,  
   high_month,  
   low_month)  
  
``` 

```{r prepare_SRI-trend}  

# 2 prepare input for SCI====    
sri_input <- semi_join(gage_mon_sri, mclust_aug,  
                       by = "sta") %>% 
  rename(date = Date) %>%   
  arrange(date) %>%  
  select(  
    sta,  
    ecoreg,  
    date,  
    log_q1_mon)  

# * double-check input data====  
sri_input %>%  
  group_by(sta) %>%  
  summarise(min = min(date), 
            max = max(date)  
  )  

# 3 prepare vector inputs as double for SCI fun----  
# 3.1 Black Hills Plateau (bhp) gages====    
bhp_bat <- sri_input %>%  
  filter(sta == "bat_her")    

bhp_fal <- sri_input %>%  
  filter(sta == "fal_hot")   

bhp_frn <- sri_input %>%  
  filter(sta == "frn_fai")    

bhp_bat_v <- as.double(bhp_bat$log_q1_mon)   
bhp_fal_v <- as.double(bhp_fal$log_q1_mon)  
bhp_frn_v <- as.double(bhp_frn$log_q1_mon)  

# 3.2 GW-control (gwc) gages====    
gwc_bev <- sri_input %>%  
  filter(sta == "bev_buf")  

gwc_lcr <- sri_input %>%  
  filter(sta == "lcr_bel")     

gwc_bev_v <- as.double(gwc_bev$log_q1_mon)  
gwc_lcr_v <- as.double(gwc_lcr$log_q1_mon)   

# 3.3 Keya Paha Tablelands (kpt) gages====   
kpt_key <- sri_input %>%   
  filter(sta == "key_key")   

kpt_wew <- sri_input %>%  
  filter(sta == "key_wew")   

kpt_key_v <- as.double(kpt_key$log_q1_mon)   
kpt_wew_v <- as.double(kpt_wew$log_q1_mon)   

# 3.4 Pierre Shale Low (psl) gages====     
psl_brs <- sri_input %>%  
  filter(sta == "brsf_co")    

psl_elk <- sri_input %>%  
  filter(sta == "elk_elm")   

psl_hat <- sri_input %>%  
  filter(sta == "hat_edg") 

psl_bad <- sri_input %>%  
  filter(sta == "bad_fpi") 

psl_hor <- sri_input %>%  
  filter(sta == "hor_oel")  

psl_brs_v <- as.double(psl_brs$log_q1_mon)   
psl_elk_v <- as.double(psl_elk$log_q1_mon)   
psl_hat_v <- as.double(psl_hat$log_q1_mon)   
psl_bad_v <- as.double(psl_bad$log_q1_mon)   
psl_hor_v <- as.double(psl_hor$log_q1_mon)   

# 3.5 Pierre Shale High (psh) gages====     
psh_bat <- sri_input %>%  
  filter(sta == "bat_bhr")    

psh_che <- sri_input %>%  
  filter(sta == "che_was")    

psh_whi <- sri_input %>%  
  filter(sta == "whi_oac")    

psh_bat_v <- as.double(psh_bat$log_q1_mon)   
psh_che_v <- as.double(psh_che$log_q1_mon)   
psh_whi_v <- as.double(psh_whi$log_q1_mon)  

# 3.6 Sand Hills (snd) gages====   
snd_lon <- sri_input %>%  
  filter(sta == "lon_riv")     

snd_mar <- sri_input %>%  
  filter(sta == "lwr_mar")     

snd_ros <- sri_input %>%  
  filter(sta == "lwr_ros")     

snd_vet <- sri_input %>%  
  filter(sta == "lwr_vet")     

snd_whi <- sri_input %>%  
  filter(sta == "lwr_whi")    

snd_nio <- sri_input %>%  
  filter(sta == "nio_spa")     

snd_lon_v <- as.double(snd_lon$log_q1_mon)   
snd_mar_v <- as.double(snd_mar$log_q1_mon)   
snd_ros_v <- as.double(snd_ros$log_q1_mon)   
snd_vet_v <- as.double(snd_vet$log_q1_mon)   
snd_whi_v <- as.double(snd_whi$log_q1_mon)   
snd_nio_v <- as.double(snd_nio$log_q1_mon)   

# 3.7 Tertiary Clay (ter) gages====   
ter_ogl <- sri_input %>%  
  filter(sta == "whi_ogl")   

ter_sta <- sri_input %>%  
  filter(sta == "whi_sta")   

ter_whi <- sri_input %>%  
  filter(sta == "whi_kad")  

ter_ogl_v <- as.double(ter_ogl$log_q1_mon)   
ter_sta_v <- as.double(ter_sta$log_q1_mon)   
ter_whi_v <- as.double(ter_whi$log_q1_mon)   


# 4.0 clean up global enviroment====    
rm(sri_input)   

```  

```{r calculate_SRI}  

# 1.0 calculate SCI_blp====  
# 1.1 SCI calcs - bhp_bat -- set up station for sci & make sci list vars====  
sta      <- bhp_bat_v    
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                           
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   

# * bhp_bat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo,  
                         sci.limit = sci.limit) %>%   
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)    
  
sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)  
  
sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  
  
sci_12mo <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_12mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)   

# * bhp_bat -- bind and rename the sci vals====         
sci_bhp_bat <- bind_cols(bhp_bat,     
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,   
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)   

# * bhp_bat -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo  
)      
rm(bhp_bat, bhp_bat_v)   
  
# 1.2 SCI calcs - bhp_fal -- set up station for sci & make sci list vars====   
sta      <- bhp_fal_v   
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 4 (MAR-APR)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 1, 5 (NOV-JAN) (MAR-MAY)   
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    # MLE fail for month 6 (JAN-JUN)   
sci_9mo  <- sci.fun(sta, 9)    # MLE fail for month 8 (DEC-AUG)  
sci_12mo <- sci.fun(sta, 12)   # MLE fail for month 8, 9 (AUG & SEP)  

# * bhp_fal -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bhp_fal -- bind and rename the sci vals====       
sci_bhp_fal <- bind_cols(bhp_fal,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value) %>%  
  rename(sci_2mo = value1) %>%   
  rename(sci_3mo = value2) %>%  
  rename(sci_4mo = value3) %>%   
  rename(sci_6mo = value4) %>%   
  rename(sci_9mo = value5) %>%  
  rename(sci_12mo = value6)  

# * bhp_fal -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_fal, bhp_fal_v)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# * bha_frn -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bha_frn -- bind and rename the sci vals====       
sci_bhp_frn <- bind_cols(bhp_frn,       
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,    
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * bha_frn -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_frn, bhp_frn_v)   

# 2.0 calculate SCI_gwc---- 
# 2.1 SCI calcs - gwc_bev -- set up station for sci & make sci list vars====    
sta      <- gwc_bev_v  
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                             
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   

# * gwc_bev -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * gwc_bev -- bind and rename the sci vals====         
sci_gwc_bev <- bind_cols(gwc_bev,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%   
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * gwc_bev -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(gwc_bev, gwc_bev_v)  

# 2.2 SCI calcs - gwc_lcr -- set up station for sci & make sci list vars====    
sta      <- gwc_lcr_v   
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 5, 8                     
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 5   
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)    

# * gwc_lcr -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * gwc_lcr -- bind and rename the sci vals====        
sci_gwc_lcr <- bind_cols(gwc_lcr,      
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * gwc_lcr -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,   
   sci_12mo)      
rm(gwc_lcr, gwc_lcr_v)  


# 3.0 calculate SCI_kpt----  
# 3.1 SCI calcs - kpt_key -- set up station for sci & make sci list vars====   
sta      <- kpt_key_v   
sci_1mo  <- sci.fun(sta, 1)                     
sci_2mo  <- sci.fun(sta, 2)                   
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * kpt_key -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * kpt_key -- bind and rename the sci vals====       
sci_kpt_key <- bind_cols(kpt_key,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * kpt_key -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(kpt_key, kpt_key_v)   

# 3.2 SCI calcs - kpt_wew -- set up station for sci & make sci list vars====  
sta      <- kpt_wew_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * kpt_wew -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)   

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * kpt_wew -- bind and rename the sci vals====       
sci_kpt_wew <- bind_cols(kpt_wew,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * kpt_wew -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(kpt_wew, kpt_wew_v)   

# 4.0 calculate SCI_psh---- 
# 4.1 SCI calcs - psh_bat -- set up station for sci & make sci list vars====   
sta      <- psh_bat_v   
sci_1mo  <- sci.fun(sta, 1)   # MLE fail months 8 & 10 (AUG & OCT)         
sci_2mo  <- sci.fun(sta, 2)   # MLE fail month 11 (OCT-NOV)                
sci_3mo  <- sci.fun(sta, 3)   # MLE fail months 9 & 11  (JUL-SEP) & (SEP-NOV)  
sci_4mo  <- sci.fun(sta, 4)   # MLE fail month 10 (JUL-OCT)           
sci_6mo  <- sci.fun(sta, 6)   # MLE fail month 12 (JUN-DEC)                
sci_9mo  <- sci.fun(sta, 9)   # MLE fail month 3 (JUN-MAR)            
sci_12mo <- sci.fun(sta, 12)  # MLE fail months 4 & 5 (MAR-APR) & (APR-MAY)    

# * psh_bat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_bat -- bind and rename the sci vals====       
sci_psh_bat <- bind_cols(psh_bat,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_bat -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_bat, psh_bat_v)  

# 4.2 SCI calcs - psh_che -- set up station for sci & make sci list vars====   
sta      <- psh_che_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)                 
sci_4mo  <- sci.fun(sta, 4)               
sci_6mo  <- sci.fun(sta, 6)                   
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)      

# * psh_che -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_che -- bind and rename the sci vals====       
sci_psh_che <- bind_cols(psh_che,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_che -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_che, psh_che_v)  

# 4.3 SCI calcs - psh_whi -- set up station for sci & make sci list vars====   
sta      <- psh_whi_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 7   
sci_2mo  <- sci.fun(sta, 2)      
sci_3mo  <- sci.fun(sta, 3)                
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)                 
sci_12mo <- sci.fun(sta, 12)        

# * psh_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_whi -- bind and rename the sci vals====       
sci_psh_whi <- bind_cols(psh_whi,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_whi -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_whi, psh_whi_v)  

# 5.0 calculate SCI_psl---- 
# 5.1 SCI calcs - psl_brs -- set up station for sci & make sci list vars====   
sta      <- psl_brs_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 9, 11 (JAN & SEP & NOV)   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month  4 (MAR-APr)                 
sci_3mo  <- sci.fun(sta, 3)    # MLE fail month 11 (SEP-NOV)                 
sci_4mo  <- sci.fun(sta, 4)    # MLE fail month 12 (SEP-DEC)             
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month  2 (SEP-FEB)                 
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)      

# * psl_brs -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_brs -- bind and rename the sci vals====       
sci_psl_brs <- bind_cols(psl_brs,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_brs -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_brs, psl_brs_v)  

# 5.2 SCI calcs - psl_elk -- set up station for sci & make sci list vars====   
sta      <- psl_elk_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 8, 10, 11, 12   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 11, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 9, 10, 11, 12         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 9, 12   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 9, 11, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 6    
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 6, 7    

# * psl_elk -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_elk -- bind and rename the sci vals====       
sci_psl_elk <- bind_cols(psl_elk,      
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_elk -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_elk, psl_elk_v)  

# 5.3 SCI calcs - psl_hat -- set up station for sci & make sci list vars====   
sta      <- psl_hat_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         

# * psl_hat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_hat -- bind and rename the sci vals====       
sci_psl_hat <- bind_cols(psl_hat,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_hat -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_hat, psl_hat_v)  

# 5.4 SCI calcs - psl_bad -- set up station for sci & make sci list vars====   
sta      <- psl_bad_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         

# * psl_bad -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_bad -- bind and rename the sci vals====       
sci_psl_bad <- bind_cols(psl_bad,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_bad -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_bad, psl_bad_v)  

# 5.5 SCI calcs - psl_hor -- set up station for sci & make sci list vars====   
sta      <- psl_hor_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 5, 6, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 2, 3, 6, 9         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 7    
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 7, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 1, 8, 9     
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 5, 11      

# * psl_hor -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_hor -- bind and rename the sci vals====       
sci_psl_hor <- bind_cols(psl_hor,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_hor -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_hor, psl_hor_v)  

# 6.0 calculate SCI_snd---- 
# 6.1 SCI calcs - snd_lon -- set up station for sci & make sci list vars====   
sta      <- snd_lon_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)    # MLE fail month 12        
sci_12mo <- sci.fun(sta, 12)   # MLE fail month 6   

# * snd_lon -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_lon -- bind and rename the sci vals====      
sci_snd_lon <- bind_cols(snd_lon,      
                         sci_1mo,   
                         sci_2mo,    
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_lon -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_lon, snd_lon_v)   

# 6.2 SCI calcs - snd_mar -- set up station for sci & make sci list vars====  
sta      <- snd_mar_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_mar -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_mar -- bind and rename the sci vals====      
sci_snd_mar <- bind_cols(snd_mar,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_mar -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_mar, snd_mar_v)    

# 6.3 SCI calcs - snd_nio -- set up station for sci & make sci list vars====  
sta      <- snd_nio_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                           
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_nio -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_nio -- bind and rename the sci vals====      
sci_snd_nio <- bind_cols(snd_nio,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_nio -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_nio, snd_nio_v)    

# 6.4 SCI calcs - snd_ros -- set up station for sci & make sci list vars====  
sta      <- snd_ros_v  
sci_1mo  <- sci.fun(sta, 1)                        
sci_2mo  <- sci.fun(sta, 2)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 5    
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_ros -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)     

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_ros -- bind and rename the sci vals====      
sci_snd_ros <- bind_cols(snd_ros,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_ros -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_ros, snd_ros_v)    

# 6.5 SCI calcs - snd_vet -- set up station for sci & make sci list vars====  
sta      <- snd_vet_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)     # MLE fail month 5   
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_vet -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_vet -- bind and rename the sci vals====      
sci_snd_vet <- bind_cols(snd_vet,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_vet -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_vet, snd_vet_v)    

# 6.6 SCI calcs - snd_whi -- set up station for sci & make sci list vars====  
sta      <- snd_whi_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                            
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_whi -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_whi -- bind and rename the sci vals====      
sci_snd_whi <- bind_cols(snd_whi,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_whi -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_whi, snd_whi_v)    




# 7.0 calculate SCI_ter---- 
# 7.1 SCI calcs - ter_ogl -- set up station for sci & make sci list vars====   
sta      <- ter_ogl_v   
sci_1mo  <- sci.fun(sta, 1)     # MLE fail month 9 (SEP)                    
sci_2mo  <- sci.fun(sta, 2)     # MLE fail month 10 (SEP-OCT)           
sci_3mo  <- sci.fun(sta, 3)    
sci_4mo  <- sci.fun(sta, 4)     # MLE fail month 2 (NOV-FEB)  
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * ter_ogl -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * ter_ogl -- bind and rename the sci vals====        
sci_ter_ogl <- bind_cols(ter_ogl,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_ogl -- clean up global environment====   
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(ter_ogl, ter_ogl_v)   

# 7.2 SCI calcs - ter_sta -- set up station for sci & make sci list vars====   
sta      <- ter_sta_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 9 (SEP)                   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 10  (SEP-OCT)               
sci_3mo  <- sci.fun(sta, 3)             
sci_4mo  <- sci.fun(sta, 4)          
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 5 (DEC-MAY)       
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * ter_sta -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * ter_sta -- bind and rename the sci vals====       
sci_ter_sta <- bind_cols(ter_sta,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_sta -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(ter_sta, ter_sta_v)  
# 7.3 SCI calcs - ter_whi -- set up station for sci & make sci list vars====  
sta      <- ter_whi_v    
sci_1mo  <- sci.fun(sta, 1)                              
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)  # MLE fail month 6     
sci_12mo <- sci.fun(sta, 12)   

# * ter_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

# * ter_whi -- bind and rename the sci vals====       
sci_ter_whi <- bind_cols(ter_whi,     
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,  
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo   
) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_whi -- clean up global environment====     
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo)   
rm(ter_whi, ter_whi_v)     

```

```{r join_SRI}  

# 1 clean up sci.fun vars====  
#rm(distrib,  
#   first_mon,  
#   p_zero,  
#   p_zero_cm,  
#   scale,  
#   sci.limit,  
#   sta,  
#   time_scale,  
#   warn_me,  
#   sci.fun)  

# 2.1 join black hills plateau SCI vals====    
sci_bhp <- bind_rows(sci_bhp_bat,  
                     sci_bhp_fal,  
                     sci_bhp_frn) %>%  
  mutate(group = "Black Hills Plateau") %>%   
  select(sta, group, ecoreg, everything())  

# 2.2 join gw control SCI vals====  
sci_gwc <- bind_rows(sci_gwc_bev,  
                     sci_gwc_lcr) %>%  
  mutate(group = "GW control") %>%   
  select(sta, group, ecoreg, everything())  

# 2.3 join keya paha tablelands SCI vals====  
sci_kpt <- bind_rows(sci_kpt_key,  
                     sci_kpt_wew) %>%  
  mutate(group = "Keya Paha Tablelands") %>%   
  select(sta, group, ecoreg, everything())  

# 2.4 join pierre shale high SCI vals====  
sci_psh <- bind_rows(sci_psh_bat,  
                     sci_psh_che,  
                     sci_psh_whi) %>%  
  mutate(group = "Pierre Shale High") %>%   
  select(sta, group, ecoreg, everything())  

# 2.5 join pierre shale low SCI vals====  
sci_psl <- bind_rows(  sci_psl_bad,  
                       sci_psl_brs,  
                       sci_psl_elk,  
                       sci_psl_hat,  
                       sci_psl_hor) %>%  
  mutate(group = "Pierre Shale Low") %>%   
  select(sta, group, ecoreg, everything())  

# 2.6 join sand hills SCI vals====  
sci_snd <- bind_rows(sci_snd_lon,  
                     sci_snd_mar,  
                     sci_snd_nio,  
                     sci_snd_ros,  
                     sci_snd_vet,  
                     sci_snd_whi) %>%  
  mutate(group = "Sand Hills") %>%   
  select(sta, group, ecoreg, everything())  

# 2.7 join tertiary clay SCI values====    
sci_ter <- bind_rows(sci_ter_ogl,  
                     sci_ter_sta,  
                     sci_ter_whi) %>%  
  mutate(group = "Tertiary Clays") %>%   
  select(sta, group, ecoreg, everything())  

# 3.0 join all values====  
sci_gage <- bind_rows(sci_bhp,  
                      sci_gwc,  
                      sci_kpt,  
                      sci_psh,  
                      sci_psl,  
                      sci_snd,  
                      sci_ter) %>%  
    gather(key = type, val = value,  
         -c(sta, date, group, ecoreg, log_q1_mon))    

# * clean up global environment====  
rm(sci_bhp,  
   sci_gwc,  
   sci_kpt,  
   sci_psh,  
   sci_psl,  
   sci_snd,  
   sci_ter,  
   sci_bhp_bat,  
   sci_bhp_fal,  
   sci_bhp_frn,  
   sci_gwc_bev,  
   sci_gwc_lcr, 
   sci_kpt_key,  
   sci_kpt_wew,  
   sci_psh_bat,  
   sci_psh_che,  
   sci_psh_whi,  
   sci_psl_bad,  
   sci_psl_brs,  
   sci_psl_elk,  
   sci_psl_hat,  
   sci_psl_hor,  
   sci_snd_lon,  
   sci_snd_mar,  
   sci_snd_nio,  
   sci_snd_ros,  
   sci_snd_vet,  
   sci_snd_whi,  
   sci_ter_ogl,  
   sci_ter_sta,  
   sci_ter_whi)  

```

```{r old-prepare-sri-deconvolution}


# old identify seasonally intermittant streams (NEED TO FIX====  
#sri_intermit <- sri_seas %>%  
#  group_by(sta) %>%  
#  summarise(group = first(group),  
#            season_max = max(season)) %>%  
#  ungroup() %>%  
#  mutate(season_max = round(season_max, digits = 2)) %>%  
#  arrange(desc(season_max))  

#export(mclust_aug, "data/lmom_mclust_fit.csv")  

# * calculate group median & MAD for plotting====   
sri_seas_group <- sri_seas %>%  
  group_by(group, date) %>%   
  summarise(sci_1mo_mad    = mad(sci_1mo),   
            sci_1mo_med    = median(sci_1mo),   
            sci_seas_mad   = mad(season),   
            sci_seas_med   = median(season),  
            sci_trend_mad  = mad(trend),   
            sci_trend_med  = median(trend),   
            sci_remain_mad = mad(remainder),   
            sci_remain_med = median(remainder)  
            ) %>%  
  ungroup() %>%  
  mutate(sci_1mo_hi    = sci_1mo_med + sci_1mo_mad) %>%  
  mutate(sci_1mo_lo    = sci_1mo_med - sci_1mo_mad) %>%  
  mutate(sci_seas_hi   = sci_seas_med + sci_seas_mad) %>%  
  mutate(sci_seas_lo   = sci_seas_med - sci_seas_mad) %>%  
  mutate(sci_trend_hi  = sci_trend_med + sci_trend_mad) %>%  
  mutate(sci_trend_lo  = sci_trend_med - sci_trend_mad) %>%  
  mutate(sci_remain_hi = sci_remain_med + sci_remain_mad) %>%  
  mutate(sci_remain_lo = sci_remain_med - sci_remain_mad)  

# * split out data-types for plotting ====  
sri_1mo_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_1mo_med, 
         sci_1mo_hi,  
         sci_1mo_lo  
         )  %>%   
  gather(key = key, value = value,  
         -c(group, date, sci_1mo_med)  
         ) 
  
sri_seas_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_seas_med, 
         sci_seas_hi,  
         sci_seas_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_seas_med)  
         ) %>% 
  mutate(month = month(date)) 
  
sri_trend_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_trend_med, 
         sci_trend_hi,  
         sci_trend_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_trend_med)  
         )   
  
sri_remain_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_remain_med, 
         sci_remain_hi,  
         sci_remain_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_remain_med)  
         )   


# prepare for plotting -- split out data types====  
sri_seas_ecoreg <- sri_seas_ecoreg %>%  
  mutate(ecoreg = fct_relevel(ecoreg, 
                              "Pierre Shale Plains",  
                              "Pine Ridge Escarpment",  
                              "White River Badlands",  
                              "Black Hills Plateau",  
                              "Keya Paha Tablelands", 
                              "Sand Hills")     
  )  

```

```{r plot_sri_old}   
 

# streamflow observations plot====  
#sri_obs <- 
  sri_seas %>%   
  ggplot(aes(date, sci_1mo)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_1mo_mad,   
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_1mo_mad,  
            aes(date, sci_1mo_med),  
            size            = 0.3,  
            colour          = "black"  
  )   
  
#test <- 
  sri_seas %>%  
  filter(group == "Pierre Shale Low") %>%  
  mutate(month = month(date)) %>% 
  select(sta, month, season) %>%  
  distinct() %>% 
  ggplot(aes(month, season)) +  
# set theme and facets  
  theme_bw() +  
  geom_point()

# streamflow seasons plot====  
#sri_seas_plot <- 
sri_seas %>%   
  mutate(month = month(date)) %>% 
  select(month, group, season) %>%  
#  distinct() %>%   
  ggplot(aes(month, season)) +  
# set theme and facets  
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month seasonality") +   
  scale_y_continuous(limits = c(-3, 3)) +  
# scale_x_continuous(breaks = 1:12,   
#                     labels = c("J", "F", "M", "A", "M", "J",  
#                                "J", "A", "S", "O", "N", "D")) +  
  facet_wrap(vars(group),   
             nrow = 2) +   
  # plot all station vals  
geom_point(colour = "gray80") + 
    # plot median +/- 1 MAD  
  geom_point(data = sri_seas_mad,  
            aes(month, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) #+  
# plot median  
  geom_line(data = sri_seas_mad,  
            aes(date, sci_seas_med),  
            size            = 0.3,  
            colour          = "black"  
  )  
 
 #  geom_line(size   = 1,  
#            colour = "gray80")  #+  
 
   
# streamflow trend plot====  
sri_trend_plot <- sri_seas %>%   
  ggplot(aes(date, trend)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month trend") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_trend_mad,  
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_trend_mad,  
            aes(date, sci_trend_med),  
            size            = 0.3,  
            colour          = "black"  
  )  

# streamflow remain plot====  
sri_remain_plot <- sri_seas %>%   
  ggplot(aes(date, remainder)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month remainder") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_remain_mad,  
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_remain_mad,  
            aes(date, sci_remain_med),  
            size            = 0.3,  
            colour          = "black"  
  ) +  
# plot anomolies  
  geom_point(data = sri_anom,  
             aes(date, sci_1mo),  
             shape = 8)  
  
# plot the plots above as a grid & save====  
cowplot::plot_grid(  
  sri_obs, sri_seas_plot, sri_trend_plot, sri_remain_plot,  
  ncol = 1,   
  align = "v"  
)  
  
cowplot::ggsave2("figure/sri_deconv.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  
  
# clean-up====  
rm(sri_obs,  
   sri_seas,  
   sri_seas_plot,  
   sri_anom,  
   sri_1mo_mad,  
   sri_remain_mad,  
   sri_remain_plot,  
   sri_seas_ecoreg,  
   sri_seas_mad,  
   sri_trend_mad,  
   sri_trend_plot,  
   gage_meta  
   )         
  
```  

```{r things}



# import sta -- and standardize vars between dfs====      
sci_sta <- import("data/spi_seas.csv") %>%     
  mutate(date = ymd(date)) %>%  
  mutate(prcp = as.numeric(prcp)) %>%  
#  filter(sta == "ONI") %>% 

            )) %>%  
# check dates  
  mutate(min_date_sta = min(date)) %>%   
  mutate(max_date_sta = max(date)) %>%     
# arrange from wide to long  
  gather(key   = spi_length,   
         value = spi_val,   
         -c(group,   
            date,   
            sta,   
            min_date_sta,  
            max_date_sta, 
            prcp
            )) %>%  
  ungroup() %>%  
  drop_na() %>%  
# prepare for joining by spi_length  
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%     
  mutate(spi_length = str_sub(spi_length, start = 5) %>% as.numeric)  
  
```  

```{r stuff}

# deconvolute streamflow into trend, seasonal & random components----   
# import streamflow data and metadata====     
#sci_gage <- import("data/sci_gage.csv") %>%    
#  mutate(date = ymd(date)) %>%   
#  filter(between(date, as.Date("1988-09-15"), as.Date("2018-09-15")))  %>%  
#  arrange(date) %>%   
#  as_tibble() %>%  
#  mutate(group = sta)  # group is for decomp_fun  
  
# clean metadata  
#gage_meta <-  import("data/gage_meta_lmom.csv") %>% 
#  select(-c(ecoreg.x, years.y, ecoreg.y)) %>% 
#  rename(years = years.x)  

#export(gage_meta, "gage_meta_lmom.csv") 
 
# remove discordant stations from metadata====    
#gage_meta <- semi_join(gage_meta, sci_gage,  
#                       by = c("sta", "ecoreg"))  
  

gage_meta <- full_join(gage_meta, sri_intermit, 
                       by = "sta") 
  
gage_meta <- gage_meta %>% 
  mutate(flow_regime = case_when(  
    season_max > 0.8 ~ "strongly intermittent",  
    season_max > 0.4 ~ "moderately intermittent", 
    TRUE ~ flow_regime
    ))   
  
export(gage_meta, "data/gage_meta_seas.csv")  
export(sri_seas, "data/sri_seas.csv") 
#sta_meta_fin <- import("data/sta_meta_fin.csv")       

# prepare for deconvoluting the grouped precip====    
#sci_sta <- sci_sta %>%   
#  mutate(prcp = as.numeric(prcp)) %>%     
#  arrange(date) %>%   
#  as_tibble() %>%   
#  # make groups  
#  mutate(group = case_when(  
#    sta == "RAP" ~ "NW",    
#    sta == "COT" ~ "NC",     
#    sta == "ONI" ~ "NE",    
#    sta == "OEL" ~ "SW",  
#    sta == "GOR" ~ "SC",   
#    sta == "MIS" ~ "SE"))  

# TO DO Monthly plot PRCP_MON - check code   
# DELETE OLD CODE  
# 1 import streamflow records & metadata====     
#gage_mon <- import("data/gage_mon_full.csv")    

# remove discordant stations & discord calcs  
#gage_meta <- import("data/gage_meta_lmom.csv") %>%  
#  filter(isD == FALSE) %>%  
#  select(-c(Dmax:Dcrit, isD, signif))  

#gage_mon <- semi_join(gage_mon, gage_meta,  
#                      by = c("sta", "ecoreg"))  


#gage_mon_sri %>% 
#  select(sta) %>% 
#  distinct()  
#rm(gage_check)  

# get mean L-statistic values from discord calculations====  
#gage_mean <-  import("data/lmom_table.csv") %>%  
#  filter(sta == "") %>%  
#  select(ecoreg, L_CV, L_skew, L_kurtosis) %>%  
#  rename(L_CV_mean   = L_CV) %>%   
#  rename(L_skew_mean = L_skew) %>%  
#  rename(L_kurt_mean = L_kurtosis)  

# find distance from centers  
#gage_meta <- left_join(gage_meta, gage_mean,  
#                       by = "ecoreg") %>%  
#  mutate(L_CV_diff   = L_CV - L_CV_mean) %>%  
#  mutate(L_skew_diff = L_skew - L_skew_mean) %>%  
#  mutate(L_kurt_diff = L_kurtosis - L_kurt_mean) %>%  
#  mutate(D2 = round(digits = 2,  
#                    sqrt(L_CV_diff^2 + L_skew_diff^2 + L_kurt_diff^2)  
#  )  
#  ) %>%  
#  arrange(D2)  

# join metadata  
#gage_sci_meta <- semi_join(gage_meta, sri_input,   
#                           by = c("sta", "ecoreg")  
#)  
# export selection and clean-up  

#rm(gage_mean,  
#   gage_meta
#)    
``` 

```{r ggplot_monthly, eval=FALSE} 
#sta_mon <- import(file = "data/stations_monthly.csv") %>%   
#  mutate(date = ymd(date))  
  
#sta_mon %>%   
#  group_by(sta) %>%   
#  summarize(count = n())  
  
sta_mon_plus$group <- factor(sta_mon_plus$group,  
                             levels = c("NW", "NC", "NE", "SW", "SC", "SE"))  
  
# plot monthly precips  
sta_mon_plus %>%   
  ggplot(aes(month, depth_mm, group = month)) +  
  facet_grid(rows = vars(group)) +   
  geom_quasirandom(size = 0.2,  
                   position = position_beeswarm()  
  ) + 
  scale_x_discrete(limits = c("1", "2", "3", "4", "5", "6",  
                              "7", "8", "9", "10", "11", "12"),    
                   labels = c("J", "F", "M", "A", "M", "J",  
                              "J", "A", "S", "O", "N", "D")   
  ) +  
  theme_bw() +  
  #  labs(title = "Monthly precipitation depths",  
  #       subtitle = "Southwestern South Dakota for 1990-2017") +   
  xlab("") +  
  ylab("mm")  
  
ggplot2::ggsave(path = "figure/", filename = "precip_mon.png",   
                width = 6, height = 6, units = "in")  
  
````  

```{r precip-EDA, include=FALSE, eval=FALSE}
# Purpose: EDA of precipitation data.
# Outcome: Differences among stations 1971-2018 are small.  
#          less than +/-5 mm on average.  
 
# the anomolously wet month series is dominated by May & June events.  
# what drives precip during this time?   
#   In May & June the area recieves low-level moisture from the Gulf   
#   of Mexico, strong cold fronts, and active upper-level pattern  
#   leading to greater chance for convection.  
```

```{r Mclust-plot-old, eval=FALSE}  

# get pc-vars for plotting====  
pca_vars  <- import('data/pca_vars.csv')  
pca_eigen <- import("data/pca_eigen.csv")  

# plot clusters by ecoregion====  
mclust_eco_plot  <- mclust_aug %>%  
  ggplot(aes(PC1_mon, PC2_mon)) +  
  # set theme and facets #  
  theme_bw() +  
  facet_wrap(vars(ecoreg)) +  
  geom_jitter(  
    aes(color = flow_type,  
        shape = ecoreg,  
        alpha = .uncertainty),  
    size = 2,  
    show.legend = FALSE) +  
  scale_alpha(".uncertainty") +  
  # plot centroids for each flow type -- commented out to reduce plot clutter  
  geom_point(aes(PC1_eco, PC2_eco,  
                 size = proportion_ecoreg,  
  ),  
  show.legend = FALSE,  
  shape = 3,                   # cross shape  
  # size = 2.5,
  stroke = .5,  
  color = "gray50"
  ) + 
  # plot pc eigenvectors as arrows #  
  geom_segment(data = pca_vars,  
               aes(x = 0, y = 0,  
                   xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.03, "npc")) 
  ) +  
  # plot pc eigenvector text #  
  geom_text(data = pca_vars,  
            size = 3,  
            nudge_x = 0.5,  
            nudge_y = -0.1,  
            hjust = 'outside',  
            aes(x = PC1, y = PC2, label = labels)  
  ) +  
  # set axis text #  
  xlab("PC1 axis (95.0%)") +  # from pca_eigen  
  ylab("PC2 axis (4.3%)") +  
  theme(legend.position="bottom")  

# plot clusters by flow type====  
mclust_flow_plot <- mclust_aug %>%  
  ggplot(aes(PC1_mon, PC2_mon)) +  
  # set theme and facets #  
  theme_bw() + 
  facet_wrap(~ flow_type) +  
  # plot points # 
  geom_jitter(aes(shape = ecoreg,  
                  color = flow_type,  
                  alpha = .uncertainty 
  ),  
  show.legend=FALSE,  
  size = 2)  +  
  # plot centroids #  
  geom_point(aes(PC1_eco, PC2_eco,  
                 shape = ecoreg,  
                 size = proportion_ecoreg  
  ),  
  show.legend=FALSE,  
  color = "black"  
  ) +  
  # set axis text #  
  xlab("PC1 axis (95.0%)") +  # from pca_eigen  
  ylab("PC2 axis (4.3%)") +  
  theme(legend.position="bottom")  

# plot grid of ggplots====  
cowplot::plot_grid(  
  mclust_eco_plot,  
  mclust_flow_plot,  
  ncol = 1,  
  align = "v"  
)  

cowplot::ggsave2("figure/mclust_plot.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  

# save results & clean up global environment  
export(mclust_aug, "data/mclust_results.csv")  
export(mclust_fit, "data/mclust_fit.csv")  

rm(mclust_flow_plot,  
   mclust_eco_plot,  
   mod,  
   mclust_aug,  
   mclust_fit,  
   mclust_means,  
   pca_eigen,  
   pca_vars  
)  
  
#    scale_colour_brewer(palette = "Greys") + 
#ecoreg_sum <- mclust_aug %>%  
#  group_by(ecoreg) %>%  
#  summarise(q)  # what to do here???
  
# map the title of the geom for the legend  
#  scale_shape_discrete(name="Ecoregion") + 
#  scale_color_hue(name="Flow type") 
  
```

# probably not best approach 
```{r build-glm-models_1mo} 
    
# set up random seed & parallel processing for glmnet & caret ----------------  
seed <- 42  
cores <- parallel::detectCores(all.tests = FALSE, logical = TRUE)   
registerDoMC(cores)    
  
# set up 'caret' training control & lambda -- 100 possible lambda vals [-2, 2]  
# note these values are used below for individual model fits  
set.seed(seed)   
reg.ctrl <-  trainControl(method = "repeatedcv", number = 5, repeats = 5,   
                          search = "grid", allowParallel = TRUE)   
  
lambda <- 10^seq(-2, 2, length = 100)  
  
# Split the data into training and test set ----------------------------------  
# remove unneeded data from the model input 
sci1mo_input <- sci_1mo %>% 
  select(sci_val, spi_length_1:spi_length_12, ecoreg, date)

# create a data partition balanced by flow depths   
set.seed(seed)     
train_index <- createDataPartition(sci1mo_input$sci_val, p=0.8)[[1]]  
  
train   <- sci1mo_input[train_index,] 
test    <- sci1mo_input[-train_index,] 
   
# ridge -- alpha = 0 ---------------------------------------------------------  
set.seed(seed)             # need to set a seed each time you call a rand num   
ridge <- train %>%   
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,         # x = 'sci_val', y = rest of the columns, from  
        data = .,                #   the dataset 'train.data'   
        method = "glmnet",       #   using method "glmnet"    
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,     
        tuneGrid = expand.grid(alpha = 0, lambda = lambda) # df with tuning values   
  )    
  
# lasso -- alpha = 1 ---------------------------------------------------------   
set.seed(seed)              # need to set a seed each time you call a rand num   
lasso <- train %>%   
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,            
        data = .,                 #   the dataset 'train.data'    
        method = "glmnet",        #   using method "glmnet"   
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,    
        tuneGrid = expand.grid(alpha = 1, lambda = lambda) # df with tuning values  
  )   
  
# elastic net -- alpha vals [0, 1] by caret ----------------------------------  
set.seed(seed)   
elastic <- train %>%  
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,          
        data = .,                 #   the dataset 'train.data'     
        method = "glmnet",        #   using method "glmnet"   
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,   
        tuneLength = 10          # tune length    
  )    
  
# make a list of the models --------------------------------------------------   
models <- list(   
  ridge = ridge,  
  lasso = lasso,   
  elastic = elastic)    
  
rm(cores, train_index, reg.ctrl)   
  
```  

```{r get-glm-coefs}
 
# get & tidy model coefficients for each of the GLMs     
# get number of parameters for each of the GLMs   
   
# ridge coeffs ---------------------------------------------------------------  
coef_ridge <- coef(  
  ridge$finalModel,  
  ridge$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "ridge")  
  
# lasso coeffs  --------------------------------------------------------------   
coef_lasso <- coef(  
  lasso$finalModel,  
  lasso$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "lasso")  
  
# elastic coeffs  ------------------------------------------------------------  
coef_elastic <- coef(  
  elastic$finalModel,  
  elastic$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "elastic")  
  
# join model coeff -----------------------------------------------------------  
coefs <- bind_rows(coef_ridge, coef_lasso, coef_elastic)   
  
coefs <- coefs %>%  
  rename(value = 2) %>%  
  mutate(value = round(  
    value, digits = 3)  
    ) %>%  
  spread(type, value)  
  
# prepare for export table --------------------------------------------------- 
# arrange by absolute value of the lasso model  
coefs <- coefs %>%   
  mutate(arrange_ridge = abs(ridge)) %>%   # temp terms to arrange coeffs  
  mutate(arrange_lasso = abs(lasso)) %>%   # temp terms to arrange coeffs  
  arrange(desc(arrange_ridge)) %>%    
  arrange(desc(arrange_lasso)) %>%  
  select(coeff, lasso, ridge, elastic)  
  
# rename coefficients to fit the hydrologic coefficient table  
coefs <- coefs %>%   
  mutate(coeff = case_when(   
    coeff == "(Intercept)" ~ "Intercept",  
    TRUE ~ coeff)) 
  
rm(coef_ridge, 
   coef_lasso, 
   coef_elastic,  
   ridge, 
   lasso, 
   elastic)     
```

```{r select-glm-models_dv}
  
# evaluate performance of models -- ridge, lasso and elastic net --      
#   best model is the one that minimizes the prediction error.    
  
# pick out the mse from the output lists   
error_call <- resamples(models) %>%    
  summary(metric = c("MAE"))     
  
# change list to tibble   
error_vals <- error_call %>%    
  pluck(., 'statistics') %>%   
    as.data.frame() %>%   
  as_tibble(., rownames = "model") %>% 
  gather(key, val, -c(model))  %>%  
  mutate(key = str_replace(key, "[.]", "_")) %>%   
  separate(key, c("statistic", "position"), extra = "drop") %>%  
  filter(position != "NA") %>%  
  mutate(val = round(val, digits = 3)) %>% 
  spread(position, val)   
  
rm(error_call)   

```

```{r plot-glm-models_dv} 
 
# prepare for plotting   
n_train <- train %>%  
  mutate(n_count = n()) %>%  
  distinct(n_count)   
  
# make a boxplot of the three models   
error_vals %>%
  ggplot() +   
  theme_bw() + 
  # facet_grid(cols = vars(statistic), 
  #            scale = "free") +   
  geom_boxplot(aes(x = factor(model),  
                   group = model,  
                   lower = `1st`,  
                   upper = `3rd`,  
                   middle = `Median`,  
                   ymin = `Min`,  
                   ymax = `Max`),  
               stat = "identity") +   
  geom_text(data = n_train,  
            x = 3, y = 0.63,    
            aes(label= paste("n =", n_count, sep = " ")),   
            size = 3,   
            color = "gray20"  
  ) + 
  ylim(0.63, 0.71) +  
labs(x = "",   
     y = bquote('Median Absolute Error')
)      
  
# save ggplot above & clean up   
ggsave("figure/model_fit_sci_all.png", width = 7, height = 3.5, units = "in")   
  
rm(n_train)    

# results are -- models look very similiar with slightly lower LASSO error
  
``` 

```{r get_glm_observations_and_predictions}  
  
# get observations & predictions -- training --------------------------------  
obs_train   <- tibble(observed = train$sci_val,   
                             date = train$date, 
                             ecoreg = train$ecoreg) 
  
preds_train <- map_dfc(models, predict, newdata = train)   
  
# combine observations & predictions  
fit_train <- bind_cols(obs_train, preds_train) %>%  
  mutate(split = "train") %>%  
  as_tibble() 
  
# get observations & predictions -- test ------------------------------------  
obs_test   <- tibble(observed = test$sci_val, 
                     date     = test$date, 
                     ecoreg   = test$ecoreg) 

preds_test <- map_dfc(models, predict, newdata = test)  
  
# combine observations & predictions 
fit_test <- bind_cols(obs_test, preds_test) %>%  
  mutate(split = "test") %>% 
  as_tibble()  
  
fit_model <-  bind_rows(fit_test, fit_train)  
 
# drop the training data -- find model errors & fit a null model ------------  
fit_model_test <- fit_model %>% 
  filter(split == "test") %>%           # only want to see test data 
  select(-c(split, ridge, elastic)) %>%        # drop non-selected models 
  group_by(date)  %>%                   # fit a null model to the data by Date  
  mutate(null_mod = mean(observed)) %>% 
  ungroup() %>%  
  gather(model, fitted, -c(observed, date, ecoreg)) %>% 
  group_by(model) %>% 
  mutate(MAE = round( 
    MAE(observed, fitted),              # find the model errors 
    digits = 3) 
    ) %>% 
  ungroup() %>% 
  mutate(residual = observed - fitted) %>% 
  mutate(freq = 1- percent_rank(observed)) %>% 
  mutate(freq = if_else(freq== 1, 0.9999, freq))  
  
# clean-up  
rm(preds_test,  
   preds_train,  
   obs_train,  
   obs_test,  
   train,  
   fit_test,  
   fit_train)    
 
``` 

```{r build-glm-models-ecoreg}  
# prepare for modeling at the ecosystem scale --------------------------------  
# drop unimportant predictors - from lasso above   
  
sci1mo_ecoreg <- sci_1mo %>%  
#  select(-c(gage, group, .fittedPC1, .fittedPC2,  
#            prcp_sq, crel_sqr, vpdan_sq, t07_sq, TWI_sq)) %>%   
  mutate(ecoreg2 = case_when(   
    ecoreg == "Black Hills Plateau"   ~ "bhplat",  
    ecoreg == "Keya Paha Tablelands"  ~ "kptabl",   
    ecoreg == "Pierre Shale Plains"   ~ "pshale",   
    ecoreg == "Pine Ridge Escarpment" ~ "escarp",      
    ecoreg == "Sand Hills"            ~ "sndhil",    
    ecoreg == "White River Badlands"  ~ "wrbadl"   
    )) %>%   
  select(-c(ecoreg, prcp, sta, gage, group,  
         min_date_gage, max_date_gage,  
         min_date_sta, max_date_sta)   
         )  
  
# Split the data into training and test sets by ecoreg -----------------------  
ecoreg_list <- sci1mo_ecoreg %>%  
  split(., .$ecoreg2) 
    
# create an index of values -- used sci_val   
ecoreg_index <- lapply(ecoreg_list, function(x) {   
  return(createDataPartition(x$sci_val, p = .8, list = FALSE))    
  })    
   
# get separate training & test df from the index (used in a code-chunk below) 
train_bhplat <- (ecoreg_list[[1]])[ecoreg_index[[1]],]  
train_kptabl <- (ecoreg_list[[2]])[ecoreg_index[[2]],]  
train_pshale <- (ecoreg_list[[3]])[ecoreg_index[[3]],]  
train_escarp <- (ecoreg_list[[4]])[ecoreg_index[[4]],]  
train_sndhil <- (ecoreg_list[[5]])[ecoreg_index[[5]],]  
train_wrbadl <- (ecoreg_list[[6]])[ecoreg_index[[6]],]  
   
test_bhplat <- (ecoreg_list[[1]])[-ecoreg_index[[1]],]  
test_kptabl <- (ecoreg_list[[2]])[-ecoreg_index[[2]],]  
test_pshale <- (ecoreg_list[[3]])[-ecoreg_index[[3]],]  
test_escarp <- (ecoreg_list[[4]])[-ecoreg_index[[4]],]  
test_sndhil <- (ecoreg_list[[5]])[-ecoreg_index[[5]],]  
test_wrbadl <- (ecoreg_list[[6]])[-ecoreg_index[[6]],]  
  
# drop ecoreg and date from the list  
ecoreg_list <- lapply(ecoreg_list,  
                      function(x) select(x, -c(ecoreg2, date))  
                      )   
# create a list of models 
set.seed(seed)  
model_list <- purrr::map2(ecoreg_list, ecoreg_index,  
                          function(df, train_index)  {   
                            train(sci_val ~ ., df[train_index,],  
                                  method = 'glmnet',  
                                  trControl = reg.ctrl,  
                                  preProcess = c('nzv', 'center', 'scale'),  
                                  tuneGrid = expand.grid(  
                                    alpha = 1, 
                                    lambda = lambda)  
                                  )  
                            })  
  
rm(lambda, seed, reg.ctrl, ecoreg_index, ecoreg_list)   
  
``` 

<!-- might be able to drop these...
```{r old-tquant-lags-manual}

# Lag and Autocorrelation Analysis----  
# 1.0  group by station;  
# 2.0  use tq_mutate() to get lags 1:12 using lag.xts();   
# 2.1  provide column names for the new columns by prefixing “lag_” to   
#        the lag numbers, k, which the sequence from 1 to 12.   
# The output is all of the lags for each station.    
#start: 1989-10-15  -- need to fix gage  
#end: 2018-09-15  -- need to fix gage  

# Prepare variables for lags 1 through 12 (12 months of lags)====    
k <- 1:12  
col_names <- paste0("lag_", k)  
  

  
# Use tq_mutate() to get lags 1:12 using lag.xts()====    
sci_sta_lags <- sci_sta %>%  
# group_by is a key step!    
  group_by(sta, spi_length) %>%    
# run the lag vals by sta & spi_length  
    tq_mutate(  
        select     = spi_val,  
        mutate_fun = lag.xts,  
        k          = k,  
        col_rename = col_names  
    ) %>% 
  ungroup() %>% 
# gather the lagged values     
  rename(lag_0 = spi_val) %>%  
  gather(key = lag_length, 
         value = spi_val,  
         -c(sta,  
            spi_length,  
            date,  
            group,  
            min_date_sta,  
            max_date_sta)  
         ) %>%  
# convert lag_length to numeric
  mutate(lag_length = str_sub(lag_length, start = 5) %>% as.numeric) 

    
# clean up  
rm(k,  
   col_names    
   )  
  
```  

```{r time-series-correlation_join_spi_sci}
  
# The goal is to get the data and each lag side-by-side so we can do a 
#   correlation. 
# Correlating each of the lags to the “count” column involves steps (above)  
#   strung together in a dplyr pipe (%>%):  
# 1. Use gather() to pivot each lagged column into a “tidy” long-format df,   
#     and exclude columns: “sta”, “date” and other columns from the pivot.   
# 2. Convert the new “lag” column from a character string (e.g. “lag_1”)  
#     to numeric (e.g. 1) using mutate() to make ordering the lags easier.  
# 3. group the long data frame by type and lag to calculate subsets of  
#     package and lag.  
  
# join sta & gage====  
sci_all <- full_join(sci_sta, sci_gage,  
                     by = c("date", 
                            "group"))  %>%   
# drop unneeded check vars 
  select(-c(min_date_sta,  
            max_date_sta,  
            min_date_gage,  
            max_date_gage)  
         )  %>%  
# organize vars by y, x1, other data  
  select(sci_val,  
         ecoreg,  
         spi_val,  
         spi_length,  
         sci_length,  
         everything() 
         ) %>%    
  drop_na()    # short-term solution -- need to get dates coordinated  

#rm(sci_sta, 
#   gage_group  
#   )  
  
# check correlations at the station level - external controls ====     
sci_corr_sta <- sci_all %>%  
 # sta, gage, group - not need grouping vars
  group_by(gage, spi_length, sci_length) %>%  
  summarize(  
    cor = cor(x = spi_val,  
              y = sci_val,    
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup()  

# quick boxplot -- note the fal_hot gage is an outlier..
sci_corr_sta %>% 
  ggplot(aes(x = gage, y = cor)) + 
  geom_boxplot()  

# remove outlier station & clean up  
sci_clean <- sci_all %>%  
  filter(gage != "fal_hot")      # drop the low correlation outlier  

rm(sci_all,  
   sci_corr_sta,  
#   sci_gage,  
   sci_sta)  

# quick check 
sci_plot <- sci_clean %>% 
  gather(key = type, 
         value = length, 
         -c(ecoreg, spi_val, sci_val, sta, date, prcp, group, gage)) %>% 
  gather(key = sci_type, 
         value = index_val, 
         -c(ecoreg, type, length, sta, date, prcp, group, gage)) 

sci_plot %>% 
  ggplot(aes(x=date, y= index_val)) + 
  facet_grid(rows = vars(length), 
             cols = vars(sci_type), 
             scales = "free") + 
  geom_point() + 
  geom_smooth() 

sci_clean %>% 
 # filter(spi_length == 6) %>% 
  ggplot(aes(x=date, y=sci_val)) + 
  facet_wrap(vars(sci_length), 
             nrow = 2, 
             scales = "free") + 
  geom_point() + 
  geom_smooth() 
```   

```{r cross-correlation}
library(feasts)  
library(tsibble)

# make into a tsibble -- the key is 'gage' 
sci_dups <- sci_clean %>% 
  duplicates()  
  
as_tsibble(key = gage)  

```

```{r quick-try-for-controlling-vars-needs-work}
# next step is to apply an 80:20 split by spi_length  

# approach for linear mod ----  
data %>%
  group_by(dataset) %>% 
  nest() %>% 
  mutate(mod = map(data, ~lm(observation ~ estimate, data = .)),
         aug = map2(mod, data, ~augment_columns(.x, .y))) %>% 
  unnest(aug)

# apply model to 
sci_mod <- sci_all %>%
  group_by(sci_length) %>% 
  nest() %>% 
  mutate(mod = map(data, ~lm(sci_val ~ spi_val + spi_length, data = .)),
         aug = map2(mod, data, ~augment_columns(.x, .y))) %>% 
  unnest(aug)

```

```{r time_series_correlation} 
# Apply the correlation ----  
# 1. apply the correlation to each group of gages & stations by 
#      lags & spi_lengths.  The summarize() function can be used 
#      to implement cor(), which takes x = count and y = lag_value.   
#   Make sure to pass use = "pairwise.complete.obs", which is almost always   
#   desired.  
# 2. The 95% upper and lower cutoff can be approximated by: cutoff=±2 / N^0.5  
#      Where:  
#        N = number of observations.  

# check correlations at the station level - external controls ====     
sci_corr_sta <- sci_all %>%  
 # sta, gage, group - not need grouping vars
  group_by(gage, spi_length, sci_length, lag_length) %>%  
  summarize(  
    cor = cor(x = spi_val,  
              y = sci_val,    
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup() 

sci_corr_sta %>% 
  ggplot(aes(x = gage, y = cor)) + 
  geom_boxplot()  

# note the fal_hot gage is an outlier... 
  
# average at the ecoregion scale====     
sci_corr_ecoreg <- sci_all %>%  
  filter(gage != "fal_hot") %>%      # drop the low correlation outlier  
  group_by(ecoreg, spi_length, sci_length, lag_length) %>%   
  summarize(  
   cor = cor(x = spi_val,   
              y = sci_val,     
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup() 

sci_corr_ecoreg %>% 
  ggplot(aes(x = lag_length, y = cor)) + 
  facet_wrap(vars(ecoreg), 
             nrow = 2) + 
  geom_point()  + 
  geom_smooth()  
```  

```{r}
sci_corr_ecoreg %>%  
  ggplot(aes(x = lag_length, y = cor_mean)) + 
  facet_grid(cols = vars(ecoreg)) + 
  geom_point(aes(color = spi_length)) +  
  geom_smooth()  
```

```{r}

# pick the top correlations====   
#sci_corr <- sci_corr_all %>%   
#  group_by(sta, gage, group, ecoreg, spi_length) %>%  
#  summarize(  
#    corr = max(cor)
#    ) %>% 
#  ungroup()    

#sci_corr_join <- right_join(sci_corr_all, sci_corr, 
#                           by = c("cor" = "corr", 
#                                  "sta",  
#                                  "gage",  
#                                  "group", 
#                                  "ecoreg", 
#                                  "spi_length"))  




  
# Visualize the cross-correlations (not ready yet!) 
sci_sta_autocorrelations %>%  
    ggplot(aes(x = lag, 
               y = cor,
#               color = gage, 
               group = gage)) +  
    # Add horizontal line a y=0  
    geom_hline(yintercept = 0) +  
    # Plot autocorrelations  
    geom_point(size = 2) +  
    geom_segment(aes(xend = lag, yend = 0), size = 1) +  
    # Add cutoffs  
    geom_line(aes(y = cutoff_upper), color = "blue", linetype = 2) +  
    geom_line(aes(y = cutoff_lower), color = "blue", linetype = 2) +  
    # Add facets  
    facet_wrap(~ gage, ncol = 3) +  
    # Aesthetics  
    expand_limits(y = c(-0.5, 0.5)) +  
    scale_color_tq() +  
    theme_tq() +  
    labs(  
        title = paste0("Tidyverse ACF Plot: Lags ", rlang::expr_text(k)),  
        subtitle = "Appears to be a weekly pattern",  
        x = "Lags"  
    ) +  
    theme(  
        legend.position = "none",  
        axis.text.x = element_text(angle = 45, hjust = 1)  
    )  
  
# Get the absolute autocorrelations====  
# Verify the weekly pattern assessment by reviewing the absolute value of the  
#   correlations independent of package. We take the absolute autocorrelation   
#   because we use the magnitude as a proxy for how much explanatory value the   
#   lag provides.   
# Use dplyr functions to manipulate the data for visualization:  
# 1. drop the package group constraint using ungroup(),    
# 2. calculate the absolute correlation using mutate(),  
# 3. convert the lag to a factor, which helps with reordering the plot.  
# 4. Select() only the “lag” and “cor_abs” columns,    
# 5.  group by “lag” to lump all of the lags together -- to determine the  
#       trend independent of package.  
  
tidyverse_absolute_autocorrelations <- tidyverse_count_autocorrelations %>%  
    ungroup() %>%  
    mutate(  
        lag = as_factor(as.character(lag)),  
        cor_abs = abs(cor)  
        ) %>%  
    select(lag, cor_abs) %>%  
    group_by(lag)   
  
# Visualize the absolute correlations====  
# 1. Use a box plot that lumps each of the lags together. 
# 2. Add a line to indicate the presence of outliers at values above 1.5IQR  
#     If the values are consistently above the 1.5IQR limit, the lag can be  
#     considered an outlier. Note that we use the fct_reorder() function from  
#     forcats to organize the boxplot in order of decending magnitude.  

# Visualize boxplot of absolute autocorrelations   
break_point <- 1.5 * IQR(tidyverse_absolute_autocorrelations$cor_abs) %>%  
  signif(3)  
  
tidyverse_absolute_autocorrelations %>%    
    ggplot(aes(x = fct_reorder(lag, cor_abs, .desc = TRUE),  
               y = cor_abs)) +  
    # Add boxplot   
    geom_boxplot(color = palette_light()[[1]]) +  
    # Add horizontal line at outlier break point  
    geom_hline(yintercept = break_point, color = "red") +  
    annotate("text", label = paste0("Outlier Break Point = ", break_point),  
             x = 24.5, y = break_point + .03, color = "red") +  
    # Aesthetics  
    expand_limits(y = c(0, 1)) +  
    theme_tq() +  
    labs(  
        title = paste0("Absolute Autocorrelations: Lags ", 
                       rlang::expr_text(k)),  
        subtitle = "Weekly pattern is consistently above outlier break point",  
        x = "Lags"  
    ) +  
    theme(  
        legend.position = "none",  
        axis.text.x = element_text(angle = 45, hjust = 1)  
    )  
  
# outcome -- lags in multiples of seven have the highest autocorrelation  
#   and are consistently above the outlier break point indicating the presence  
#   of a strong weekly pattern. The autocorrelation with the seven-day lag is  
#   the highest, with a median of approximately 0.75. Lags 14, 21, and 28 are  
#   also outliers with median autocorrelations in excess of our outlier break  
#   point of 0.471.  
  
# Note -- the median of Lag 1 is essentially at the break point indicating  
#   that half of the packages have a presence of “abnormal” autocorrelation.  
#   However, this is not part of a seasonal pattern since a periodic frequency  
#   is not present.  
# In the case above, the tidyverse packages exhibit a strong weekly pattern.  
``` 

```{r old_code, eval=FALSE}

  
# prepare for plotting - reorganize flow by centroids====   
mclust_aug_means <- mclust_aug %>%  
  group_by(.class) %>%  
  summarize(#q1_flow = mean(q1_mon),  # these are ~equal to mclust_means  
            #q7_flow = mean(q7_mon),  
            #q30_flow = mean(q30_mon),  
            mean.PC1_mon = mean(PC1_mon),  
            mean.PC2_mon = mean(PC2_mon), 
            size = n()  
            ) %>%  
  ungroup()  
  
mclust_means <- full_join(mclust_means, mclust_aug_means,  
                  by = c("size",  
                         ".class")  
                  ) %>%  
# reorganize columns  
  select(.class,  
         flow_type,  
         size,  
         proportion,  
         everything()  
         )  
  
# join flow_type to tidy cluster model & clean up global environment====  
mclust_aug <- full_join(mclust_aug, mclust_means,  
                     by = c(".class")  
                     ) %>%  
  group_by(.class, ecoreg) %>%  
  mutate(q1 = mean(q1_mon)) %>%  
  mutate(q7_eco = mean(q7_mon)) %>%  
  mutate(q30_eco = mean(q30_mon))  %>%  
  mutate(PC1_eco = mean(PC1_mon)) %>%  
  mutate(PC2_eco = mean(PC2_mon)) %>%  
  ungroup() %>%  
  mutate(flow_type = as.factor(flow_type)) %>%  
# change the order of facets #  
  mutate(ecoreg = factor(ecoreg,  
                         levels = c('Pierre Shale Plains',  
                                    'Pine Ridge Escarpment',  
                                    'White River Badlands',  
                                    'Black Hills Plateau',  
                                    'Keya Paha Tablelands',  
                                    'Sand Hills')  
                         )  
         )  
  
# get proportions of different flow types by ecoregion  
mclust_prop <- mclust_aug %>%  
  group_by(ecoreg, flow_type) %>%  
  summarize(count = n()) %>%  
  group_by(ecoreg) %>%  
  mutate(count2 = sum(count)) %>%  
  ungroup() %>%  
  mutate(proportion_ecoreg = count/count2)  %>%  
  select(-c(count, count2))  
  
mclust_aug <- full_join(mclust_aug, mclust_prop,   
                         by = c("ecoreg", "flow_type"))  
  
# check results -- sample cluster plot====  
factoextra::fviz_mclust(mod,  
                          "classification",  
                          geom = "point",  
                          ellipse.type = "t",  
                          ellipse.level = 0.7,  
                          pointsize = 1.5,  
                          palatte = "npg"  
                          )  
  
# clean up global environment  
rm(clust_input,  
   BIC,  
   mclust_aug_means,  
   mclust_prop  
   )  
   
```

```{r ci_result_table, eval=FALSE}  

# get mean precipitation 
prcp <- spi_fin %>%  
  group_by(group) %>%  
  summarise(prcp = mean(prcp)) %>% 
  ungroup() 

rap_bef <- prcp %>% 
  filter(group == "RAP<1989") %>% 
  select(-group) %>% 
  as.double()

# pluck results for summary tables & bind====
prcp_results <- prcp_dabest %>% 
  pluck("result") %>% 
  select(-c(func,  
            paired,  
            variable,  
            bootstraps,  
            nboots,  
            pct_ci_low,  
            pct_ci_high  
  )  
  )   

prcp_results <- full_join(prcp_results, prcp, 
                  by = c("test_group" = "group")  
                  ) %>% 
  filter(test_group != "RAP<1989") %>% 
  mutate(control_group = case_when(  
    is.na(control_group) ~ "RAP<1989",  
    TRUE ~ control_group  
    )
  ) %>%  
  mutate(difference = case_when(  
    is.na(difference) ~ prcp - rap_bef,  
    TRUE ~ difference  
    )
  ) %>% 
  mutate(ci = as.integer(ci))  %>% 
  mutate_if(is.numeric, round, digits = 0)  


# convert tibble to a flextable after fixing vars for presentation==== 
prcp_table <- prcp_table %>% 
  flextable() %>% 
  #  colformat_num(col_keys = col_key_num, 
  #                big.mark=",", 
  #                digits = 1, na_str = "N/A") %>% 
  set_header_labels(control_group = "Control Group", 
                    test_group = "Test Groups", 
                    control_size = "Control Size",
                    test_size = "Test Size", 
                    func = "Test Statistic", 
                    variable = "Variable",
                    difference = "Mean Difference", 
                    ci = "CI", 
                    bca_ci_low = "Lower Limit", 
                    bca_ci_high = "Upper Limit") %>% 
  autofit() %>% 
  align(., part = "all", align = "center") %>% 
  theme_booktabs() 


ci_table2 <- read_docx() %>% 
  body_add_flextable(value = ci_table)   
  
print(ci_table2, target = "output/ci_table.docx") 
  
rm(ci_results_pc1, ci_results_pc2, ci_table2, ci_table) 
  
```  
-->

