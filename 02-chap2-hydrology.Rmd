<!--
Big Picture Steps
2.    Characterize drought
2.1   Download station data: _04_prco-data_munging
2.2   Identify distribution
2.3   Calculate SPI
2.3.1 Learn purrr::map(): http://r4ds.had.co.nz/iteration.html#the-map-functions
2.4   Calculate SDI
2.5   Cluster time series  
2.6   Delineate watersheds
2.7   Cluster ungaged stations
2.7.1 learn 'rf' function
2.8   Disseminate results
2.8.1 Identify journal


## Broad questions:
What is the drought history of the Pine Ridge Reservation?  
Does the drought extent differ across the study area?

## Narrower question:
What is the underlying distribution of precipitation data?  

## Analysis Steps & progress
1. Recreated analysis from the lmomco text ch 12 (author?) in Tidyverse
2. Imported cleaned precipitation data (see 04_prcp-data_munging)   
3. Applied sqrt & log10 transform to explore effects on skew 
4. Explored the data with box plots, violin plot.
5. Applied Weibull plotting position and graphed the data on sqrt plot
6. Calculated L-moments and L-moment ratios 
7. Calculated SPI for 'cot', 'oel', 'rap', 'int', and 'ora' datasets using Pearson III.

## Issues: there is a duplicate variable - int for 'intermediate' and for 'Interior' 
## Next Steps: 
1.  Combine data frames for coefficients

Someday - Maybe
1. Map the variable as a function - might put off, but ugly and long code below!
2. figure out how to reference stuff 

## Variable naming convention:   
sta          precipitation station  
_meta        metadata  
_mon         monthly precipitation depths  
_grp         wide data changed to long data #might change to _gath
_notzero     non-zero precip values
_zero        precip values equal to zero
_log         log10 of monthly precipitation depths
_count       number of months in a given record

min          minimum non-zero value
n            number of months in a given record

int#         intermediate variable used to bind rows; # = 1, 2, ...
intc#        intermediate variable used to bind cols; # = 1, 2, ...
intr#        intermediate variable used to bind rows; # = 1, 2, ...

# SPI Outputs
spi          Standardized Precipitation Index vals for a station 
 _gath       Dataframe is long rather than wide
 _cot        Cottonwood station
 _oel        Oelrichs station 
 _rap        Rapid City station 
 _int        Interior station 
 -ora        Oral station

## Thoughts - the orig depth vs plotting vals look j-shaped.  
## Sqrt trans vs plotting vals look slightly sinusoidal; nice boxplots
## Log-tranformation looks like the mirror of orig depth vs plotting

## Results: Fits a PE3 distribution
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, include=FALSE, message=FALSE} 
# Sets up the library of packages 
library("magrittr") # contains easier ways to say things about lists
library("here") # identifies where to save work 
library("rio") # more robust I/O - to import and clean data
library("lubridate") # fixes dates 
library("tidyverse") 

library("SPEI") # Calculates SPI-index

#library("lintr")
#library("test_that")
#library("jsonlite") # Convert between JSON data and R objects
#library("curl") # Drop-in replacement for base url
#library("listviewer") # htmlwidget for interactive views of R lists
# library("broom")
#library("janitor") # tools to clean dirty data 

#lmomco <- citation("lmomco")
#toBibtex(lmomco)

# Session Info
a_session <- devtools::session_info()
```

```{r import-data} 
# General Purpose: prepare data for drought index   
# Specific purpose: graphical EDA  
sta_meta    <- as.tibble(import("data/sta_meta_fin3.csv"))  
sta_mon     <- as.tibble(import("data/stations_monthly.csv")) 

# fix date & add year and month  
sta_mon <- sta_mon %>% 
  mutate(date = ymd(date)) %>% 
  arrange(desc(date)) 

# add a small value to zeros to solve a downstream issue 
# maybe have this fixed now using ts rather than date class
#sta_mon <- sta_mon %>% 
#  gather(key = "station", value = "depth", -date, -year, -month) %>%
#  mutate(depth = replace(depth, depth == 0.0, 0.15)) %>%
#  spread(station, depth)

# make the wide data long, remove NA vals, sqrt transform
sta_grp <- sta_mon %>%
  gather(key = "station", value = "depth", -date, -year, -month) %>%
  drop_na(depth)  # %>% 
#  mutate(sqrt_depth = sqrt(depth)) 

# Check on log transformation
#sta_notzero <- sta_grp %>%
#  filter(depth != 0)

#min <- min(sta_notzero$depth)

#sta_zero <- sta_grp %>%
#  filter(depth == 0) %>%
#  mutate(depth = depth + min/2)

#sta_log <- bind_rows(sta_zero, sta_notzero)
#sta_log <- sta_log %>%
#  mutate(log_depth = log10(depth))

#rm(min) 
```

```{r precip-boxplot, include=FALSE, eval=FALSE} 

sta_sum <- as.tibble(summary(sta_mon))
  
# plot the precip data as a boxplot
ggplot(sta_grp, aes(as.factor(station), depth)) +
  geom_violin() +
  geom_boxplot() +
#  scale_y_sqrt() +
#  scale_y_log10() +
  scale_y_sqrt() +
  theme_bw() +
  ggtitle("Weather stations near Pine Ridge Reservation, SD", 
          subtitle = "1909-2018") +
  xlab("") + 
  ylab("Monthly depth in mm") +
  NULL

#ggplot2::ggsave(filename = "rf_boxplot.png", 
#                width = 6, height = 6, units = "in")
```

```{r eda_fiddling, include=FALSE, eval=FALSE}
sta_big <- sta_grp %>%
  filter(depth > 100)
summary(sta_big)
ggplot(sta_big, aes(month)) +
  geom_histogram(binwidth = 1) 

# the anomolously wet month series is dominated by May & June events.
# what drives precip during this time? 
#   In May & June the area recieves low-level moisture from the Gulf 
#   of Mexico, strong cold fronts, and active upper-level pattern 
#   leading to greater chance for convection.
```

```{r testing-cot, include=FALSE, eval=FALSE}
library("tidyverse") 
library("lubridate")
library("rio") 
library("SPEI")

sta_meta    <- as.tibble(import("data/sta_meta_fin3.csv"))  
sta_mon     <- as.tibble(import("data/stations_monthly.csv")) %>% 
  arrange(date)
  
# prepare to rejoin date
Date <- sta_mon %>% 
  select(date) %>%
  mutate(date = ymd(date)) %>%
  arrange(date)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Use a single station - cot
sta_cot_ts <- sta_mon %>% 
  select(cot) %>%
  ts(end = c(2018, 05), frequency = 12)

spi_list  <- spi(sta_cot_ts, 1, 
                 distribution = 'PearsonIII', na.rm = TRUE) 

spi1_coeff_cot <- as.tibble(spi_list$coefficients) %>% 
  t() %>% as.tibble() 

spi1_cot_ts <- as.tibble(spi_list$fitted)  
spi1_cot_ts <- bind_cols(Date, spi1_cot_ts) 

# Results
as.tibble(summary(spi1_cot_ts))
#   Var1  Var2        n                     
#   <chr> <chr>       <fct>                 
# 1 ""    "     date" "Min.   :1909-06-01  "
# 2 ""    "     date" "1st Qu.:1936-08-24  "
# 3 ""    "     date" "Median :1963-11-16  "
# 4 ""    "     date" "Mean   :1963-11-16  "
# 5 ""    "     date" "3rd Qu.:1991-02-08  "
# 6 ""    "     date" "Max.   :2018-05-01  "
# 7 ""    "     cot"  "Min.   :-2.40240  "  
# 8 ""    "     cot"  "1st Qu.:-0.69324  "  
# 9 ""    "     cot"  "Median : 0.02341  "  
#10 ""    "     cot"  "Mean   : 0.01383  "  
#11 ""    "     cot"  "3rd Qu.: 0.68317  "  
#12 ""    "     cot"  "Max.   : 3.30822  "  
```

```{r testing-lubridate, include=FALSE, eval=FALSE}
# Use lubridate-created object for date
# results are as above

library("tidyverse") 
library("lubridate")
library("rio") 
library("SPEI")

sta_meta    <- as.tibble(import("data/sta_meta_fin3.csv"))  
sta_mon     <- as.tibble(import("data/stations_monthly.csv")) %>% 
  arrange(date)

# prepare to rejoin date
Date <- sta_mon %>% 
  select(date) %>%
  mutate(date = ymd(date)) %>%
  arrange(date)

# prepare data 
sta_cot_lub <- sta_mon %>% 
  select(cot) 

spi_list  <- spi(sta_cot_lub, 1, 
                 distribution = 'PearsonIII', na.rm = TRUE) 
 
spi1_coeff_cot_lub <- as.tibble(spi_list$coefficients) %>% 
  t() %>% as.tibble() 

spi1_cot_lub <- as.tibble(spi_list$fitted) 
spi1_cot_lub <- bind_cols(Date, spi1_cot_lub) 
rm(sta_cot_lub)

# Results
as.tibble(summary(spi1_cot_lub))
# A tibble: 12 x 3
#   Var1  Var2        n                     
#   <chr> <chr>       <fct>                 
# 1 ""    "     date" "Min.   :1909-06-01  "
# 2 ""    "     date" "1st Qu.:1936-08-24  "
# 3 ""    "     date" "Median :1963-11-16  "
# 4 ""    "     date" "Mean   :1963-11-16  "
# 5 ""    "     date" "3rd Qu.:1991-02-08  "
# 6 ""    "     date" "Max.   :2018-05-01  "
# 7 ""    "     cot"  "Min.   :-2.40240  "  
# 8 ""    "     cot"  "1st Qu.:-0.69324  "  
# 9 ""    "     cot"  "Median : 0.02341  "  
#10 ""    "     cot"  "Mean   : 0.01383  "  
#11 ""    "     cot"  "3rd Qu.: 0.68317  "  
#12 ""    "     cot"  "Max.   : 3.30822  "   
```

```{r testing-batch, include=FALSE, eval=FALSE}
# Use lubridate-created object for date for a batch process
# results are as above for 'cot' but have -Inf for 'rap' 

library("tidyverse") 
library("lubridate")
library("rio") 
library("SPEI")

sta_meta    <- as.tibble(import("data/sta_meta_fin3.csv"))  
sta_mon     <- as.tibble(import("data/stations_monthly.csv")) %>% 
  arrange(date)

# prepare to rejoin date
Date <- sta_mon %>% 
  select(date) %>%
  mutate(date = ymd(date)) %>%
  arrange(date)

# prepare data 
sta_all <- sta_mon %>% 
  select(-c(date, year, month))  
 
spi_list  <- spi(sta_all, 1,  
                 distribution = 'PearsonIII', na.rm = TRUE) 

spi1_coeff_all <- as.tibble(spi_list$coefficients) %>% 
  t() %>% as.tibble() 

spi1_all <- as.tibble(spi_list$fitted) 
spi1_all <- bind_cols(Date, spi1_all) 

# Selected Results
summary(spi1_all$cot)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# -2.40240 -0.69324  0.02341  0.01383  0.68317  3.30822 

summary(spi1_all$date)
# Min.      1st Qu.       Median     Mean      3rd Qu.       Max.
# "1909-06-01" "36-08-24" "63-11-16" "63-11-16" "91-02-08" "2018-05-01" 
summary(spi1_all$rap)
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#   -Inf -0.6472  0.0022    -Inf  0.6657  2.9000     467 
```

```{r testing-rap, include=FALSE, eval=FALSE} 
# Use only 'rap' with NA vals 
# Summary: It looks like the "bug" is in handling the na.rm?
# Work around: Split, apply combine.

# Use lubridate-created object for date for a batch process
# results are as above for 'cot' but have -Inf for 'rap' 

library("tidyverse") 
library("lubridate")
library("rio") 
library("SPEI")

sta_meta    <- as.tibble(import("data/sta_meta_fin3.csv"))  
sta_mon     <- as.tibble(import("data/stations_monthly.csv")) %>% 
  arrange(date)

# prepare to rejoin date
Date <- sta_mon %>% 
  select(date) %>%
  mutate(date = ymd(date)) %>%
  arrange(date)

# prepare data 
sta_rap <- sta_mon %>% 
  select(rap) 

spi_list  <- spi(sta_rap, 1, 
                 distribution = 'PearsonIII', na.rm = TRUE) 

spi1_coeff_rap <- as.tibble(spi_list$coefficients) %>% 
  t() %>% as.tibble()  

spi1_rap <- as.tibble(spi_list$fitted) 
spi1_rap <- bind_cols(Date, spi1_rap) 

# Results
as.tibble(summary(spi1_rap))
# A tibble: 14 x 3
#   Var1  Var2        n                     
#   <chr> <chr>       <fct>                 
# 1 ""    "     date" "Min.   :1909-06-01  "
# 2 ""    "     date" "1st Qu.:1936-08-24  " 
# 3 ""    "     date" "Median :1963-11-16  "
# 4 ""    "     date" "Mean   :1963-11-16  "
# 5 ""    "     date" "3rd Qu.:1991-02-08  "
# 6 ""    "     date" "Max.   :2018-05-01  "
# 7 ""    "     date" NA                    
# 8 ""    "     rap"  "Min.   :   -Inf  "   
# 9 ""    "     rap"  "1st Qu.:-0.6472  "   
#10 ""    "     rap"  "Median : 0.0022  "   
#11 ""    "     rap"  "Mean   :   -Inf  "   
#12 ""    "     rap"  "3rd Qu.: 0.6657  "   
#13 ""    "     rap"  "Max.   : 2.9000  "   
#14 ""    "     rap"  "NA's   :467  "       
```

```{r spi-cot} 
# This code chunk calculates SPI coefficients for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Cottonwood, SD. 
# Code is mostly following the SPI vignette. 

# Add Cottonwoods dataset and change to time series 
sta_cot <- sta_mon %>% 
  select(date, cot) %>% 
  arrange(date) 

# Calculate Cottonwood SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot  <- spi(sta_cot[,'cot'], 1, distribution = 'PearsonIII') 
spi_2cot  <- spi(sta_cot[,'cot'], 2, distribution = 'PearsonIII') 
spi_3cot  <- spi(sta_cot[,'cot'], 3, distribution = 'PearsonIII') 
spi_4cot  <- spi(sta_cot[,'cot'], 4, distribution = 'PearsonIII') 
spi_5cot  <- spi(sta_cot[,'cot'], 5, distribution = 'PearsonIII') 
spi_6cot  <- spi(sta_cot[,'cot'], 6, distribution = 'PearsonIII') 
spi_9cot  <- spi(sta_cot[,'cot'], 9, distribution = 'PearsonIII') 
spi_12cot <- spi(sta_cot[,'cot'], 12, distribution = 'PearsonIII')  
spi_18cot <- spi(sta_cot[,'cot'], 18, distribution = 'PearsonIII') 
spi_24cot <- spi(sta_cot[,'cot'], 24, distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot_coeff <- as.tibble(spi_1cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_2cot_coeff <- as.tibble(spi_2cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_3cot_coeff <- as.tibble(spi_3cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_4cot_coeff <- as.tibble(spi_4cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_5cot_coeff <- as.tibble(spi_5cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_6cot_coeff <- as.tibble(spi_6cot$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9cot_coeff <- as.tibble(spi_9cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_12cot_coeff <- as.tibble(spi_12cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_18cot_coeff <- as.tibble(spi_18cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_24cot_coeff <- as.tibble(spi_24cot$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot_coeff <- spi_1cot_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2cot_coeff <- spi_2cot_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3cot_coeff <- spi_3cot_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4cot_coeff <- spi_4cot_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5cot_coeff <- spi_5cot_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6cot_coeff <- spi_6cot_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9cot_coeff <- spi_9cot_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12cot_coeff <- spi_12cot_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18cot_coeff <- spi_18cot_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24cot_coeff <- spi_24cot_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 

# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1cot_coeff, spi_2cot_coeff) 
rm(spi_1cot_coeff, spi_2cot_coeff) 

int2 <- bind_cols(int1, spi_3cot_coeff) 
rm(int1, spi_3cot_coeff) 

int3 <- bind_cols(int2, spi_4cot_coeff) 
rm(int2, spi_4cot_coeff) 

int4 <- bind_cols(int3, spi_5cot_coeff) 
rm(int3, spi_5cot_coeff) 

int5 <- bind_cols(int4, spi_6cot_coeff) 
rm(int4, spi_6cot_coeff) 

int6 <- bind_cols(int5, spi_9cot_coeff) 
rm(int5, spi_9cot_coeff) 

int7 <- bind_cols(int6, spi_12cot_coeff) 
rm(int6, spi_12cot_coeff) 

int8 <- bind_cols(int7, spi_18cot_coeff) 
rm(int7, spi_18cot_coeff) 

spi_coeff_cot <- bind_cols(int8, spi_24cot_coeff) 
rm(int8, spi_24cot_coeff, sta_cot) 

spi_coeff_cot <- rownames_to_column(spi_coeff_cot, "month")

# export(spi_coeff_cot, "data/spi_coeff_cot.csv") 
# rm(spi_coeff_cot)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# save SPI values
spi_1cot <- as.tibble(spi_1cot$fitted) %>% 
  mutate(duration = 1) 

spi_2cot <- as.tibble(spi_2cot$fitted) %>% 
  mutate(duration = 2)

spi_3cot <- as.tibble(spi_3cot$fitted) %>% 
  mutate(duration = 3) 

spi_4cot <- as.tibble(spi_4cot$fitted) %>% 
  mutate(duration = 4) 

spi_5cot <- as.tibble(spi_5cot$fitted) %>% 
  mutate(duration = 5) 

spi_6cot <- as.tibble(spi_6cot$fitted) %>% 
  mutate(duration = 6) 

spi_9cot <- as.tibble(spi_9cot$fitted) %>% 
  mutate(duration = 9)

spi_12cot <- as.tibble(spi_12cot$fitted) %>% 
  mutate(duration = 12) 

spi_18cot <- as.tibble(spi_18cot$fitted) %>% 
  mutate(duration = 18) 

spi_24cot <- as.tibble(spi_24cot$fitted) %>% 
  mutate(duration = 24) 

# add date to the SPI data
date <- sta_mon %>%
  select(date) %>%
  arrange(date)

spi_1cot <-  bind_cols(date, spi_1cot) 
spi_2cot  <-  bind_cols(date, spi_2cot) 
spi_3cot  <-  bind_cols(date, spi_3cot) 
spi_4cot  <-  bind_cols(date, spi_4cot) 
spi_5cot  <-  bind_cols(date, spi_5cot) 
spi_6cot  <-  bind_cols(date, spi_6cot) 
spi_9cot  <-  bind_cols(date, spi_9cot) 
spi_12cot <-  bind_cols(date, spi_12cot) 
spi_18cot <-  bind_cols(date, spi_18cot) 
spi_24cot <-  bind_cols(date, spi_24cot) 

# join the SPI data by wide and long
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1- & 2-month
intr1 <- bind_rows(spi_1cot, spi_2cot) 

#intc1 <- bind_cols(spi_1cot, spi_2cot) 
#intc1 <- intc1 %>%
#  select(-c(date1, duration, duration1)) %>%
#  rename(cot_1 = "Series 1") %>%
#  rename(cot_2 = "Series 11")
rm(spi_1cot, spi_2cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3-month
intr2 <- bind_rows(intr1, spi_3cot) 

#intc2 <- bind_cols(intc1, spi_3cot) 
#intc2 <- intc2 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_3 = "Series 1") 
rm(intr1, intc1, spi_3cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 4-month
intr3 <- bind_rows(intr2, spi_4cot) 

#intc3 <- bind_cols(intc2, spi_4cot) 
#intc3 <- intc3 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_4 = "Series 1") 
rm(intr2, intc2, spi_4cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 5-month
intr4 <- bind_rows(intr3, spi_5cot) 

#intc4 <- bind_cols(intc3, spi_5cot) 
#intc4 <- intc4 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_5 = "Series 1") 
rm(intr3, intc3, spi_5cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 6-month
intr5 <- bind_rows(intr4, spi_6cot) 

#intc5 <- bind_cols(intc4, spi_6cot) 
#intc5 <- intc5 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_6 = "Series 1") 
rm(intr4, intc4, spi_6cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 9-month
intr6 <- bind_rows(intr5, spi_9cot) 

#intc6 <- bind_cols(intc5, spi_9cot) 
#intc6 <- intc6 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_9 = "Series 1") 
rm(intr5, intc5, spi_9cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 12-month
intr7 <- bind_rows(intr6, spi_12cot) 

#intc7 <- bind_cols(intc6, spi_12cot) 
#intc7 <- intc7 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_12 = "Series 1") 
rm(intr6, intc6, spi_12cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 18-month
intr8 <- bind_rows(intr7, spi_18cot) 

#intc8 <- bind_cols(intc7, spi_18cot) 
#intc8 <- intc8 %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_18 = "Series 1") 
rm(intr7, intc7, spi_18cot) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 24-month
spi_cot <- bind_rows(intr8, spi_24cot) 

#spi_cot <- bind_cols(intc8, spi_24cot) 
#spi_cot <- spi_cot %>%
#  select(-c(date1, duration)) %>%
#  rename(cot_24 = "Series 1") 

# clean up
rm(intr8, intc8, spi_24cot)  
```

```{r spi-algorithm-coeff-oel}   
# This code chunk calculates SPI coefficients for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Oelrichs  
 
# Add Oelrichs dataset and change to time series 
sta_oel <- sta_mon %>% 
  arrange(date) %>% 
  select(year, month, oel) %>% 
  ts(end = c(2018, 05), frequency = 12) 

# Calculate SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1oel  <- spi(sta_oel[,'oel'], 1, distribution = 'PearsonIII') 
spi_2oel  <- spi(sta_oel[,'oel'], 2, distribution = 'PearsonIII') 
spi_3oel  <- spi(sta_oel[,'oel'], 3, distribution = 'PearsonIII') 
spi_4oel  <- spi(sta_oel[,'oel'], 4, distribution = 'PearsonIII') 
spi_5oel  <- spi(sta_oel[,'oel'], 5, distribution = 'PearsonIII') 
spi_6oel  <- spi(sta_oel[,'oel'], 6, distribution = 'PearsonIII') 
spi_9oel  <- spi(sta_oel[,'oel'], 9, distribution = 'PearsonIII') 
spi_12oel <- spi(sta_oel[,'oel'], 12, distribution = 'PearsonIII')  
spi_18oel <- spi(sta_oel[,'oel'], 18, distribution = 'PearsonIII') 
spi_24oel <- spi(sta_oel[,'oel'], 24, distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1oel_coeff <- as.tibble(spi_1oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_2oel_coeff <- as.tibble(spi_2oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_3oel_coeff <- as.tibble(spi_3oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_4oel_coeff <- as.tibble(spi_4oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_5oel_coeff <- as.tibble(spi_5oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_6oel_coeff <- as.tibble(spi_6oel$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9oel_coeff <- as.tibble(spi_9oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_12oel_coeff <- as.tibble(spi_12oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_18oel_coeff <- as.tibble(spi_18oel$coefficients) %>% 
  t() %>% as.tibble() 

spi_24oel_coeff <- as.tibble(spi_24oel$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1oel_coeff <- spi_1oel_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2oel_coeff <- spi_2oel_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3oel_coeff <- spi_3oel_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4oel_coeff <- spi_4oel_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5oel_coeff <- spi_5oel_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6oel_coeff <- spi_6oel_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9oel_coeff <- spi_9oel_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12oel_coeff <- spi_12oel_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18oel_coeff <- spi_18oel_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24oel_coeff <- spi_24oel_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 


# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1oel_coeff, spi_2oel_coeff) 
rm(spi_1oel_coeff, spi_2oel_coeff) 

int2 <- bind_cols(int1, spi_3oel_coeff) 
rm(int1, spi_3oel_coeff) 

int3 <- bind_cols(int2, spi_4oel_coeff) 
rm(int2, spi_4oel_coeff) 

int4 <- bind_cols(int3, spi_5oel_coeff) 
rm(int3, spi_5oel_coeff) 

int5 <- bind_cols(int4, spi_6oel_coeff) 
rm(int4, spi_6oel_coeff) 

int6 <- bind_cols(int5, spi_9oel_coeff) 
rm(int5, spi_9oel_coeff) 

int7 <- bind_cols(int6, spi_12oel_coeff) 
rm(int6, spi_12oel_coeff) 
 
int8 <- bind_cols(int7, spi_18oel_coeff) 
rm(int7, spi_18oel_coeff) 

spi_coeff_oel <- bind_cols(int8, spi_24oel_coeff) 
rm(int8, spi_24oel_coeff) 

# export(spi_coeff_oel, "data/spi_coeff_oel.csv") 
# rm(spi_coeff_oel, sta_oel)
```

```{r spi-algorithm-fit-oel}
# This code chunk calculates SPI fitted values for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Oelrichs.  
# It is a continuation of 'spi-algorithm-coeff-oel'

# extract SPI values & add duration
spi_1oel <- as.tibble(spi_1oel$fitted) %>% 
  mutate(duration = 1)

spi_2oel <- as.tibble(spi_2oel$fitted) %>% 
  mutate(duration = 2)

spi_3oel <- as.tibble(spi_3oel$fitted) %>% 
  mutate(duration = 3) 

spi_4oel <- as.tibble(spi_4oel$fitted) %>% 
  mutate(duration = 4) 

spi_5oel <- as.tibble(spi_5oel$fitted) %>% 
  mutate(duration = 5) 

spi_6oel <- as.tibble(spi_6oel$fitted) %>% 
  mutate(duration = 6) 

spi_9oel <- as.tibble(spi_9oel$fitted) %>% 
  mutate(duration = 9)

spi_12oel <- as.tibble(spi_12oel$fitted) %>% 
  mutate(duration = 12) 

spi_18oel <- as.tibble(spi_18oel$fitted) %>% 
  mutate(duration = 18) 

spi_24oel <- as.tibble(spi_24oel$fitted) %>% 
  mutate(duration = 24) 

# add date to the SPI data
date <- sta_mon %>%
  select(date) %>%
  arrange(date)

spi_1oel  <-  bind_cols(date, spi_1oel) 
spi_2oel  <-  bind_cols(date, spi_2oel) 
spi_3oel  <-  bind_cols(date, spi_3oel) 
spi_4oel  <-  bind_cols(date, spi_4oel) 
spi_5oel  <-  bind_cols(date, spi_5oel) 
spi_6oel  <-  bind_cols(date, spi_6oel) 
spi_9oel  <-  bind_cols(date, spi_9oel) 
spi_12oel <-  bind_cols(date, spi_12oel) 
spi_18oel <-  bind_cols(date, spi_18oel) 
spi_24oel <-  bind_cols(date, spi_24oel) 

# join the SPI data by wide and long
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1- & 2-month
intr1 <- bind_rows(spi_1oel, spi_2oel) 

intc1 <- bind_cols(spi_1oel, spi_2oel) 
intc1 <- intc1 %>%
  select(-c(date1, duration, duration1)) %>%
  rename(oel_1 = "Series 1") %>%
  rename(oel_2 = "Series 11")
rm(spi_1oel, spi_2oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3-month
intr2 <- bind_rows(intr1, spi_3oel) 

intc2 <- bind_cols(intc1, spi_3oel) 
intc2 <- intc2 %>%
  select(-c(date1, duration)) %>%
  rename(oel_3 = "Series 1") 
rm(intr1, intc1, spi_3oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 4-month
intr3 <- bind_rows(intr2, spi_4oel) 

intc3 <- bind_cols(intc2, spi_4oel) 
intc3 <- intc3 %>%
  select(-c(date1, duration)) %>%
  rename(oel_4 = "Series 1") 
rm(intr2, intc2, spi_4oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 5-month
intr4 <- bind_rows(intr3, spi_5oel) 

intc4 <- bind_cols(intc3, spi_5oel) 
intc4 <- intc4 %>%
  select(-c(date1, duration)) %>%
  rename(oel_5 = "Series 1") 
rm(intr3, intc3, spi_5oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 6-month
intr5 <- bind_rows(intr4, spi_6oel) 

intc5 <- bind_cols(intc4, spi_6oel) 
intc5 <- intc5 %>%
  select(-c(date1, duration)) %>%
  rename(oel_6 = "Series 1") 
rm(intr4, intc4, spi_6oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 9-month
intr6 <- bind_rows(intr5, spi_9oel) 

intc6 <- bind_cols(intc5, spi_9oel) 
intc6 <- intc6 %>%
  select(-c(date1, duration)) %>%
  rename(oel_9 = "Series 1") 
rm(intr5, intc5, spi_9oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 12-month
intr7 <- bind_rows(intr6, spi_12oel) 

intc7 <- bind_cols(intc6, spi_12oel) 
intc7 <- intc7 %>%
  select(-c(date1, duration)) %>%
  rename(oel_12 = "Series 1") 
rm(intr6, intc6, spi_12oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 18-month
intr8 <- bind_rows(intr7, spi_18oel) 

intc8 <- bind_cols(intc7, spi_18oel) 
intc8 <- intc8 %>%
  select(-c(date1, duration)) %>%
  rename(oel_18 = "Series 1") 
rm(intr7, intc7, spi_18oel) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 24-month
spi_oel_gath <- bind_rows(intr8, spi_24oel) 
spi_oel_gath <- spi_oel_gath %>%
  rename(spi_oel = "Series 1")

spi_oel <- bind_cols(intc8, spi_24oel) 
spi_oel <- spi_oel %>%
  select(-c(date1, duration)) %>%
  rename(oel_24 = "Series 1") 

rm(intr8, intc8, spi_24oel, sta_oel) 
# Next steps:
# distribution = 'PersonIII',
```










```{r working-on} 
# This code chunk applies the SPI function across list of stations
# There seems to be an error with zeros and NA vals in 'SPEI'
# The sta_grp data from import-data code chunk above has NA removed

# Change the data into a simple list 
by_sta <- sta_grp %>% 
  select(station, depth, date) %>% 
    split(.$station) %>%
  transpose() # invert the list
by_sta <- by_sta$depth # drop the unneeded character elements

# Apply SPI to the list
spi_list  <- by_sta %>% 
  purrr::map(~spi(data = ., 1,  
                 distribution = 'PearsonIII', na.rm = TRUE)) %>%
  transpose()
spi_fit <- as.array(spi_list$fitted, make.names = TRUE)

test <- as.tibble(unlist(spi_fit))

cot <- as.tibble(spi_fit$cot)



```





# Next Steps - work with dates to join the lists???
by_sta_date <- sta_grp %>% 
  select(station, date) %>% 
    split(.$station) %>%
  transpose() # invert the list
multi_join <- function(list_of_loaded_data, join_func, ...){
    require("dplyr")
    output <- Reduce(function(x, y) {join_func(x, y, ...)}, list_of_loaded_data)
    return(output)
}
merged_data <- multi_join(spi_list, full_join)

by_sta_date <- by_sta_date$date # drop the unneeded character elements




```{r SPI-1month}

test <- as.tibble(import("data/stations_monthly.csv")) %>% 
  select(date, cot)

Date <- test %>% 
  select(date) %>%
  mutate(date = ymd(date)) 

test <- test %>%
  ts(end = c(2018, 05), frequency = 12)

spi_list  <- spi(test[,'cot'], 1, 
                 distribution = 'PearsonIII', na.rm = TRUE) 

test_coeff <- as.tibble(spi_list$coefficients) %>% 
  t() %>% as.tibble() 

spi_test <- as.tibble(spi_list$fitted) %>%
  rename(cot = "Series 1")
spi_test <- bind_cols(Date, spi_test) 

# visual check of output for cottonwood SPI
ggplot(spi_test, aes(date, cot)) + 
  geom_line() +
  theme_classic() + 
  labs(title = "Standardized Precipitation Index (SPI)",
       subtitle = "Cottonwood, SD") +
       xlab("") + 
       ylab("SPI-value") +
  NULL 


```




```{r spi-algorithm-coeff-rap} 
# This code chunk calculates SPI coefficients for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Rapid City, SD.

# Add Rapid City dataset and change to time series 
sta_rap <- sta_mon %>% 
  arrange(date) %>% 
  select(year, month, rap) %>% 
  ts(end = c(2018, 05), frequency = 12)

# Calculate SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
# Added na.rm = TRUE to handle the missing vals
spi_1rap  <- spi(sta_rap[,'rap'], 1, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_2rap  <- spi(sta_rap[,'rap'], 2, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_3rap  <- spi(sta_rap[,'rap'], 3, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_4rap  <- spi(sta_rap[,'rap'], 4, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_5rap  <- spi(sta_rap[,'rap'], 5, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_6rap  <- spi(sta_rap[,'rap'], 6, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_9rap  <- spi(sta_rap[,'rap'], 9, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_12rap <- spi(sta_rap[,'rap'], 12, na.rm = TRUE, 
                 distribution = 'PearsonIII')  
spi_18rap <- spi(sta_rap[,'rap'], 18, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_24rap <- spi(sta_rap[,'rap'], 24, na.rm = TRUE, 
                 distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1rap_coeff <- as.tibble(spi_1rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_2rap_coeff <- as.tibble(spi_2rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_3rap_coeff <- as.tibble(spi_3rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_4rap_coeff <- as.tibble(spi_4rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_5rap_coeff <- as.tibble(spi_5rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_6rap_coeff <- as.tibble(spi_6rap$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9rap_coeff <- as.tibble(spi_9rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_12rap_coeff <- as.tibble(spi_12rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_18rap_coeff <- as.tibble(spi_18rap$coefficients) %>% 
  t() %>% as.tibble() 

spi_24rap_coeff <- as.tibble(spi_24rap$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1rap_coeff <- spi_1rap_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2rap_coeff <- spi_2rap_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3rap_coeff <- spi_3rap_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4rap_coeff <- spi_4rap_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5rap_coeff <- spi_5rap_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6rap_coeff <- spi_6rap_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9rap_coeff <- spi_9rap_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12rap_coeff <- spi_12rap_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18rap_coeff <- spi_18rap_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24rap_coeff <- spi_24rap_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 


# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1rap_coeff, spi_2rap_coeff) 
rm(spi_1rap_coeff, spi_2rap_coeff) 

int2 <- bind_cols(int1, spi_3rap_coeff) 
rm(int1, spi_3rap_coeff) 

int3 <- bind_cols(int2, spi_4rap_coeff) 
rm(int2, spi_4rap_coeff) 

int4 <- bind_cols(int3, spi_5rap_coeff) 
rm(int3, spi_5rap_coeff) 

int5 <- bind_cols(int4, spi_6rap_coeff) 
rm(int4, spi_6rap_coeff) 

int6 <- bind_cols(int5, spi_9rap_coeff) 
rm(int5, spi_9rap_coeff) 

int7 <- bind_cols(int6, spi_12rap_coeff) 
rm(int6, spi_12rap_coeff) 

int8 <- bind_cols(int7, spi_18rap_coeff) 
rm(int7, spi_18rap_coeff) 

spi_coeff_rap <- bind_cols(int8, spi_24rap_coeff) 
rm(int8, spi_24rap_coeff, sta_rap) 

# export(spi_coeff_rap, "data/spi_coeff_rap.csv") 
# rm(spi_coeff_rap)
```

```{r spi-algorithm-fit-rap}
# This code chunk calculates SPI fitted values for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Rapid City, SD. 
# It is a continuation of 'spi-algorithm-coeff-rap'

# extract SPI values & add duration
spi_1rap <- as.tibble(spi_1rap$fitted) %>% 
  mutate(duration = 1)

spi_2rap <- as.tibble(spi_2rap$fitted) %>% 
  mutate(duration = 2)

spi_3rap <- as.tibble(spi_3rap$fitted) %>% 
  mutate(duration = 3) 

spi_4rap <- as.tibble(spi_4rap$fitted) %>% 
  mutate(duration = 4) 

spi_5rap <- as.tibble(spi_5rap$fitted) %>% 
  mutate(duration = 5) 

spi_6rap <- as.tibble(spi_6rap$fitted) %>% 
  mutate(duration = 6) 

spi_9rap <- as.tibble(spi_9rap$fitted) %>% 
  mutate(duration = 9)

spi_12rap <- as.tibble(spi_12rap$fitted) %>% 
  mutate(duration = 12) 

spi_18rap <- as.tibble(spi_18rap$fitted) %>% 
  mutate(duration = 18) 

spi_24rap <- as.tibble(spi_24rap$fitted) %>% 
  mutate(duration = 24) 

# add date to the SPI data
date <- sta_mon %>%
  select(date) %>%
  arrange(date)

spi_1rap  <-  bind_cols(date, spi_1rap) 
spi_2rap  <-  bind_cols(date, spi_2rap) 
spi_3rap  <-  bind_cols(date, spi_3rap) 
spi_4rap  <-  bind_cols(date, spi_4rap) 
spi_5rap  <-  bind_cols(date, spi_5rap) 
spi_6rap  <-  bind_cols(date, spi_6rap) 
spi_9rap  <-  bind_cols(date, spi_9rap) 
spi_12rap <-  bind_cols(date, spi_12rap) 
spi_18rap <-  bind_cols(date, spi_18rap) 
spi_24rap <-  bind_cols(date, spi_24rap) 

# join the SPI data by wide and long
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1- & 2-month
intr1 <- bind_rows(spi_1rap, spi_2rap) 

intc1 <- bind_cols(spi_1rap, spi_2rap) 
intc1 <- intc1 %>%
  select(-c(date1, duration, duration1)) %>%
  rename(int_1 = "Series 1") %>%
  rename(int_2 = "Series 11")
rm(spi_1rap, spi_2rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3-month
intr2 <- bind_rows(intr1, spi_3rap) 

intc2 <- bind_cols(intc1, spi_3rap) 
intc2 <- intc2 %>%
  select(-c(date1, duration)) %>%
  rename(rap_3 = "Series 1") 
rm(intr1, intc1, spi_3rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 4-month
intr3 <- bind_rows(intr2, spi_4rap) 

intc3 <- bind_cols(intc2, spi_4rap) 
intc3 <- intc3 %>%
  select(-c(date1, duration)) %>%
  rename(rap_4 = "Series 1") 
rm(intr2, intc2, spi_4rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 5-month
intr4 <- bind_rows(intr3, spi_5rap) 

intc4 <- bind_cols(intc3, spi_5rap) 
intc4 <- intc4 %>%
  select(-c(date1, duration)) %>%
  rename(rap_5 = "Series 1") 
rm(intr3, intc3, spi_5rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 6-month
intr5 <- bind_rows(intr4, spi_6rap) 

intc5 <- bind_cols(intc4, spi_6rap) 
intc5 <- intc5 %>%
  select(-c(date1, duration)) %>%
  rename(rap_6 = "Series 1") 
rm(intr4, intc4, spi_6rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 9-month
intr6 <- bind_rows(intr5, spi_9rap) 

intc6 <- bind_cols(intc5, spi_9rap) 
intc6 <- intc6 %>%
  select(-c(date1, duration)) %>%
  rename(rap_9 = "Series 1") 
rm(intr5, intc5, spi_9rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 12-month
intr7 <- bind_rows(intr6, spi_12rap) 

intc7 <- bind_cols(intc6, spi_12rap) 
intc7 <- intc7 %>%
  select(-c(date1, duration)) %>%
  rename(rap_12 = "Series 1") 
rm(intr6, intc6, spi_12rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 18-month
intr8 <- bind_rows(intr7, spi_18rap) 

intc8 <- bind_cols(intc7, spi_18rap) 
intc8 <- intc8 %>%
  select(-c(date1, duration)) %>%
  rename(rap_18 = "Series 1") 
rm(intr7, intc7, spi_18rap) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 24-month
spi_rap_gath <- bind_rows(intr8, spi_24rap) 
spi_rap_gath <- spi_rap_gath %>%
  rename(spi_rap = "Series 1")

spi_rap <- bind_cols(intc8, spi_24rap) 
spi_rap <- spi_rap %>%
  select(-c(date1, duration)) %>%
  rename(rap_24 = "Series 1") 

rm(intr8, intc8, spi_24rap) 
# Next steps:
# distribution = 'PersonIII'
```

```{r spi-algorithm-coeff-int}  
# This code chunk calculates SPI coefficients for  
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Interior, SD. 

# Add Interior dataset and change to time series 
sta_int <- sta_mon %>% 
  arrange(date) %>% 
  select(year, month, int) %>% 
  ts(end = c(2018, 05), frequency = 12)

# Calculate SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
# Added na.rm = TRUE to handle the missing vals
spi_1int  <- spi(sta_int[,'int'], 1, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_2int  <- spi(sta_int[,'int'], 2, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_3int  <- spi(sta_int[,'int'], 3, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_4int  <- spi(sta_int[,'int'], 4, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_5int  <- spi(sta_int[,'int'], 5, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_6int  <- spi(sta_int[,'int'], 6, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_9int  <- spi(sta_int[,'int'], 9, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_12int <- spi(sta_int[,'int'], 12, na.rm = TRUE, 
                 distribution = 'PearsonIII')  
spi_18int <- spi(sta_int[,'int'], 18, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_24int <- spi(sta_int[,'int'], 24, na.rm = TRUE, 
                 distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1int_coeff <- as.tibble(spi_1int$coefficients) %>% 
  t() %>% as.tibble() 

spi_2int_coeff <- as.tibble(spi_2int$coefficients) %>% 
  t() %>% as.tibble() 

spi_3int_coeff <- as.tibble(spi_3int$coefficients) %>% 
  t() %>% as.tibble() 

spi_4int_coeff <- as.tibble(spi_4int$coefficients) %>% 
  t() %>% as.tibble() 

spi_5int_coeff <- as.tibble(spi_5int$coefficients) %>% 
  t() %>% as.tibble() 

spi_6int_coeff <- as.tibble(spi_6int$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9int_coeff <- as.tibble(spi_9int$coefficients) %>% 
  t() %>% as.tibble() 

spi_12int_coeff <- as.tibble(spi_12int$coefficients) %>% 
  t() %>% as.tibble() 

spi_18int_coeff <- as.tibble(spi_18int$coefficients) %>% 
  t() %>% as.tibble() 

spi_24int_coeff <- as.tibble(spi_24int$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1int_coeff <- spi_1int_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2int_coeff <- spi_2int_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3int_coeff <- spi_3int_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4int_coeff <- spi_4int_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5int_coeff <- spi_5int_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6int_coeff <- spi_6int_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9int_coeff <- spi_9int_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12int_coeff <- spi_12int_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18int_coeff <- spi_18int_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24int_coeff <- spi_24int_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 


# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1int_coeff, spi_2int_coeff) 
rm(spi_1int_coeff, spi_2int_coeff) 

int2 <- bind_cols(int1, spi_3int_coeff) 
rm(int1, spi_3int_coeff) 

int3 <- bind_cols(int2, spi_4int_coeff) 
rm(int2, spi_4int_coeff) 

int4 <- bind_cols(int3, spi_5int_coeff) 
rm(int3, spi_5int_coeff) 

int5 <- bind_cols(int4, spi_6int_coeff) 
rm(int4, spi_6int_coeff) 

int6 <- bind_cols(int5, spi_9int_coeff) 
rm(int5, spi_9int_coeff) 

int7 <- bind_cols(int6, spi_12int_coeff) 
rm(int6, spi_12int_coeff) 

int8 <- bind_cols(int7, spi_18int_coeff) 
rm(int7, spi_18int_coeff) 

spi_coeff_int <- bind_cols(int8, spi_24int_coeff) 
rm(int8, spi_24int_coeff, sta_int) 

# export(spi_coeff_int, "data/spi_coeff_int.csv") 
# rm(spi_coeff_int)
```

```{r spi-algorithm-fit-int}  
# This code chunk calculates SPI fitted values for  
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Interior, SD. 
# It is a continuation of 'spi-algorithm-coeff-int'

# extract SPI values & add duration
spi_1int <- as.tibble(spi_1int$fitted) %>% 
  mutate(duration = 1)

spi_2int <- as.tibble(spi_2int$fitted) %>% 
  mutate(duration = 2)

spi_3int <- as.tibble(spi_3int$fitted) %>% 
  mutate(duration = 3) 

spi_4int <- as.tibble(spi_4int$fitted) %>% 
  mutate(duration = 4) 

spi_5int <- as.tibble(spi_5int$fitted) %>% 
  mutate(duration = 5) 

spi_6int <- as.tibble(spi_6int$fitted) %>% 
  mutate(duration = 6) 

spi_9int <- as.tibble(spi_9int$fitted) %>% 
  mutate(duration = 9)

spi_12int <- as.tibble(spi_12int$fitted) %>% 
  mutate(duration = 12) 

spi_18int <- as.tibble(spi_18int$fitted) %>% 
  mutate(duration = 18) 

spi_24int <- as.tibble(spi_24int$fitted) %>% 
  mutate(duration = 24) 

# add date to the SPI data
date <- sta_mon %>%
  select(date) %>%
  arrange(date)

spi_1int  <-  bind_cols(date, spi_1int) 
spi_2int  <-  bind_cols(date, spi_2int) 
spi_3int  <-  bind_cols(date, spi_3int) 
spi_4int  <-  bind_cols(date, spi_4int) 
spi_5int  <-  bind_cols(date, spi_5int) 
spi_6int  <-  bind_cols(date, spi_6int) 
spi_9int  <-  bind_cols(date, spi_9int) 
spi_12int <-  bind_cols(date, spi_12int) 
spi_18int <-  bind_cols(date, spi_18int) 
spi_24int <-  bind_cols(date, spi_24int) 

# join the SPI data by wide and long
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1- & 2-month
intr1 <- bind_rows(spi_1int, spi_2int) 

intc1 <- bind_cols(spi_1int, spi_2int) 
intc1 <- intc1 %>%
  select(-c(date1, duration, duration1)) %>%
  rename(int_1 = "Series 1") %>%
  rename(int_2 = "Series 11")
rm(spi_1int, spi_2int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3-month
intr2 <- bind_rows(intr1, spi_3int) 

intc2 <- bind_cols(intc1, spi_3int) 
intc2 <- intc2 %>%
  select(-c(date1, duration)) %>%
  rename(int_3 = "Series 1") 
rm(intr1, intc1, spi_3int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 4-month
intr3 <- bind_rows(intr2, spi_4int) 

intc3 <- bind_cols(intc2, spi_4int) 
intc3 <- intc3 %>%
  select(-c(date1, duration)) %>%
  rename(int_4 = "Series 1") 
rm(intr2, intc2, spi_4int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 5-month
intr4 <- bind_rows(intr3, spi_5int) 

intc4 <- bind_cols(intc3, spi_5int) 
intc4 <- intc4 %>%
  select(-c(date1, duration)) %>%
  rename(int_5 = "Series 1") 
rm(intr3, intc3, spi_5int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 6-month
intr5 <- bind_rows(intr4, spi_6int) 

intc5 <- bind_cols(intc4, spi_6int) 
intc5 <- intc5 %>%
  select(-c(date1, duration)) %>%
  rename(int_6 = "Series 1") 
rm(intr4, intc4, spi_6int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 9-month
intr6 <- bind_rows(intr5, spi_9int) 

intc6 <- bind_cols(intc5, spi_9int) 
intc6 <- intc6 %>%
  select(-c(date1, duration)) %>%
  rename(int_9 = "Series 1") 
rm(intr5, intc5, spi_9int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 12-month
intr7 <- bind_rows(intr6, spi_12int) 

intc7 <- bind_cols(intc6, spi_12int) 
intc7 <- intc7 %>%
  select(-c(date1, duration)) %>%
  rename(int_12 = "Series 1") 
rm(intr6, intc6, spi_12int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 18-month
intr8 <- bind_rows(intr7, spi_18int) 

intc8 <- bind_cols(intc7, spi_18int) 
intc8 <- intc8 %>%
  select(-c(date1, duration)) %>%
  rename(int_18 = "Series 1") 
rm(intr7, intc7, spi_18int) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 24-month
spi_int_gath <- bind_rows(intr8, spi_24int) 
spi_int_gath <- spi_int_gath %>%
  rename(spi_int = "Series 1")

spi_int <- bind_cols(intc8, spi_24int) 
spi_int <- spi_int %>%
  select(-c(date1, duration)) %>%
  rename(int_24 = "Series 1") 

rm(intr8, intc8, spi_24int) 
# Next steps:
# distribution = 'PersonIII',
```

```{r spi-algorithm-coeff-ora}  
# This code chunk calculates SPI coefficients for  
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Oral, SD.

# Add Oral dataset and change to time series 
sta_ora <- sta_mon %>% 
  arrange(date) %>% 
  select(year, month, ora) %>% 
  ts(end = c(2018, 05), frequency = 12)

# Calculate SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
# Added na.rm = TRUE to handle the missing vals
spi_1ora  <- spi(sta_ora[,'ora'], 1, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_2ora  <- spi(sta_ora[,'ora'], 2, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_3ora  <- spi(sta_ora[,'ora'], 3, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_4ora  <- spi(sta_ora[,'ora'], 4, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_5ora  <- spi(sta_ora[,'ora'], 5, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_6ora  <- spi(sta_ora[,'ora'], 6, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_9ora  <- spi(sta_ora[,'ora'], 9, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_12ora <- spi(sta_ora[,'ora'], 12, na.rm = TRUE, 
                 distribution = 'PearsonIII')  
spi_18ora <- spi(sta_ora[,'ora'], 18, na.rm = TRUE, 
                 distribution = 'PearsonIII') 
spi_24ora <- spi(sta_ora[,'ora'], 24, na.rm = TRUE, 
                 distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1ora_coeff <- as.tibble(spi_1ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_2ora_coeff <- as.tibble(spi_2ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_3ora_coeff <- as.tibble(spi_3ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_4ora_coeff <- as.tibble(spi_4ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_5ora_coeff <- as.tibble(spi_5ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_6ora_coeff <- as.tibble(spi_6ora$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9ora_coeff <- as.tibble(spi_9ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_12ora_coeff <- as.tibble(spi_12ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_18ora_coeff <- as.tibble(spi_18ora$coefficients) %>% 
  t() %>% as.tibble() 

spi_24ora_coeff <- as.tibble(spi_24ora$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1ora_coeff <- spi_1ora_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2ora_coeff <- spi_2ora_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3ora_coeff <- spi_3ora_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4ora_coeff <- spi_4ora_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5ora_coeff <- spi_5ora_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6ora_coeff <- spi_6ora_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9ora_coeff <- spi_9ora_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12ora_coeff <- spi_12ora_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18ora_coeff <- spi_18ora_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24ora_coeff <- spi_24ora_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 


# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1ora_coeff, spi_2ora_coeff) 
rm(spi_1ora_coeff, spi_2ora_coeff) 

int2 <- bind_cols(int1, spi_3ora_coeff) 
rm(int1, spi_3ora_coeff) 

int3 <- bind_cols(int2, spi_4ora_coeff) 
rm(int2, spi_4ora_coeff) 

int4 <- bind_cols(int3, spi_5ora_coeff) 
rm(int3, spi_5ora_coeff) 

int5 <- bind_cols(int4, spi_6ora_coeff) 
rm(int4, spi_6ora_coeff) 

int6 <- bind_cols(int5, spi_9ora_coeff) 
rm(int5, spi_9ora_coeff) 

int7 <- bind_cols(int6, spi_12ora_coeff) 
rm(int6, spi_12ora_coeff) 

int8 <- bind_cols(int7, spi_18ora_coeff) 
rm(int7, spi_18ora_coeff) 

spi_coeff_ora <- bind_cols(int8, spi_24ora_coeff) 
rm(int8, spi_24ora_coeff, sta_ora) 

# export(spi_coeff_ora, "data/spi_coeff_ora.csv") 
# rm(spi_coeff_ora)
```

```{r spi-algorithm-fit-ora} 
# This code chunk calculates SPI fitted values for  
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Oral, SD. 
# It is a continuation of 'spi-algorithm-coeff-ora'

# extract SPI values & add duration
spi_1ora <- as.tibble(spi_1ora$fitted) %>% 
  mutate(duration = 1)

spi_2ora <- as.tibble(spi_2ora$fitted) %>% 
  mutate(duration = 2)

spi_3ora <- as.tibble(spi_3ora$fitted) %>% 
  mutate(duration = 3) 

spi_4ora <- as.tibble(spi_4ora$fitted) %>% 
  mutate(duration = 4) 

spi_5ora <- as.tibble(spi_5ora$fitted) %>% 
  mutate(duration = 5) 

spi_6ora <- as.tibble(spi_6ora$fitted) %>% 
  mutate(duration = 6) 

spi_9ora <- as.tibble(spi_9ora$fitted) %>% 
  mutate(duration = 9)

spi_12ora <- as.tibble(spi_12ora$fitted) %>% 
  mutate(duration = 12) 

spi_18ora <- as.tibble(spi_18ora$fitted) %>% 
  mutate(duration = 18) 

spi_24ora <- as.tibble(spi_24ora$fitted) %>% 
  mutate(duration = 24) 

# add date to the SPI data
date <- sta_mon %>%
  select(date) %>%
  arrange(date)

spi_1ora  <-  bind_cols(date, spi_1ora) 
spi_2ora  <-  bind_cols(date, spi_2ora) 
spi_3ora  <-  bind_cols(date, spi_3ora) 
spi_4ora  <-  bind_cols(date, spi_4ora) 
spi_5ora  <-  bind_cols(date, spi_5ora) 
spi_6ora  <-  bind_cols(date, spi_6ora) 
spi_9ora  <-  bind_cols(date, spi_9ora) 
spi_12ora <-  bind_cols(date, spi_12ora) 
spi_18ora <-  bind_cols(date, spi_18ora) 
spi_24ora <-  bind_cols(date, spi_24ora) 

# join the SPI data by wide and long
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1- & 2-month
intr1 <- bind_rows(spi_1ora, spi_2ora) 

intc1 <- bind_cols(spi_1ora, spi_2ora) 
intc1 <- intc1 %>%
  select(-c(date1, duration, duration1)) %>%
  rename(int_1 = "Series 1") %>%
  rename(int_2 = "Series 11")
rm(spi_1ora, spi_2ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3-month
intr2 <- bind_rows(intr1, spi_3ora) 

intc2 <- bind_cols(intc1, spi_3ora) 
intc2 <- intc2 %>%
  select(-c(date1, duration)) %>%
  rename(ora_3 = "Series 1") 
rm(intr1, intc1, spi_3ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 4-month
intr3 <- bind_rows(intr2, spi_4ora) 

intc3 <- bind_cols(intc2, spi_4ora) 
intc3 <- intc3 %>%
  select(-c(date1, duration)) %>%
  rename(ora_4 = "Series 1") 
rm(intr2, intc2, spi_4ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 5-month
intr4 <- bind_rows(intr3, spi_5ora) 

intc4 <- bind_cols(intc3, spi_5ora) 
intc4 <- intc4 %>%
  select(-c(date1, duration)) %>%
  rename(ora_5 = "Series 1") 
rm(intr3, intc3, spi_5ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 6-month
intr5 <- bind_rows(intr4, spi_6ora) 

intc5 <- bind_cols(intc4, spi_6ora) 
intc5 <- intc5 %>%
  select(-c(date1, duration)) %>%
  rename(ora_6 = "Series 1") 
rm(intr4, intc4, spi_6ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 9-month
intr6 <- bind_rows(intr5, spi_9ora) 

intc6 <- bind_cols(intc5, spi_9ora) 
intc6 <- intc6 %>%
  select(-c(date1, duration)) %>%
  rename(ora_9 = "Series 1") 
rm(intr5, intc5, spi_9ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 12-month
intr7 <- bind_rows(intr6, spi_12ora) 

intc7 <- bind_cols(intc6, spi_12ora) 
intc7 <- intc7 %>%
  select(-c(date1, duration)) %>%
  rename(ora_12 = "Series 1") 
rm(intr6, intc6, spi_12ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 18-month
intr8 <- bind_rows(intr7, spi_18ora) 

intc8 <- bind_cols(intc7, spi_18ora) 
intc8 <- intc8 %>%
  select(-c(date1, duration)) %>%
  rename(ora_18 = "Series 1") 
rm(intr7, intc7, spi_18ora) 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 24-month
spi_ora_gath <- bind_rows(intr8, spi_24ora) 
spi_ora_gath <- spi_ora_gath %>%
  rename(spi_ora = "Series 1")

spi_ora <- bind_cols(intc8, spi_24ora) 
spi_ora <- spi_ora %>%
  select(-c(date1, duration)) %>%
  rename(ora_24 = "Series 1") 

rm(intr8, intc8, spi_24ora) 
# Next steps:
# distribution = 'PersonIII',
```

```{r spi-plot-cot, include=FALSE, eval=FALSE}
# visual check of output for cottonwood SPI
ggplot(spi_cot_gath, aes(date, spi_cot)) + 
  geom_line() +
  facet_grid(duration~.) +
  theme_classic() + 
  labs(title = "Standardized Precipitation Index (SPI)",
       subtitle = "Cottonwood, SD") +
       xlab("") + 
       ylab("SPI-value") +
  NULL 
```

```{r spi-plot-oel, include=FALSE, eval=FALSE} 
# visual check of Oelrichs SPI 
ggplot(spi_oel_gath, aes(date, spi_oel)) +  
  geom_line() + 
  facet_grid(duration~.) + 
  theme_classic() +  
  labs(title = "Standardized Precipitation Index (SPI)", 
       subtitle = "Oral, SD") + 
       xlab("") + 
       ylab("SPI-value") 
```

```{r spi-plot-rap, include=FALSE, eval=FALSE} 
# visual check of Rapid City SPI 
ggplot(spi_rap_gath, aes(date, spi_rap)) +  
  geom_line(aes(na.rm = TRUE)) + 
  facet_grid(duration~.) + 
  theme_classic() + 
  labs(title = "Standardized Precipitation Index (SPI)", 
       subtitle = "Rapid City, SD") + 
       xlab("") + 
       ylab("SPI-value") 
# Next steps : how to remove NA from all of the facets 
```

```{r spi-plot-int, include=FALSE, eval=FALSE} 
# visual check of Interior SPI  
ggplot(spi_int_gath, aes(date, spi_int)) +  
  geom_line(aes(na.rm = TRUE)) + 
  facet_grid(duration~.) +
  theme_classic() + 
  labs(title = "Standardized Precipitation Index (SPI)",
       subtitle = "Interior, SD") +
       xlab("") +
       ylab("SPI-value")
# Next steps : how to remove NA from all of the facets
```

```{r spi-plot-ora, include=FALSE, eval=FALSE} 
ggplot(spi_ora_gath, aes(date, spi_ora)) +  
  geom_line(aes(na.rm = TRUE)) + 
  facet_grid(duration~.) + 
  theme_classic() +  
  labs(title = "Standardized Precipitation Index (SPI)", 
       subtitle = "Oral, SD") + 
       xlab("") + 
       ylab("SPI-value") 
# Next steps : how to remove NA from all of the facets  
```
```{r spi-algorithm-coeff-cot-DEPR} 
# This code chunk calculates SPI coefficients for 
# 1, 2, 3, 4, 5, 6, 9, 12, 24 months for Cottonwood, SD. 
# Code is mostly following the SPI vignette. 

# Add Cottonwoods dataset and change to time series 
sta_cot <- sta_mon %>% 
  select(date, cot) %>% 
  arrange(date) 




# Calculate Cottonwood SPI 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot  <- spi(sta_cot[,'cot'], 1, distribution = 'PearsonIII') 
spi_2cot  <- spi(sta_cot[,'cot'], 2, distribution = 'PearsonIII') 
spi_3cot  <- spi(sta_cot[,'cot'], 3, distribution = 'PearsonIII') 
spi_4cot  <- spi(sta_cot[,'cot'], 4, distribution = 'PearsonIII') 
spi_5cot  <- spi(sta_cot[,'cot'], 5, distribution = 'PearsonIII') 
spi_6cot  <- spi(sta_cot[,'cot'], 6, distribution = 'PearsonIII') 
spi_9cot  <- spi(sta_cot[,'cot'], 9, distribution = 'PearsonIII') 
spi_12cot <- spi(sta_cot[,'cot'], 12, distribution = 'PearsonIII')  
spi_18cot <- spi(sta_cot[,'cot'], 18, distribution = 'PearsonIII') 
spi_24cot <- spi(sta_cot[,'cot'], 24, distribution = 'PearsonIII') 

# save coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot_coeff <- as.tibble(spi_1cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_2cot_coeff <- as.tibble(spi_2cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_3cot_coeff <- as.tibble(spi_3cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_4cot_coeff <- as.tibble(spi_4cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_5cot_coeff <- as.tibble(spi_5cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_6cot_coeff <- as.tibble(spi_6cot$coefficients) %>% 
  t() %>%
  as.tibble() 

spi_9cot_coeff <- as.tibble(spi_9cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_12cot_coeff <- as.tibble(spi_12cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_18cot_coeff <- as.tibble(spi_18cot$coefficients) %>% 
  t() %>% as.tibble() 

spi_24cot_coeff <- as.tibble(spi_24cot$coefficients) %>% 
  t() %>% as.tibble() 

# Rename coefficients 
# THIS CODE COULD BE DONE MUCH BETTER! 
spi_1cot_coeff <- spi_1cot_coeff %>% 
  rename(mu_1 = mu) %>%
   rename(sigma_1 = sigma) %>% 
   rename(gamma_1 = gamma)
  
spi_2cot_coeff <- spi_2cot_coeff %>% 
  rename(mu_2 = mu) %>%
   rename(sigma_2 = sigma) %>% 
   rename(gamma_2 = gamma) 

spi_3cot_coeff <- spi_3cot_coeff %>% 
  rename(mu_3 = mu) %>%
   rename(sigma_3 = sigma) %>% 
   rename(gamma_3 = gamma) 

spi_4cot_coeff <- spi_4cot_coeff %>% 
  rename(mu_4 = mu) %>%
   rename(sigma_4 = sigma) %>% 
   rename(gamma_4 = gamma) 

spi_5cot_coeff <- spi_5cot_coeff %>% 
  rename(mu_5 = mu) %>%
   rename(sigma_5 = sigma) %>% 
   rename(gamma_5 = gamma) 

spi_6cot_coeff <- spi_6cot_coeff %>% 
  rename(mu_6 = mu) %>%
   rename(sigma_6 = sigma) %>% 
   rename(gamma_6 = gamma) 

spi_9cot_coeff <- spi_9cot_coeff %>% 
  rename(mu_9 = mu) %>%
   rename(sigma_9 = sigma) %>% 
   rename(gamma_9 = gamma) 

spi_12cot_coeff <- spi_12cot_coeff %>% 
  rename(mu_12 = mu) %>%
   rename(sigma_12 = sigma)  %>% 
   rename(gamma_12 = gamma) 

spi_18cot_coeff <- spi_18cot_coeff %>% 
  rename(mu_18 = mu) %>%
   rename(sigma_18 = sigma) %>% 
   rename(gamma_18 = gamma) 

spi_24cot_coeff <- spi_24cot_coeff %>% 
  rename(mu_24 = mu) %>%
   rename(sigma_24 = sigma) %>% 
   rename(gamma_24 = gamma) 

# Join the values 
# THIS CODE COULD BE DONE MUCH BETTER! 
int1 <- bind_cols(spi_1cot_coeff, spi_2cot_coeff) 
rm(spi_1cot_coeff, spi_2cot_coeff) 

int2 <- bind_cols(int1, spi_3cot_coeff) 
rm(int1, spi_3cot_coeff) 

int3 <- bind_cols(int2, spi_4cot_coeff) 
rm(int2, spi_4cot_coeff) 

int4 <- bind_cols(int3, spi_5cot_coeff) 
rm(int3, spi_5cot_coeff) 

int5 <- bind_cols(int4, spi_6cot_coeff) 
rm(int4, spi_6cot_coeff) 

int6 <- bind_cols(int5, spi_9cot_coeff) 
rm(int5, spi_9cot_coeff) 

int7 <- bind_cols(int6, spi_12cot_coeff) 
rm(int6, spi_12cot_coeff) 

int8 <- bind_cols(int7, spi_18cot_coeff) 
rm(int7, spi_18cot_coeff) 

spi_coeff_cot <- bind_cols(int8, spi_24cot_coeff) 
rm(int8, spi_24cot_coeff, sta_cot) 

# export(spi_coeff_cot, "data/spi_coeff_cot.csv") 
# rm(spi_coeff_cot)
```

```{r combine-spi-coeff}   
# prepare for combining
# THIS COULD BE DONE BETTER
spi_coeff_cot <- spi_coeff_cot %>% 
  mutate(sta = "cot") %>%
  mutate(month = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) 

spi_coeff_oel <- spi_coeff_oel %>% 
  mutate(sta = "oel") %>%
  mutate(month = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) 

spi_coeff_rap <- spi_coeff_rap %>% 
  mutate(sta = "rap") %>%
  mutate(month = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) 

spi_coeff_int <- spi_coeff_int %>% 
  mutate(sta = "int") %>%
  mutate(month = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) 

spi_coeff_ora <- spi_coeff_ora %>% 
  mutate(sta = "ora") %>%
  mutate(month = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) 

# combine in steps
int1 <- bind_rows(spi_coeff_cot, spi_coeff_oel) 
rm(spi_coeff_cot, spi_coeff_oel) 

int2 <- bind_rows(int1, spi_coeff_rap) 
rm(int1, spi_coeff_rap) 

int3 <- bind_rows(int2, spi_coeff_int) 
rm(int2, spi_coeff_int) 

spi_coeff <- bind_rows(int3, spi_coeff_ora) 
rm(int3, spi_coeff_ora) 
```








```{r boxplots_1month, include=FALSE, eval=FALSE}
#ggplot(spi_1mon_grp, aes(month, value, group = month)) + 
#  geom_boxplot() + 
#  facet_wrap(~station) + 
#  theme_classic() +  
#  labs(title = "Monthly precipitation depths", 
#       subtitle = "Pine Ridge Reservation, SD for 1910-2017") + 
#       xlab("Date") + 
#       ylab("Depth, mm") 
```









## Introduction


## Methods
I imported Global Historical Climatology Network (GHCN) daily precipitation records for candidate "WEATHER STATIONS" into R-Studio (REF1) using the "rnoaa" package.
I used Theissen polygons and the length and continuity of precipitation records to select stations for further analysis.
I used 'dplyr' to fill NA values with data from nearest station
I used 'dplyr' to create monthly vals from daily vals.
I removed short records: Oral & Long Valley after checking for 
covariance.

<!-- 
Work on finishing describing methods for EDA.
-->

## Results
<!--
Work on describing results of EDA.
