---
title: "Untitled"
author: "CJ Tinant"
date: "1/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

<!--  

```{r prepare-SPI1-summary-statistics-moderate-old}

duration <-  35    # days
severity <- -1.5  

# 1. create the set of SPI drought [-1.5, 0]====  
spi1_drought <- spi_decomp_long %>%  
 select(spi_value = value,  
         sta,  
         date,  
         spi_length = name) %>%  
  # prepare spi_length  
  mutate(spi_length = str_remove_all(spi_length, "sci_")) %>%   
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%  
  mutate(spi_length = as.numeric(spi_length)) %>%  
  # keep only spi-1 -- and drought  
  filter(spi_length == 1) %>%                 
  filter(between(spi_value, !!!severity, 0)) %>%   
  # drop possible duplicates from SSI corr 
  unique()                                    

# 2. create a df of start ids [-1.5, 1]====  
spi1_mod_start <- spi1_drought %>%  
  # keep only moderate drought start points  
  filter(between(spi_value, !!!severity, -1)) %>%   
  group_by(sta) %>%  
  mutate(id = seq_len(n())) %>%  
  unite("id_long", sta, id) %>%  
  ungroup()  

# 3. join start ids and drought obs====   
spi1_mod_obs <- left_join(spi1_drought, spi1_mod_start,  
                   by = c("date", "spi_value", "spi_length")) %>%  
# drop duplicates with different stations  
  separate(id_long, c("sta_ck", "id"), remove = FALSE) %>%  
  filter(is.na(sta_ck) | 
           sta == sta_ck)  %>%  
  select(-sta_ck) %>%  
  mutate(id = as.numeric(id))  

# 4. moderate - create unique droughts -- should do this as a loop!!====  
spi1_mod_obs <- spi1_mod_obs %>%  
  group_by(sta) %>%  
  # create a span to  id continuing droughts  
  mutate(span = date - lag(date, 1)) %>%  
  # create a 2-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 2-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 3-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
  # create a 4-month duration id  
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    TRUE ~ id)) %>%  
# create a 5-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 6-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%   
# create a 7-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%      
# create a 8-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2, 
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%    
# create a 9-month duration id   
  mutate(id2 = lag(id, 1)) %>%    
  mutate(id2 = case_when(  
    span < duration ~ id2,   
    TRUE ~ NA_real_)) %>%  
  mutate(id = case_when(  
    is.na(id) ~ id2,  
    id - 1 == id2 ~ id2, 
    TRUE ~ id)) %>%  
  ungroup()  

# 5 drop non-moderate droughts====    
spi1_mod_obs <- spi1_mod_obs %>%  
  filter(!is.na(id)) %>%  
  unite("drought_id", sta, id, remove = FALSE) %>%  
  select(spi_value:spi_length)  

# 6 clean up global enviroment====  
rm(spi1_mod_start,  
   spi1_drought)  

```

```{r old-drop}

# create a drought span == 1-month duration  
#drought_mod <- drought_mod %>%  
#  mutate(date_lag = lag(date, 1)) %>%  
  mutate(span = date - date_lag) %>%  

  


# create a drought span == 2-month duration    
drought_mod <- drought_mod %>%    
  mutate(date_lag = lag(date, 2)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id2, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 65 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id)) 


  # create a drought span == 3-month duration  
drought_mod <- drought_mod %>%    
  mutate(date_lag = lag(date,3)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 95 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id)) %>%  
  # create a drought span == 3-month duration  
  mutate(date_lag = lag(date,4)) %>%  
  mutate(span = date - date_lag) %>%  
  mutate(id_lag = lag(drought_id, 1)) %>%  
  mutate(drought_id2 = case_when(  
    span < 125 ~ id_lag, 
    TRUE ~ "NA")) %>%  
  mutate(drought_id2 = na_if(drought_id2, "NA")) %>%   
  mutate(drought_id = case_when(  
    !is.na(drought_id2) ~ drought_id2, 
    TRUE ~ drought_id))  


```

#  # get deviations from the mean  
#  unite("spi_lag", spi:lag, remove = FALSE) %>%  
#  group_by(spi_lag) %>%   
#  mutate(r_mean = mean(r, na.rm = TRUE)) %>%  
#  ungroup() %>%  
#  mutate(deviation = r - r_mean) #%>%  

# check on these !!  
# check sri drought====  
spi_drought <- sci_long %>%  
#  filter(spi_length <= 4) %>%   
  filter(sri_value <= -0.8)  

spi_drought_mid <- sci_long %>%  
  filter(spi_length == 6) %>%   
  filter(spi_value <= -0.8)  
  
```{r other spi correlations -drop}



# plot spi vs sri====  
sci_long %>%  
#  filter(group == "Pierre Shale Low") %>%  
  filter(spi_length == 12) %>% 
  filter(sri_length == 12)  %>%  
  select(-c(spi_length, sri_length)) %>% 
  pivot_longer(cols = spi_value:sri_value) %>%  
  ggplot(aes(x = date, y = value)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  facet_grid(cols = vars(name),  
             rows = vars(group)) +   
  # plot xxx #  
  geom_point(color = "gray50",  
             shape = ".") +  
  geom_smooth() + 
  geom_hline(yintercept = 0, 
             color = "gray80")

# plot deviation vs spi====  
sci_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  

```

```{r plot_drought-corr-short}

# plot rho vs spi====  
drought_corr_s_group %>%  
  filter(rho > 0.25) %>% 
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = rho, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
geom_point(aes(shape = group,  
                color = group)) +   
    geom_line(aes(linetype = group,  
                color = group)) +  
  scale_colour_viridis_d()  
  
# plot deviation vs spi====  
drought_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  


scale_x_continuous(breaks = c(2, 4, 6))
```

```{r plot_drought-corr-mid}

# plot rho vs spi====  
drought_corr_group %>%  
  filter(rho > 0) %>%  
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = rho, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
geom_point(aes(shape = group,  
                color = group)) +   
    geom_line(aes(linetype = group,  
                color = group)) +  
  scale_colour_viridis_d()  
  
# plot deviation vs spi====  
drought_corr_group %>%   
  mutate(spi = as.factor(spi)) %>%  
  ggplot(aes(x = spi, y = deviation, group = group)) +  
  # set theme, labels, facets #  
  theme_bw() +  
  #  xlab("") +  
  #  ylab("SRI 1-month") +   
  #  scale_y_continuous(limits = c(-3, 3)) +  
  scale_x_discrete(breaks = c(1, 2, 3, 4, 6, 9, 12)) +   
  facet_wrap(vars(sri),   
             nrow = 2) +   
  # plot xxx #  
  geom_line(aes(linetype = group,  
                color = group)) +  
  # plot zero line   
  geom_hline(yintercept = 0,  
             color = "gray70") +  
  scale_colour_viridis_d()  


scale_x_continuous(breaks = c(2, 4, 6))
```

```{r SCI-correlation_drought}

# 1 prepare for SPI & SRI correlations====  
sci_drought_all <- spi_drought %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_corr <- sci_drought_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr <- sci_drought_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_group <- spi_drought %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_drought-short}

# 1 prepare for SPI & SRI correlations====  
sci_drought_s_all <- spi_drought_short %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_s_corr <- sci_drought_s_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr_s <- sci_drought_s_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_s_group <- spi_drought_short %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_drought-midt}

# 1 prepare for SPI & SRI correlations====  
sci_drought_m_all <- spi_drought_mid %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date, group)) %>%    
correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 3 make SRI corr table====  
sri_drought_s_corr <- sci_drought_s_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12, sri_12)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
drought_corr_s <- sci_drought_s_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
drought_corr_m_group <- spi_drought_mid %>%  
  pivot_wider(names_from = spi_length, values_from = spi_value,  
              names_prefix = "spi_") %>%  
  pivot_wider(names_from = sri_length, values_from = sri_value,  
              names_prefix = "sri_") %>%  
  select(-c(sta, gage, location, ecoreg, date)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1:spi_4)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1:sri_12),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r SCI-correlation_all-values-drop}

# 1 prepare for SPI & SRI correlations====  
sci_corr_all <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp, group)) %>%    
  correlate(method = "spearman") %>%  
  shave() %>%  # use shave to set upper triangle to NA and then...  
  stretch(na.rm = TRUE) %>% # omit all NAs, therefore keeping each   
                             # correlation only once.  
  rename(rho = r)  %>%  
  mutate_if(is.numeric, round, digits = 2)    

# 2 make SPI correlation table ====  
spi_corr_table <- sci_corr_all %>%  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^spi")) %>%  
  spread(y, rho) %>%   
  select(-spi_12mo, spi_12mo)  

# 3 make SRI corr table====  
sri_corr_table <- sci_corr_all %>%  
  filter(str_detect(x, "^sri")) %>%  
  filter(str_detect(y, "^sri"))  %>%  
  spread(y, rho) %>%   
  rename(sri =  x) %>%  
  select(-sri_12mo, sri_12mo)  

# 4 make SPI-SRI corr table====  
# note the high association -- consider 1, 3, 6, 12-month intervals  
sci_corr <- sci_corr_all %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(x, "^spi")) %>%  
  filter(str_detect(y, "^sri")) %>%  
  rename(spi =  x) %>%  
  rename(sri =  y) %>%  
  arrange(rho) %>%  
 # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = as.numeric(spi))    

# 5 calculate association coefficents for SPI-SRI by hydrologic group====  
sci_corr_group <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%  
  # group by hydrologic group, nest, and correlate by hydrologic group  
  group_by(group) %>%  
  nest() %>%  
  mutate(data = map(data, correlate, method = "spearman")) %>%  
  unnest(cols = c(data)) %>%  
  ungroup() %>%  
  rename(spi = rowname) %>%  
  # drop spi-spi and sri-sri correlations  
  filter(str_detect(spi, "^spi")) %>%  
  select(-c(spi_1mo:spi_12mo)) %>%  
  # pivot sri results to long  
  pivot_longer(cols = c(sri_1mo:sri_12mo),  
               names_to = "sri",  
               values_to = "rho") %>%  
  # remove characters and transform to numeric  
  mutate(sri = str_remove_all(sri, "[sri_mo]")) %>%  
  mutate(sri = as.numeric(sri)) %>%  
  mutate(spi = str_remove_all(spi, "[spi_mo]")) %>%  
  mutate(spi = as.numeric(spi)) %>%  
  mutate_if(is.numeric, round, digits = 2) %>%  
  # get deviations from the mean  
#  mutate(rho_noGW = case_when(  
#    group == "GW Control" ~ NA_real_,   
#    TRUE ~ rho)) %>%  
  unite("spi_sri", spi:sri, remove = FALSE) %>%  
  group_by(spi_sri) %>%   
  mutate(rho_mean = mean(rho, na.rm = TRUE)) %>%  
  ungroup() %>%  
  mutate(deviation = rho - rho_mean) %>%  
  # relevel groups for plotting  
  mutate(group = factor(group)) %>%   
  mutate(group = fct_relevel(group,   
                             "Pierre Shale Low",   
                             "Pierre Shale High",   
                             "Tertiary Clays",  
                             "Black Hills Plateau",  
                             "GW Control",  
                             "Keya Paha Tablelands",  
                             "Sand Hills"))  

rm(drought_corr_all)  

```

```{r plot-SCRATCH}
# 6 create group max mins====  
#seas_group <- full_join(seas_group_min, seas_group_max,  
#                        by = "group")  
#seas_group <- full_join(seas_group, seas_group_med,  
#                        by = "group")  

# * clean up global environment  
#rm(seas_group_max,  
#   seas_group_med,  
#   seas_group_min)  
# rm(seas_group)  
```

```{r SCRATCH4} 
# 1.2 SCI calcs - bhp_fal -- set up station for sci & make sci list vars====   
sta      <- bhp_fal_v   
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 4 (MAR-APR)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 1, 5 (NOV-JAN) (MAR-MAY)   
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    # MLE fail for month 6 (JAN-JUN)   
sci_9mo  <- sci.fun(sta, 9)    # MLE fail for month 8 (DEC-AUG)  
sci_12mo <- sci.fun(sta, 12)   # MLE fail for month 8, 9 (AUG & SEP)  

# * bhp_fal -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bhp_fal -- bind and rename the sci vals====       
sci_bhp_fal <- bind_cols(bhp_fal,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value) %>%  
  rename(sci_2mo = value1) %>%   
  rename(sci_3mo = value2) %>%  
  rename(sci_4mo = value3) %>%   
  rename(sci_6mo = value4) %>%   
  rename(sci_9mo = value5) %>%  
  rename(sci_12mo = value6)  

# * bhp_fal -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_fal, bhp_fal_v)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# * bha_frn -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bha_frn -- bind and rename the sci vals====       
sci_bhp_frn <- bind_cols(bhp_frn,       
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,    
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * bha_frn -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_frn, bhp_frn_v)   


```

```{r SCRATCH3}

# * bhp_bat -- bind and rename the sci vals====         
sci_bhp_bat <- bind_cols(bhp_bat,     
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,   
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)   

# * bhp_bat -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_bat, bhp_bat_v)   

``` 

```{r sthings}
# working from here----
library(igraph)
library(ggraph) 
library("ggcorrplot")

  
#  rename(rho = r) %>%  
#  fashion() #%>%  
# transforms the 'no quote' class from 
#  as.matrix() %>%  
#  as_tibble() %>%  
#  mutate(rho = as.numeric(rho)) %>%  
  
  # 3 ?? prepare SPI for plotting ??====  
#  mutate(x = str_remove_all(x, "spi_")) %>%  
#  mutate(y = str_remove_all(y, "spi_")) %>%  

# make SPI corr table2 - not working yet  
#spi_corr %>% 
#  column_to_rownames(spi, var = "spi")
#  as.matrix() %>%  
  
#ggcorrplot()  
# working====  
sci_corr_group <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%    
  group_by(group) %>% ## avoids calling data = everything() below  
  nest() %>%  
#  mutate(data = map(data, 
#                    purrr::compose(stretch, correlate,  
#                                   method = "spearman"))) %>% 
  mutate(data = map(data, c
                    purrr::compose(stretch, correlate,  
                                   method = "spearman"))) %>% 
  unnest() %>%  
#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)

# working====  
mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%  
#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)


sci_corr_table <- sci_decomp %>%  
  select(-c(sta, gage, location, ecoreg, date, prcp)) %>%    
  group_by(group) %>% ## avoids calling data = everything() below  
  nest() %>%  
  mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%  
  drop_na()  

#  ungroup()  %>% 
  select(x, y, r, group) %>%
  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)


# interesting graph----
ggraph(spi_corr, layout = "kk") +
  geom_edge_link(aes(edge_alpha = abs(r), color = r), edge_width = 5) +
  guides(edge_alpha = "none") +
  scale_edge_colour_gradientn(limits = c(-1, 1), colors = heat.colors(5)) +
  geom_node_point(color = "black", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) +
#  facet_edges(~group) +
  theme_minimal() 

sci_corr_table1

test2 <- sci_corr %>%  

  
  split(.$group) %>% 
  correlate(method = "spearman") %>%  
  mutate_if(is.numeric, round, 2) %>%  
  ungroup()  
#  filter(str_detect(rowname, "sri")) #%>% 

#  column_to_rownames("final_group")      
  select(rowname:spi_12mo) 
  %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  select(-sri_12mo, sri_12mo) %>% 
  rownames_to_column() %>% 
  mutate(rowname = case_when( 
    rowname == "2" ~ "10", 
    TRUE ~ rowname)) %>% 
  mutate(rowname = as.integer(rowname)) %>% 
  arrange(rowname) %>% 
  select(-rowname)
  
  

# [WORKING] 5 correlate SPI and SRI====  

weather_cor <- weather_sub %>%
  group_by(origin) %>% ## redundant but worth it for illustration
  nest() %>%
  mutate(data = map(data, purrr::compose(stretch, correlate))) %>% 
  unnest() %>%

  filter(abs(r) > .3) %>%
  graph_from_data_frame(directed = FALSE)

```

```{r eda_plot_series} 
# needs work!
mon_plot <- sci_1mo %>%  
  ggplot(aes(x = spi_length_12, y = sci_val)) + 
  theme_bw() + 
  facet_wrap(vars(sci_val), 
             ncol =2) +
  geom_jitter(size = .1) + 
  geom_smooth() +
  geom_abline(slope = 1 , intercept = 0)

mon_plot
eco_plot <- sci_1mo %>%  
  ggplot(aes(x = spi_length_12, y = sci_val)) + 
  theme_bw() + 
  facet_wrap(vars(ecoreg), 
             ncol =2) +
  geom_jitter(size = .1) + 
  geom_smooth() +
  geom_abline(slope = 1 , intercept = 0) 

```

```{r create-models}
# http://environmentalcomputing.net/intro-to-gams/ -- check this!
# https://multithreaded.stitchfix.com/blog/2015/07/30/gam/ 

# Consider that different months might behave differently!
# Also consider that different drought lengths might behave differently!

test <- sci %>% 
  select(sci_length) %>% 
  distinct() 

# load gam model -- mgcv 
library(mgcv) 

# walk before you run 
#sci_1mo_nest <- sci_1mo %>% 
#  group_by(ecoreg) %>% 
#  nest()  

sci_1mo_input <- sci %>% 
  filter(sci_length == 1) %>% 
  group_by(sta, mon, spi_length) %>% 
  nest()

#define function for linear model
sci_1mo_lm <-function(df) {
  lm(sci_val ~ spi_val, data = df)
}

#define function for GAM 
sci_1mo_gam <- function(df) {
  gam(sci_val ~ s(spi_val), 
                   method = "REML", 
                   data = df)
} 
  
# create columns for the models
sci_models <- sci_1mo_input %>%
        mutate(model_lm = map(data, sci_1mo_lm),
               model_gam = map(data,sci_1mo_gam)
               )

# extract models 
models_details<-sci_models %>%
        mutate(
                glance_lm  = model_lm %>% 
                  map(glance),  #model summary 
                AIC_lm     = glance_lm %>% 
                  map_dbl("AIC"),  #extract AIC   
                glance_gam = model_gam %>% 
                  map(broom::glance), #GAM model summary  
                AIC_gam    = glance_gam %>% 
                  map_dbl("AIC"), #extract AIC
                tidy_lm    = model_lm %>% 
                  map(tidy), #model estimate: coeff...
                tidy_gam    = model_gam %>% 
                  map(tidy), #model estimate: coeff...
                rsq_lm      = glance_lm %>% 
                  map_dbl("r.squared"),  #extract rsquared 
                augment_lm = model_lm %>% 
                  map(augment), #observation stats: resid,hat...
                res_lm        = augment_lm %>% 
                  map(".resid") #extract resid
               ) %>% 
  mutate(AIC_diff = AIC_lm - AIC_gam) 

test <- sci_models %>% 
  mutate(R.square = map_dbl(model_gam, ~ summary(.)$r.sq)) %>% 
  select(R.square)

test2 <- test %>% 
  group_by(ecoreg, spi_length) %>%  
  summarize(rsq_mean     = mean(R.square),  
            rsq_median   = median(R.square), 
            rsq_75       = quantile(R.square, probs =.75), 
            rsq_25       = quantile(R.square, probs =.25), 
            rsq_min      = min(R.square), 
            rsq_max      = max(R.square)          
            ) %>% 
  ungroup()
  


  
out <- models_details %>% 
  group_by(ecoreg, spi_length) %>%  
  summarize(AIC_mean     = mean(AIC_diff),  
            AIC_median   = median(AIC_diff), 
            AIC_75       = quantile(AIC_diff, probs =.75), 
            AIC_25       = quantile(AIC_diff, probs =.25), 
            AIC_min      = min(AIC_diff), 
            AIC_max      = max(AIC_diff) , 
            deviance_gam = median(deviance_gam)           
            ) %>% 
  ungroup()

out2 <- out %>% 
  arrange(desc(deviance_gam)) 

  summarize(deviance = ma)
```

```{r time-series-correlation_join_sci}    
#  start by walking ----  

# keep only the 1-mo vals as a response variable -- checking step
#sci_gage_1mo <- sci_gage %>%  
 # filter(sci_length == 1)  
  
sci <- full_join(sci_gage, sci_sta,  
                     by = c("group", "date")) %>%  
  drop_na() %>%   
#  spread(spi_length, spi_val, sep = "_") %>%  
#  drop_na() %>%  
  # reorder factors by ecoreg 
  mutate(ecoreg = fct_relevel(ecoreg, 
                              "Pierre Shale Plains", 
                              "Pine Ridge Escarpment",  
                              "White River Badlands", 
                              "Black Hills Plateau", 
                              "Keya Paha Tablelands", 
                              "Sand Hills")) %>% 
  mutate(year = year(date)) %>% 
  mutate(mon = month(date))
  
# check for na values ====  
# the '2' beelow refers to columns 
indx <- sci %>%
  apply(2, 
        function(x) any(is.na(x) | is.infinite(x))
        ) %>%   
enframe()  

rm(indx) 

# make a 'biology' series====  
# using april = 4, may = 5, june = 6 - idea --
#sci_1mo_b <- sci_1mo %>% 
#  filter(mon == 4 | 
#           mon == 5 | 
#           mon == 6)  
  
```

```{r time-series-correlation_prepare_sci-old}    
  
# import gage group to fix the 'group' -- used for function call above====   
gage_group <- import("data/gage_meta_seas.csv") %>%  
 rename(gage = sta) %>%  
  mutate(north_group = case_when(   
    dec_lat_va > 43.5 ~ "N",   
    TRUE ~ "S")   
  ) %>%   
  mutate(east_group = case_when(  
    dec_long_va  > -100.67 ~ "E",  
    dec_long_va  > -102.33 ~ "C",    
    TRUE ~ "W")  
  ) %>%  
  mutate(group = str_c(north_group,  
                       east_group,   
                       sep = "")) %>%  
  select(gage, group)   
  
# import gage & fix 'group' which was used above====    
sci_gage <- import("data/sri_seas.csv") %>%    
  mutate(date = ymd(date)) %>%  
  rename(gage = sta) %>%  
  select(-group)  

# join group & spi data====    
sci_gage <- full_join(gage_group, sci_gage, 
                      by = "gage") %>%   
  mutate(min_date_gage = min(date)) %>%    
  mutate(max_date_gage = max(date)) %>%  
  select(-c(log_q1_mon,  
            season,  
            trend,  
            remainder,  
            remainder_l1,  
            remainder_l2,  
            anomaly  
  )) %>%  
# arrange data from wide to long -- spi_length is used in the join below
  gather(key   = sci_length,   
         value = sci_val,   
         -c(group,   
            date,   
            gage,   
            ecoreg,   
            min_date_gage,   
            max_date_gage    
         )) %>%    
  ungroup() %>%   
# prepare for joining by spi_length  
  mutate(sci_length = str_remove_all(sci_length, "mo")) %>%     
  mutate(sci_length = str_sub(sci_length, start = 5) %>% as.numeric)  
  
rm(gage_group)  
```  

```{r time-series-correlation_prepare_spi-old1}  

# 1 get data====  
#spi_seas  <- import("data/spi_seas.csv")   
#sri_final <- import("data/sri_final.csv")   

# 2 identify gage locations====     
mclust_fin <- import("data/mclust_final.csv") %>%  
    rename(gage = sta)  

gage_location <- import("data/gage_meta.csv") %>%  
    rename(gage = sta)  

gage_location <- semi_join(gage_location, mclust_fin,  
                       by = "gage") %>%  
 # select(gage, dec_lat_va, dec_long_va) %>%   
  mutate(north_group = case_when(   
    dec_lat_va > 43.5 ~ "N",   
    TRUE ~ "S")   
  ) %>%   
  mutate(east_group = case_when(  
    dec_long_va  > -100.67 ~ "E",  
    dec_long_va  > -102.33 ~ "C",    
    TRUE ~ "W"))%>%  
  mutate(location = str_c(north_group,  
                       east_group,   
                       sep = "")) %>%  
  select(gage, location)  

# * add location to mclust dataframe====  
mclust_fin <- full_join(mclust_fin, gage_location,  
                         by = "gage")  

# 3 drop season & trend variables from SPI and SRI dataframes====  
spi_corr <- spi_seas %>%  
  select(-c(prcp,  
            season:anomaly)) %>%  
  pivot_longer(-c(sta, date, location)) %>%  
  mutate(name = str_replace_all(name, "sci", "spi")) %>%   
  pivot_wider()  

# 3 join SRI and SRI by location and date====  
# * add gage location to SRI dataframe====  
sri_corr <- full_join(sri_final, gage_location,  
                         by = c("sta" ="gage")) %>%  
  select(-c(log_q1_mon,  
            ecoreg,  
            group,  
            remainder_l1,  
            remainder_l2,  
            anomaly)) %>%  
  select(sta, final_group, location, everything()) %>%  
  rename(gage = sta) #%>%  
  pivot_longer(-c(gage, date, location, final_group)) %>%  
  mutate(name = str_replace_all(name, "sci", "sri")) %>%   
  pivot_wider()  

# * join SRI and SPI & clean up global environment====  
sci_corr <- full_join(spi_corr, sri_corr)  

rm(gage_location,  
   spi_seas,  
 #  sri_seas,  
   sri_final,  
   spi_corr,  
   sri_corr)    

# [WORKING] prepare to correlate SPI and SRI====  
sci_drought <- sci_corr %>%  
  pivot_longer(c(spi_1mo:spi_12mo)) %>%   
  filter(value <= -0.8) %>%  
  pivot_wider() %>%     
  filter(final_group == "Black Hills Plateau") 
  
# [WORKING] 4 prepare to correlate SPI and SRI--filter SRI drought months====  
#test <- sci_corr %>%  
#  filter(final_group == "Black Hills Plateau") 
#  
#  rename(current = spi_1mo) %>%  
#  mutate(spi_1mo = lag(current, 1)) %>%  
#  select(sta:current, spi_1mo, everything())  

ggplot(sci_drought, aes(spi_1mo, sri_2mo)) + 
  geom_point() +  
  geom_smooth()


# [WORKING] 5 correlate SPI and SRI====  
test2 <- sci_drought %>%  
  select(-c(sta, date, location, gage, final_group)) %>%  
#  column_to_rownames("final_group")  
  correlate(method = "spearman") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  filter(str_detect(rowname, "sri")) #%>% 
    
  select(rowname:spi_12mo) 
  %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  select(-sri_12mo, sri_12mo) %>% 
  rownames_to_column() %>% 
  mutate(rowname = case_when( 
    rowname == "2" ~ "10", 
    TRUE ~ rowname)) %>% 
  mutate(rowname = as.integer(rowname)) %>% 
  arrange(rowname) %>% 
  select(-rowname)

```

```{r summarise_sri}

# Get counts of high and low vals====  
# * summarize high and low flow values====  
summary_prop <- sci_gage %>%  
    group_by(group) %>%  
    summarise(n = n()) 

summary_high <- sci_gage %>%  
  filter(value >= 3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()  

summary_low <- sci_gage %>%  
  filter(value <= -3.0) %>%  
  mutate(year = year(date)) %>%  
  mutate(month = month(date)) %>%  
  group_by(group, type, year, month) %>%  
  summarise(count = n()) %>%  
  ungroup()   

# * get high and low flow counts by year and month====  
# * summarize year====  
high_year <- summary_high %>%  
  group_by(group, year) %>%  
  summarise(high_year = sum(count)) %>%  
  ungroup() 

low_year <- summary_low %>%  
  group_by(group, year) %>%  
  summarise(low_year = sum(count)) %>%  
  ungroup()  

# join the high and low year values 
exceed_year <- full_join(high_year, low_year,  
                         by = c("group", "year")) %>%  
  replace_na(list(low_year = 0, high_year = 0)) %>%  
  mutate(low_year = -low_year) %>% 
  pivot_longer(c(high_year, low_year),  
               names_to = "key",  
               values_to = "value")  

# * create year proportations====  
exceed_year <- full_join(exceed_year, summary_prop, 
                         by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>% 
  mutate(group = fct_relevel(group,  
                             "GW control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * summarize month====  
high_month <- summary_high %>%  
  group_by(group, month) %>%  
  summarise(high_month = sum(count)) %>%  
  ungroup()  

low_month <- summary_low %>%  
  group_by(group, month) %>%  
  summarise(low_month = sum(count)) %>%  
  ungroup()  

# join the high and low month values  
exceed_month <- full_join(high_month, low_month,  
                         by = c("group", "month")) %>%  
  replace_na(list(low_month = 0, high_month = 0)) %>%  
  mutate(low_month = -low_month) %>% 
  pivot_longer(c(high_month, low_month),  
               names_to = "key",  
               values_to = "value")  

# * create month proportations====  
exceed_month <- full_join(exceed_month, summary_prop, 
                         by = "group") %>%  
  mutate(prop = 100 * value/n) %>%  
  # relevel final groups for plotting  
  mutate(group = factor(group)) %>%  
  mutate(group = fct_relevel(group,  
                             "GW control",  
                             "Tertiary Clays",  
                             "Pierre Shale High",  
                             "Black Hills Plateau",  
                             "Keya Paha Tablelands",  
                             "Sand Hills",  
                             "Pierre Shale Low"))  

# * clean up global environment====  
rm(summary_high,  
   summary_low,  
   summary_prop,  
   high_year,  
   low_year,  
   high_month,  
   low_month)  
  
``` 

```{r prepare_SRI-trend}  

# 2 prepare input for SCI====    
sri_input <- semi_join(gage_mon_sri, mclust_aug,  
                       by = "sta") %>% 
  rename(date = Date) %>%   
  arrange(date) %>%  
  select(  
    sta,  
    ecoreg,  
    date,  
    log_q1_mon)  

# * double-check input data====  
sri_input %>%  
  group_by(sta) %>%  
  summarise(min = min(date), 
            max = max(date)  
  )  

# 3 prepare vector inputs as double for SCI fun----  
# 3.1 Black Hills Plateau (bhp) gages====    
bhp_bat <- sri_input %>%  
  filter(sta == "bat_her")    

bhp_fal <- sri_input %>%  
  filter(sta == "fal_hot")   

bhp_frn <- sri_input %>%  
  filter(sta == "frn_fai")    

bhp_bat_v <- as.double(bhp_bat$log_q1_mon)   
bhp_fal_v <- as.double(bhp_fal$log_q1_mon)  
bhp_frn_v <- as.double(bhp_frn$log_q1_mon)  

# 3.2 GW-control (gwc) gages====    
gwc_bev <- sri_input %>%  
  filter(sta == "bev_buf")  

gwc_lcr <- sri_input %>%  
  filter(sta == "lcr_bel")     

gwc_bev_v <- as.double(gwc_bev$log_q1_mon)  
gwc_lcr_v <- as.double(gwc_lcr$log_q1_mon)   

# 3.3 Keya Paha Tablelands (kpt) gages====   
kpt_key <- sri_input %>%   
  filter(sta == "key_key")   

kpt_wew <- sri_input %>%  
  filter(sta == "key_wew")   

kpt_key_v <- as.double(kpt_key$log_q1_mon)   
kpt_wew_v <- as.double(kpt_wew$log_q1_mon)   

# 3.4 Pierre Shale Low (psl) gages====     
psl_brs <- sri_input %>%  
  filter(sta == "brsf_co")    

psl_elk <- sri_input %>%  
  filter(sta == "elk_elm")   

psl_hat <- sri_input %>%  
  filter(sta == "hat_edg") 

psl_bad <- sri_input %>%  
  filter(sta == "bad_fpi") 

psl_hor <- sri_input %>%  
  filter(sta == "hor_oel")  

psl_brs_v <- as.double(psl_brs$log_q1_mon)   
psl_elk_v <- as.double(psl_elk$log_q1_mon)   
psl_hat_v <- as.double(psl_hat$log_q1_mon)   
psl_bad_v <- as.double(psl_bad$log_q1_mon)   
psl_hor_v <- as.double(psl_hor$log_q1_mon)   

# 3.5 Pierre Shale High (psh) gages====     
psh_bat <- sri_input %>%  
  filter(sta == "bat_bhr")    

psh_che <- sri_input %>%  
  filter(sta == "che_was")    

psh_whi <- sri_input %>%  
  filter(sta == "whi_oac")    

psh_bat_v <- as.double(psh_bat$log_q1_mon)   
psh_che_v <- as.double(psh_che$log_q1_mon)   
psh_whi_v <- as.double(psh_whi$log_q1_mon)  

# 3.6 Sand Hills (snd) gages====   
snd_lon <- sri_input %>%  
  filter(sta == "lon_riv")     

snd_mar <- sri_input %>%  
  filter(sta == "lwr_mar")     

snd_ros <- sri_input %>%  
  filter(sta == "lwr_ros")     

snd_vet <- sri_input %>%  
  filter(sta == "lwr_vet")     

snd_whi <- sri_input %>%  
  filter(sta == "lwr_whi")    

snd_nio <- sri_input %>%  
  filter(sta == "nio_spa")     

snd_lon_v <- as.double(snd_lon$log_q1_mon)   
snd_mar_v <- as.double(snd_mar$log_q1_mon)   
snd_ros_v <- as.double(snd_ros$log_q1_mon)   
snd_vet_v <- as.double(snd_vet$log_q1_mon)   
snd_whi_v <- as.double(snd_whi$log_q1_mon)   
snd_nio_v <- as.double(snd_nio$log_q1_mon)   

# 3.7 Tertiary Clay (ter) gages====   
ter_ogl <- sri_input %>%  
  filter(sta == "whi_ogl")   

ter_sta <- sri_input %>%  
  filter(sta == "whi_sta")   

ter_whi <- sri_input %>%  
  filter(sta == "whi_kad")  

ter_ogl_v <- as.double(ter_ogl$log_q1_mon)   
ter_sta_v <- as.double(ter_sta$log_q1_mon)   
ter_whi_v <- as.double(ter_whi$log_q1_mon)   


# 4.0 clean up global enviroment====    
rm(sri_input)   

```  

```{r calculate_SRI}  

# 1.0 calculate SCI_blp====  
# 1.1 SCI calcs - bhp_bat -- set up station for sci & make sci list vars====  
sta      <- bhp_bat_v    
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                           
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   

# * bhp_bat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo,  
                         sci.limit = sci.limit) %>%   
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)    
  
sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)  
  
sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo,  
                         sci.limit = sci.limit) %>%  
  enframe(name                     = NULL)  
  
sci_12mo <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_12mo,  
                         sci.limit = sci.limit) %>%    
  enframe(name                     = NULL)   

# * bhp_bat -- bind and rename the sci vals====         
sci_bhp_bat <- bind_cols(bhp_bat,     
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,   
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)   

# * bhp_bat -- clean up global environment====  
rm(sci_1mo,  
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo  
)      
rm(bhp_bat, bhp_bat_v)   
  
# 1.2 SCI calcs - bhp_fal -- set up station for sci & make sci list vars====   
sta      <- bhp_fal_v   
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 4 (MAR-APR)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 1, 5 (NOV-JAN) (MAR-MAY)   
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)    # MLE fail for month 6 (JAN-JUN)   
sci_9mo  <- sci.fun(sta, 9)    # MLE fail for month 8 (DEC-AUG)  
sci_12mo <- sci.fun(sta, 12)   # MLE fail for month 8, 9 (AUG & SEP)  

# * bhp_fal -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bhp_fal -- bind and rename the sci vals====       
sci_bhp_fal <- bind_cols(bhp_fal,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value) %>%  
  rename(sci_2mo = value1) %>%   
  rename(sci_3mo = value2) %>%  
  rename(sci_4mo = value3) %>%   
  rename(sci_6mo = value4) %>%   
  rename(sci_9mo = value5) %>%  
  rename(sci_12mo = value6)  

# * bhp_fal -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_fal, bhp_fal_v)   

# 1.3 SCI calcs - bha_frn -- set up station for sci & make sci list vars====  
sta      <- bhp_frn_v    
sci_1mo  <- sci.fun(sta, 1)    # MLE fail for month 10 (OCT)                
sci_2mo  <- sci.fun(sta, 2)    # MLE fail for month 11 (OCT-NOV)               
sci_3mo  <- sci.fun(sta, 3)     # MLE fail for month 12 (OCT-DEC)       
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)      
sci_12mo <- sci.fun(sta, 12)   

# * bha_frn -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)    

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * bha_frn -- bind and rename the sci vals====       
sci_bhp_frn <- bind_cols(bhp_frn,       
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,    
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * bha_frn -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(bhp_frn, bhp_frn_v)   

# 2.0 calculate SCI_gwc---- 
# 2.1 SCI calcs - gwc_bev -- set up station for sci & make sci list vars====    
sta      <- gwc_bev_v  
sci_1mo  <- sci.fun(sta, 1)                             
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                             
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)    
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)   

# * gwc_bev -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * gwc_bev -- bind and rename the sci vals====         
sci_gwc_bev <- bind_cols(gwc_bev,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%   
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * gwc_bev -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(gwc_bev, gwc_bev_v)  

# 2.2 SCI calcs - gwc_lcr -- set up station for sci & make sci list vars====    
sta      <- gwc_lcr_v   
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 5, 8                     
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 5   
sci_9mo  <- sci.fun(sta, 9)    
sci_12mo <- sci.fun(sta, 12)    

# * gwc_lcr -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * gwc_lcr -- bind and rename the sci vals====        
sci_gwc_lcr <- bind_cols(gwc_lcr,      
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * gwc_lcr -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,   
   sci_12mo)      
rm(gwc_lcr, gwc_lcr_v)  


# 3.0 calculate SCI_kpt----  
# 3.1 SCI calcs - kpt_key -- set up station for sci & make sci list vars====   
sta      <- kpt_key_v   
sci_1mo  <- sci.fun(sta, 1)                     
sci_2mo  <- sci.fun(sta, 2)                   
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * kpt_key -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * kpt_key -- bind and rename the sci vals====       
sci_kpt_key <- bind_cols(kpt_key,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * kpt_key -- clean up global environment====  
rm(sci_1mo,    
   sci_2mo,   
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(kpt_key, kpt_key_v)   

# 3.2 SCI calcs - kpt_wew -- set up station for sci & make sci list vars====  
sta      <- kpt_wew_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)           
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * kpt_wew -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,      
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)   

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * kpt_wew -- bind and rename the sci vals====       
sci_kpt_wew <- bind_cols(kpt_wew,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * kpt_wew -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(kpt_wew, kpt_wew_v)   

# 4.0 calculate SCI_psh---- 
# 4.1 SCI calcs - psh_bat -- set up station for sci & make sci list vars====   
sta      <- psh_bat_v   
sci_1mo  <- sci.fun(sta, 1)   # MLE fail months 8 & 10 (AUG & OCT)         
sci_2mo  <- sci.fun(sta, 2)   # MLE fail month 11 (OCT-NOV)                
sci_3mo  <- sci.fun(sta, 3)   # MLE fail months 9 & 11  (JUL-SEP) & (SEP-NOV)  
sci_4mo  <- sci.fun(sta, 4)   # MLE fail month 10 (JUL-OCT)           
sci_6mo  <- sci.fun(sta, 6)   # MLE fail month 12 (JUN-DEC)                
sci_9mo  <- sci.fun(sta, 9)   # MLE fail month 3 (JUN-MAR)            
sci_12mo <- sci.fun(sta, 12)  # MLE fail months 4 & 5 (MAR-APR) & (APR-MAY)    

# * psh_bat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_bat -- bind and rename the sci vals====       
sci_psh_bat <- bind_cols(psh_bat,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_bat -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_bat, psh_bat_v)  

# 4.2 SCI calcs - psh_che -- set up station for sci & make sci list vars====   
sta      <- psh_che_v  
sci_1mo  <- sci.fun(sta, 1)                       
sci_2mo  <- sci.fun(sta, 2)                        
sci_3mo  <- sci.fun(sta, 3)                 
sci_4mo  <- sci.fun(sta, 4)               
sci_6mo  <- sci.fun(sta, 6)                   
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)      

# * psh_che -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_che -- bind and rename the sci vals====       
sci_psh_che <- bind_cols(psh_che,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_che -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_che, psh_che_v)  

# 4.3 SCI calcs - psh_whi -- set up station for sci & make sci list vars====   
sta      <- psh_whi_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 7   
sci_2mo  <- sci.fun(sta, 2)      
sci_3mo  <- sci.fun(sta, 3)                
sci_4mo  <- sci.fun(sta, 4)     
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)                 
sci_12mo <- sci.fun(sta, 12)        

# * psh_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psh_whi -- bind and rename the sci vals====       
sci_psh_whi <- bind_cols(psh_whi,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psh_whi -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psh_whi, psh_whi_v)  

# 5.0 calculate SCI_psl---- 
# 5.1 SCI calcs - psl_brs -- set up station for sci & make sci list vars====   
sta      <- psl_brs_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 9, 11 (JAN & SEP & NOV)   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month  4 (MAR-APr)                 
sci_3mo  <- sci.fun(sta, 3)    # MLE fail month 11 (SEP-NOV)                 
sci_4mo  <- sci.fun(sta, 4)    # MLE fail month 12 (SEP-DEC)             
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month  2 (SEP-FEB)                 
sci_9mo  <- sci.fun(sta, 9)                
sci_12mo <- sci.fun(sta, 12)      

# * psl_brs -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_brs -- bind and rename the sci vals====       
sci_psl_brs <- bind_cols(psl_brs,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_brs -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_brs, psl_brs_v)  

# 5.2 SCI calcs - psl_elk -- set up station for sci & make sci list vars====   
sta      <- psl_elk_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 8, 10, 11, 12   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 11, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 9, 10, 11, 12         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 9, 12   
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 9, 11, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 6    
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 6, 7    

# * psl_elk -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_elk -- bind and rename the sci vals====       
sci_psl_elk <- bind_cols(psl_elk,      
                         sci_1mo,    
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_elk -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_elk, psl_elk_v)  

# 5.3 SCI calcs - psl_hat -- set up station for sci & make sci list vars====   
sta      <- psl_hat_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         

# * psl_hat -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_hat -- bind and rename the sci vals====       
sci_psl_hat <- bind_cols(psl_hat,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_hat -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_hat, psl_hat_v)  

# 5.4 SCI calcs - psl_bad -- set up station for sci & make sci list vars====   
sta      <- psl_bad_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 9, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 2, 12   
sci_3mo  <- sci.fun(sta, 3)            
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 2  
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 10    
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 12    
sci_12mo <- sci.fun(sta, 12)         

# * psl_bad -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_bad -- bind and rename the sci vals====       
sci_psl_bad <- bind_cols(psl_bad,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_bad -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_bad, psl_bad_v)  

# 5.5 SCI calcs - psl_hor -- set up station for sci & make sci list vars====   
sta      <- psl_hor_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail months 1, 5, 6, 11   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail months 1, 2, 6, 8, 12  
sci_3mo  <- sci.fun(sta, 3)    # MLE fail months 1, 2, 3, 6, 9         
sci_4mo  <- sci.fun(sta, 4)    # MLE fail months 1, 3, 7    
sci_6mo  <- sci.fun(sta, 6)    # MLE fail months 1, 2, 7, 12  
sci_9mo  <- sci.fun(sta, 9)    # MLE fail months 1, 8, 9     
sci_12mo <- sci.fun(sta, 12)   # MLE fail months 5, 11      

# * psl_hor -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * psl_hor -- bind and rename the sci vals====       
sci_psl_hor <- bind_cols(psl_hor,        
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * psl_hor -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(psl_hor, psl_hor_v)  

# 6.0 calculate SCI_snd---- 
# 6.1 SCI calcs - snd_lon -- set up station for sci & make sci list vars====   
sta      <- snd_lon_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)    # MLE fail month 12        
sci_12mo <- sci.fun(sta, 12)   # MLE fail month 6   

# * snd_lon -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_lon -- bind and rename the sci vals====      
sci_snd_lon <- bind_cols(snd_lon,      
                         sci_1mo,   
                         sci_2mo,    
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_lon -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_lon, snd_lon_v)   

# 6.2 SCI calcs - snd_mar -- set up station for sci & make sci list vars====  
sta      <- snd_mar_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                       
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_mar -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_mar -- bind and rename the sci vals====      
sci_snd_mar <- bind_cols(snd_mar,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_mar -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_mar, snd_mar_v)    

# 6.3 SCI calcs - snd_nio -- set up station for sci & make sci list vars====  
sta      <- snd_nio_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                           
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_nio -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,     
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_nio -- bind and rename the sci vals====      
sci_snd_nio <- bind_cols(snd_nio,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,   
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_nio -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_nio, snd_nio_v)    

# 6.4 SCI calcs - snd_ros -- set up station for sci & make sci list vars====  
sta      <- snd_ros_v  
sci_1mo  <- sci.fun(sta, 1)                        
sci_2mo  <- sci.fun(sta, 2)                    
sci_3mo  <- sci.fun(sta, 3)    # MLE fail for month 5    
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_ros -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)     

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_ros -- bind and rename the sci vals====      
sci_snd_ros <- bind_cols(snd_ros,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo  
) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_ros -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_ros, snd_ros_v)    

# 6.5 SCI calcs - snd_vet -- set up station for sci & make sci list vars====  
sta      <- snd_vet_v   
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)     # MLE fail month 5   
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_vet -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_vet -- bind and rename the sci vals====      
sci_snd_vet <- bind_cols(snd_vet,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,    
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_vet -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_vet, snd_vet_v)    

# 6.6 SCI calcs - snd_whi -- set up station for sci & make sci list vars====  
sta      <- snd_whi_v  
sci_1mo  <- sci.fun(sta, 1)                      
sci_2mo  <- sci.fun(sta, 2)                            
sci_3mo  <- sci.fun(sta, 3)       
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * snd_whi -- apply the transformation identified by fitSCI function====    
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * snd_whi -- bind and rename the sci vals====      
sci_snd_whi <- bind_cols(snd_whi,      
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * snd_whi -- clean up global environment====  
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(snd_whi, snd_whi_v)    




# 7.0 calculate SCI_ter---- 
# 7.1 SCI calcs - ter_ogl -- set up station for sci & make sci list vars====   
sta      <- ter_ogl_v   
sci_1mo  <- sci.fun(sta, 1)     # MLE fail month 9 (SEP)                    
sci_2mo  <- sci.fun(sta, 2)     # MLE fail month 10 (SEP-OCT)           
sci_3mo  <- sci.fun(sta, 3)    
sci_4mo  <- sci.fun(sta, 4)     # MLE fail month 2 (NOV-FEB)  
sci_6mo  <- sci.fun(sta, 6)     
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * ter_ogl -- apply the transformation identified by fitSCI function====     
sci_1mo  <- transformSCI(sta,     
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * ter_ogl -- bind and rename the sci vals====        
sci_ter_ogl <- bind_cols(ter_ogl,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_ogl -- clean up global environment====   
rm(sci_1mo,    
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(ter_ogl, ter_ogl_v)   

# 7.2 SCI calcs - ter_sta -- set up station for sci & make sci list vars====   
sta      <- ter_sta_v  
sci_1mo  <- sci.fun(sta, 1)    # MLE fail month 9 (SEP)                   
sci_2mo  <- sci.fun(sta, 2)    # MLE fail month 10  (SEP-OCT)               
sci_3mo  <- sci.fun(sta, 3)             
sci_4mo  <- sci.fun(sta, 4)          
sci_6mo  <- sci.fun(sta, 6)    # MLE fail month 5 (DEC-MAY)       
sci_9mo  <- sci.fun(sta, 9)         
sci_12mo <- sci.fun(sta, 12)   

# * ter_sta -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,    
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)   

sci_2mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%   
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,   
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,    
                         first.mon = first_mon,   
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)    

sci_6mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,  
                         first.mon = first_mon,   
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%   
  enframe(name                     = NULL)   

# * ter_sta -- bind and rename the sci vals====       
sci_ter_sta <- bind_cols(ter_sta,       
                         sci_1mo,   
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,   
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo) %>%                             
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%   
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%   
  rename(sci_6mo = value4)  %>%   
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_sta -- clean up global environment====   
rm(sci_1mo,   
   sci_2mo,  
   sci_3mo,  
   sci_4mo,   
   sci_6mo,  
   sci_9mo,  
   sci_12mo)      
rm(ter_sta, ter_sta_v)  
# 7.3 SCI calcs - ter_whi -- set up station for sci & make sci list vars====  
sta      <- ter_whi_v    
sci_1mo  <- sci.fun(sta, 1)                              
sci_2mo  <- sci.fun(sta, 2)                             
sci_3mo  <- sci.fun(sta, 3)                            
sci_4mo  <- sci.fun(sta, 4)    
sci_6mo  <- sci.fun(sta, 6)      
sci_9mo  <- sci.fun(sta, 9)  # MLE fail month 6     
sci_12mo <- sci.fun(sta, 12)   

# * ter_whi -- apply the transformation identified by fitSCI function====      
sci_1mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_1mo) %>%  
  enframe(name                     = NULL)  

sci_2mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_2mo) %>%  
  enframe(name                     = NULL)  

sci_3mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_3mo) %>%  
  enframe(name                     = NULL)  

sci_4mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_4mo) %>%  
  enframe(name                     = NULL)  

sci_6mo  <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_6mo) %>%  
  enframe(name                     = NULL)  

sci_9mo  <- transformSCI(sta,   
                         first.mon = first_mon,  
                         obj       = sci_9mo) %>%  
  enframe(name                     = NULL)  

sci_12mo <- transformSCI(sta,  
                         first.mon = first_mon,  
                         obj       = sci_12mo) %>%  
  enframe(name                     = NULL)  

# * ter_whi -- bind and rename the sci vals====       
sci_ter_whi <- bind_cols(ter_whi,     
                         sci_1mo,  
                         sci_2mo,   
                         sci_3mo,  
                         sci_4mo,  
                         sci_6mo,  
                         sci_9mo,   
                         sci_12mo   
) %>%  
  rename(sci_1mo = value)   %>%  
  rename(sci_2mo = value1)  %>%  
  rename(sci_3mo = value2)  %>%  
  rename(sci_4mo = value3)  %>%  
  rename(sci_6mo = value4)  %>%  
  rename(sci_9mo = value5)  %>%  
  rename(sci_12mo = value6)  

# * ter_whi -- clean up global environment====     
rm(sci_1mo,  
   sci_2mo,  
   sci_3mo,  
   sci_4mo,  
   sci_6mo,  
   sci_9mo,  
   sci_12mo)   
rm(ter_whi, ter_whi_v)     

```

```{r join_SRI}  

# 1 clean up sci.fun vars====  
#rm(distrib,  
#   first_mon,  
#   p_zero,  
#   p_zero_cm,  
#   scale,  
#   sci.limit,  
#   sta,  
#   time_scale,  
#   warn_me,  
#   sci.fun)  

# 2.1 join black hills plateau SCI vals====    
sci_bhp <- bind_rows(sci_bhp_bat,  
                     sci_bhp_fal,  
                     sci_bhp_frn) %>%  
  mutate(group = "Black Hills Plateau") %>%   
  select(sta, group, ecoreg, everything())  

# 2.2 join gw control SCI vals====  
sci_gwc <- bind_rows(sci_gwc_bev,  
                     sci_gwc_lcr) %>%  
  mutate(group = "GW control") %>%   
  select(sta, group, ecoreg, everything())  

# 2.3 join keya paha tablelands SCI vals====  
sci_kpt <- bind_rows(sci_kpt_key,  
                     sci_kpt_wew) %>%  
  mutate(group = "Keya Paha Tablelands") %>%   
  select(sta, group, ecoreg, everything())  

# 2.4 join pierre shale high SCI vals====  
sci_psh <- bind_rows(sci_psh_bat,  
                     sci_psh_che,  
                     sci_psh_whi) %>%  
  mutate(group = "Pierre Shale High") %>%   
  select(sta, group, ecoreg, everything())  

# 2.5 join pierre shale low SCI vals====  
sci_psl <- bind_rows(  sci_psl_bad,  
                       sci_psl_brs,  
                       sci_psl_elk,  
                       sci_psl_hat,  
                       sci_psl_hor) %>%  
  mutate(group = "Pierre Shale Low") %>%   
  select(sta, group, ecoreg, everything())  

# 2.6 join sand hills SCI vals====  
sci_snd <- bind_rows(sci_snd_lon,  
                     sci_snd_mar,  
                     sci_snd_nio,  
                     sci_snd_ros,  
                     sci_snd_vet,  
                     sci_snd_whi) %>%  
  mutate(group = "Sand Hills") %>%   
  select(sta, group, ecoreg, everything())  

# 2.7 join tertiary clay SCI values====    
sci_ter <- bind_rows(sci_ter_ogl,  
                     sci_ter_sta,  
                     sci_ter_whi) %>%  
  mutate(group = "Tertiary Clays") %>%   
  select(sta, group, ecoreg, everything())  

# 3.0 join all values====  
sci_gage <- bind_rows(sci_bhp,  
                      sci_gwc,  
                      sci_kpt,  
                      sci_psh,  
                      sci_psl,  
                      sci_snd,  
                      sci_ter) %>%  
    gather(key = type, val = value,  
         -c(sta, date, group, ecoreg, log_q1_mon))    

# * clean up global environment====  
rm(sci_bhp,  
   sci_gwc,  
   sci_kpt,  
   sci_psh,  
   sci_psl,  
   sci_snd,  
   sci_ter,  
   sci_bhp_bat,  
   sci_bhp_fal,  
   sci_bhp_frn,  
   sci_gwc_bev,  
   sci_gwc_lcr, 
   sci_kpt_key,  
   sci_kpt_wew,  
   sci_psh_bat,  
   sci_psh_che,  
   sci_psh_whi,  
   sci_psl_bad,  
   sci_psl_brs,  
   sci_psl_elk,  
   sci_psl_hat,  
   sci_psl_hor,  
   sci_snd_lon,  
   sci_snd_mar,  
   sci_snd_nio,  
   sci_snd_ros,  
   sci_snd_vet,  
   sci_snd_whi,  
   sci_ter_ogl,  
   sci_ter_sta,  
   sci_ter_whi)  

```

```{r old-prepare-sri-deconvolution}


# old identify seasonally intermittant streams (NEED TO FIX====  
#sri_intermit <- sri_seas %>%  
#  group_by(sta) %>%  
#  summarise(group = first(group),  
#            season_max = max(season)) %>%  
#  ungroup() %>%  
#  mutate(season_max = round(season_max, digits = 2)) %>%  
#  arrange(desc(season_max))  

#export(mclust_aug, "data/lmom_mclust_fit.csv")  

# * calculate group median & MAD for plotting====   
sri_seas_group <- sri_seas %>%  
  group_by(group, date) %>%   
  summarise(sci_1mo_mad    = mad(sci_1mo),   
            sci_1mo_med    = median(sci_1mo),   
            sci_seas_mad   = mad(season),   
            sci_seas_med   = median(season),  
            sci_trend_mad  = mad(trend),   
            sci_trend_med  = median(trend),   
            sci_remain_mad = mad(remainder),   
            sci_remain_med = median(remainder)  
            ) %>%  
  ungroup() %>%  
  mutate(sci_1mo_hi    = sci_1mo_med + sci_1mo_mad) %>%  
  mutate(sci_1mo_lo    = sci_1mo_med - sci_1mo_mad) %>%  
  mutate(sci_seas_hi   = sci_seas_med + sci_seas_mad) %>%  
  mutate(sci_seas_lo   = sci_seas_med - sci_seas_mad) %>%  
  mutate(sci_trend_hi  = sci_trend_med + sci_trend_mad) %>%  
  mutate(sci_trend_lo  = sci_trend_med - sci_trend_mad) %>%  
  mutate(sci_remain_hi = sci_remain_med + sci_remain_mad) %>%  
  mutate(sci_remain_lo = sci_remain_med - sci_remain_mad)  

# * split out data-types for plotting ====  
sri_1mo_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_1mo_med, 
         sci_1mo_hi,  
         sci_1mo_lo  
         )  %>%   
  gather(key = key, value = value,  
         -c(group, date, sci_1mo_med)  
         ) 
  
sri_seas_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_seas_med, 
         sci_seas_hi,  
         sci_seas_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_seas_med)  
         ) %>% 
  mutate(month = month(date)) 
  
sri_trend_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_trend_med, 
         sci_trend_hi,  
         sci_trend_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_trend_med)  
         )   
  
sri_remain_mad <- sri_seas_group %>%  
  select(group,  
         date,  
         sci_remain_med, 
         sci_remain_hi,  
         sci_remain_lo  
         )  %>%   
  gather(key = var, value = val,  
         -c(group, date, sci_remain_med)  
         )   


# prepare for plotting -- split out data types====  
sri_seas_ecoreg <- sri_seas_ecoreg %>%  
  mutate(ecoreg = fct_relevel(ecoreg, 
                              "Pierre Shale Plains",  
                              "Pine Ridge Escarpment",  
                              "White River Badlands",  
                              "Black Hills Plateau",  
                              "Keya Paha Tablelands", 
                              "Sand Hills")     
  )  

```

```{r plot_sri_old}   
 

# streamflow observations plot====  
#sri_obs <- 
  sri_seas %>%   
  ggplot(aes(date, sci_1mo)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_1mo_mad,   
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_1mo_mad,  
            aes(date, sci_1mo_med),  
            size            = 0.3,  
            colour          = "black"  
  )   
  
#test <- 
  sri_seas %>%  
  filter(group == "Pierre Shale Low") %>%  
  mutate(month = month(date)) %>% 
  select(sta, month, season) %>%  
  distinct() %>% 
  ggplot(aes(month, season)) +  
# set theme and facets  
  theme_bw() +  
  geom_point()

# streamflow seasons plot====  
#sri_seas_plot <- 
sri_seas %>%   
  mutate(month = month(date)) %>% 
  select(month, group, season) %>%  
#  distinct() %>%   
  ggplot(aes(month, season)) +  
# set theme and facets  
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month seasonality") +   
  scale_y_continuous(limits = c(-3, 3)) +  
# scale_x_continuous(breaks = 1:12,   
#                     labels = c("J", "F", "M", "A", "M", "J",  
#                                "J", "A", "S", "O", "N", "D")) +  
  facet_wrap(vars(group),   
             nrow = 2) +   
  # plot all station vals  
geom_point(colour = "gray80") + 
    # plot median +/- 1 MAD  
  geom_point(data = sri_seas_mad,  
            aes(month, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) #+  
# plot median  
  geom_line(data = sri_seas_mad,  
            aes(date, sci_seas_med),  
            size            = 0.3,  
            colour          = "black"  
  )  
 
 #  geom_line(size   = 1,  
#            colour = "gray80")  #+  
 
   
# streamflow trend plot====  
sri_trend_plot <- sri_seas %>%   
  ggplot(aes(date, trend)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month trend") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_trend_mad,  
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_trend_mad,  
            aes(date, sci_trend_med),  
            size            = 0.3,  
            colour          = "black"  
  )  

# streamflow remain plot====  
sri_remain_plot <- sri_seas %>%   
  ggplot(aes(date, remainder)) +     
  theme_bw() +  
  xlab("") +  
  ylab("SRI 1-month remainder") +   
  scale_y_continuous(limits = c(-3, 3)) +  
  facet_wrap(vars(group),   
             nrow = 2  
  ) +   
  # plot all station vals  
  geom_line(size            = 1,  
            colour          = "gray80"  
  )  +  
# plot median +/- 1 MAD  
  geom_line(data = sri_remain_mad,  
            aes(date, val),  
            size            = 0.6,  
            colour          = "gray50"  
  ) +  
# plot median  
  geom_line(data = sri_remain_mad,  
            aes(date, sci_remain_med),  
            size            = 0.3,  
            colour          = "black"  
  ) +  
# plot anomolies  
  geom_point(data = sri_anom,  
             aes(date, sci_1mo),  
             shape = 8)  
  
# plot the plots above as a grid & save====  
cowplot::plot_grid(  
  sri_obs, sri_seas_plot, sri_trend_plot, sri_remain_plot,  
  ncol = 1,   
  align = "v"  
)  
  
cowplot::ggsave2("figure/sri_deconv.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  
  
# clean-up====  
rm(sri_obs,  
   sri_seas,  
   sri_seas_plot,  
   sri_anom,  
   sri_1mo_mad,  
   sri_remain_mad,  
   sri_remain_plot,  
   sri_seas_ecoreg,  
   sri_seas_mad,  
   sri_trend_mad,  
   sri_trend_plot,  
   gage_meta  
   )         
  
```  

```{r things}



# import sta -- and standardize vars between dfs====      
sci_sta <- import("data/spi_seas.csv") %>%     
  mutate(date = ymd(date)) %>%  
  mutate(prcp = as.numeric(prcp)) %>%  
#  filter(sta == "ONI") %>% 

            )) %>%  
# check dates  
  mutate(min_date_sta = min(date)) %>%   
  mutate(max_date_sta = max(date)) %>%     
# arrange from wide to long  
  gather(key   = spi_length,   
         value = spi_val,   
         -c(group,   
            date,   
            sta,   
            min_date_sta,  
            max_date_sta, 
            prcp
            )) %>%  
  ungroup() %>%  
  drop_na() %>%  
# prepare for joining by spi_length  
  mutate(spi_length = str_remove_all(spi_length, "mo")) %>%     
  mutate(spi_length = str_sub(spi_length, start = 5) %>% as.numeric)  
  
```  

```{r stuff}

# deconvolute streamflow into trend, seasonal & random components----   
# import streamflow data and metadata====     
#sci_gage <- import("data/sci_gage.csv") %>%    
#  mutate(date = ymd(date)) %>%   
#  filter(between(date, as.Date("1988-09-15"), as.Date("2018-09-15")))  %>%  
#  arrange(date) %>%   
#  as_tibble() %>%  
#  mutate(group = sta)  # group is for decomp_fun  
  
# clean metadata  
#gage_meta <-  import("data/gage_meta_lmom.csv") %>% 
#  select(-c(ecoreg.x, years.y, ecoreg.y)) %>% 
#  rename(years = years.x)  

#export(gage_meta, "gage_meta_lmom.csv") 
 
# remove discordant stations from metadata====    
#gage_meta <- semi_join(gage_meta, sci_gage,  
#                       by = c("sta", "ecoreg"))  
  

gage_meta <- full_join(gage_meta, sri_intermit, 
                       by = "sta") 
  
gage_meta <- gage_meta %>% 
  mutate(flow_regime = case_when(  
    season_max > 0.8 ~ "strongly intermittent",  
    season_max > 0.4 ~ "moderately intermittent", 
    TRUE ~ flow_regime
    ))   
  
export(gage_meta, "data/gage_meta_seas.csv")  
export(sri_seas, "data/sri_seas.csv") 
#sta_meta_fin <- import("data/sta_meta_fin.csv")       

# prepare for deconvoluting the grouped precip====    
#sci_sta <- sci_sta %>%   
#  mutate(prcp = as.numeric(prcp)) %>%     
#  arrange(date) %>%   
#  as_tibble() %>%   
#  # make groups  
#  mutate(group = case_when(  
#    sta == "RAP" ~ "NW",    
#    sta == "COT" ~ "NC",     
#    sta == "ONI" ~ "NE",    
#    sta == "OEL" ~ "SW",  
#    sta == "GOR" ~ "SC",   
#    sta == "MIS" ~ "SE"))  

# TO DO Monthly plot PRCP_MON - check code   
# DELETE OLD CODE  
# 1 import streamflow records & metadata====     
#gage_mon <- import("data/gage_mon_full.csv")    

# remove discordant stations & discord calcs  
#gage_meta <- import("data/gage_meta_lmom.csv") %>%  
#  filter(isD == FALSE) %>%  
#  select(-c(Dmax:Dcrit, isD, signif))  

#gage_mon <- semi_join(gage_mon, gage_meta,  
#                      by = c("sta", "ecoreg"))  


#gage_mon_sri %>% 
#  select(sta) %>% 
#  distinct()  
#rm(gage_check)  

# get mean L-statistic values from discord calculations====  
#gage_mean <-  import("data/lmom_table.csv") %>%  
#  filter(sta == "") %>%  
#  select(ecoreg, L_CV, L_skew, L_kurtosis) %>%  
#  rename(L_CV_mean   = L_CV) %>%   
#  rename(L_skew_mean = L_skew) %>%  
#  rename(L_kurt_mean = L_kurtosis)  

# find distance from centers  
#gage_meta <- left_join(gage_meta, gage_mean,  
#                       by = "ecoreg") %>%  
#  mutate(L_CV_diff   = L_CV - L_CV_mean) %>%  
#  mutate(L_skew_diff = L_skew - L_skew_mean) %>%  
#  mutate(L_kurt_diff = L_kurtosis - L_kurt_mean) %>%  
#  mutate(D2 = round(digits = 2,  
#                    sqrt(L_CV_diff^2 + L_skew_diff^2 + L_kurt_diff^2)  
#  )  
#  ) %>%  
#  arrange(D2)  

# join metadata  
#gage_sci_meta <- semi_join(gage_meta, sri_input,   
#                           by = c("sta", "ecoreg")  
#)  
# export selection and clean-up  

#rm(gage_mean,  
#   gage_meta
#)    
``` 

```{r ggplot_monthly, eval=FALSE} 
#sta_mon <- import(file = "data/stations_monthly.csv") %>%   
#  mutate(date = ymd(date))  
  
#sta_mon %>%   
#  group_by(sta) %>%   
#  summarize(count = n())  
  
sta_mon_plus$group <- factor(sta_mon_plus$group,  
                             levels = c("NW", "NC", "NE", "SW", "SC", "SE"))  
  
# plot monthly precips  
sta_mon_plus %>%   
  ggplot(aes(month, depth_mm, group = month)) +  
  facet_grid(rows = vars(group)) +   
  geom_quasirandom(size = 0.2,  
                   position = position_beeswarm()  
  ) + 
  scale_x_discrete(limits = c("1", "2", "3", "4", "5", "6",  
                              "7", "8", "9", "10", "11", "12"),    
                   labels = c("J", "F", "M", "A", "M", "J",  
                              "J", "A", "S", "O", "N", "D")   
  ) +  
  theme_bw() +  
  #  labs(title = "Monthly precipitation depths",  
  #       subtitle = "Southwestern South Dakota for 1990-2017") +   
  xlab("") +  
  ylab("mm")  
  
ggplot2::ggsave(path = "figure/", filename = "precip_mon.png",   
                width = 6, height = 6, units = "in")  
  
````  

```{r precip-EDA, include=FALSE, eval=FALSE}
# Purpose: EDA of precipitation data.
# Outcome: Differences among stations 1971-2018 are small.  
#          less than +/-5 mm on average.  
 
# the anomolously wet month series is dominated by May & June events.  
# what drives precip during this time?   
#   In May & June the area recieves low-level moisture from the Gulf   
#   of Mexico, strong cold fronts, and active upper-level pattern  
#   leading to greater chance for convection.  
```

```{r Mclust-plot-old, eval=FALSE}  

# get pc-vars for plotting====  
pca_vars  <- import('data/pca_vars.csv')  
pca_eigen <- import("data/pca_eigen.csv")  

# plot clusters by ecoregion====  
mclust_eco_plot  <- mclust_aug %>%  
  ggplot(aes(PC1_mon, PC2_mon)) +  
  # set theme and facets #  
  theme_bw() +  
  facet_wrap(vars(ecoreg)) +  
  geom_jitter(  
    aes(color = flow_type,  
        shape = ecoreg,  
        alpha = .uncertainty),  
    size = 2,  
    show.legend = FALSE) +  
  scale_alpha(".uncertainty") +  
  # plot centroids for each flow type -- commented out to reduce plot clutter  
  geom_point(aes(PC1_eco, PC2_eco,  
                 size = proportion_ecoreg,  
  ),  
  show.legend = FALSE,  
  shape = 3,                   # cross shape  
  # size = 2.5,
  stroke = .5,  
  color = "gray50"
  ) + 
  # plot pc eigenvectors as arrows #  
  geom_segment(data = pca_vars,  
               aes(x = 0, y = 0,  
                   xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.03, "npc")) 
  ) +  
  # plot pc eigenvector text #  
  geom_text(data = pca_vars,  
            size = 3,  
            nudge_x = 0.5,  
            nudge_y = -0.1,  
            hjust = 'outside',  
            aes(x = PC1, y = PC2, label = labels)  
  ) +  
  # set axis text #  
  xlab("PC1 axis (95.0%)") +  # from pca_eigen  
  ylab("PC2 axis (4.3%)") +  
  theme(legend.position="bottom")  

# plot clusters by flow type====  
mclust_flow_plot <- mclust_aug %>%  
  ggplot(aes(PC1_mon, PC2_mon)) +  
  # set theme and facets #  
  theme_bw() + 
  facet_wrap(~ flow_type) +  
  # plot points # 
  geom_jitter(aes(shape = ecoreg,  
                  color = flow_type,  
                  alpha = .uncertainty 
  ),  
  show.legend=FALSE,  
  size = 2)  +  
  # plot centroids #  
  geom_point(aes(PC1_eco, PC2_eco,  
                 shape = ecoreg,  
                 size = proportion_ecoreg  
  ),  
  show.legend=FALSE,  
  color = "black"  
  ) +  
  # set axis text #  
  xlab("PC1 axis (95.0%)") +  # from pca_eigen  
  ylab("PC2 axis (4.3%)") +  
  theme(legend.position="bottom")  

# plot grid of ggplots====  
cowplot::plot_grid(  
  mclust_eco_plot,  
  mclust_flow_plot,  
  ncol = 1,  
  align = "v"  
)  

cowplot::ggsave2("figure/mclust_plot.png",  
                 units = "in",  
                 width = 7,  
                 height = 9)  

# save results & clean up global environment  
export(mclust_aug, "data/mclust_results.csv")  
export(mclust_fit, "data/mclust_fit.csv")  

rm(mclust_flow_plot,  
   mclust_eco_plot,  
   mod,  
   mclust_aug,  
   mclust_fit,  
   mclust_means,  
   pca_eigen,  
   pca_vars  
)  
  
#    scale_colour_brewer(palette = "Greys") + 
#ecoreg_sum <- mclust_aug %>%  
#  group_by(ecoreg) %>%  
#  summarise(q)  # what to do here???
  
# map the title of the geom for the legend  
#  scale_shape_discrete(name="Ecoregion") + 
#  scale_color_hue(name="Flow type") 
  
```

# probably not best approach 
```{r build-glm-models_1mo} 
    
# set up random seed & parallel processing for glmnet & caret ----------------  
seed <- 42  
cores <- parallel::detectCores(all.tests = FALSE, logical = TRUE)   
registerDoMC(cores)    
  
# set up 'caret' training control & lambda -- 100 possible lambda vals [-2, 2]  
# note these values are used below for individual model fits  
set.seed(seed)   
reg.ctrl <-  trainControl(method = "repeatedcv", number = 5, repeats = 5,   
                          search = "grid", allowParallel = TRUE)   
  
lambda <- 10^seq(-2, 2, length = 100)  
  
# Split the data into training and test set ----------------------------------  
# remove unneeded data from the model input 
sci1mo_input <- sci_1mo %>% 
  select(sci_val, spi_length_1:spi_length_12, ecoreg, date)

# create a data partition balanced by flow depths   
set.seed(seed)     
train_index <- createDataPartition(sci1mo_input$sci_val, p=0.8)[[1]]  
  
train   <- sci1mo_input[train_index,] 
test    <- sci1mo_input[-train_index,] 
   
# ridge -- alpha = 0 ---------------------------------------------------------  
set.seed(seed)             # need to set a seed each time you call a rand num   
ridge <- train %>%   
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,         # x = 'sci_val', y = rest of the columns, from  
        data = .,                #   the dataset 'train.data'   
        method = "glmnet",       #   using method "glmnet"    
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,     
        tuneGrid = expand.grid(alpha = 0, lambda = lambda) # df with tuning values   
  )    
  
# lasso -- alpha = 1 ---------------------------------------------------------   
set.seed(seed)              # need to set a seed each time you call a rand num   
lasso <- train %>%   
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,            
        data = .,                 #   the dataset 'train.data'    
        method = "glmnet",        #   using method "glmnet"   
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,    
        tuneGrid = expand.grid(alpha = 1, lambda = lambda) # df with tuning values  
  )   
  
# elastic net -- alpha vals [0, 1] by caret ----------------------------------  
set.seed(seed)   
elastic <- train %>%  
  select(-c(ecoreg, date)) %>% 
  train(sci_val ~.,          
        data = .,                 #   the dataset 'train.data'     
        method = "glmnet",        #   using method "glmnet"   
        preProcess = c("center", "scale"),   
        trControl = reg.ctrl,   
        tuneLength = 10          # tune length    
  )    
  
# make a list of the models --------------------------------------------------   
models <- list(   
  ridge = ridge,  
  lasso = lasso,   
  elastic = elastic)    
  
rm(cores, train_index, reg.ctrl)   
  
```  

```{r get-glm-coefs}
 
# get & tidy model coefficients for each of the GLMs     
# get number of parameters for each of the GLMs   
   
# ridge coeffs ---------------------------------------------------------------  
coef_ridge <- coef(  
  ridge$finalModel,  
  ridge$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "ridge")  
  
# lasso coeffs  --------------------------------------------------------------   
coef_lasso <- coef(  
  lasso$finalModel,  
  lasso$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "lasso")  
  
# elastic coeffs  ------------------------------------------------------------  
coef_elastic <- coef(  
  elastic$finalModel,  
  elastic$bestTune$lambda) %>%  
  as.matrix() %>%     
  as_tibble(., rownames = "coeff") %>%  
  mutate(type = "elastic")  
  
# join model coeff -----------------------------------------------------------  
coefs <- bind_rows(coef_ridge, coef_lasso, coef_elastic)   
  
coefs <- coefs %>%  
  rename(value = 2) %>%  
  mutate(value = round(  
    value, digits = 3)  
    ) %>%  
  spread(type, value)  
  
# prepare for export table --------------------------------------------------- 
# arrange by absolute value of the lasso model  
coefs <- coefs %>%   
  mutate(arrange_ridge = abs(ridge)) %>%   # temp terms to arrange coeffs  
  mutate(arrange_lasso = abs(lasso)) %>%   # temp terms to arrange coeffs  
  arrange(desc(arrange_ridge)) %>%    
  arrange(desc(arrange_lasso)) %>%  
  select(coeff, lasso, ridge, elastic)  
  
# rename coefficients to fit the hydrologic coefficient table  
coefs <- coefs %>%   
  mutate(coeff = case_when(   
    coeff == "(Intercept)" ~ "Intercept",  
    TRUE ~ coeff)) 
  
rm(coef_ridge, 
   coef_lasso, 
   coef_elastic,  
   ridge, 
   lasso, 
   elastic)     
```

```{r select-glm-models_dv}
  
# evaluate performance of models -- ridge, lasso and elastic net --      
#   best model is the one that minimizes the prediction error.    
  
# pick out the mse from the output lists   
error_call <- resamples(models) %>%    
  summary(metric = c("MAE"))     
  
# change list to tibble   
error_vals <- error_call %>%    
  pluck(., 'statistics') %>%   
    as.data.frame() %>%   
  as_tibble(., rownames = "model") %>% 
  gather(key, val, -c(model))  %>%  
  mutate(key = str_replace(key, "[.]", "_")) %>%   
  separate(key, c("statistic", "position"), extra = "drop") %>%  
  filter(position != "NA") %>%  
  mutate(val = round(val, digits = 3)) %>% 
  spread(position, val)   
  
rm(error_call)   

```

```{r plot-glm-models_dv} 
 
# prepare for plotting   
n_train <- train %>%  
  mutate(n_count = n()) %>%  
  distinct(n_count)   
  
# make a boxplot of the three models   
error_vals %>%
  ggplot() +   
  theme_bw() + 
  # facet_grid(cols = vars(statistic), 
  #            scale = "free") +   
  geom_boxplot(aes(x = factor(model),  
                   group = model,  
                   lower = `1st`,  
                   upper = `3rd`,  
                   middle = `Median`,  
                   ymin = `Min`,  
                   ymax = `Max`),  
               stat = "identity") +   
  geom_text(data = n_train,  
            x = 3, y = 0.63,    
            aes(label= paste("n =", n_count, sep = " ")),   
            size = 3,   
            color = "gray20"  
  ) + 
  ylim(0.63, 0.71) +  
labs(x = "",   
     y = bquote('Median Absolute Error')
)      
  
# save ggplot above & clean up   
ggsave("figure/model_fit_sci_all.png", width = 7, height = 3.5, units = "in")   
  
rm(n_train)    

# results are -- models look very similiar with slightly lower LASSO error
  
``` 

```{r get_glm_observations_and_predictions}  
  
# get observations & predictions -- training --------------------------------  
obs_train   <- tibble(observed = train$sci_val,   
                             date = train$date, 
                             ecoreg = train$ecoreg) 
  
preds_train <- map_dfc(models, predict, newdata = train)   
  
# combine observations & predictions  
fit_train <- bind_cols(obs_train, preds_train) %>%  
  mutate(split = "train") %>%  
  as_tibble() 
  
# get observations & predictions -- test ------------------------------------  
obs_test   <- tibble(observed = test$sci_val, 
                     date     = test$date, 
                     ecoreg   = test$ecoreg) 

preds_test <- map_dfc(models, predict, newdata = test)  
  
# combine observations & predictions 
fit_test <- bind_cols(obs_test, preds_test) %>%  
  mutate(split = "test") %>% 
  as_tibble()  
  
fit_model <-  bind_rows(fit_test, fit_train)  
 
# drop the training data -- find model errors & fit a null model ------------  
fit_model_test <- fit_model %>% 
  filter(split == "test") %>%           # only want to see test data 
  select(-c(split, ridge, elastic)) %>%        # drop non-selected models 
  group_by(date)  %>%                   # fit a null model to the data by Date  
  mutate(null_mod = mean(observed)) %>% 
  ungroup() %>%  
  gather(model, fitted, -c(observed, date, ecoreg)) %>% 
  group_by(model) %>% 
  mutate(MAE = round( 
    MAE(observed, fitted),              # find the model errors 
    digits = 3) 
    ) %>% 
  ungroup() %>% 
  mutate(residual = observed - fitted) %>% 
  mutate(freq = 1- percent_rank(observed)) %>% 
  mutate(freq = if_else(freq== 1, 0.9999, freq))  
  
# clean-up  
rm(preds_test,  
   preds_train,  
   obs_train,  
   obs_test,  
   train,  
   fit_test,  
   fit_train)    
 
``` 

```{r build-glm-models-ecoreg}  
# prepare for modeling at the ecosystem scale --------------------------------  
# drop unimportant predictors - from lasso above   
  
sci1mo_ecoreg <- sci_1mo %>%  
#  select(-c(gage, group, .fittedPC1, .fittedPC2,  
#            prcp_sq, crel_sqr, vpdan_sq, t07_sq, TWI_sq)) %>%   
  mutate(ecoreg2 = case_when(   
    ecoreg == "Black Hills Plateau"   ~ "bhplat",  
    ecoreg == "Keya Paha Tablelands"  ~ "kptabl",   
    ecoreg == "Pierre Shale Plains"   ~ "pshale",   
    ecoreg == "Pine Ridge Escarpment" ~ "escarp",      
    ecoreg == "Sand Hills"            ~ "sndhil",    
    ecoreg == "White River Badlands"  ~ "wrbadl"   
    )) %>%   
  select(-c(ecoreg, prcp, sta, gage, group,  
         min_date_gage, max_date_gage,  
         min_date_sta, max_date_sta)   
         )  
  
# Split the data into training and test sets by ecoreg -----------------------  
ecoreg_list <- sci1mo_ecoreg %>%  
  split(., .$ecoreg2) 
    
# create an index of values -- used sci_val   
ecoreg_index <- lapply(ecoreg_list, function(x) {   
  return(createDataPartition(x$sci_val, p = .8, list = FALSE))    
  })    
   
# get separate training & test df from the index (used in a code-chunk below) 
train_bhplat <- (ecoreg_list[[1]])[ecoreg_index[[1]],]  
train_kptabl <- (ecoreg_list[[2]])[ecoreg_index[[2]],]  
train_pshale <- (ecoreg_list[[3]])[ecoreg_index[[3]],]  
train_escarp <- (ecoreg_list[[4]])[ecoreg_index[[4]],]  
train_sndhil <- (ecoreg_list[[5]])[ecoreg_index[[5]],]  
train_wrbadl <- (ecoreg_list[[6]])[ecoreg_index[[6]],]  
   
test_bhplat <- (ecoreg_list[[1]])[-ecoreg_index[[1]],]  
test_kptabl <- (ecoreg_list[[2]])[-ecoreg_index[[2]],]  
test_pshale <- (ecoreg_list[[3]])[-ecoreg_index[[3]],]  
test_escarp <- (ecoreg_list[[4]])[-ecoreg_index[[4]],]  
test_sndhil <- (ecoreg_list[[5]])[-ecoreg_index[[5]],]  
test_wrbadl <- (ecoreg_list[[6]])[-ecoreg_index[[6]],]  
  
# drop ecoreg and date from the list  
ecoreg_list <- lapply(ecoreg_list,  
                      function(x) select(x, -c(ecoreg2, date))  
                      )   
# create a list of models 
set.seed(seed)  
model_list <- purrr::map2(ecoreg_list, ecoreg_index,  
                          function(df, train_index)  {   
                            train(sci_val ~ ., df[train_index,],  
                                  method = 'glmnet',  
                                  trControl = reg.ctrl,  
                                  preProcess = c('nzv', 'center', 'scale'),  
                                  tuneGrid = expand.grid(  
                                    alpha = 1, 
                                    lambda = lambda)  
                                  )  
                            })  
  
rm(lambda, seed, reg.ctrl, ecoreg_index, ecoreg_list)   
  
``` 

<!-- might be able to drop these...
```{r old-tquant-lags-manual}

# Lag and Autocorrelation Analysis----  
# 1.0  group by station;  
# 2.0  use tq_mutate() to get lags 1:12 using lag.xts();   
# 2.1  provide column names for the new columns by prefixing “lag_” to   
#        the lag numbers, k, which the sequence from 1 to 12.   
# The output is all of the lags for each station.    
#start: 1989-10-15  -- need to fix gage  
#end: 2018-09-15  -- need to fix gage  

# Prepare variables for lags 1 through 12 (12 months of lags)====    
k <- 1:12  
col_names <- paste0("lag_", k)  
  

  
# Use tq_mutate() to get lags 1:12 using lag.xts()====    
sci_sta_lags <- sci_sta %>%  
# group_by is a key step!    
  group_by(sta, spi_length) %>%    
# run the lag vals by sta & spi_length  
    tq_mutate(  
        select     = spi_val,  
        mutate_fun = lag.xts,  
        k          = k,  
        col_rename = col_names  
    ) %>% 
  ungroup() %>% 
# gather the lagged values     
  rename(lag_0 = spi_val) %>%  
  gather(key = lag_length, 
         value = spi_val,  
         -c(sta,  
            spi_length,  
            date,  
            group,  
            min_date_sta,  
            max_date_sta)  
         ) %>%  
# convert lag_length to numeric
  mutate(lag_length = str_sub(lag_length, start = 5) %>% as.numeric) 

    
# clean up  
rm(k,  
   col_names    
   )  
  
```  

```{r time-series-correlation_join_spi_sci}
  
# The goal is to get the data and each lag side-by-side so we can do a 
#   correlation. 
# Correlating each of the lags to the “count” column involves steps (above)  
#   strung together in a dplyr pipe (%>%):  
# 1. Use gather() to pivot each lagged column into a “tidy” long-format df,   
#     and exclude columns: “sta”, “date” and other columns from the pivot.   
# 2. Convert the new “lag” column from a character string (e.g. “lag_1”)  
#     to numeric (e.g. 1) using mutate() to make ordering the lags easier.  
# 3. group the long data frame by type and lag to calculate subsets of  
#     package and lag.  
  
# join sta & gage====  
sci_all <- full_join(sci_sta, sci_gage,  
                     by = c("date", 
                            "group"))  %>%   
# drop unneeded check vars 
  select(-c(min_date_sta,  
            max_date_sta,  
            min_date_gage,  
            max_date_gage)  
         )  %>%  
# organize vars by y, x1, other data  
  select(sci_val,  
         ecoreg,  
         spi_val,  
         spi_length,  
         sci_length,  
         everything() 
         ) %>%    
  drop_na()    # short-term solution -- need to get dates coordinated  

#rm(sci_sta, 
#   gage_group  
#   )  
  
# check correlations at the station level - external controls ====     
sci_corr_sta <- sci_all %>%  
 # sta, gage, group - not need grouping vars
  group_by(gage, spi_length, sci_length) %>%  
  summarize(  
    cor = cor(x = spi_val,  
              y = sci_val,    
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup()  

# quick boxplot -- note the fal_hot gage is an outlier..
sci_corr_sta %>% 
  ggplot(aes(x = gage, y = cor)) + 
  geom_boxplot()  

# remove outlier station & clean up  
sci_clean <- sci_all %>%  
  filter(gage != "fal_hot")      # drop the low correlation outlier  

rm(sci_all,  
   sci_corr_sta,  
#   sci_gage,  
   sci_sta)  

# quick check 
sci_plot <- sci_clean %>% 
  gather(key = type, 
         value = length, 
         -c(ecoreg, spi_val, sci_val, sta, date, prcp, group, gage)) %>% 
  gather(key = sci_type, 
         value = index_val, 
         -c(ecoreg, type, length, sta, date, prcp, group, gage)) 

sci_plot %>% 
  ggplot(aes(x=date, y= index_val)) + 
  facet_grid(rows = vars(length), 
             cols = vars(sci_type), 
             scales = "free") + 
  geom_point() + 
  geom_smooth() 

sci_clean %>% 
 # filter(spi_length == 6) %>% 
  ggplot(aes(x=date, y=sci_val)) + 
  facet_wrap(vars(sci_length), 
             nrow = 2, 
             scales = "free") + 
  geom_point() + 
  geom_smooth() 
```   

```{r cross-correlation}
library(feasts)  
library(tsibble)

# make into a tsibble -- the key is 'gage' 
sci_dups <- sci_clean %>% 
  duplicates()  
  
as_tsibble(key = gage)  

```

```{r quick-try-for-controlling-vars-needs-work}
# next step is to apply an 80:20 split by spi_length  

# approach for linear mod ----  
data %>%
  group_by(dataset) %>% 
  nest() %>% 
  mutate(mod = map(data, ~lm(observation ~ estimate, data = .)),
         aug = map2(mod, data, ~augment_columns(.x, .y))) %>% 
  unnest(aug)

# apply model to 
sci_mod <- sci_all %>%
  group_by(sci_length) %>% 
  nest() %>% 
  mutate(mod = map(data, ~lm(sci_val ~ spi_val + spi_length, data = .)),
         aug = map2(mod, data, ~augment_columns(.x, .y))) %>% 
  unnest(aug)

```

```{r time_series_correlation} 
# Apply the correlation ----  
# 1. apply the correlation to each group of gages & stations by 
#      lags & spi_lengths.  The summarize() function can be used 
#      to implement cor(), which takes x = count and y = lag_value.   
#   Make sure to pass use = "pairwise.complete.obs", which is almost always   
#   desired.  
# 2. The 95% upper and lower cutoff can be approximated by: cutoff=±2 / N^0.5  
#      Where:  
#        N = number of observations.  

# check correlations at the station level - external controls ====     
sci_corr_sta <- sci_all %>%  
 # sta, gage, group - not need grouping vars
  group_by(gage, spi_length, sci_length, lag_length) %>%  
  summarize(  
    cor = cor(x = spi_val,  
              y = sci_val,    
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup() 

sci_corr_sta %>% 
  ggplot(aes(x = gage, y = cor)) + 
  geom_boxplot()  

# note the fal_hot gage is an outlier... 
  
# average at the ecoregion scale====     
sci_corr_ecoreg <- sci_all %>%  
  filter(gage != "fal_hot") %>%      # drop the low correlation outlier  
  group_by(ecoreg, spi_length, sci_length, lag_length) %>%   
  summarize(  
   cor = cor(x = spi_val,   
              y = sci_val,     
              use = "pairwise.complete.obs"),  
    cutoff_upper = 2/(n())^0.5,  
    cutoff_lower = -2/(n())^0.5  
  ) %>% 
  ungroup() 

sci_corr_ecoreg %>% 
  ggplot(aes(x = lag_length, y = cor)) + 
  facet_wrap(vars(ecoreg), 
             nrow = 2) + 
  geom_point()  + 
  geom_smooth()  
```  

```{r}
sci_corr_ecoreg %>%  
  ggplot(aes(x = lag_length, y = cor_mean)) + 
  facet_grid(cols = vars(ecoreg)) + 
  geom_point(aes(color = spi_length)) +  
  geom_smooth()  
```

```{r}

# pick the top correlations====   
#sci_corr <- sci_corr_all %>%   
#  group_by(sta, gage, group, ecoreg, spi_length) %>%  
#  summarize(  
#    corr = max(cor)
#    ) %>% 
#  ungroup()    

#sci_corr_join <- right_join(sci_corr_all, sci_corr, 
#                           by = c("cor" = "corr", 
#                                  "sta",  
#                                  "gage",  
#                                  "group", 
#                                  "ecoreg", 
#                                  "spi_length"))  




  
# Visualize the cross-correlations (not ready yet!) 
sci_sta_autocorrelations %>%  
    ggplot(aes(x = lag, 
               y = cor,
#               color = gage, 
               group = gage)) +  
    # Add horizontal line a y=0  
    geom_hline(yintercept = 0) +  
    # Plot autocorrelations  
    geom_point(size = 2) +  
    geom_segment(aes(xend = lag, yend = 0), size = 1) +  
    # Add cutoffs  
    geom_line(aes(y = cutoff_upper), color = "blue", linetype = 2) +  
    geom_line(aes(y = cutoff_lower), color = "blue", linetype = 2) +  
    # Add facets  
    facet_wrap(~ gage, ncol = 3) +  
    # Aesthetics  
    expand_limits(y = c(-0.5, 0.5)) +  
    scale_color_tq() +  
    theme_tq() +  
    labs(  
        title = paste0("Tidyverse ACF Plot: Lags ", rlang::expr_text(k)),  
        subtitle = "Appears to be a weekly pattern",  
        x = "Lags"  
    ) +  
    theme(  
        legend.position = "none",  
        axis.text.x = element_text(angle = 45, hjust = 1)  
    )  
  
# Get the absolute autocorrelations====  
# Verify the weekly pattern assessment by reviewing the absolute value of the  
#   correlations independent of package. We take the absolute autocorrelation   
#   because we use the magnitude as a proxy for how much explanatory value the   
#   lag provides.   
# Use dplyr functions to manipulate the data for visualization:  
# 1. drop the package group constraint using ungroup(),    
# 2. calculate the absolute correlation using mutate(),  
# 3. convert the lag to a factor, which helps with reordering the plot.  
# 4. Select() only the “lag” and “cor_abs” columns,    
# 5.  group by “lag” to lump all of the lags together -- to determine the  
#       trend independent of package.  
  
tidyverse_absolute_autocorrelations <- tidyverse_count_autocorrelations %>%  
    ungroup() %>%  
    mutate(  
        lag = as_factor(as.character(lag)),  
        cor_abs = abs(cor)  
        ) %>%  
    select(lag, cor_abs) %>%  
    group_by(lag)   
  
# Visualize the absolute correlations====  
# 1. Use a box plot that lumps each of the lags together. 
# 2. Add a line to indicate the presence of outliers at values above 1.5IQR  
#     If the values are consistently above the 1.5IQR limit, the lag can be  
#     considered an outlier. Note that we use the fct_reorder() function from  
#     forcats to organize the boxplot in order of decending magnitude.  

# Visualize boxplot of absolute autocorrelations   
break_point <- 1.5 * IQR(tidyverse_absolute_autocorrelations$cor_abs) %>%  
  signif(3)  
  
tidyverse_absolute_autocorrelations %>%    
    ggplot(aes(x = fct_reorder(lag, cor_abs, .desc = TRUE),  
               y = cor_abs)) +  
    # Add boxplot   
    geom_boxplot(color = palette_light()[[1]]) +  
    # Add horizontal line at outlier break point  
    geom_hline(yintercept = break_point, color = "red") +  
    annotate("text", label = paste0("Outlier Break Point = ", break_point),  
             x = 24.5, y = break_point + .03, color = "red") +  
    # Aesthetics  
    expand_limits(y = c(0, 1)) +  
    theme_tq() +  
    labs(  
        title = paste0("Absolute Autocorrelations: Lags ", 
                       rlang::expr_text(k)),  
        subtitle = "Weekly pattern is consistently above outlier break point",  
        x = "Lags"  
    ) +  
    theme(  
        legend.position = "none",  
        axis.text.x = element_text(angle = 45, hjust = 1)  
    )  
  
# outcome -- lags in multiples of seven have the highest autocorrelation  
#   and are consistently above the outlier break point indicating the presence  
#   of a strong weekly pattern. The autocorrelation with the seven-day lag is  
#   the highest, with a median of approximately 0.75. Lags 14, 21, and 28 are  
#   also outliers with median autocorrelations in excess of our outlier break  
#   point of 0.471.  
  
# Note -- the median of Lag 1 is essentially at the break point indicating  
#   that half of the packages have a presence of “abnormal” autocorrelation.  
#   However, this is not part of a seasonal pattern since a periodic frequency  
#   is not present.  
# In the case above, the tidyverse packages exhibit a strong weekly pattern.  
``` 

```{r old_code, eval=FALSE}

  
# prepare for plotting - reorganize flow by centroids====   
mclust_aug_means <- mclust_aug %>%  
  group_by(.class) %>%  
  summarize(#q1_flow = mean(q1_mon),  # these are ~equal to mclust_means  
            #q7_flow = mean(q7_mon),  
            #q30_flow = mean(q30_mon),  
            mean.PC1_mon = mean(PC1_mon),  
            mean.PC2_mon = mean(PC2_mon), 
            size = n()  
            ) %>%  
  ungroup()  
  
mclust_means <- full_join(mclust_means, mclust_aug_means,  
                  by = c("size",  
                         ".class")  
                  ) %>%  
# reorganize columns  
  select(.class,  
         flow_type,  
         size,  
         proportion,  
         everything()  
         )  
  
# join flow_type to tidy cluster model & clean up global environment====  
mclust_aug <- full_join(mclust_aug, mclust_means,  
                     by = c(".class")  
                     ) %>%  
  group_by(.class, ecoreg) %>%  
  mutate(q1 = mean(q1_mon)) %>%  
  mutate(q7_eco = mean(q7_mon)) %>%  
  mutate(q30_eco = mean(q30_mon))  %>%  
  mutate(PC1_eco = mean(PC1_mon)) %>%  
  mutate(PC2_eco = mean(PC2_mon)) %>%  
  ungroup() %>%  
  mutate(flow_type = as.factor(flow_type)) %>%  
# change the order of facets #  
  mutate(ecoreg = factor(ecoreg,  
                         levels = c('Pierre Shale Plains',  
                                    'Pine Ridge Escarpment',  
                                    'White River Badlands',  
                                    'Black Hills Plateau',  
                                    'Keya Paha Tablelands',  
                                    'Sand Hills')  
                         )  
         )  
  
# get proportions of different flow types by ecoregion  
mclust_prop <- mclust_aug %>%  
  group_by(ecoreg, flow_type) %>%  
  summarize(count = n()) %>%  
  group_by(ecoreg) %>%  
  mutate(count2 = sum(count)) %>%  
  ungroup() %>%  
  mutate(proportion_ecoreg = count/count2)  %>%  
  select(-c(count, count2))  
  
mclust_aug <- full_join(mclust_aug, mclust_prop,   
                         by = c("ecoreg", "flow_type"))  
  
# check results -- sample cluster plot====  
factoextra::fviz_mclust(mod,  
                          "classification",  
                          geom = "point",  
                          ellipse.type = "t",  
                          ellipse.level = 0.7,  
                          pointsize = 1.5,  
                          palatte = "npg"  
                          )  
  
# clean up global environment  
rm(clust_input,  
   BIC,  
   mclust_aug_means,  
   mclust_prop  
   )  
   
```

```{r ci_result_table, eval=FALSE}  

# get mean precipitation 
prcp <- spi_fin %>%  
  group_by(group) %>%  
  summarise(prcp = mean(prcp)) %>% 
  ungroup() 

rap_bef <- prcp %>% 
  filter(group == "RAP<1989") %>% 
  select(-group) %>% 
  as.double()

# pluck results for summary tables & bind====
prcp_results <- prcp_dabest %>% 
  pluck("result") %>% 
  select(-c(func,  
            paired,  
            variable,  
            bootstraps,  
            nboots,  
            pct_ci_low,  
            pct_ci_high  
  )  
  )   

prcp_results <- full_join(prcp_results, prcp, 
                  by = c("test_group" = "group")  
                  ) %>% 
  filter(test_group != "RAP<1989") %>% 
  mutate(control_group = case_when(  
    is.na(control_group) ~ "RAP<1989",  
    TRUE ~ control_group  
    )
  ) %>%  
  mutate(difference = case_when(  
    is.na(difference) ~ prcp - rap_bef,  
    TRUE ~ difference  
    )
  ) %>% 
  mutate(ci = as.integer(ci))  %>% 
  mutate_if(is.numeric, round, digits = 0)  


# convert tibble to a flextable after fixing vars for presentation==== 
prcp_table <- prcp_table %>% 
  flextable() %>% 
  #  colformat_num(col_keys = col_key_num, 
  #                big.mark=",", 
  #                digits = 1, na_str = "N/A") %>% 
  set_header_labels(control_group = "Control Group", 
                    test_group = "Test Groups", 
                    control_size = "Control Size",
                    test_size = "Test Size", 
                    func = "Test Statistic", 
                    variable = "Variable",
                    difference = "Mean Difference", 
                    ci = "CI", 
                    bca_ci_low = "Lower Limit", 
                    bca_ci_high = "Upper Limit") %>% 
  autofit() %>% 
  align(., part = "all", align = "center") %>% 
  theme_booktabs() 


ci_table2 <- read_docx() %>% 
  body_add_flextable(value = ci_table)   
  
print(ci_table2, target = "output/ci_table.docx") 
  
rm(ci_results_pc1, ci_results_pc2, ci_table2, ci_table) 
  
```  
-->

