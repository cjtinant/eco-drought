---
title: "stream_data_munging"
author: "Charles Jason Tinant"
date: "4/11/2018"
output: pdf_document
---

# Next STEPS
1. blc_wan <- readNWISDaily("06446700") # this not working!
Reached out to Joyce Williamson 2019-03-18

2. Check on next steps from Chapter 2 list 


# Someday Maybe
USGS 06447050 UNNAMED TRIB BUZZARD CREEK NR LONG VALLEY, SD -instant meas
https://nwis.waterdata.usgs.gov/usa/nwis/qwdata/?huc_cd=10140202&format=station_list&sort_key=site_no&index_pmcode_00065=3&index_pmcode_00060=4&index_pmcode_00062=5&index_pmcode_72020=6&sort_key=site_no&group_key=county_cd&sitefile_output_format=station_list

## Variable naming convention:   
  for USGS functions: EGRET & dataRetrieval:
startDate    Beginning date for downloading USGS gage data
endDate      End date for downloading USGS gage data
parameter_cd USGS parameter codes

xxx_yyy      individual gage names xxx = stream & yyy = location

gage         USGS streamgage station 
  _cont      set of active gages 
  _disc      set of discontinued gages   
  _othr      set of gages not found in initial analysis 

  _full      equals {_cont + _disc + _othr}; 741,215 obs for 61 sta 
  _drp#      observations sequentially dropped from _full
  _fin#      equals {_full} - {_drp#} 

  _meta      metadata  
  _incomp    temporary variable to find station-years w/ incomp data 
  _mdp#      gages sequentially dropped from _meta
  _met#      equals {_meta} - {_mdp#} 
  _yr        temporary variable to calculate years of stations
 
 for filtering original set of gages 
  _ltxx      less than year xx
  _comp      complete {post-1990}
  _incomp    incomplete
  _res       within the Pine Ridge Reservation administrative boundary

check_sta    check variable 


-->

```{r setup, include=FALSE, message=FALSE}  
#knitr::opts_chunk$set(echo = FALSE)  
options(tibble.print_max = 70) # sets tibble output for printing  

# Sets up the library of packages   
library("here") # identifies where to save work  
library("EGRET") # Exploration and Graphics for RivEr Trends 
library("rio") # more robust I/O - to import and clean data  
library("lubridate") # easier dates 
library("tidyverse") 
library("janitor") # tools for examining and cleaning dirty data  
library("dataRetrieval") # USGS data import  

#library("cowplot") # Streamlined plot theme & annotations 
# library("drake") # gen.purpose computational engine for data analys
# library("DataExplorer") # quick look at NA vals 
# library('jsonlite') # tools for working with lists   
# library("magrittr") # provides aliases for easier reading 
# library("friendlyeval") 
#gage_cont <- import(file = "data/gage_cont.csv")

```

```{r import_daily_flow_active, eval=FALSE} 

# Loads USGS gage data for active stations individually, bind_cols & 
# exports data to a folder.  Gage IDs identified by USGS watermapper.  
# The data needs to be saved as two smaller files to be uploaded on GitHub.
# 
#   Egret::readNWISDaily(siteNumber, parameterCd = "00060", startDate = "",
#      endDate = "", interactive = TRUE, convert = TRUE) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 1. create a list of gages
# add an end date to remove provisional data & gaps in vals
startDate    <- "" # blank gets earliest date
endDate      <- "2017-09-30"
parameter_cd <- "00060" 
# ~~~~~~~~~~~~~~~~~~~~~ 

gage_cont_top_nm <-  tibble(sta = c("bad_mid", "bat_bhr", "brsf_co", "blp_bel", 
                                 "bev_buf", "bev_pri","che_red", "che_sce", 
                                 "hat_edg","hor_oel", "lcr_bel", 
                                 "lcr_vet", "lwr_mar", "lwr_ros"),  
                  site_no = c("06441000", "06406500", "06402500", "06402430", 
                              "06447230", "06440200", "06402600", "06403700", 
                              "06408650", "06423500", "06400000", 
                              "06400875", "06449000", "06449100"))  

gage_cont_bot_nm <-  tibble(sta = c("lwr_whi", "rap_far", "wcc_ogl", "whi_int", 
                                 "whi_kad", "whi_ogl", "whi_slm", "whi_sta", 
                                 "whi_whi", "wkc_wok", "che_buf", "che_was", 
                                 "whi_roc"), 
                  site_no = c("06447500", "06449500", "06450500", "06421500", 
                              "06445980", "06446100", "06446500", "06447000", 
                              "06446000", "06446200", "06445700", "06445685",
                              "06447450")) 


# 2. get flow data from USGS using purrr:map
gage_cont_top <- gage_cont_top_nm %>% 
  split(.$site_no)  %>% # from base R
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                      parameter_cd, startDate, endDate), .id = "site_no") 

gage_cont_bot <- gage_cont_bot_nm %>% 
  split(.$site_no)  %>% # from base R
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                      parameter_cd, startDate, endDate), .id = "site_no") 

# 3. add short-names to dataframe
gage_cont_top <- full_join(gage_cont_top_nm, gage_cont_top) 

# this removes some bad data at the start:
fal_hot <- readNWISDaily("06402000", parameter_cd, "1947-06-01", endDate,
                         convert = TRUE) %>% 
  mutate(sta = "fal_hot") %>% 
  mutate(site_no = "06402000") 

gage_cont_top <- rbind(gage_cont_top, fal_hot)
rm(fal_hot)

# export daily flows to data folder
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
export(gage_cont_top, "data/gage_cont_top.csv") 
export(gage_cont_bot, "data/gage_cont_bot.csv") 

# 4. bind top and bottom data & create a summary
gage_cont <- bind_rows(gage_cont_top, gage_cont_bot)  

rm(gage_cont_top, gage_cont_bot)  

gage_summary_cont <- gage_cont %>% 
  group_by(sta) %>% 
  summarize(site_no = first(site_no)) %>% 
  mutate(type = "active") 
```



```{r import_daily_flow_discontinued_EGRET, eval=FALSE} 
# 1. load individual gages
gage_disc_nm <-  tibble(sta = c("ant_gor",  "brnf_ph",  "bea_eli", "bev_abf", 
                                "bor_cha", "cas_hot", "che_hot", "hor_aoe", 
                                "lcr_abv", "lwr_abv", "min_kil", "nio_abb", 
                                "nio_bbb", "nio_col", "nio_cod", "nio_dun", 
                                "nio_hay", "rap_cre", "ros_ros", "sna_bur", 
                                "sna_dou", "sna_mer", "spr_stf", "whi_cha", 
                                "whi_cra", "whi_wht"), 
                  site_no = c("06458000", "06440500", "06458500", "06402470", 
                              "06445590", "06400497", "06400500", "06400870", 
                              "06448000", "06449300", "06460900", "06454500", 
                              "06455500", "06457000", "06459000", "06455900", 
                              "06456500", "06422000", "06449400", "06459500", 
                              "06459175", "06459200", "06449250", "06445500", 
                              "06444000", "06445000")) 

# 2. get flow data from USGS using purrr:map
gage_disc <- gage_disc_nm %>% 
  split(.$site_no)  %>% # from base R
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                      parameter_cd, startDate, endDate), .id = "site_no") 

# 3. add short-names to dataframe
gage_disc <- full_join(gage_disc_nm, gage_disc) 

# this removes some bad data at the start:
fre_fai <- readNWISDaily("06403500", parameter_cd, "1946-01-14", endDate) %>%
  mutate(sta = "fre_fai") %>% 
  mutate(site_no = "06403500") 

gage_disc <- rbind(gage_disc, fre_fai)
rm(fre_fai)

# export daily flows to data folder
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
export(gage_disc, "data/gage_disc.csv") 

# summarize & join
gage_summary_disc <- gage_disc %>% 
  group_by(sta) %>% 
  summarize(site_no = first(site_no)) %>% 
  mutate(type = "discontinued")
```










# List of possible extra sites - list was iteratively constructed
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# A tibble: 6 x 2
#   sta     site_no station_nm                                   
# * <chr>     <int> <chr>          
#1 che_ang 06401500 CHEYENNE R BELOW ANGOSTURA DAM,SD
#2 frn_fai 06403300 FRENCH CR ABOVE FAIRBURN SD      
#3 bat_key 06404000 BATTLE CR NEAR KEYSTONE,SD       
#4 bat_bhr 06406000 BATTLE CR AT HERMOSA,SD          
#5 spr_her 06408500 SPRING CR NEAR HERMOSA,SD        
#6 nio_gor 06457500 NIOBRARA RIVER NEAR GORDON, NEBR.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# this is what was done to find the stations above: 


```{r import_daily_flow_overlooked, eval=FALSE} 

# this code chunk checks for "missed" stations.  
# for filtering info see: https://help.waterdata.usgs.gov/site_tp_cd
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 1. join gage summary data 
gage_summary <- bind_rows(gage_summary_cont, gage_summary_disc) 

rm(gage_summary_cont, gage_summary_disc) 

# 1. find other possible sites by bounding box 
# bBox = acontiguous range of decimal latitude and longitude, starting with the west longitude, then the south latitude, then the east longitude, and then the north latitude with each value separated by a comma. 
# https://waterservices.usgs.gov/rest/Site-Service.html#bBox 
# the Pine Ridge Reservation boundary is c(-103, 43, -100, 43.7)

poss_sites <- whatNWISsites(bBox = c(-103.5, 42.5, -99.5, 44.2), 
                       parameterCd = "00060", hasDataTypeCd = "dv") 

# 2. remove sites we already collected
poss_sites <- anti_join(poss_sites, gage_summary, by = "site_no") 


# 3. remove karstic & crystaline sites & sites with upstream control
poss_sites <- poss_sites %>% 
  filter(!str_detect(station_nm, 
                     'BOXELDER|CUSTER|KEYSTONE|CLEGHORN|DAM|DITCH|LIME|DRAIN')) 




# create short-names 
gage_other <- poss_sites %>% 
  select(site_no, station_nm) %>% 
  arrange(station_nm)


gage_other <- gage_disc_nm %>% 
  split(.$site_no)  %>% # from base R
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                      parameter_cd, startDate, endDate), .id = "site_no") 


test <- poss_sites %>%
  split(.$site_no)  %>% # from base R
  map(~ readNWISDaily(siteNumber = .$site_no, parameter_cd, startDate ,endDate))  
        
        
        
        lm(mpg ~ wt, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared")

test2 <- mtcars %>%
  split(.$cyl) #%>% # from base R
  

map(~ lm(mpg ~ wt, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared")


# g. clean dataframe to fit the area
gages_pot <- gages_dv %>% 
  mutate(alt_va = as.numeric(alt_va)) %>% 
  filter(count_nu > 365*5) %>%
  filter(dec_lat_va < 43.97) %>% 
  filter(dec_long_va > -103.58825) %>% 
  filter(dec_long_va < -100.55167) %>% 
  filter(alt_va < 4050) %>% 
  mutate(end_date = ymd(end_date)) %>% 
  mutate(end_yr = year(end_date)) %>% 
  filter(end_yr > 1990)

# bind new and old metadata cols together to check
gages_pot_list <- gages_pot %>% 
  select(site_no, station_nm) %>% 
  mutate(site_no = as.integer(site_no))
gages_exist <- gage_meta %>% 
    select(site_no, station_nm) 

gages_new <- full_join(gages_pot_list, gages_exist, by = "site_no") 
gages_new <- gages_new %>% 
  filter(is.na(station_nm.y)) %>% 
  rename(station_nm = station_nm.x) %>% 
  select(-station_nm.y) %>% 
  as.tibble() 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 1. load individual gages
# ~~~~~~~~~~~~~~~~~~~~~~~~~
# add an end date to remove provisional data & gaps in vals
startDate    <- "" #Gets earliest date
endDate      <- "2017-09-30"
parameter_cd <- "00060" 
# ~~~~~~~~~~~~~~~~~~~~~ 
bat_bhr <- readNWISDaily("06406000", parameter_cd, startDate ,endDate) 
bat_key <- readNWISDaily("06404000", parameter_cd, startDate ,endDate) 
che_ang <- readNWISDaily("06401500", parameter_cd, startDate ,endDate)
frn_fai <- readNWISDaily("06403300", parameter_cd, startDate ,endDate) 
nio_gor <- readNWISDaily("06457500", parameter_cd, startDate ,endDate) 
spr_her <- readNWISDaily("06408500", parameter_cd, startDate ,endDate)  

# 2. add short name and abbreviation to gage data 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

bat_bhr <- bat_bhr %>% 
  mutate(sta = "bat_her") %>%
  mutate(site_no = "6406000") 

bat_key <- bat_key %>% 
  mutate(sta = "bat_key") %>%
  mutate(site_no = "6404000") 

che_ang <- che_ang  %>% 
  mutate(sta = "che_ang") %>%
  mutate(site_no = "6401500")

frn_fai <- frn_fai %>% 
  mutate(sta = "frn_fai") %>%
  mutate(site_no = "6403300") 

nio_gor <- nio_gor %>% 
  mutate(sta = "nio_gor") %>%
  mutate(site_no = "6457500") 

spr_her <- spr_her %>% 
  mutate(sta = "spr_her") %>%
  mutate(site_no = "6408500")

# 3. join together in long format
# Next step: probably could be done more efficiently with map_df()
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_other  <- bind_rows(bat_bhr, che_ang, frn_fai, nio_gor, spr_her) 

# export daily flows to data folder
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
export(gage_other, "data/gage_other.csv") 

# summarize & join
gage_other_summary <- gage_other %>% 
  group_by(sta) %>% 
  summarize(site_no = first(site_no)) %>% 
  mutate(type = "other)

``` 

```{r import_dailyflow_EGRET-bearLodge, eval=FALSE}
# long story, but Bear in the Lodge streamflow is restricted.  So,
# need to find another approach to getting the data. 
# one way is annual reports - but only to 2013
# Need to email the webmaster to get streamflow data.
# https://waterdata.usgs.gov/sd/nwis/inventory/?site_no=06446700&agency_cd= 

#blc_wan <- readNWISDaily("06446700") # this not working! 
#blc_wan <- blc_wan %>%
#  mutate(sta = blc_wan) %>%
#  mutate(site_no = "06446700")

```

```{r import_gage_metadata, eval=FALSE} 
  
# import daily streamflow datasets  
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#gage_cont_top <- import("data/gage_cont_top.csv") 
#gage_disc <- import("data/gage_disc.csv") 
#gage_othr <- import("data/gage_other.csv") 
 
# check for duplicate data  
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_cont_ck  <- gage_cont %>% 
  distinct(sta, site_no) 

gage_dist_ck  <- gage_disc %>% 
  distinct(sta, site_no) 

gage_othr_ck  <- gage_othr %>% 
  distinct(sta, site_no) 

gage_names <- bind_rows(gage_cont_ck, gage_dist_ck) 
gage_names <- bind_rows(gage_names, gage_othr_ck) 

rm(gage_cont_ck, gage_dist_ck, gage_othr_ck) 

# join data & import metadata 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

gage_full  <- bind_rows(gage_cont, gage_disc)  
gage_full  <- bind_rows(gage_full, gage_othr) 

# gage$site_no is brought in as an integer but needs to be 8-dig char 
gage_full <- gage_full %>% 
  mutate(sta = as.character(sta)) %>%  
  mutate(site_no = zeroPad(site_no, 8)) %>% 
  select(site_no, sta, everything()) 

# reduces the set down to a small number to reduce API calls 
gage_id <- gage_full %>% 
  distinct(site_no, sta) 

# iterate across a list of gage ids by purrr::map  
# & get gage metadata using dataRetrieval::readNWISsite 
gage_meta_list <- map(gage_id$site_no, readNWISsite) 

# extract the wanted dataframe items from the list 

gage_meta <- gage_meta_list %>% 
  map_df(rbind, 
               c("site_no", "station_nm", "site_tp_cd", "dec_lat_va", 
                 "dec_long_va", "dec_coord_datum_cd", "state_cd", 
                 "county_cd", "alt_va", "alt_datum_cd", "huc_cd", 
                 "drain_area_va", "contrib_drain_area_va")) 

# and clean up
gage_meta <- gage_meta %>% 
  filter(agency_cd == "USGS") %>% 
  select(-agency_cd)  %>% 
  select(-country_cd) %>% 
  select(-(site_tp_cd:long_va)) %>% 
  select(-(coord_meth_cd:coord_acy_cd)) %>% 
  select(-district_cd) %>% 
  select(-(map_nm:map_scale_fc)) %>% 
  select(-(alt_meth_cd:alt_acy_va)) %>% 
  select(-(basin_cd:inventory_dt)) %>% 
  select(-(tz_cd:project_no)) %>% 
  select(dec_lat_va, dec_long_va, alt_va, drain_area_va, 
         contrib_drain_area_va, state_cd, county_cd, huc_cd,
         land_net_ds, everything()) %>% 
  select(station_nm, site_no, everything()) %>% 
  mutate(dec_lat_va = as.numeric(dec_lat_va)) %>% 
  mutate(dec_long_va = as.numeric(dec_long_va)) %>%   
  mutate(alt_va = as.numeric(alt_va)) %>%   
  mutate(drain_area_va = as.numeric(drain_area_va)) %>%  
  mutate(contrib_drain_area_va = as.numeric(contrib_drain_area_va)) %>% 
  mutate(contrib_drain_area_va = as.numeric(contrib_drain_area_va)) 

rm(gage_meta_list) 

# join the abbreviation to the metadata 
gage_meta <- gage_meta %>%  
  full_join(gage_id, gage_meta, by = "site_no") 

gage_meta <- gage_meta %>% 
  select(sta, everything()) 

# check on integrity of the data by looking at counts 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
ck_sta <- gage_meta %>% 
  distinct(sta) 

ck_num <- gage_meta %>% 
  distinct(site_no) 

ck_sta_num <- gage_meta %>% 
  distinct(sta, site_no) 

ck_nam <- gage_meta %>% 
  distinct(station_nm) 

ck_sta_nam <- gage_meta %>% 
  distinct(sta, station_nm) 

num_nam <- gage_meta %>% 
  distinct(site_no, station_nm) 

ck_sta_nam_num <- gage_meta %>% 
  distinct(sta, site_no, station_nm) 

# export dataframes of the largest population of gages 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# export(gage, "data/gage_full.csv") # too big for GitHub 
# export(gage_meta, "data/gage_meta_full.csv")  

# create a table to show abbreviation, site no & station name 
gage_table <- gage_meta %>% 
  select(sta, site_no, station_nm) %>% 
  as.tibble() 


```

```{r clean_daily flow} 
# this code chunk checks and removes gages w/o useful characteristics
#   for future analysis 
# This code is a refactor of prior code above, some of it broken
# 
# Steps: 
# 1. Assemble a full dataset (N = 61 stations; 741,215 obs)
# 2. Remove streams prior to 1990 from the analysis series 
#      (N = 19 stations, 103,465 obs) 
# 3. Remove streams with substantial missing data 
# 4. Investigate remaining stations 

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 1. Assemble a set of all possible recorded streamflows----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_meta_full <- import("data/gage_meta_full.csv") %>% 
  arrange(sta) 

gage_cont <- import("data/gage_cont.csv") 
gage_disc <- import("data/gage_disc.csv") 
gage_othr <- import("data/gage_other.csv") 

# Assemble a complete set of stations identifed in prior steps
gage_full  <- bind_rows(gage_cont, gage_disc, gage_othr)  

gage_full <- gage_full %>% 
  arrange(sta) %>% 
  select(site_no, sta, Date, i, everything()) 

# check results - should be 61 stations; yes
check_sta <- gage_full %>% 
  distinct(sta)
rm(gage_cont, gage_disc, gage_othr, check_sta)  

# calculate the minimun and maximum years in the series in metadata
gage_yr <- gage_full %>% 
  group_by(sta) %>% 
  summarize(min_yr = min(waterYear), 
            max_yr = max(waterYear)) %>% 
  mutate(count_yr = 1 + max_yr - min_yr)

gage_meta_full <- full_join(gage_meta_full, gage_yr, by = "sta")

gage_meta_full <- gage_meta_full %>% 
  arrange(count_yr) %>% 
#  select(-c(site_tp_cd, dec_coord_datum_cd, alt_datum_cd, huc_cd)) %>% 
   as.tibble() %>% 
   select(count_yr, everything())

# join together gage & gage metadata information
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_full <- full_join(gage_meta_full, gage_full, by = c("site_no", 
                                                         "sta"))
rm(gage_yr)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 2. Remove streams prior to 1990 from the analysis series----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# identify old stations (<1990): n = 17 stations
gage_meta_drop <- gage_meta_full %>% 
  filter(max_yr < 1990) 

# identify stations for analysis: n = 44 stations; 17 + 44 = 61
gage_meta <- gage_meta_full %>% 
  filter(max_yr > 1989) # 44 sta

gage <- gage_full %>% 
    filter(max_yr > 1989) # 670,492 

gage_drop <- gage_full %>% 
  filter(max_yr <= 1988)  #  70,723

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3. Remove streams with substantial missing data----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Identify serially incomplete observations 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_incomp <- gage %>% 
  group_by(sta, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(sta, waterYear, i_count) 

# 18 stations post-1990n are incomplete; two stations 
#   (bad_mid & chr_ang) have many incomplete years

# gage_incomp 
# A tibble: 62 x 3 - redacted & includes a note 
#   sta     waterYear i_count  note
#   <chr>       <int>   <int> <mine>
#  1 bad_mid      1991      28  most years incomplete; remove
# 17 bad_mid      2017       4
# 23 chr_ang      1991     181  most years incomplete; remove
#  7 chr_ang      2017     181

# remove stations with many incomplete years 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
drop_sta <- gage_meta %>% 
   filter(sta == "bad_mid" |    
           sta == "chr_ang"
         ) # 2 sta

gage_meta_drop <- bind_rows(gage_meta_drop, drop_sta) # 17 + 2 = 19 sta
  
gage_meta <- gage_meta %>% 
  filter(sta != "bad_mid" &  
           sta != "chr_ang"
         ) %>% 
  arrange(min_yr) %>% 
  select(sta, min_yr, max_yr, count_yr, everything()) # 44 - 2 = 42 sta

# remove observations with many incomplete years
drop_obs <- gage %>% 
  filter(sta == "bad_mid" |   
           sta == "chr_ang"
         ) # 32,742 obs

gage_drop <- bind_rows(gage_drop, drop_obs) # 70,723 + 32,742 = 103,465

gage <- gage %>% 
  filter(sta != "bad_mid" &  
           sta != "chr_ang"
         ) %>% 
  arrange(min_yr) %>% 
  select(sta, min_yr, max_yr, count_yr, everything()) 
# 670,492 - 32,742 = 637,750

rm(drop_sta, drop_obs, gage_incomp, gage_full, gage_drop, 
   gage_meta_drop, gage_meta_full) 

# quick check of the geology of watersheds

chk_sta <- gage_meta %>% 
  select(sta, station_nm) %>% 
  arrange(sta)

#chk_sta  # shows the watershed general type if not sedimentarty
# A tibble: 42 x 2 
#   sta     station_nm                                   
#   <chr>   <chr>                                         
# 1 bat_bhr BATTLE CR BELOW HERMOSA,SD                   
# 2 bat_her BATTLE CR AT HERMOSA,SD                      
# 3 bat_key BATTLE CR NEAR KEYSTONE,SD                   * igneous  
# 4 bev_abf BEAVER CREEK ABOVE BUFFALO GAP, SD           
# 5 bev_buf BEAVER CR NEAR BUFFALO GAP,SD                
# 6 bev_pri BEAVER CREEK NEAR PRINGLE, SD                
# 7 blp_bel BLACK PIPE CREEK NR BELVIDERE, SD            
# 8 brsf_co SOUTH FORK BAD R NEAR COTTONWOOD,SD          
# 9 cas_hot CASCADE SPRINGS NEAR HOT SPRINGS SD          
#10 che_buf CHEYENNE R NEAR BUFFALO GAP SD               
#11 che_red CHEYENNE RIVER AT RED SHIRT, SD              
#12 che_sce CHEYENNE RIVER NEAR SCENIC, SD               
#13 che_was CHEYENNE RIVER NEAR WASTA, SD                
#14 fal_hot FALL R AT HOT SPRINGS,SD                     
#15 frn_fai FRENCH CR ABOVE FAIRBURN SD                  
#16 hat_edg HAT CR NEAR EDGEMONT,SD                      
#17 hor_oel HORSEHEAD CR AT OELRICHS,SD                  
#18 lcr_abv LAKE CR ABOVE REFUGE NEAR TUTHILL,SD         
#19 lcr_bel LAKE CR BELOW REFUGE NEAR TUTHILL,SD         
#20 lcr_vet LITTLE WHITE R NEAR VETAL,SD                 
#21 lwr_abv LITTLE WHITE R ABV ROSEBUD SD                
#22 lwr_mar LITTLE WHITE R NEAR MARTIN,SD                
#23 lwr_ros LITTLE WHITE R NEAR ROSEBUD SD               
#24 lwr_whi LITTLE WHITE R BELOW WHITE RIVER,SD          
#25 nio_abb NIOBRARA RIVER ABOVE BOX BUTTE RESERVOIR, NE  
#26 nio_bbb NIOBRARA RIVER BELOW BOX BUTTE RESERVOIR NEBR 
#27 nio_gor NIOBRARA RIVER NEAR GORDON, NEBR.            
#28 rap_cre RAPID CR AT CRESTON SD                       
#29 rap_far RAPID CR NEAR FARMINGDALE,SD                 
#30 ros_ros ROSEBUD CR AT ROSEBUD SD                     
#31 sna_bur SNAKE RIVER NEAR BURGE, NEBR.                
#32 sna_dou SNAKE R AT DOUGHBOY, NE                      
#33 spr_her SPRING CR NEAR HERMOSA,SD                    
#34 wcc_ogl WHITE CLAY CR NEAR OGLALA SD                 
#35 whi_cra White River at Crawford, Nebr.               
#36 whi_int WHITE R NEAR INTERIOR,SD                      
#37 whi_kad WHITE R NEAR KADOKA,SD                       
#38 whi_ogl WHITE R NEAR OGLALA SD                       
#39 whi_slm WHITE RIVER AT SLIM BUTTE, SD                
#40 whi_sta WHITE R NR NE-SD STATE LINE                  
#41 whi_whi WHITE RIVER NEAR WHITE RIVER, SD             
#42 wkc_wok WOUNDED KNEE CREEK AT WOUNDED KNEE, SD    

# remove igneous PreCambrian station from analysis----
gage <- gage %>% 
  filter(sta != "bat_key")             # obs  from 637,750 -> 616,525 

gage_meta <- gage_meta %>% 
  filter(sta != "bat_key")             # gage from      42 ->      41 

rm(chk_sta)
```

```{r create_post1980_subset}
# This code chunk subsets gages with 1990+ observations for clustering.
# Note - using water year (10-01) as start of year... 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Original Gages; gage_full       = 61 gages & 741,215 obs  
#      Gages w/o 1980+ or missing data = 19 gages & 103,465 (dropped) 
#   Gages remaining; gage           = 42 gages & 637,750 obs 
#      Gages with PreC geology      =  1 gage &   21,225 obs (dropped)
#   Gages remaining; gage           = 41 gages & 616,525 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages pre-1980; gage_lt80       = 29 gages & 255,068 obs 
#   Gages remaining; gage           = 42 gages & 361,457 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#   Remove gages w/o full yrs       =  1 gage  &     363 obs
#   Gages remaining; gage           = 40 gages & 361,094 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#   Identify reservation gages     = 14 gages 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

 
# 1. filter pre-1980 gages---- 
gage_lt80_meta <- gage_meta %>% 
  filter(min_yr < 1979) # 29 gages 

gage_lt80 <- gage %>% 
  filter(min_yr <= 1979) %>%                        # waterYear 1980
  filter(Date < "1979-10-01")                       #  255,068 obs  

# remove pre-1980 observations    
gage <- gage %>% 
  filter(Date >= "1979-10-01")                      #  361,457 obs 

# export observations
export(gage_lt80, "data/gage_lt80.csv") 
export(gage_lt80_meta, "data/gage_lt80_meta.csv") 

rm(gage_lt80, gage_lt80_meta)


# 2. remove post-1990 stations w/o full years----

gage_comp <- gage %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n >= 364) %>%
  group_by(sta) %>%
  count() %>% 
  ungroup() %>% 
  rename(yrs_post80 = nn) %>% 
  arrange(yrs_post80)

check_sta <- anti_join(gage, gage_comp, by = "sta")
# this shows rap_cre should be dropped   

# update stations by dropping rap_cre
gage_meta <- semi_join(gage_meta, gage_comp, by = "sta")     # 40 sta
gage      <- semi_join(gage, gage_comp)                 # 361,094 obs

rm(check_sta) 

# 3. Investigate remaining stations----
gage_incomp <- gage %>% 
  group_by(sta, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(i_count, waterYear, sta) 

# filter set of Reservation stations
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_res <- gage_meta %>% 
  filter(state_cd == 46) %>% 
  filter(county_cd == 7 | 
           county_cd == 71 |
           county_cd == 95 |
           county_cd == 102
  ) %>% 
  select(min_yr, max_yr, sta)

# join post-90 reservation stations 
gage_res <- left_join(gage_comp, gage_res, by = "sta") 

gage_res <- gage_res %>% 
  arrange(max_yr, yrs_post80) 

rm(gage_comp, gage_incomp) 

# The table below is the 13 stations on the reservation, which are 
# shown with min & max year and the other stations in the region) 

# gage_res 
# A tibble: 41 x 4
#   sta     yrs_post80 min_yr max_yr
#   <chr>        <int>  <dbl>  <dbl>
# 1 wkc_wok          5   1992   1997
# 2 whi_slm          6   1962   1997
# 3 wcc_ogl         14   1966   1999
# 4 lcr_abv         19   1938   2016
# 5 whi_int         15   1929   2017
# 6 blp_bel         25   1992   2017
# 7 brsf_co         29   1989   2017
# 8 whi_sta         30   1988   2017
# 9 lcr_bel         38   1939   2017
#10 lcr_vet         38   1959   2017
#11 lwr_mar         38   1938   2017
#12 lwr_whi         38   1950   2017
#13 whi_kad         38   1942   2017
#14 whi_ogl         38   1943   2017
#15 bev_abf          7     NA     NA
#16 che_sce         10     NA     NA
#17 che_buf         11     NA     NA
#18 nio_bbb         12     NA     NA
#19 nio_gor         12     NA     NA
#20 sna_dou         13     NA     NA
#21 whi_cra         13     NA     NA
#22 nio_abb         15     NA     NA
#23 sna_bur         15     NA     NA
#24 cas_hot         16     NA     NA
#25 whi_whi         16     NA     NA
#26 lwr_abv         18     NA     NA
#27 ros_ros         18     NA     NA
#28 che_red         19     NA     NA
#29 spr_her         25     NA     NA
#30 bev_pri         26     NA     NA
#31 bat_bhr         29     NA     NA
#32 hor_oel         34     NA     NA
#33 frn_fai         35     NA     NA
#34 rap_far         37     NA     NA
#35 bat_her         38     NA     NA
#36 bat_key         38     NA     NA
#37 bev_buf         38     NA     NA
#38 che_was         38     NA     NA
#39 fal_hot         38     NA     NA
#40 hat_edg         38     NA     NA
#41 lwr_ros         38     NA     NA

# wkc-wok is 1993-1998 - so first clustering is over these dates 
#   to identify a group for wkc-wok to estimate streamflows 


```

```{r create_9398_subset}
# This code chunk creates a cluster for wkc_wok active years
# Notes: Use water year Oct1-Sept31, w/ year on the majority of months 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 93-98             = 31 gages &  58,599 obs  
#   Missing years                      =  3 gages &  xxxxxx obs 
#   Incomplete gages from 93-98        =  1 gage (lcr_abv)   
#____________________________________________________________________ 
#     Complete gages from 93-98        = 27 gages &  57,697 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# 1. filter gages w/ complete 1993-98 obs (wkc_wok) ----
# this is to create an initial cluster set with wkc_wok
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1993-1998
gage_9398_meta <- gage_meta %>% 
  filter(min_yr <= 1992)  %>%
  filter(max_yr >= 1997)                               #     31 gages 

gage_9398 <- gage %>% 
  filter(min_yr <= 1992)    %>%                       #     31 gages          
  filter(max_yr >= 1997)    %>%
  filter(waterYear >= 1993) %>%                   # drops to 28 gages
  filter(waterYear <= 1998)                        

gage_9398_meta <- semi_join(gage_9398_meta, gage_9398)
# note that whi_int, whi_cra, & che_buf have missing years in the data...

# Identify gages missing data 1993-1998 
gage_incomp <- gage_9398 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n) %>% 
  filter(waterYear > 1992) %>% 
  filter(waterYear < 1998)                              # 1 obs 

#gage_incomp 
# A tibble: 4 x 3 - the o
#  sta     waterYear     n 
#  <chr>       <int> <int> 
#1 lcr_abv      1996   172 * on Rez - need to add in later  
# ~~~~~~~~~~~~~~~~~~~~~~~~ 

#  make gage_incomp full record & remove gages w/ miss. yrs in 93-98 
gage_9398_incomp <- semi_join(gage_9398_meta, gage_incomp, by = "sta") 
gage_9398_meta <- anti_join(gage_9398_meta, gage_incomp, by = "sta") 

# removed lcr_abv - for now - 30 gages remaining  

# drop incomplete stations 
gage_9398 <- anti_join(gage_9398, gage_incomp, by = "sta") 
# 57,697 remaining obs 

# check results & clean up 
chk_sta <- anti_join(gage_meta, gage_9398_meta, by = "sta") %>% 
  select(1:3) 

gage_name <- gage_9398 %>% 
  distinct(sta) 
  
  
# chk_sta 
# A tibble: 10 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991   ok to drop 
# 2 lcr_abv   1938   2016 
# 3 nio_bbb   1947   1991   ok to drop 
# 4 nio_abb   1947   1994   ok to drop 
# 5 sna_bur   1948   1995   ok to drop 
# 6 cas_hot   1976   1995   ok to drop 
# 7 sna_dou   1982   1995   ok to drop 
# 8 che_red   1998   2017   ok to drop 
# 9 whi_whi   2001   2017   ok to drop 
#10 che_sce   2007   2017   ok to drop 

# A tibble: 13 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991
# 2 whi_int   1929   2017 - missing years
# 3 whi_cra   1931   2004 - missing years
# 4 lcr_abv   1938   2016 * on Rez - need to add in later 
# 5 nio_bbb   1947   1991
# 6 nio_abb   1947   1994
# 7 sna_bur   1948   1995
# 8 che_buf   1969   2017 - missing years
# 9 cas_hot   1976   1995
#10 sna_dou   1982   1995
#11 che_red   1998   2017
#12 whi_whi   2001   2017
#13 che_sce   2007   2017


# final check 
chk_sta <- gage_9398 %>% 
  distinct(sta) 

chk_sta <- anti_join(chk_sta, gage_9398_meta, by = "sta")


# export 1993-1998 & clean up 
export(gage_9398, "data/gage_9398.csv") 
export(gage_9398_meta, "data/gage_meta_9398.csv") 

rm(chk_sta, gage_9398_incomp, gage_incomp, gage_name) 
```

```{r create_9016_subset_new}
# This code chunk creates a cluster for lcr_abv
# Notes: Use water year Oct1-Sept31, w/ year on the majority of months 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 90-16             = 31 gages &  
#58,599 obs  


#   Missing years                      =  3 gages &
#   Incomplete gages from 93-98        =  1 gage (lcr_abv)   
#____________________________________________________________________ 
#     Complete gages from 93-98        = 27 gages &  57,697 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# 1. filter gages w/ complete 1990-16 obs (lcr_abv) ----
# this is to create an initial cluster set with wkc_wok
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1993-1998
gage_9015_meta <- gage_meta %>% 
  filter(min_yr <= 1989)  %>%
  filter(max_yr >= 2015)                               #     21 gages 

gage_9015 <- gage %>% 
  filter(min_yr <= 1989)    %>%                       #     21 gages          
  filter(max_yr >= 2015)    %>%
  filter(waterYear >= 1990) %>%                   # remains 21 gages
  filter(waterYear <= 2015)                       # 185,536 obs 

gage_9015_meta <- semi_join(gage_9015_meta, gage_9015, by = "sta") 


# Identify gages missing data 1990-1998 
gage_incomp <- gage_9015 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n) %>% 
  filter(waterYear > 1989) %>% 
  filter(waterYear < 2017)                              # 1 obs 

gage_incomp 
# A tibble: 2 x 3
#  sta     waterYear     n
#  <chr>       <int> <int>
#1 lcr_abv      1996   172   * drop 1996
#2 che_buf      2007   192   * drop 2007
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# drop 1996 & 2017 for lcr_abv & che_buf 
gage_9015 <- gage_9015 %>% 
  filter(waterYear != 1996) %>% 
  filter(waterYear != 2007)                          # 171,284 obs

# check results & clean up 
chk_sta <- anti_join(gage_meta, gage_9015_meta, by = "sta") %>% 
  select(1:3) 

chk_sta 
# A tibble: 19 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991  * dropped from both - short record, Neb
# 2 whi_cra   1931   2004  * dropped from both - short record, miss.yr
# 3 nio_bbb   1947   1991  * dropped from both - short record, Neb
# 4 nio_abb   1947   1994  * dropped from both - short record, Neb
# 5 sna_bur   1948   1995  * dropped from both - short record, Neb
# 6 spr_her   1949   2004  * in 9397 dataset 
# 7 whi_slm   1962   1997  * in 9397 dataset 
# 8 wcc_ogl   1966   1999  * in 9397 dataset 
# 9 ros_ros   1975   2004  * in 9397 dataset 
#10 cas_hot   1976   1995  * dropped from both - short record, in SD
#11 sna_dou   1982   1995  * dropped from both - short record, Neb
#12 lwr_abv   1982   2004  * in 9397 dataset 
#13 bev_abf   1991   1997  * in 9397 dataset 
#14 bev_pri   1991   2017  * in 9397 dataset 
#15 wkc_wok   1992   1997  * in 9397 dataset 
#16 blp_bel   1992   2017  * in 9397 dataset 
#17 che_red   1998   2017  * dropped from both - short record, in SD
#18 whi_whi   2001   2017  * dropped from both - short record, in SD
#19 che_sce   2007   2017   * dropped from both - short record, in SD 

# find set of records from 9397 dataset
sta_update <- anti_join(gage_9398_meta, gage_9015_meta) %>% 
  select(sta)

# final checks
chk_sta <- gage_9015 %>% 
  distinct(sta) 

chk_sta <- anti_join(chk_sta, gage_9015_meta, by = "sta")

chk_sta <- gage_9015 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup()                         


# export 1993-1998 & clean up 
export(gage_9015, "data/gage_9015.csv")  # unable to commit to GitHub
export(gage_9015_meta, "data/gage_meta_9015.csv") 
export(sta_update, "data/update_9398.csv") 

rm(chk_sta) 
```


```{r create_9016_subset} 
# This code chunk creates a cluster for lcr_abv active years
#   Complete 1990-16 obs w/o 96 (lcr_abv); range of yrs [1938, 2016] 
# 
#   Remember waterYear 1990 = Oct 1989 - Sept 1990, 
#     so the last possible wateryear is 2016; but n(2006) = 61 obs,
#       so, use 2015 as last year
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 90-16             = 21 gages & 251,862 obs           
#   Incomp. gages !Rez & !93-98        =  5 gages &  18,458 obs *
#____________________________________________________________________ 
#     Intermediate gages               = 21 gages & 233,404 obs 
#   Incomp. gages in 90-16             =  1 gage  &  32,726 obs * 
#____________________________________________________________________ 
#     Intermediate gages               = 20 gages & 200,678 obs 
#   1996 observations                  = NA gages &   8,224 obs   
#____________________________________________________________________ 
#  Final group of 90-16_no96           = 20 gages & 192,820 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# * these gages will not be used at all in the analysis


# 1. filter gages with 1990-16 obs---- 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1990-2016; all observations  
gage_9016_meta <- gage_meta %>% 
  filter(min_yr <= 1989)  %>% 
  filter(max_yr >= 2015)                                #  21 gages 

gage_9016 <- gage %>% 
  filter(waterYear >= 1990) %>% 
  filter(waterYear <= 2015)                             # 251,862 obs

# identify gages w/ missing years in 1990-2016 & not in 1993-1998
gage_incomp <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n)                       #  16 gages (but mixed)

# prepare to use the gage_missing to examine # incomplete observations
gage_missing <- anti_join(gage_incomp, gage_9398_meta, by = "sta") 

gage_missing <- gage_missing %>% 
  arrange(waterYear)

gage_missing <- gage_missing %>% 
  filter(sta != "lcr_abv")
  
#gage_missing 
# A tibble: 7 x 3
#  sta     waterYear     n
#  <chr>       <int> <int>
#1 sna_dou      1995    17  - ok to drop 
#2 sna_bur      1995   221  - ok to drop 
#3 che_red      1998    19  - ok to drop 
#4 whi_whi      2001   122  - ok to drop 
#5 che_sce      2007   183  - ok to drop              #       5 gages

# drop gages missing: the set is: not Rez, incomp. 93-98
gage_drop    <- semi_join(gage_9016, gage_missing, 
                            by = "sta")               #  18,458  obs 

gage_9016      <- anti_join(gage_9016, gage_missing, by = "sta")
                                                        # 233,404 obs 

gage_9016_meta <- anti_join(gage_9016_meta, gage_missing, by = "sta") 
                                                        #    21 gages


# 2. Remove gages incomplete 1990-16 obs---- 

# find incomplete gages
gage_incomp <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(sta)  %>% 
  group_by(sta) %>%  
  count() %>% 
  ungroup() 

# gage_incomp 
# A tibble: 8 x 2 
#  sta        nn - this is the number of water years missing  
#  <chr>   <int> 
#1 bev_pri     1   - 1991 
#2 blp_bel     1   - 1992
#3 che_buf     1   - 2007 
#4 lcr_abv     2   - 1996  * this is the one to keep!
#5 lwr_abv     3   - 2000, 2003, 2004
#6 ros_ros     2   - 2004 
#7 whi_slm     1   - 1991
#8 wkc_wok     1   - 1992 
  
# prepare for a join by removing lcr_abv from file
gage_incomp <- gage_incomp %>% 
  filter(sta != "lcr_abv")

# drop gages w/ missing obs, the set is: not Rez, incomp. 90-16 
gage_drop      <- semi_join(gage_9016, gage_incomp, 
                            by = "sta")                 #  32,726 obs 

gage_drop_meta <- semi_join(gage_9016_meta, gage_incomp, 
                            by = "sta")                #       1 gage

gage_9016      <- anti_join(gage_9016, gage_incomp, by = "sta")
                                                       # 200,678  obs 
gage_9016_meta <- anti_join(gage_9016_meta, gage_incomp, by = "sta") 
                                                      #      20 gages

# check results 
chk_sta <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n)                # 1 obs of gage w/ missing yrs

# export results & clean up 
export(gage_9016, "data/gage_9016.csv") 
export(gage_9016_meta, "data/gage_meta.csv") 

rm(chk_sta, gage_drop, gage_drop_meta, gage_incomp, gage_missing) 


# 3. prepare cluster two for export---- 

# remove the year 1996 from result 
gage_9016_no96 <- gage_9016 %>% 
  filter(waterYear != 1996) 

export(gage_9016_no96, "data/gage_9016_no96.csv") 
export(gage_9016_meta, "data/gage_meta_9016.csv") 
```

```{r check_results_subset} 

# identify stations with full years 
chk_sta <- bind_rows(gage_9398_meta, gage_9016_meta) 

chk_sta <- chk_sta %>% 
  distinct(sta, .keep_all = TRUE) %>% 
  select(sta, station_nm, min_yr, max_yr, count_yr, everything()) %>% 
    arrange(station_nm) 

# identify stations dropped in the analysis
drop_sta <- anti_join(gage_meta, chk_sta, by = "sta") 

drop_sta <- drop_sta %>% 
  select(sta, station_nm, min_yr, max_yr, count_yr) %>% 
  arrange(station_nm)

# drop_sta 
# A tibble: 9 x 5 - thise are stations that won't be used in analysis
#  sta     station_nm                          min_yr max_yr count_yr 
#  <chr>   <chr>                                <dbl>  <dbl>    <dbl> 
#1 cas_hot CASCADE SPRINGS NEAR HOT SPRINGS SD   1976   1995       20 
#2 che_red CHEYENNE RIVER AT RED SHIRT, SD       1998   2017       20 
#3 che_sce CHEYENNE RIVER NEAR SCENIC, SD        2007   2017       11 
#4 nio_abb NIOBRARA RIVER ABOVE BOX BUTTE RES…   1947   1994       48 
#5 nio_bbb NIOBRARA RIVER BELOW BOX BUTTE RES…   1947   1991       45 
#6 nio_gor NIOBRARA RIVER NEAR GORDON, NEBR.     1928   1991       64 
#7 sna_dou SNAKE R AT DOUGHBOY, NE               1982   1995       14 
#8 sna_bur SNAKE RIVER NEAR BURGE, NEBR.         1948   1995       48 
#9 whi_whi WHITE RIVER NEAR WHITE RIVER, SD      2001   2017       17 
#x bat_key BATTLE CR NEAR KEYSTONE,SD            1945   2017       73


# chk_sta 
# A tibble: 32 x 5
#   sta     station_nm                         min_yr max_yr count_yr
#   <chr>   <chr>                               <dbl>  <dbl>    <dbl>
# 1 bat_her BATTLE CR AT HERMOSA,SD              1949   2017       69
# 2 bat_bhr BATTLE CR BELOW HERMOSA,SD           1951   2017       67
# 3 bev_buf BEAVER CR NEAR BUFFALO GAP,SD        1938   2017       80
# 4 bev_abf BEAVER CREEK ABOVE BUFFALO GAP, SD   1991   1997        7
# 5 bev_pri BEAVER CREEK NEAR PRINGLE, SD        1991   2017       27
# 6 blp_bel BLACK PIPE CREEK NR BELVIDERE, SD    1992   2017       26
# 7 che_buf CHEYENNE R NEAR BUFFALO GAP SD       1969   2017       49
# 8 che_was CHEYENNE RIVER NEAR WASTA, SD        1915   2017      103
# 9 fal_hot FALL R AT HOT SPRINGS,SD             1947   2017       71
#10 frn_fai FRENCH CR ABOVE FAIRBURN SD          1982   2017       36
#11 hat_edg HAT CR NEAR EDGEMONT,SD              1951   2017       67
#12 hor_oel HORSEHEAD CR AT OELRICHS,SD          1983   2017       35
#13 lcr_abv LAKE CR ABOVE REFUGE NEAR TUTHILL…   1938   2016       79
#14 lcr_bel LAKE CR BELOW REFUGE NEAR TUTHILL…   1939   2017       79
#15 lwr_abv LITTLE WHITE R ABV ROSEBUD SD        1982   2004       23
#16 lwr_whi LITTLE WHITE R BELOW WHITE RIVER,…   1950   2017       68
#17 lwr_mar LITTLE WHITE R NEAR MARTIN,SD        1938   2017       80
#18 lwr_ros LITTLE WHITE R NEAR ROSEBUD SD       1943   2017       75
#19 lcr_vet LITTLE WHITE R NEAR VETAL,SD         1959   2017       59
#20 rap_far RAPID CR NEAR FARMINGDALE,SD         1946   2017       72
#21 ros_ros ROSEBUD CR AT ROSEBUD SD             1975   2004       30
#22 brsf_co SOUTH FORK BAD R NEAR COTTONWOOD,…   1989   2017       29
#23 spr_her SPRING CR NEAR HERMOSA,SD            1949   2004       56
#24 wcc_ogl WHITE CLAY CR NEAR OGLALA SD         1966   1999       34
#25 whi_int WHITE R NEAR INTERIOR,SD             1929   2017       89
#26 whi_kad WHITE R NEAR KADOKA,SD               1942   2017       76
#27 whi_ogl WHITE R NEAR OGLALA SD               1943   2017       75
#28 whi_sta WHITE R NR NE-SD STATE LINE          1988   2017       30
#29 whi_cra White River at Crawford, Nebr.       1931   2004       74
#30 whi_slm WHITE RIVER AT SLIM BUTTE, SD        1962   1997       36
#31 wkc_wok WOUNDED KNEE CREEK AT WOUNDED KNE…   1992   1997        6


```

```{r next_steps_munging, eval=FALSE}
# Also add BEAR in the LODGE


# check ice - starts 2017-10-23 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ice <- gage_int %>%
  filter(code == "P Ice") %>% 
  arrange(date) 

# check provisional values 
# ~~~~~~~~~~~~~~~~~~~~~~~~
provis <- gage_int %>%
  filter(code == "P" | code == "P e" | code == "P <") %>%
  arrange(date) # starts 2016-10-05

# remove data after 2017-10-01
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_int <- gage_int %>%
  filter(year != 2018)

gage_2017 <- gage_int %>%
  filter(year == 2017)

gage_prior <- gage_int %>%
  filter(year < 2017) 

gage_2017 <- gage_2017 %>%
  filter(month != 10) %>% 
  filter(month != 11) %>%
filter(month != 12)

gage_imp <- bind_rows(gage_prior, gage_2017) %>%
  arrange(desc(date)) 
rm(gage_2017, gage_int, gage_list, gage_prior, ice, provis, gage_raw) 

# simplify the naming convention for gages 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_imp <- gage_imp %>% 
  select(site_no, date, discharge, code)

station_nm <- gage_meta %>% 
  select(site_no, station_nm) %>% 
  as.tibble()

abrev <- c("whi_sta", "whi_ogl", "wcc_ogl", "whi_int", "wkc_wok", 
           "blc_wan", "whi_kad", "blp_bel", "lwr_mar", "lcr_bel", 
           "lcr_vet", "brsf_co", "bad_mid") %>%
  as.tibble() %>%
  rename(sta = value)

abrev <- bind_cols(abrev, station_nm) 

gage_imp <- full_join(abrev, gage_imp, by = "site_no")
gage_meta <- full_join(abrev, gage_meta, by = "site_no")
rm(station_nm, abrev)

# Split and spread data
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_dis_imp <- gage_imp %>% 
  select(sta, date, discharge)

gage_dis_imp <- gage_dis_imp %>% 
  spread(key = sta, value = discharge) 

# Add short name to metadata
# ~~~~~~~~~~~~~~~~~~~~~~~~~~
abrev <- gage_imp %>%
  distinct(sta, site_no)

gage_meta <- full_join(abrev, gage_meta, by = "site_no") 

# export and import station df by rio
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# export(gage_raw, "data/gage_raw.csv") 
# write_lines(gage_json, "data/gage_list.json")
# export(gage_imp, "data/gage_imperial.csv") 

# export(gage_dis_imp, "data/gage_discharge_imp.csv") 


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# get site numbers from prior metadata
gage_meta <- import("data/gage_meta.csv")
#site_nums <- gage_meta %>%
#  select(sta, site_no) %>% 
#  print()


#Sample <- readNWISSample(siteNumber,parameter_cd,startDate,endDate)
# this code chunk uses dataRetreval to get discharge in cfs 
# removes provisional values and ice and saves the data as a csv.
```


```{r code = readlines(knitr::purl("/path/to/file", documentation = 1)), echo=T, eval=F}
# this R markdown chunk generates a code appendix 

#
```

