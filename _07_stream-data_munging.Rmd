---
title: "stream_data_munging"
author: "Charles Jason Tinant"
date: "4/11/2018"
output: pdf_document
---

# Next STEPS
1. blc_wan <- readNWISDaily("06446700") # this not working!
Reached out to Joyce Williamson 2019-03-18

2. Check on next steps from Chapter 2 list 


# Someday Maybe


## Variable naming convention:   
  for USGS functions: EGRET & dataRetrieval:
startDate    Beginning date for downloading USGS gage data
endDate      End date for downloading USGS gage data
parameter_cd USGS parameter codes

xxx_yyy      individual gage names xxx = stream & yyy = location

gage         USGS stream gages with daily values 
    _dv      daily values; used for the first set of gages selected
    _meta    metadata; without a modifier is the set after initial site removal
    _poss    possible; used for finding initial stations & metadata  
    _pos     possible & shorter length; used for shortened initial metadata
    _

meta_cd      metadata code - used to check on gage metadata 
-->
more stuff

```{r setup, include=FALSE, message=FALSE}  
#knitr::opts_chunk$set(echo = FALSE)  
options(tibble.print_max = 70) # sets tibble output for printing  

# Sets up the library of packages   
library("here") # identifies where to save work  
library("EGRET") # Exploration and Graphics for RivEr Trends 
library("rio") # more robust I/O - to import and clean data  
library("lubridate") # easier dates 
library("tidyverse") 
library("janitor") # tools for examining and cleaning dirty data  
library("dataRetrieval") # USGS data import  
```

```{r import_daily_flow_metadata, eval=FALSE} 

# this code chunk finds all sites within a bounding box 
# adds the metadata, then filters no data sites for 1990- 2018 water years 
# for filtering info see: https://help.waterdata.usgs.gov/site_tp_cd
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 1. find  possible sites by bounding box 
# bBox = a contiguous range of decimal latitude and longitude, starting with the west longitude, then the south latitude, then the east longitude, and then the north latitude with each value separated by a comma. 
# https://waterservices.usgs.gov/rest/Site-Service.html#bBox 
# the Pine Ridge Reservation boundary is c(-103, 43, -100.2, 43.8)

gage_poss <- whatNWISsites(bBox = c(-103.8, 42.2, -99.2, 44.6), 
                       parameterCd = "00060", hasDataTypeCd = "dv") %>% 
  arrange(site_no)

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 2. get metadata 
# this needs to be run in parts because some project numbers are stored 
#     as integers & others are stored as characters 
# this code could be improved on possibly by map2 to convert 'project_no' to 
#     a character 

gage_meta_poss_01 <- gage_poss %>% 
    slice(1:6) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# this uses an integer value for project number
gage_meta_poss_02 <- gage_poss %>% 
    slice(7) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_poss_03 <- gage_poss %>% 
    slice(8:16) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# this uses an integer value for project number
gage_meta_poss_04 <- gage_poss %>% 
    slice(17) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_poss_05 <- gage_poss %>% 
    slice(18:93) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# this uses an integer value for project number
gage_meta_poss_06 <- gage_poss %>% 
    slice(94) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_poss_07 <- gage_poss %>% 
    slice(95:141) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# this uses an integer value for project number
gage_meta_poss_08 <- gage_poss %>% 
    slice(142) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_poss_09 <- gage_poss %>% 
    slice(143:147) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

# this uses an integer value for project number
gage_meta_poss_10 <- gage_poss %>% 
    slice(148) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 

gage_meta_poss_11 <- gage_poss %>% 
    slice(149:155) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISsite(siteNumbers = .$site_no)) %>% 
  select(-c(project_no, inventory_dt)) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 3. join gage metadata & drop the partial sites 
# this could be improved on by passing a for loop for naming...
gage_meta_poss <- bind_rows(gage_meta_poss_01, gage_meta_poss_02, 
                            gage_meta_poss_03, gage_meta_poss_04,  
                            gage_meta_poss_05, gage_meta_poss_06, 
                            gage_meta_poss_07, gage_meta_poss_08, 
                            gage_meta_poss_09, gage_meta_poss_10, 
                            gage_meta_poss_11)  

rm(gage_meta_poss_01, gage_meta_poss_02, 
                            gage_meta_poss_03, gage_meta_poss_04,  
                            gage_meta_poss_05, gage_meta_poss_06, 
                            gage_meta_poss_07, gage_meta_poss_08, 
                            gage_meta_poss_09, gage_meta_poss_10, 
                            gage_meta_poss_11)   

rm(gage_poss) 

# 4. export metadata to data folder 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
export(gage_meta_poss, "data/gage_meta_poss.csv")  
```

```{r clean_daily_flow_metadata, eval=FALSE}
# cleans the imported metadata 

# 1. make a tibble of metadata codes 
meta_cd <- enframe(names(gage_meta_poss), name = NULL) 

# 2. remove codes not needed for this project 
gage_meta_pos <- gage_meta_poss %>% 
  select(-site_tp_cd) %>% # all streams so delete 
  select(-c(lat_va, long_va)) %>% # in DMS so delete 
  select(-c(coord_meth_cd, coord_acy_cd)) %>% # coord method & agency, so delete 
  select(-c(coord_datum_cd, dec_coord_datum_cd)) %>% # NAD83 or NAD27 
  select(-c(district_cd, country_cd)) %>% # Congressional dist & Country 
  select(-c(land_net_ds, map_nm, map_scale_fc)) %>%  # refers to USGS maps 
  select(-c(alt_meth_cd, alt_datum_cd, alt_acy_va)) %>% #%>% # altitude metadata  
  select(-c(basin_cd, topo_cd, instruments_cd)) %>% 
  select(-c(construction_dt)) %>% 
  select(-c(tz_cd, local_time_fg)) %>% # daily data, so NA 
  select(-c(gw_file_cd, nat_aqfr_cd, aqfr_type_cd, aqfr_cd)) %>% 
  # aquifer data, so NA 
  select(-c(well_depth_va, hole_depth_va, depth_src_cd)) 
```

```{r remove_not_useful_stations, eval=FALSE}
# remove gages that do not meet standards or in crystaline or karst catchments 
gage_meta <- gage_meta_pos %>%   
  mutate(reliability_cd = replace_na(reliability_cd, 0)) %>% # otherwise drops NA
  filter(reliability_cd != "M") %>% # M is minimal data 
  filter(!str_detect(station_nm, 'DAM|DITCH|DRAIN')) %>% # upstream control 
  filter(!str_detect(station_nm, 
                     'CUSTER|KEYSTONE|HILL CITY|HAYWARD')) %>% 
  # crystaline catchments 
  filter(!str_detect(station_nm, 
                     'LEAD|DEADWOOD|WHITEWOOD')) %>%   
  filter(!str_detect(station_nm, 'CLEGHORN')) %>% # karstic? spring 
  filter(!str_detect(station_nm, 'BOXELDER|LIME')) %>% # karstic 
  filter(!str_detect(station_nm, 'RAPID')) %>%   # Rapid Creek & upper Spring Creek 
  filter(!str_detect(station_nm, 'MISSOURI'))

# 4. export metadata to data folder after fixing leading zero
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_meta <- gage_meta %>% 
  mutate(site_no = as.character(site_no)) %>% 
  select(-reliability_cd) %>% 
  mutate(length = str_length(site_no)) %>% 
  filter(length <= 8) %>%   # removes two provisional sites
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8)) %>% 
  select(-length)

export(gage_meta, "data/gage_meta.csv") 

```

```{r import_daily_flow, eval=FALSE} 

# Loads USGS gage data for active stations individually, bind_cols & 
# exports data to a folder.  Gage IDs identified by USGS watermapper.  
# The data needs to be saved as two smaller files to be uploaded on GitHub.
# 
#   Egret::readNWISDaily(siteNumber, parameterCd = "00060", startDate = "",
#      endDate = "", interactive = TRUE, convert = TRUE) 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# 1. create a list of active gages & get metadata for water year 1990-2018 
startDate    <- "" # note that blank gets earliest date 
# for some reason, adding a value here causes an error...
# Error in names(data) <- c("agency", "site", "dateTime", "value", "code") : 
#  'names' attribute [5] must be the same length as the vector [3]
# add an end date to remove provisional data & gaps in vals 
endDate      <- "2018-09-30" 
parameter_cd <- "00060" 
# ~~~~~~~~~~~~~~~~~~~~~ 

# load the metadata 
gage_meta <- import("data/gage_meta.csv", setclass = "tibble") %>% 
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8)) 

# remove short sites with provisional data
gage_meta <- gage_meta %>%  
  filter(site_no != "06461150"& 
         site_no != "06463670"& 
         site_no != "06461595") 

# remove Long Pine Creek near Riverview, Nebr. 
#   needs to be called separately or it creates an error 
lon_riv <- gage_meta %>% 
  filter(site_no == "06463500") 

gage_meta <- gage_meta %>%  
  filter(site_no != "06463500") 

# get daily values & join
gage_dv_01 <- gage_meta %>% 
#  slice(1:88) %>% 
  split(.$site_no) %>% 
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                          parameter_cd, startDate, endDate), .id = "site_no") 

gage_dv_02 <- lon_riv %>%  
  split(.$site_no) %>% 
  map_dfr(~ readNWISDaily(siteNumber = .$site_no, 
                          parameter_cd, startDate, endDate), .id = "site_no") 

gage_dv <- bind_rows(gage_dv, gage_dv_02)

# clean up & export
rm(endDate, parameter_cd, startDate, gage_meta_poss, gage_meta_pos, meta_cd, 
   gage_dv_01, gage_dv_02, lon_riv) 

export(gage_dv, "data/gage_dv.csv") 
```

```{r clean_daily_flow, eval=FALSE} 
# # this code chunk removes dates prior to water year 1990 & other bits

# 1. load the metadata & daily flows 
gage_meta <- import("data/gage_meta.csv", setclass = "tibble") %>% 
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8)) %>% 
  mutate(state_cd = as.character(state_cd)) %>% 
  mutate(county_cd = as.character(county_cd)) %>% 
  mutate(huc_cd = as.character(huc_cd))

gage_dv <- import("data/gage_dv.csv", setclass = "tibble")  %>% 
  mutate(site_no = as.character(site_no)) %>% 
  mutate(site_no = zeroPad(site_no, 8))   


# 2. remove dates prior to water year 1990 & NA vals
gage_dv <- gage_dv %>% 
  filter(waterYear >= 1990)  %>% 
  filter(Q != is.na(Q)) # remove NA discharge values from record  

# 3. filter out sites with < 5 years
# create a summary variable for number of years 
gage_yr_summ <- gage_dv %>% 
  group_by(site_no) %>% 
  summarise(min_year = min(waterYear),
            max_year = max(waterYear), 
            num_year = n_distinct(waterYear))

# join the summary variable
gage_dv <- left_join(gage_dv, gage_yr_summ, by = "site_no")

# filter less than five years
gage_dv <- gage_dv %>% 
  filter(num_year > 5) 


# 4. remove Northern Black Hills stations
gage_dv <- gage_dv %>% 
  filter(site_no != "06438000") %>% 
  filter(site_no != "06437000") 

# 5. remove East River stations
gage_dv <- gage_dv %>% 
  filter(site_no != "06442718")

# 6. remove streams with substantial missing data
# identify serially incomplete observations 
gage_incomp <- gage_dv %>% 
  group_by(station_nm, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(station_nm, waterYear, i_count) 

# remove streams with a large number of incomplete observations 
gage_dv <- gage_dv %>% 
  filter(site_no != "06441000") 

# 7. join daily flow & metadata
gage_meta <- semi_join(gage_meta, gage_dv, by = "site_no") 
gage_dv <- left_join(gage_dv, gage_meta, by = "site_no") 


# 8. check results 
gage_incomp <- gage_dv %>% 
  group_by(station_nm, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(station_nm, waterYear, i_count) 

gage_yr_summ <- gage_dv %>% 
  group_by(site_no) %>% 
  summarise(station_nm = first(station_nm), 
            min_year = min(waterYear),
            max_year = max(waterYear), 
            num_year = n_distinct(waterYear)) %>% 
  ungroup() %>% 
  arrange(station_nm) 


gage_yr_sum2 <- gage_yr_summ %>% 
  summarise(number_sta = n(), 
            ave_year = mean(num_year)) 

gage_ck  <- gage_dv %>% 
  distinct()  
``` 

```{r create-short-names}
gage_yr_summ 


gage_nm_short <- tibble(sta = c("hor_oel", fal
))




06441500	BAD R NEAR FORT PIERRE,SD	1990             bad_fpi

06406000	BATTLE CR AT HERMOSA,SD	1990	             bat_her
06406500	BATTLE CR BELOW HERMOSA,SD	1990	         bat_bhr
06446700	BEAR IN THE LODGE CR NEAR WANBLEE,SD	1993 blc_wan	
06402500	BEAVER CR NEAR BUFFALO GAP,SD	1990	       bev_buf
06402470	BEAVER CREEK ABOVE BUFFALO GAP, SD	1991	 bev_abf
06402430	BEAVER CREEK NEAR PRINGLE, SD	1991	       bev_pri
06447230	BLACK PIPE CREEK NR BELVIDERE, SD	1992	   blp_bel
06400497	CASCADE SPRINGS NEAR HOT SPRINGS SD	1990	 cas_hot
06402600	CHEYENNE R NEAR BUFFALO GAP SD	2007	     che_buf
06438500	CHEYENNE R NEAR PLAINVIEW,SD	1994	       che_pla
06403700	CHEYENNE RIVER AT RED SHIRT, SD	1998       che_red
06408650	CHEYENNE RIVER NEAR SCENIC, SD	2007	     che_sce 
06423500	CHEYENNE RIVER NEAR WASTA, SD	1990	       che_was
06425500	ELK CR NEAR ELM SPRINGS,SD	1990	         elk_elm
06424000	ELK CR NEAR ROUBAIX,SD	1992	             elk_rob 
06402000	FALL R AT HOT SPRINGS,SD	1990	           fal_hot
06403300	FRENCH CR ABOVE FAIRBURN SD	1990	         frn_fai
06400000	HAT CR NEAR EDGEMONT,SD	1990	             hat_edg
06400875	HORSEHEAD CR AT OELRICHS,SD	1990  	hor_oel
06464500	KEYA PAHA R AT WEWELA,SD	1990	  key_wew
06464100	KEYA PAHA R NEAR KEYAPAHA,SD	1990	key_key
06448000	LAKE CR ABOVE REFUGE NEAR TUTHILL,SD	1996	lcr_abv
06449000	LAKE CR BELOW REFUGE NEAR TUTHILL,SD	1990	lcr_bel 
06449300	LITTLE WHITE R ABV ROSEBUD SD	1990	        lwr_aro
06450500	LITTLE WHITE R BELOW WHITE RIVER,SD	1990    lwr_whi
06447500	LITTLE WHITE R NEAR MARTIN,SD	1990        	lwr_mar
06449500	LITTLE WHITE R NEAR ROSEBUD SD	1990	      lwr_ros
06449100	LITTLE WHITE R NEAR VETAL,SD	1990	        lwr_vet
06463500  Long Pine Creek near Riverview, Nebr.       lon_riv
06461000	MINNECHADUZA CREEK AT VALENTINE, NEBR.	1990	min_val 
06454100	Niobrara River at Agate, Nebr.	1990	nio_age
06463720	Niobrara River at Mariaville, Nebr.	2012	nio_mar 
06461500	Niobrara River near Sparks, Nebr.	1990	nio_spa
06462500	PLUM CREEK AT MEADVILLE, NE	1990	 plu_mea
06441110	PLUM CREEK BELOW HAYES, SD	1990	 plu_hay
06449400	ROSEBUD CR AT ROSEBUD SD	1990     ros_ros
06459175	SNAKE R AT DOUGHBOY, NE	1990	     sna_dou
06459500	SNAKE RIVER NEAR BURGE, NEBR.	1990	sna_bur
06440200	SOUTH FORK BAD R NEAR COTTONWOOD,SD	1990	brsf_co
06408500	SPRING CR NEAR HERMOSA,SD	1990	spr_her
06445980	WHITE CLAY CR NEAR OGLALA SD	1990	wcc_ogl
06446500	WHITE R NEAR INTERIOR,SD	2003	whi_int
06447000	WHITE R NEAR KADOKA,SD	1990	whi_kad
06452000	WHITE R NEAR OACOMA,SD	1990	whi_oac
06446000	WHITE R NEAR OGLALA SD	1990	whi_ogl
06445685	WHITE R NR NE-SD STATE LINE	1990	whi_sta
06445700  WHITE RIVER AT SLIM BUTTE, SD	1991	whi_slm
06447450	WHITE RIVER NEAR WHITE RIVER, SD	2001	whi_whi
06446100	WOUNDED KNEE CREEK AT WOUNDED KNEE, SD	1992	wkc_wok




```




```{r clean_daily flow} 
# this code chunk checks and removes gages w/o useful characteristics
#   for future analysis 
# This code is a refactor of prior code above, some of it broken
# 
# Steps: 
# 1. Assemble a full dataset (N = 61 stations; 741,215 obs)
# 2. Remove streams prior to 1990 from the analysis series 
#      (N = 19 stations, 103,465 obs) 
# 3. Remove streams with substantial missing data 
# 4. Investigate remaining stations 



# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# 3. Remove streams with substantial missing data----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Identify serially incomplete observations 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
gage_incomp <- gage %>% 
  group_by(sta, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(sta, waterYear, i_count) 

# 18 stations post-1990n are incomplete; two stations 
#   (bad_mid & chr_ang) have many incomplete years

# gage_incomp 
# A tibble: 62 x 3 - redacted & includes a note 
#   sta     waterYear i_count  note
#   <chr>       <int>   <int> <mine>
#  1 bad_mid      1991      28  most years incomplete; remove
# 17 bad_mid      2017       4
# 23 chr_ang      1991     181  most years incomplete; remove
#  7 chr_ang      2017     181

# remove stations with many incomplete years 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
drop_sta <- gage_meta %>% 
   filter(sta == "bad_mid" |    
           sta == "chr_ang"
         ) # 2 sta

gage_meta_drop <- bind_rows(gage_meta_drop, drop_sta) # 17 + 2 = 19 sta
  
gage_meta <- gage_meta %>% 
  filter(sta != "bad_mid" &  
           sta != "chr_ang"
         ) %>% 
  arrange(min_yr) %>% 
  select(sta, min_yr, max_yr, count_yr, everything()) # 44 - 2 = 42 sta

# remove observations with many incomplete years
drop_obs <- gage %>% 
  filter(sta == "bad_mid" |   
           sta == "chr_ang"
         ) # 32,742 obs

gage_drop <- bind_rows(gage_drop, drop_obs) # 70,723 + 32,742 = 103,465

gage <- gage %>% 
  filter(sta != "bad_mid" &  
           sta != "chr_ang"
         ) %>% 
  arrange(min_yr) %>% 
  select(sta, min_yr, max_yr, count_yr, everything()) 
# 670,492 - 32,742 = 637,750

rm(drop_sta, drop_obs, gage_incomp, gage_full, gage_drop, 
   gage_meta_drop, gage_meta_full) 

# quick check of the geology of watersheds

chk_sta <- gage_meta %>% 
  select(sta, station_nm) %>% 
  arrange(sta)



# remove igneous PreCambrian station from analysis----
gage <- gage %>% 
  filter(sta != "bat_key")             # obs  from 637,750 -> 616,525 

gage_meta <- gage_meta %>% 
  filter(sta != "bat_key")             # gage from      42 ->      41 

rm(chk_sta)
```

```{r create_post1980_subset}
# This code chunk subsets gages with 1990+ observations for clustering.
# Note - using water year (10-01) as start of year... 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Original Gages; gage_full       = 61 gages & 741,215 obs  
#      Gages w/o 1980+ or missing data = 19 gages & 103,465 (dropped) 
#   Gages remaining; gage           = 42 gages & 637,750 obs 
#      Gages with PreC geology      =  1 gage &   21,225 obs (dropped)
#   Gages remaining; gage           = 41 gages & 616,525 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages pre-1980; gage_lt80       = 29 gages & 255,068 obs 
#   Gages remaining; gage           = 42 gages & 361,457 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#   Remove gages w/o full yrs       =  1 gage  &     363 obs
#   Gages remaining; gage           = 40 gages & 361,094 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#   Identify reservation gages     = 14 gages 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

 
# 1. filter pre-1980 gages---- 
gage_lt80_meta <- gage_meta %>% 
  filter(min_yr < 1979) # 29 gages 

gage_lt80 <- gage %>% 
  filter(min_yr <= 1979) %>%                        # waterYear 1980
  filter(Date < "1979-10-01")                       #  255,068 obs  

# remove pre-1980 observations    
gage <- gage %>% 
  filter(Date >= "1979-10-01")                      #  361,457 obs 

# export observations
export(gage_lt80, "data/gage_lt80.csv") 
export(gage_lt80_meta, "data/gage_lt80_meta.csv") 

rm(gage_lt80, gage_lt80_meta)


# 2. remove post-1990 stations w/o full years----

gage_comp <- gage %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n >= 364) %>%
  group_by(sta) %>%
  count() %>% 
  ungroup() %>% 
  rename(yrs_post80 = nn) %>% 
  arrange(yrs_post80)

check_sta <- anti_join(gage, gage_comp, by = "sta")
# this shows rap_cre should be dropped   

# update stations by dropping rap_cre
gage_meta <- semi_join(gage_meta, gage_comp, by = "sta")     # 40 sta
gage      <- semi_join(gage, gage_comp)                 # 361,094 obs

rm(check_sta) 

# 3. Investigate remaining stations----
gage_incomp <- gage %>% 
  group_by(sta, waterYear) %>% 
  summarize(i_count = n()) %>% 
  filter(i_count <= 364) %>% 
  ungroup() %>% 
  filter(waterYear > 1990) %>% 
  arrange(i_count, waterYear, sta) 

# filter set of Reservation stations
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_res <- gage_meta %>% 
  filter(state_cd == 46) %>% 
  filter(county_cd == 7 | 
           county_cd == 71 |
           county_cd == 95 |
           county_cd == 102
  ) %>% 
  select(min_yr, max_yr, sta)

# join post-90 reservation stations 
gage_res <- left_join(gage_comp, gage_res, by = "sta") 

gage_res <- gage_res %>% 
  arrange(max_yr, yrs_post80) 

rm(gage_comp, gage_incomp) 

# The table below is the 13 stations on the reservation, which are 
# shown with min & max year and the other stations in the region) 

# gage_res 
# A tibble: 41 x 4
#   sta     yrs_post80 min_yr max_yr
#   <chr>        <int>  <dbl>  <dbl>
# 1 wkc_wok          5   1992   1997
# 2 whi_slm          6   1962   1997
# 3 wcc_ogl         14   1966   1999
# 4 lcr_abv         19   1938   2016
# 5 whi_int         15   1929   2017
# 6 blp_bel         25   1992   2017
# 7 brsf_co         29   1989   2017
# 8 whi_sta         30   1988   2017
# 9 lcr_bel         38   1939   2017
#10 lcr_vet         38   1959   2017
#11 lwr_mar         38   1938   2017
#12 lwr_whi         38   1950   2017
#13 whi_kad         38   1942   2017
#14 whi_ogl         38   1943   2017
#15 bev_abf          7     NA     NA
#16 che_sce         10     NA     NA
#17 che_buf         11     NA     NA
#18 nio_bbb         12     NA     NA
#19 nio_gor         12     NA     NA
#20 sna_dou         13     NA     NA
#21 whi_cra         13     NA     NA
#22 nio_abb         15     NA     NA
#23 sna_bur         15     NA     NA
#24 cas_hot         16     NA     NA
#25 whi_whi         16     NA     NA
#26 lwr_abv         18     NA     NA
#27 ros_ros         18     NA     NA
#28 che_red         19     NA     NA
#29 spr_her         25     NA     NA
#30 bev_pri         26     NA     NA
#31 bat_bhr         29     NA     NA
#32 hor_oel         34     NA     NA
#33 frn_fai         35     NA     NA
#34 rap_far         37     NA     NA
#35 bat_her         38     NA     NA
#36 bat_key         38     NA     NA
#37 bev_buf         38     NA     NA
#38 che_was         38     NA     NA
#39 fal_hot         38     NA     NA
#40 hat_edg         38     NA     NA
#41 lwr_ros         38     NA     NA

# wkc-wok is 1993-1998 - so first clustering is over these dates 
#   to identify a group for wkc-wok to estimate streamflows 


```

```{r create_9398_subset}
# This code chunk creates a cluster for wkc_wok active years
# Notes: Use water year Oct1-Sept31, w/ year on the majority of months 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 93-98             = 31 gages &  58,599 obs  
#   Missing years                      =  3 gages &  xxxxxx obs 
#   Incomplete gages from 93-98        =  1 gage (lcr_abv)   
#____________________________________________________________________ 
#     Complete gages from 93-98        = 27 gages &  57,697 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# 1. filter gages w/ complete 1993-98 obs (wkc_wok) ----
# this is to create an initial cluster set with wkc_wok
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1993-1998
gage_9398_meta <- gage_meta %>% 
  filter(min_yr <= 1992)  %>%
  filter(max_yr >= 1997)                               #     31 gages 

gage_9398 <- gage %>% 
  filter(min_yr <= 1992)    %>%                       #     31 gages          
  filter(max_yr >= 1997)    %>%
  filter(waterYear >= 1993) %>%                   # drops to 28 gages
  filter(waterYear <= 1998)                        

gage_9398_meta <- semi_join(gage_9398_meta, gage_9398)
# note that whi_int, whi_cra, & che_buf have missing years in the data...

# Identify gages missing data 1993-1998 
gage_incomp <- gage_9398 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n) %>% 
  filter(waterYear > 1992) %>% 
  filter(waterYear < 1998)                              # 1 obs 

#gage_incomp 
# A tibble: 4 x 3 - the o
#  sta     waterYear     n 
#  <chr>       <int> <int> 
#1 lcr_abv      1996   172 * on Rez - need to add in later  
# ~~~~~~~~~~~~~~~~~~~~~~~~ 

#  make gage_incomp full record & remove gages w/ miss. yrs in 93-98 
gage_9398_incomp <- semi_join(gage_9398_meta, gage_incomp, by = "sta") 
gage_9398_meta <- anti_join(gage_9398_meta, gage_incomp, by = "sta") 

# removed lcr_abv - for now - 30 gages remaining  

# drop incomplete stations 
gage_9398 <- anti_join(gage_9398, gage_incomp, by = "sta") 
# 57,697 remaining obs 

# check results & clean up 
chk_sta <- anti_join(gage_meta, gage_9398_meta, by = "sta") %>% 
  select(1:3) 

gage_name <- gage_9398 %>% 
  distinct(sta) 
  
  
# chk_sta 
# A tibble: 10 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991   ok to drop 
# 2 lcr_abv   1938   2016 
# 3 nio_bbb   1947   1991   ok to drop 
# 4 nio_abb   1947   1994   ok to drop 
# 5 sna_bur   1948   1995   ok to drop 
# 6 cas_hot   1976   1995   ok to drop 
# 7 sna_dou   1982   1995   ok to drop 
# 8 che_red   1998   2017   ok to drop 
# 9 whi_whi   2001   2017   ok to drop 
#10 che_sce   2007   2017   ok to drop 

# A tibble: 13 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991
# 2 whi_int   1929   2017 - missing years
# 3 whi_cra   1931   2004 - missing years
# 4 lcr_abv   1938   2016 * on Rez - need to add in later 
# 5 nio_bbb   1947   1991
# 6 nio_abb   1947   1994
# 7 sna_bur   1948   1995
# 8 che_buf   1969   2017 - missing years
# 9 cas_hot   1976   1995
#10 sna_dou   1982   1995
#11 che_red   1998   2017
#12 whi_whi   2001   2017
#13 che_sce   2007   2017


# final check 
chk_sta <- gage_9398 %>% 
  distinct(sta) 

chk_sta <- anti_join(chk_sta, gage_9398_meta, by = "sta")


# export 1993-1998 & clean up 
export(gage_9398, "data/gage_9398.csv") 
export(gage_9398_meta, "data/gage_meta_9398.csv") 

rm(chk_sta, gage_9398_incomp, gage_incomp, gage_name) 
```

```{r create_9016_subset_new}
# This code chunk creates a cluster for lcr_abv
# Notes: Use water year Oct1-Sept31, w/ year on the majority of months 

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 90-16             = 31 gages &  
#58,599 obs  


#   Missing years                      =  3 gages &
#   Incomplete gages from 93-98        =  1 gage (lcr_abv)   
#____________________________________________________________________ 
#     Complete gages from 93-98        = 27 gages &  57,697 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# 1. filter gages w/ complete 1990-16 obs (lcr_abv) ----
# this is to create an initial cluster set with wkc_wok
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1993-1998
gage_9015_meta <- gage_meta %>% 
  filter(min_yr <= 1989)  %>%
  filter(max_yr >= 2015)                               #     21 gages 

gage_9015 <- gage %>% 
  filter(min_yr <= 1989)    %>%                       #     21 gages          
  filter(max_yr >= 2015)    %>%
  filter(waterYear >= 1990) %>%                   # remains 21 gages
  filter(waterYear <= 2015)                       # 185,536 obs 

gage_9015_meta <- semi_join(gage_9015_meta, gage_9015, by = "sta") 


# Identify gages missing data 1990-1998 
gage_incomp <- gage_9015 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n) %>% 
  filter(waterYear > 1989) %>% 
  filter(waterYear < 2017)                              # 1 obs 

gage_incomp 
# A tibble: 2 x 3
#  sta     waterYear     n
#  <chr>       <int> <int>
#1 lcr_abv      1996   172   * drop 1996
#2 che_buf      2007   192   * drop 2007
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

# drop 1996 & 2017 for lcr_abv & che_buf 
gage_9015 <- gage_9015 %>% 
  filter(waterYear != 1996) %>% 
  filter(waterYear != 2007)                          # 171,284 obs

# check results & clean up 
chk_sta <- anti_join(gage_meta, gage_9015_meta, by = "sta") %>% 
  select(1:3) 

chk_sta 
# A tibble: 19 x 3
#   sta     min_yr max_yr
#   <chr>    <dbl>  <dbl>
# 1 nio_gor   1928   1991  * dropped from both - short record, Neb
# 2 whi_cra   1931   2004  * dropped from both - short record, miss.yr
# 3 nio_bbb   1947   1991  * dropped from both - short record, Neb
# 4 nio_abb   1947   1994  * dropped from both - short record, Neb
# 5 sna_bur   1948   1995  * dropped from both - short record, Neb
# 6 spr_her   1949   2004  * in 9397 dataset 
# 7 whi_slm   1962   1997  * in 9397 dataset 
# 8 wcc_ogl   1966   1999  * in 9397 dataset 
# 9 ros_ros   1975   2004  * in 9397 dataset 
#10 cas_hot   1976   1995  * dropped from both - short record, in SD
#11 sna_dou   1982   1995  * dropped from both - short record, Neb
#12 lwr_abv   1982   2004  * in 9397 dataset 
#13 bev_abf   1991   1997  * in 9397 dataset 
#14 bev_pri   1991   2017  * in 9397 dataset 
#15 wkc_wok   1992   1997  * in 9397 dataset 
#16 blp_bel   1992   2017  * in 9397 dataset 
#17 che_red   1998   2017  * dropped from both - short record, in SD
#18 whi_whi   2001   2017  * dropped from both - short record, in SD
#19 che_sce   2007   2017   * dropped from both - short record, in SD 

# find set of records from 9397 dataset
sta_update <- anti_join(gage_9398_meta, gage_9015_meta) %>% 
  select(sta)

# final checks
chk_sta <- gage_9015 %>% 
  distinct(sta) 

chk_sta <- anti_join(chk_sta, gage_9015_meta, by = "sta")

chk_sta <- gage_9015 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup()                         


# export 1993-1998 & clean up 
export(gage_9015, "data/gage_9015.csv")  # unable to commit to GitHub
export(gage_9015_meta, "data/gage_meta_9015.csv") 
export(sta_update, "data/update_9398.csv") 

rm(chk_sta) 
```


```{r create_9016_subset} 
# This code chunk creates a cluster for lcr_abv active years
#   Complete 1990-16 obs w/o 96 (lcr_abv); range of yrs [1938, 2016] 
# 
#   Remember waterYear 1990 = Oct 1989 - Sept 1990, 
#     so the last possible wateryear is 2016; but n(2006) = 61 obs,
#       so, use 2015 as last year
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   Gages post1980; gage               = 40 gages & 361,094 obs 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
#     All gages from 90-16             = 21 gages & 251,862 obs           
#   Incomp. gages !Rez & !93-98        =  5 gages &  18,458 obs *
#____________________________________________________________________ 
#     Intermediate gages               = 21 gages & 233,404 obs 
#   Incomp. gages in 90-16             =  1 gage  &  32,726 obs * 
#____________________________________________________________________ 
#     Intermediate gages               = 20 gages & 200,678 obs 
#   1996 observations                  = NA gages &   8,224 obs   
#____________________________________________________________________ 
#  Final group of 90-16_no96           = 20 gages & 192,820 obs
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
# * these gages will not be used at all in the analysis


# 1. filter gages with 1990-16 obs---- 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# filter gages for water years 1990-2016; all observations  
gage_9016_meta <- gage_meta %>% 
  filter(min_yr <= 1989)  %>% 
  filter(max_yr >= 2015)                                #  21 gages 

gage_9016 <- gage %>% 
  filter(waterYear >= 1990) %>% 
  filter(waterYear <= 2015)                             # 251,862 obs

# identify gages w/ missing years in 1990-2016 & not in 1993-1998
gage_incomp <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n)                       #  16 gages (but mixed)

# prepare to use the gage_missing to examine # incomplete observations
gage_missing <- anti_join(gage_incomp, gage_9398_meta, by = "sta") 

gage_missing <- gage_missing %>% 
  arrange(waterYear)

gage_missing <- gage_missing %>% 
  filter(sta != "lcr_abv")
  
#gage_missing 
# A tibble: 7 x 3
#  sta     waterYear     n
#  <chr>       <int> <int>
#1 sna_dou      1995    17  - ok to drop 
#2 sna_bur      1995   221  - ok to drop 
#3 che_red      1998    19  - ok to drop 
#4 whi_whi      2001   122  - ok to drop 
#5 che_sce      2007   183  - ok to drop              #       5 gages

# drop gages missing: the set is: not Rez, incomp. 93-98
gage_drop    <- semi_join(gage_9016, gage_missing, 
                            by = "sta")               #  18,458  obs 

gage_9016      <- anti_join(gage_9016, gage_missing, by = "sta")
                                                        # 233,404 obs 

gage_9016_meta <- anti_join(gage_9016_meta, gage_missing, by = "sta") 
                                                        #    21 gages


# 2. Remove gages incomplete 1990-16 obs---- 

# find incomplete gages
gage_incomp <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(sta)  %>% 
  group_by(sta) %>%  
  count() %>% 
  ungroup() 

# gage_incomp 
# A tibble: 8 x 2 
#  sta        nn - this is the number of water years missing  
#  <chr>   <int> 
#1 bev_pri     1   - 1991 
#2 blp_bel     1   - 1992
#3 che_buf     1   - 2007 
#4 lcr_abv     2   - 1996  * this is the one to keep!
#5 lwr_abv     3   - 2000, 2003, 2004
#6 ros_ros     2   - 2004 
#7 whi_slm     1   - 1991
#8 wkc_wok     1   - 1992 
  
# prepare for a join by removing lcr_abv from file
gage_incomp <- gage_incomp %>% 
  filter(sta != "lcr_abv")

# drop gages w/ missing obs, the set is: not Rez, incomp. 90-16 
gage_drop      <- semi_join(gage_9016, gage_incomp, 
                            by = "sta")                 #  32,726 obs 

gage_drop_meta <- semi_join(gage_9016_meta, gage_incomp, 
                            by = "sta")                #       1 gage

gage_9016      <- anti_join(gage_9016, gage_incomp, by = "sta")
                                                       # 200,678  obs 
gage_9016_meta <- anti_join(gage_9016_meta, gage_incomp, by = "sta") 
                                                      #      20 gages

# check results 
chk_sta <- gage_9016 %>% 
  group_by(sta, waterYear) %>%  
  count() %>% 
  arrange(n) %>% 
  ungroup() %>% 
  filter(n < 364) %>% 
  arrange(waterYear, n)                # 1 obs of gage w/ missing yrs

# export results & clean up 
export(gage_9016, "data/gage_9016.csv") 
export(gage_9016_meta, "data/gage_meta.csv") 

rm(chk_sta, gage_drop, gage_drop_meta, gage_incomp, gage_missing) 


# 3. prepare cluster two for export---- 

# remove the year 1996 from result 
gage_9016_no96 <- gage_9016 %>% 
  filter(waterYear != 1996) 

export(gage_9016_no96, "data/gage_9016_no96.csv") 
export(gage_9016_meta, "data/gage_meta_9016.csv") 
```

```{r check_results_subset} 

# identify stations with full years 
chk_sta <- bind_rows(gage_9398_meta, gage_9016_meta) 

chk_sta <- chk_sta %>% 
  distinct(sta, .keep_all = TRUE) %>% 
  select(sta, station_nm, min_yr, max_yr, count_yr, everything()) %>% 
    arrange(station_nm) 

# identify stations dropped in the analysis
drop_sta <- anti_join(gage_meta, chk_sta, by = "sta") 

drop_sta <- drop_sta %>% 
  select(sta, station_nm, min_yr, max_yr, count_yr) %>% 
  arrange(station_nm)

# drop_sta 
# A tibble: 9 x 5 - thise are stations that won't be used in analysis
#  sta     station_nm                          min_yr max_yr count_yr 
#  <chr>   <chr>                                <dbl>  <dbl>    <dbl> 
#1 cas_hot CASCADE SPRINGS NEAR HOT SPRINGS SD   1976   1995       20 
#2 che_red CHEYENNE RIVER AT RED SHIRT, SD       1998   2017       20 
#3 che_sce CHEYENNE RIVER NEAR SCENIC, SD        2007   2017       11 
#4 nio_abb NIOBRARA RIVER ABOVE BOX BUTTE RES…   1947   1994       48 
#5 nio_bbb NIOBRARA RIVER BELOW BOX BUTTE RES…   1947   1991       45 
#6 nio_gor NIOBRARA RIVER NEAR GORDON, NEBR.     1928   1991       64 
#7 sna_dou SNAKE R AT DOUGHBOY, NE               1982   1995       14 
#8 sna_bur SNAKE RIVER NEAR BURGE, NEBR.         1948   1995       48 
#9 whi_whi WHITE RIVER NEAR WHITE RIVER, SD      2001   2017       17 
#x bat_key BATTLE CR NEAR KEYSTONE,SD            1945   2017       73


# chk_sta 
# A tibble: 32 x 5
#   sta     station_nm                         min_yr max_yr count_yr
#   <chr>   <chr>                               <dbl>  <dbl>    <dbl>
# 1 bat_her BATTLE CR AT HERMOSA,SD              1949   2017       69
# 2 bat_bhr BATTLE CR BELOW HERMOSA,SD           1951   2017       67
# 3 bev_buf BEAVER CR NEAR BUFFALO GAP,SD        1938   2017       80
# 4 bev_abf BEAVER CREEK ABOVE BUFFALO GAP, SD   1991   1997        7
# 5 bev_pri BEAVER CREEK NEAR PRINGLE, SD        1991   2017       27
# 6 blp_bel BLACK PIPE CREEK NR BELVIDERE, SD    1992   2017       26
# 7 che_buf CHEYENNE R NEAR BUFFALO GAP SD       1969   2017       49
# 8 che_was CHEYENNE RIVER NEAR WASTA, SD        1915   2017      103
# 9 fal_hot FALL R AT HOT SPRINGS,SD             1947   2017       71
#10 frn_fai FRENCH CR ABOVE FAIRBURN SD          1982   2017       36
#11 hat_edg HAT CR NEAR EDGEMONT,SD              1951   2017       67
#12 hor_oel HORSEHEAD CR AT OELRICHS,SD          1983   2017       35
#13 lcr_abv LAKE CR ABOVE REFUGE NEAR TUTHILL…   1938   2016       79
#14 lcr_bel LAKE CR BELOW REFUGE NEAR TUTHILL…   1939   2017       79
#15 lwr_abv LITTLE WHITE R ABV ROSEBUD SD        1982   2004       23
#16 lwr_whi LITTLE WHITE R BELOW WHITE RIVER,…   1950   2017       68
#17 lwr_mar LITTLE WHITE R NEAR MARTIN,SD        1938   2017       80
#18 lwr_ros LITTLE WHITE R NEAR ROSEBUD SD       1943   2017       75
#19 lcr_vet LITTLE WHITE R NEAR VETAL,SD         1959   2017       59
#20 rap_far RAPID CR NEAR FARMINGDALE,SD         1946   2017       72
#21 ros_ros ROSEBUD CR AT ROSEBUD SD             1975   2004       30
#22 brsf_co SOUTH FORK BAD R NEAR COTTONWOOD,…   1989   2017       29
#23 spr_her SPRING CR NEAR HERMOSA,SD            1949   2004       56
#24 wcc_ogl WHITE CLAY CR NEAR OGLALA SD         1966   1999       34
#25 whi_int WHITE R NEAR INTERIOR,SD             1929   2017       89
#26 whi_kad WHITE R NEAR KADOKA,SD               1942   2017       76
#27 whi_ogl WHITE R NEAR OGLALA SD               1943   2017       75
#28 whi_sta WHITE R NR NE-SD STATE LINE          1988   2017       30
#29 whi_cra White River at Crawford, Nebr.       1931   2004       74
#30 whi_slm WHITE RIVER AT SLIM BUTTE, SD        1962   1997       36
#31 wkc_wok WOUNDED KNEE CREEK AT WOUNDED KNE…   1992   1997        6


```

```{r next_steps_munging, eval=FALSE}
# Also add BEAR in the LODGE


# check ice - starts 2017-10-23 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ice <- gage_int %>%
  filter(code == "P Ice") %>% 
  arrange(date) 

# check provisional values 
# ~~~~~~~~~~~~~~~~~~~~~~~~
provis <- gage_int %>%
  filter(code == "P" | code == "P e" | code == "P <") %>%
  arrange(date) # starts 2016-10-05

# remove data after 2017-10-01
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_int <- gage_int %>%
  filter(year != 2018)

gage_2017 <- gage_int %>%
  filter(year == 2017)

gage_prior <- gage_int %>%
  filter(year < 2017) 

gage_2017 <- gage_2017 %>%
  filter(month != 10) %>% 
  filter(month != 11) %>%
filter(month != 12)

gage_imp <- bind_rows(gage_prior, gage_2017) %>%
  arrange(desc(date)) 
rm(gage_2017, gage_int, gage_list, gage_prior, ice, provis, gage_raw) 

# simplify the naming convention for gages 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_imp <- gage_imp %>% 
  select(site_no, date, discharge, code)

station_nm <- gage_meta %>% 
  select(site_no, station_nm) %>% 
  as.tibble()

abrev <- c("whi_sta", "whi_ogl", "wcc_ogl", "whi_int", "wkc_wok", 
           "blc_wan", "whi_kad", "blp_bel", "lwr_mar", "lcr_bel", 
           "lcr_vet", "brsf_co", "bad_mid") %>%
  as.tibble() %>%
  rename(sta = value)

abrev <- bind_cols(abrev, station_nm) 

gage_imp <- full_join(abrev, gage_imp, by = "site_no")
gage_meta <- full_join(abrev, gage_meta, by = "site_no")
rm(station_nm, abrev)

# Split and spread data
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
gage_dis_imp <- gage_imp %>% 
  select(sta, date, discharge)

gage_dis_imp <- gage_dis_imp %>% 
  spread(key = sta, value = discharge) 

# Add short name to metadata
# ~~~~~~~~~~~~~~~~~~~~~~~~~~
abrev <- gage_imp %>%
  distinct(sta, site_no)

gage_meta <- full_join(abrev, gage_meta, by = "site_no") 

# export and import station df by rio
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# export(gage_raw, "data/gage_raw.csv") 
# write_lines(gage_json, "data/gage_list.json")
# export(gage_imp, "data/gage_imperial.csv") 

# export(gage_dis_imp, "data/gage_discharge_imp.csv") 


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# get site numbers from prior metadata
gage_meta <- import("data/gage_meta.csv")
#site_nums <- gage_meta %>%
#  select(sta, site_no) %>% 
#  print()


#Sample <- readNWISSample(siteNumber,parameter_cd,startDate,endDate)
# this code chunk uses dataRetreval to get discharge in cfs 
# removes provisional values and ice and saves the data as a csv.
```


```{r code = readlines(knitr::purl("/path/to/file", documentation = 1)), echo=T, eval=F}
# this R markdown chunk generates a code appendix 

#
```

